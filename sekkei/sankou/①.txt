
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ä½å®…æ¡ˆä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v7ï¼ˆè‡ªå‹•ä¿å­˜ãƒ»åˆæœŸã‚¨ãƒ©ãƒ¼ä¿®æ­£ç‰ˆ2ï¼‰</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Yu Gothic',Meiryo,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
.header{position:sticky;top:0;z-index:5;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;padding:22px 24px}
.header h1{font-size:1.6rem;margin-bottom:6px}
.controls{padding:14px 20px;background:#f8f9fa;display:flex;gap:12px;flex-wrap:wrap;align-items:center;border-bottom:1px solid #eee}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab-btn{padding:8px 14px;border:2px solid #e9ecef;border-radius:999px;background:#fff;cursor:pointer;font-weight:700;font-size:.9rem}
.tab-btn.active{background:#667eea;color:#fff;border-color:#667eea}
.flex-1{flex:1}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input{height:38px;padding:0 12px;border:2px solid #e9ecef;border-radius:10px;font-size:.95rem;min-width:180px;background:#fff}
.select{height:38px;padding:0 8px;border:2px solid #e9ecef;border-radius:10px;background:#fff}
.btn{padding:10px 16px;border:none;border-radius:12px;cursor:pointer;font-weight:700;color:#fff;white-space:nowrap}
.btn-primary{background:#667eea}
.btn-secondary{background:#43e97b}
.btn-ghost{background:#f0f3f7;color:#333}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.75rem;font-weight:700}
.badge-green{background:#e6ffec;color:#1a7f37}
.cards-container{padding:20px}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(600px,1fr));gap:18px}
.cards-grid.manual-mode{grid-template-columns:repeat(auto-fill,minmax(600px,1fr))}
.project-card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 4px 20px rgba(0,0,0,.08);border:2px solid #f1f3f4;position:relative}
.card-header{display:flex;justify-content:space-between;gap:8px;margin-bottom:14px}
.card-title{font-size:18px;font-weight:800;color:#333;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.card-subtitle{font-size:13px;color:#666;margin-top:4px}
.milestone-row{font-size:13.5px;color:#333;margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
.milestone{font-size:14px;padding:6px 12px;display:inline-flex;align-items:center;line-height:1}
.milestone .label{font-weight:700;margin-right:6px}
.milestone-floor{background:#ffe8e8;border-color:#ffd2d2;color:#7a1f1f}.milestone{background:#fff3cd;color:#7a5b00;border:1px solid #ffeeba;border-radius:999px;padding:2px 8px;cursor:pointer}.milestone .label{font-weight:700;margin-right:4px}
.editable{border-bottom:1px dashed transparent;cursor:text}
.editable:focus{outline:none;border-bottom:1px dashed #667eea;background:#f5f7ff}
.progress-section{margin-bottom:12px}
.progress-bar{height:8px;background:#e9ecef;border-radius:4px;overflow:hidden;margin:8px 0}
.progress-fill{height:100%;background:#667eea;transition:width .25s}
.tasks-container{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.task-item{display:flex;align-items:center;gap:6px;font-size:11px;color:#555;padding:4px 8px;border-radius:6px;background:#f8f9fa;min-width:140px}
.task-checkbox{width:14px;height:14px;cursor:pointer}
.card-footer{display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px solid #f1f3f4;margin-top:8px}
.card-actions{display:flex;gap:6px;flex-wrap:wrap}
.card-btn{padding:6px 10px;border:none;border-radius:10px;cursor:pointer;font-size:11px;font-weight:700}
.card-btn-primary{background:#667eea;color:#fff}
.card-btn-secondary{background:#f0f3f7;color:#333}
.card-btn-danger{background:#dc3545;color:#fff}
.empty-state{text-align:center;padding:60px 20px;color:#666}
.section-header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;margin-top:12px}
@media (max-width:768px){
  .cards-grid{grid-template-columns:1fr}
  .tasks-container{flex-direction:column}
  .input{min-width:140px}
}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999}
.modal .modal-content{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);width:min(720px,92vw);max-height:86vh;overflow:auto;padding:16px}
body.noscroll{overflow:hidden}
.task-select{height:28px;padding:0 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;font-size:12px}
.task-select.state-yellow{background:#fff8d6;border-color:#f4e2a0;color:#7a5b00}
.task-select.state-green{background:#e8f7e8;border-color:#b9e4b9;color:#0f5132}
.task-item.task-disabled{opacity:0.55}
.task-item.task-disabled .task-checkbox{cursor:not-allowed}
.task-item.task-disabled .task-select{opacity:0.9}
.task-item.task-disabled span[onclick]{pointer-events:none}
.save-indicator{font-size:.85rem;font-weight:700;display:flex;align-items:center;gap:8px;margin-top:6px;opacity:.95}
.save-indicator .dot{width:8px;height:8px;border-radius:50%}
.save-indicator.saving .dot{background:#ffec99}
.save-indicator.saved .dot{background:#b2f2bb}
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>ä½å®…æ¡ˆä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    <div style="opacity:.9">æ‹…å½“è¨­è¨ˆå£«ã”ã¨ã®é¡§å®¢æ¡ˆä»¶ã‚’ã‚«ãƒ¼ãƒ‰å½¢å¼ã§åŠ¹ç‡ç®¡ç†ï¼ˆæ‰‹å‹•ä¸¦ã³ãƒ»è‡ªå‹•ä¿å­˜ï¼‰</div>
    <div id="saveIndicator" class="save-indicator saved" aria-live="polite">
      <span class="dot" aria-hidden="true"></span><span id="saveText">ä¿å­˜æ¸ˆã¿</span>
    </div>
  </div>

  <div class="controls">
    <div class="tabs" id="tabsContainer"></div>

    <div class="toolbar flex-1">
      <input id="q" class="input" placeholder="æ¤œç´¢ï¼ˆé¡§å®¢å / ãƒ¡ãƒ¢ï¼‰" oninput="renderCards()" />
      <select id="sortKey" class="select" onchange="renderCards()">
        <option value="manual" selected>æ‰‹å‹•ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆï¼‰</option>
        <option value="progress">é€²æ—ãŒä½ã„é †</option>
        <option value="updatedAt">æ›´æ–°ãŒæ–°ã—ã„é †</option>
        <option value="customer">é¡§å®¢åï¼ˆã‚ã„ã†ãˆãŠï¼‰</option>
      </select>
      <select id="specFilter" class="select" onchange="renderCards()">
        <option value="">ä»•æ§˜ï¼šã™ã¹ã¦</option>
        <option>LIFE</option><option>LIFE+</option><option>HOURS</option>
        <option>LACIE</option><option>LIFEãƒªãƒŸ</option><option>LIFE+ãƒªãƒŸ</option>
      </select>
      <button class="btn btn-ghost" onclick="exportJSON()">JSONå‡ºåŠ›</button>
      <button class="btn btn-ghost" onclick="exportCSV()">CSVå‡ºåŠ›</button>
      <button class="btn btn-ghost" onclick="resetData()">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
      <label class="btn btn-ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        å–è¾¼<input type="file" accept=".json" style="display:none" onchange="importJSON(event)"/>
      </label>
      <button class="btn btn-secondary" onclick="openDesignerModal()">è¨­è¨ˆå£«ç®¡ç†</button>
      <button class="btn btn-primary" onclick="openProjectModal()">æ¡ˆä»¶è¿½åŠ </button>
    </div>
  </div>

  <div class="cards-container">
    <div class="cards-grid" id="cardsGrid"></div>
    <div class="empty-state" id="emptyState" style="display:none;">
      <div style="font-size:4rem;margin-bottom:20px">ğŸ“‹</div>
      <div style="font-size:1.2rem;font-weight:700;margin-bottom:8px">æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>
      <button class="btn btn-primary" onclick="openProjectModal()">æœ€åˆã®æ¡ˆä»¶ã‚’è¿½åŠ </button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ï¼ˆçœç•¥ã›ãšä¿æŒï¼‰ -->
<div id="projectModal" class="modal" role="dialog" aria-modal="true" style="display:none">
  <div class="modal-content" style="background:#fff;margin:5% auto;padding:20px;border-radius:16px;width:90%;max-width:720px;max-height:80vh;overflow:auto">
    <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2 id="modalTitle">æ¡ˆä»¶è¿½åŠ </h2>
      <button class="close" onclick="closeProjectModal()" aria-label="é–‰ã˜ã‚‹" style="background:none;border:none;font-size:24px;cursor:pointer">&times;</button>
    </div>
    <div class="form-group"><label>ãŠå®¢æ§˜å</label><input type="text" id="customerName" placeholder="ç”°ä¸­å¤ªéƒæ§˜" style="width:100%;padding:10px;border:2px solid #e9ecef;border-radius:8px;font-size:14px"></div>
    <div class="form-group">
      <label>æ‹…å½“è¨­è¨ˆå£«</label>
      <select id="assignedTo" style="width:100%;padding:10px;border:2px solid #e9ecef;border-radius:8px;font-size:14px"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
    </div>
    <div class="form-group"><label>æ–°ã—ã„æ‹…å½“è€…</label><input type="text" id="newAssignee" placeholder="æ–°è¦ã®å ´åˆå…¥åŠ›" style="width:100%;padding:10px;border:2px solid #e9ecef;border-radius:8px;font-size:14px"></div>
    <div class="form-group"><label>ä»•æ§˜</label>
      <select id="specifications" style="width:100%;padding:10px;border:2px solid #e9ecef;border-radius:8px;font-size:14px">
        <option>LIFE</option><option>LIFE+</option><option>HOURS</option>
        <option>LACIE</option><option>LIFEãƒªãƒŸ</option><option>LIFE+ãƒªãƒŸ</option>
      </select>
    </div>
    <div class="form-group"><label>ãƒ¡ãƒ¢</label><textarea id="memo" rows="3" placeholder="è¦æœ›ãƒ»æ³¨æ„ç‚¹ãªã©" style="width:100%;padding:10px;border:2px solid #e9ecef;border-radius:8px;font-size:14px"></textarea></div>
    <div style="text-align:right;margin-top:10px">
      <button class="btn btn-secondary" onclick="closeProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveProject()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div id="progressModal" class="modal" role="dialog" aria-modal="true" style="display:none">
  <div class="modal-content" style="background:#fff;margin:5% auto;padding:20px;border-radius:16px;width:90%;max-width:860px;max-height:80vh;overflow:auto">
    <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2 id="progressTitle">é€²æ—ç®¡ç†</h2>
      <button class="close" onclick="closeProgressModal()" aria-label="é–‰ã˜ã‚‹" style="background:none;border:none;font-size:24px;cursor:pointer">&times;</button>
    </div>
    <div class="progress-grid" id="progressGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px"></div>
    <div style="text-align:right"><button class="btn btn-primary" onclick="closeProgressModal()">å®Œäº†</button></div>
  </div>
</div>

<div id="designerModal" class="modal" role="dialog" aria-modal="true" style="display:none">
  <div class="modal-content" style="background:#fff;margin:5% auto;padding:20px;border-radius:16px;width:90%;max-width:720px;max-height:80vh;overflow:auto">
    <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2>è¨­è¨ˆå£«ç®¡ç†</h2>
      <button class="close" onclick="closeDesignerModal()" aria-label="é–‰ã˜ã‚‹" style="background:none;border:none;font-size:24px;cursor:pointer">&times;</button>
    </div>
    <div class="form-group">
      <label>æ–°ã—ã„è¨­è¨ˆå£«ã‚’è¿½åŠ </label>
      <div style="display:flex;gap:10px">
        <input type="text" id="newDesignerName" style="flex:1;padding:10px;border:2px solid #e9ecef;border-radius:8px;font-size:14px" placeholder="è¨­è¨ˆå£«å">
        <button class="btn btn-primary" onclick="addDesigner()">è¿½åŠ </button>
      </div>
    </div>
    <div id="designerList"></div>
    <div style="text-align:right;margin-top:10px"><button class="btn btn-primary" onclick="closeDesignerModal()">å®Œäº†</button></div>
  </div>
</div>

<script>
if(!Object.values){ Object.values = function(o){ var r=[]; for(var k in o){ if(Object.prototype.hasOwnProperty.call(o,k)) r.push(o[k]); } return r; }; }
if(!String.prototype.padStart){ String.prototype.padStart = function(t, ch){ var s=String(this); ch = ch || ' '; while(s.length < t){ s = ch + s; } return s; }; }

var __memStore = {};
var __LS_OK = (function(){
  try{ var k='__cd_test__'; localStorage.setItem(k,'1'); localStorage.removeItem(k); return true; }
  catch(e){ return false; }
})();
function lsGet(k){ return __LS_OK ? localStorage.getItem(k) : (Object.prototype.hasOwnProperty.call(__memStore,k)?__memStore[k]:null); }
function lsSet(k,v){ if(__LS_OK){ localStorage.setItem(k,v); } else { __memStore[k]=v; } }
function lsRemove(k){ if(__LS_OK){ localStorage.removeItem(k); } else { delete __memStore[k]; } }

var seedProjects = [
  { customer:'ç”°ä¸­å¤ªéƒæ§˜', assignedTo:'ä½è—¤å»ºç¯‰å£«', specifications:'LIFE+', memo:'å¤ªé™½å…‰ç™ºé›»ã«èˆˆå‘³ã‚ã‚Š', status:'active',
    progress:{meeting0:{completed:true,date:''},floorPlan:{completed:true,date:''},initialPrep:{completed:true,date:''},finalDrawing:{completed:true,date:''},checklist:{completed:true,date:''},workingDrawing:{completed:true,date:''},plumbing:{completed:true,date:''},ventilation:{completed:false,date:''},solar:{completed:false,date:''},evoltz:{completed:false,date:''},sash:{completed:false,date:''},structure:{completed:false,date:''},groundSurvey:{completed:true,date:''},application:{completed:false,date:''},exterior:{completed:false,date:''},dandori:{completed:false,date:''}},
    updatedAt: Date.now()-864000000
  },
  { customer:'å±±ç”°èŠ±å­æ§˜', assignedTo:'éˆ´æœ¨è¨­è¨ˆ', specifications:'HOURS', memo:'æ…é‡ã«æ¤œè¨ä¸­', status:'active',
    progress:{meeting0:{completed:true,date:''},floorPlan:{completed:true,date:''},initialPrep:{completed:false,date:''},finalDrawing:{completed:false,date:''},checklist:{completed:false,date:''},workingDrawing:{completed:false,date:''},plumbing:{completed:false,date:''},ventilation:{completed:false,date:''},solar:{completed:false,date:''},evoltz:{completed:false,date:''},sash:{completed:false,date:''},structure:{completed:false,date:''},groundSurvey:{completed:false,date:''},application:{completed:false,date:''},exterior:{completed:false,date:''},dandori:{completed:false,date:''}},
    updatedAt: Date.now()-432000000
  },
  { customer:'é«˜æ©‹ä¸€éƒæ§˜', assignedTo:'ä¼Šè—¤å·¥å‹™åº—', specifications:'LACIE', memo:'å®Œäº†æ¸ˆã¿ã®æ¡ˆä»¶ã§ã™', status:'completed',
    progress:{meeting0:{completed:true,date:''},floorPlan:{completed:true,date:''},initialPrep:{completed:true,date:''},finalDrawing:{completed:true,date:''},checklist:{completed:true,date:''},workingDrawing:{completed:true,date:''},plumbing:{completed:true,date:''},ventilation:{completed:true,date:''},solar:{completed:false,date:''},evoltz:{completed:false,date:''},sash:{completed:true,date:''},structure:{completed:true,date:''},groundSurvey:{completed:false,date:''},application:{completed:true,date:''},exterior:{completed:true,date:''},dandori:{completed:true,date:''}},
    updatedAt: Date.now()-1728000000
  }
];

var taskStates = {
  workingDrawing: ['','ä¾é ¼æ¸ˆ','ä¿å­˜æ¸ˆ'],
  plumbing: ['','ä¾é ¼æ¸ˆ','ä¿å­˜æ¸ˆ'],
  ventilation: ['','ä¾é ¼æ¸ˆ','ä¿å­˜æ¸ˆ'],
  solar: ['','ä¾é ¼æ¸ˆ','ä¿å­˜æ¸ˆ'],
  evoltz: ['','ä¾é ¼æ¸ˆ','ä¿å­˜æ¸ˆ'],
  sash: ['','ä¾é ¼æ¸ˆ','ä¿å­˜æ¸ˆ'],
  groundSurvey: ['','ä¾é ¼æ¸ˆ','ä¿å­˜æ¸ˆ'],
  application: ['','ä¾é ¼æ¸ˆ','ä¿å­˜æ¸ˆ'],
  structure: ['','ä¾é ¼æ¸ˆ','ãƒ©ãƒ•ãƒã‚§ãƒƒã‚¯æ¸ˆ','ï¼‘å›ç›®CBæ¸ˆ','ï¼’å›ç›®CBæ¸ˆ']
};
function setTaskState(index, key, val){
  if(!projects[index].progress[key]) projects[index].progress[key] = {completed:false,date:'',state:''};
  projects[index].progress[key].state = val;
  touchProject(index); renderCards();
}

function stateClass(val){ if(val==='ä¾é ¼æ¸ˆ') return 'state-yellow'; if(val==='ä¿å­˜æ¸ˆ') return 'state-green'; return ''; }
var taskNames = {
  meeting0:'0å›ç›®æ‰“åˆã›',
  floorPlan:'é–“å–ã‚Šç¢ºå®š',
  finalDrawing:'ç¢ºå®šå›³é¢',
  checklist:'ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ',
  workingDrawing:'å®Ÿæ–½å›³ä¾é ¼',
  plumbing:'çµ¦æ’æ°´',
  ventilation:'æ›æ°—',
  solar:'å¤ªé™½å…‰',
  evoltz:'ã‚¨ãƒœãƒ«ãƒ„',
  sash:'ã‚µãƒƒã‚·ä¾é ¼',
  structure:'æ§‹é€ ä¾é ¼',
  groundSurvey:'åœ°ç›¤èª¿æŸ»',
  application:'ç”³è«‹ä¾é ¼',
  exterior:'å¤–æ§‹ä¾é ¼',
  dandori:'ãƒ€ãƒ³ãƒ‰ãƒªUP',
  initialPrep:'åˆå›æº–å‚™'
};
function applicationGateInfo(p){
  var reqKeys = ['plumbing','ventilation','solar','evoltz','sash'];
  var missing = [];
  for(var i=0;i<reqKeys.length;i++){
    var k=reqKeys[i]; var t=(p.progress&&p.progress[k])?p.progress[k]:{completed:false,state:''};
    var ok=(t.completed===true)&&(t.state==='ä¿å­˜æ¸ˆ');
    if(!ok) missing.push(taskNames[k]||k);
  }
  return { ok: missing.length===0, missing: missing };
}

function deepClone(obj){ try{ return JSON.parse(JSON.stringify(obj)); }catch(e){ return obj; } }

var STORAGE_KEY = 'connectdesign.projects.v7';
var ORDER_KEY = 'connectdesign.projects.order.v3';
var DESIGNERS_KEY = 'connectdesign.designers.v1';
var AUTO_SNAPSHOT_KEY = 'connectdesign.autosave.snapshot.v1';

function loadProjects(){
  try{ var raw = lsGet(STORAGE_KEY); if(!raw) return deepClone(seedProjects);
    var data = JSON.parse(raw); return Array.isArray(data)? data : deepClone(seedProjects); }
  catch(e){ return deepClone(seedProjects); }
}
function saveProjects(){
  lsSet(STORAGE_KEY, JSON.stringify(projects));
  lsSet(AUTO_SNAPSHOT_KEY, JSON.stringify({ts:Date.now(), projects:projects, designers:designers}));
  indicateSaved();
}

function loadDesigners(){
  try{
    var raw = lsGet(DESIGNERS_KEY);
    var arr = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(arr)) arr = [];
    projects.forEach(p=>{ if(p.assignedTo && !arr.includes(p.assignedTo)) arr.push(p.assignedTo); });
    return arr;
  }catch(e){
    var arr=[]; projects.forEach(p=>{ if(p.assignedTo && !arr.includes(p.assignedTo)) arr.push(p.assignedTo); });
    return arr;
  }
}
function saveDesigners(arr){ lsSet(DESIGNERS_KEY, JSON.stringify(arr)); indicateSaved(); }
function getDesigners(){ var set = new Set(designers); projects.forEach(p=> set.add(p.assignedTo)); return Array.from(set); }
function migrateDesignerOrderKey(oldName, newName){
  try{
    ['ACTIVE','COMPLETED'].forEach(function(t){
      var k = ORDER_KEY+':'+oldName+':'+t; var raw=lsGet(k);
      if(raw!==null){ lsSet(ORDER_KEY+':'+newName+':'+t, raw); lsRemove(k); }
    });
  }catch(e){ console.warn('order key migrate failed', e); }
}

function orderKeyFor(tab, type){ return ORDER_KEY + ':' + tab + ':' + (type||'ACTIVE'); }
function subsetFor(tab, type){
  var list = projects.slice();
  if(tab==='ALL'){ list = list.filter(function(p){return p.status!=='completed';}); }
  else { list = list.filter(function(p){return p.assignedTo===tab;}); }
  if(type==='COMPLETED'){ list = list.filter(function(p){return p.status==='completed';}); }
  else { list = list.filter(function(p){return p.status!=='completed';}); }
  return list;
}
function getOrder(tab, type){
  var key = orderKeyFor(tab||currentTab, type);
  try{ var raw = lsGet(key); if(!raw) return []; var arr = JSON.parse(raw); return Array.isArray(arr)?arr:[]; }catch(e){ return []; }
}
function saveOrder(arr, tab, type){ var key = orderKeyFor(tab||currentTab, type); lsSet(key, JSON.stringify(arr)); indicateSaved(); }
function ensureUID(p){ if(!p.uid){ try{ p.uid = (crypto.randomUUID?crypto.randomUUID():('uid_'+Math.random().toString(36).slice(2))); }catch(e){ p.uid='uid_'+Math.random().toString(36).slice(2); } } }
function initOrder(tab, type){
  tab = tab || currentTab; type = type || 'ACTIVE';
  var arr = getOrder(tab, type); var subset = subsetFor(tab, type);
  subset.forEach(function(p){ ensureUID(p); if(arr.indexOf(p.uid)<0) arr.push(p.uid); });
  arr = arr.filter(function(uid){ return subset.some(function(p){ return p.uid===uid; }); });
  saveOrder(arr, tab, type); return arr;
}
function sortByManual(list, type){ var arr = initOrder(currentTab, type||'ACTIVE'); list.sort(function(a,b){ return arr.indexOf(a.uid)-arr.indexOf(b.uid); }); }
function moveBefore(dragUid, targetUid, type){
  var arr = initOrder(currentTab, type||'ACTIVE');
  var from = arr.indexOf(dragUid); if(from<0) return;
  arr.splice(from,1);
  var to = targetUid ? arr.indexOf(targetUid) : arr.length; if(to<0) to = arr.length;
  arr.splice(to,0,dragUid); saveOrder(arr, currentTab, type||'ACTIVE');
}
var draggingUid = null, draggingType = 'ACTIVE';
function onDragStart(ev, uid, type){ draggingUid = uid; draggingType = type||'ACTIVE'; ev.dataTransfer.setData('text/plain', uid); }
function onDragOver(ev){ ev.preventDefault(); }
function onDrop(ev, targetUid, type){ ev.preventDefault(); var uid = draggingUid || ev.dataTransfer.getData('text/plain'); var t = type || draggingType || 'ACTIVE'; if(uid && uid!==targetUid){ moveBefore(uid, targetUid, t); renderCards(); } draggingUid = null; draggingType = 'ACTIVE'; }

var projects = loadProjects(); projects.forEach(ensureUID);
var designers = loadDesigners();
var currentTab = 'ALL', editingIndex=-1, progressEditingIndex=-1;

function blankProgress(){ var pg = {}; var keys = ['meeting0','floorPlan','initialPrep','finalDrawing','checklist','workingDrawing','plumbing','ventilation','solar','evoltz','sash','structure','groundSurvey','application','exterior','dandori']; for(var i=0;i<keys.length;i++){ pg[keys[i]] = {completed:false,date:'',state:''}; } return pg; }
function calculateProgress(p){ var total = Object.keys(p.progress).length, completed=0; for(var k in p.progress){ if(p.progress[k].completed) completed++; } return Math.round((completed/total)*100); }
function formatDate(str){ if(!str) return ''; var d=new Date(str); if(isNaN(d)) return str; return (d.getMonth()+1)+'/'+d.getDate(); }
function todayStr(){ var t=new Date(); return t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0')+'-'+String(t.getDate()).padStart(2,'0'); }

function updateTabs(){
  var designersAll = getDesigners();
  var activeCountAll = projects.filter(function(p){return p.status!=='completed';}).length;
  var html = `<button class="tab-btn ${currentTab==='ALL'?'active':''}" onclick="setTab('ALL')">å…¨æ¡ˆä»¶ (${activeCountAll})</button>`;
  designersAll.forEach(function(name){
    var countActive = projects.filter(function(p){return p.assignedTo===name && p.status!=='completed';}).length;
    html += `<button class="tab-btn ${currentTab===name?'active':''}" onclick="setTab('${name}')">${name} (${countActive})</button>`;
  });
  document.getElementById('tabsContainer').innerHTML = html;
}
function setTab(tab){ currentTab=tab; updateTabs(); renderCards(); }

function filtered(){
  var list = projects.slice();
  if(currentTab==='ALL'){ list = list.filter(function(p){return p.status!=='completed';}); }
  else { list = list.filter(function(p){return p.assignedTo===currentTab;}); }
  var qEl = document.getElementById('q'); var q = (qEl && qEl.value ? qEl.value : '').trim();
  if(q){ var qi = q.toLowerCase(); list = list.filter(function(p){ return p.customer.toLowerCase().includes(qi) || (p.memo||'').toLowerCase().includes(qi); }); }
  var spec = document.getElementById('specFilter').value; if(spec){ list = list.filter(function(p){ return p.specifications===spec; }); }
  return list;
}

function renderCards(){
  var list = filtered();
  var grid = document.getElementById('cardsGrid');
  var empty = document.getElementById('emptyState');
  var manualMode = (document.getElementById('sortKey').value==='manual');
  grid.classList.toggle('manual-mode', manualMode);

  if(list.length===0){ grid.style.display='none'; empty.style.display='block'; return; }
  grid.style.display='grid'; empty.style.display='none';

  var designerMode = (currentTab!=='ALL');
  var sortKey = document.getElementById('sortKey').value;
  function applySort(list, type){
    if(sortKey==='manual'){ sortByManual(list, type); }
    else if(sortKey==='progress'){ list.sort(function(a,b){ return calculateProgress(a)-calculateProgress(b); }); }
    else if(sortKey==='customer'){ list.sort(function(a,b){ return a.customer.localeCompare(b.customer,'ja'); }); }
    else { list.sort(function(a,b){ return (b.updatedAt||0)-(a.updatedAt||0); }); }
  }
  var html = '';
  function buildCard(p, manualType){
    var idx = projects.indexOf(p); var progress = calculateProgress(p); var isCompleted = p.status==='completed';
    var completedBadge = isCompleted ? `<div style="position:absolute;top:8px;right:8px" class="badge badge-green">âœ… å®Œäº†æ¸ˆã¿</div>` : '';
    var tasksHtml = ''; var order = Object.keys(taskNames);
    for(var oi=0; oi<order.length; oi++){
      var key = order[oi]; var t = p.progress[key] || {completed:false,date:'',state:''}; var dateText = t.date ? ' ('+formatDate(t.date)+')' : '';
      var gateBlocked = (key==='application' && !applicationGateInfo(p).ok);
      tasksHtml += `
        <div class="task-item ${gateBlocked ? 'task-disabled' : ''}" title="${gateBlocked ? ('ä¸è¶³ï¼š'+applicationGateInfo(p).missing.join('ã€')):''}">
          <input type="checkbox" class="task-checkbox" onchange="updateProgress(${idx},'${key}', this.checked)" ${t.completed?'checked':''} ${gateBlocked?'disabled':''}>
          <span onclick="editTaskDate(${idx},'${key}')" title="ã‚¯ãƒªãƒƒã‚¯ã§å®Œäº†æ—¥ç·¨é›†" style="cursor:pointer">${taskNames[key]}${dateText}</span>
          ${ (taskStates[key] ? `<select class="task-select ${stateClass(t.state)}" ${gateBlocked?'disabled':''} onchange="setTaskState(${idx},'${key}', this.value)">${taskStates[key].map(function(s){return `<option value="${s}" ${(t.state||'')===s?'selected':''}>${s||'â€”'}</option>`;}).join('')}</select>` : '' ) }
        </div>`;
    }
    var moveEndBtn = manualMode ? `<button class="card-btn card-btn-secondary" onclick="moveToEnd('${p.uid}', '${isCompleted?'COMPLETED':(manualType||'ACTIVE')}')">æœ«å°¾ã¸</button>` : '';
    return `
      <div class="project-card" data-uid="${p.uid}" data-type="${isCompleted?'COMPLETED':(manualType||'ACTIVE')}" draggable="true"
        ondragstart="onDragStart(event, '${p.uid}', '${isCompleted?'COMPLETED':(manualType||'ACTIVE')}')" ondragover="onDragOver(event)" ondrop="onDrop(event, '${p.uid}', '${isCompleted?'COMPLETED':(manualType||'ACTIVE')}')" ${isCompleted?'style="opacity:.9;border-color:#43e97b"':''}>
        ${completedBadge}
        <div class="card-header">
          <div style="min-width:0">
            <div class="card-title">
              <span contenteditable="true" class="editable" onblur="inlineUpdate(${idx}, 'customer', this.textContent.trim())">${p.customer}</span>
              <span class="badge" style="background:#eef2ff;color:#3f51b5">${p.specifications}</span>
            </div>
            <div class="card-subtitle">æ‹…å½“ï¼š
              <span contenteditable="true" class="editable" onblur="inlineUpdate(${idx}, 'assignedTo', this.textContent.trim())">${p.assignedTo}</span>
            </div>
          </div>
          <div class="milestone-row">
            <span class="milestone" onclick="quickEditMilestone(${idx},'meeting0')"><span class="label">0å›ç›®æ‰“åˆã›</span>${p.progress.meeting0 && p.progress.meeting0.date ? formatDate(p.progress.meeting0.date) : 'â€”'}</span>
            <span class="milestone milestone-floor" onclick="quickEditMilestone(${idx},'floorPlan')"><span class="label">é–“å–ã‚Šç¢ºå®š</span>${p.progress.floorPlan && p.progress.floorPlan.date ? formatDate(p.progress.floorPlan.date) : 'â€”'}</span>
          </div>
        </div>
        <div class="progress-section">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <span>é€²æ—: <b>${progress}%</b></span>
            <div style="display:flex;gap:6px;align-items:center">
              <button class="card-btn card-btn-secondary" onclick="openProgressModal(${idx})">è©³ç´°</button>
            </div>
          </div>
          <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
        </div>
        <div class="tasks-container">${tasksHtml}</div>
        ${(p.memo && p.memo.trim()) ? `<div style="padding:10px;background:#f0f8ff;border-radius:8px;margin-bottom:8px;font-size:12px" contenteditable="true" class="editable" onblur="inlineUpdate(${idx}, 'memo', this.textContent)">${p.memo}</div>` : `<div style="padding:10px;background:#fafafa;border-radius:8px;margin-bottom:8px;font-size:12px;color:#999" contenteditable="true" class="editable" onblur="inlineUpdate(${idx}, 'memo', this.textContent)">ãƒ¡ãƒ¢ã‚’å…¥åŠ›</div>`}
        <div class="card-footer">
          <div style="font-size:11px;color:#666">ä»•æ§˜ï¼š
            <span contenteditable="true" class="editable" onblur="inlineUpdate(${idx}, 'specifications', this.textContent.trim())">${p.specifications}</span>
          </div>
          <div class="card-actions">
            ${isCompleted ? `<button class="card-btn card-btn-secondary" onclick="restoreProject(${idx})">å¾©æ´»</button>` : `<button class="card-btn card-btn-secondary" onclick="completeProject(${idx})">å®Œäº†</button>`}
            ${moveEndBtn}
            <button class="card-btn card-btn-primary" onclick="editProject(${idx})">ç·¨é›†</button>
            <button class="card-btn card-btn-danger" onclick="deleteProject(${idx})">å‰Šé™¤</button>
          </div>
        </div>
      </div>`;
  }

  if(designerMode){
    var activeList = list.filter(function(p){return p.status!=='completed';});
    var completedList = list.filter(function(p){return p.status==='completed';});
    applySort(activeList,'ACTIVE'); applySort(completedList,'COMPLETED');
    activeList.forEach(function(p){ html += buildCard(p,'ACTIVE'); });
    if(completedList.length>0){
      html += `<div class="section-header">
        <div class="badge badge-green">å®Œäº†æ¸ˆã¿ ${completedList.length}</div>
        <button class="card-btn card-btn-secondary" onclick="toggleCompletedSection()" id="toggleCompletedBtn">åˆ‡æ›¿</button>
      </div>`;
      html += `<div class="completed-section" id="completedSection" style="display:none">`;
      completedList.forEach(function(p){ html += buildCard(p,'COMPLETED'); });
      html += `</div>`;
    }
  } else {
    var activeOnly = list.filter(function(p){return p.status!=='completed';});
    applySort(activeOnly,'ACTIVE');
    activeOnly.forEach(function(p){ html += buildCard(p,'ACTIVE'); });
  }
  grid.innerHTML = html;

  wireEditableLiveSavingHint();
}

/* ========= Event Handlers ========= */
function touchProject(idx){ projects[idx].updatedAt = Date.now(); scheduleAutoSave(); updateTabsIndicatorOnly(); }
function inlineUpdate(idx, key, val){
  if(!val && (key==='customer' || key==='assignedTo')) return;
  projects[idx][key] = val; touchProject(idx); updateTabs(); renderCards();
}
function updateProgress(projectIndex, taskKey, checked){
  var p = projects[projectIndex]; p.progress[taskKey].completed = checked; touchProject(projectIndex); updateTabs(); renderCards();
}
function editTaskDate(projectIndex, taskKey){
  var t = projects[projectIndex].progress[taskKey];
  var nd = prompt('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (YYYY-MM-DD):', t.date || ''); if(nd===null) return;
  projects[projectIndex].progress[taskKey].date = nd.trim(); touchProject(projectIndex); renderCards();
}

function toggleCompletedSection(){ var el = document.getElementById('completedSection'); if(!el) return; el.style.display = (el.style.display==='none' || el.style.display==='') ? 'grid' : 'none'; }

function quickEditMilestone(index, key){
  var p = projects[index]; var cur = (p.progress[key] && p.progress[key].date) ? p.progress[key].date : '';
  var nd = prompt((key==='meeting0'?'0å›ç›®æ‰“åˆã›':'é–“å–ã‚Šç¢ºå®š')+' ã®æ—¥ä»˜ (YYYY-MM-DD):', cur); if(nd===null) return;
  if(!p.progress[key]) p.progress[key] = {completed:false,date:''};
  p.progress[key].date = nd.trim(); touchProject(index); renderCards();
}

function moveToEnd(uid, type){ try{ moveBefore(uid, null, type||'ACTIVE'); renderCards(); scheduleAutoSave(); }catch(e){ console.warn(e); } }
function completeProject(index){
  if(confirm('ã“ã®æ¡ˆä»¶ã‚’å®Œäº†æ¸ˆã¿ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')){
    var p = projects[index]; p.status='completed'; touchProject(index);
    var arrC = initOrder(p.assignedTo,'COMPLETED'); if(arrC.indexOf(p.uid)<0){ arrC.push(p.uid); saveOrder(arrC, p.assignedTo, 'COMPLETED'); }
    initOrder(p.assignedTo,'ACTIVE'); initOrder('ALL','ACTIVE'); saveProjects(); updateTabs(); renderCards(); alert('æ¡ˆä»¶ã‚’å®Œäº†æ¸ˆã¿ã«ç§»å‹•ã—ã¾ã—ãŸ');
  }
}
function restoreProject(index){
  if(confirm('ã“ã®æ¡ˆä»¶ã‚’é€²è¡Œä¸­ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')){
    var p = projects[index]; p.status='active'; touchProject(index);
    var arrA = initOrder(p.assignedTo,'ACTIVE'); if(arrA.indexOf(p.uid)<0){ arrA.push(p.uid); saveOrder(arrA, p.assignedTo, 'ACTIVE'); }
    var arrAll = initOrder('ALL','ACTIVE'); if(arrAll.indexOf(p.uid)<0){ arrAll.push(p.uid); saveOrder(arrAll, 'ALL','ACTIVE'); }
    initOrder(p.assignedTo,'COMPLETED'); saveProjects(); updateTabs(); renderCards(); alert('æ¡ˆä»¶ã‚’é€²è¡Œä¸­ã«æˆ»ã—ã¾ã—ãŸ');
  }
}

/* ========= Progress Modal ========= */
function openProgressModal(index){
  progressEditingIndex = index; var p = projects[index];
  document.getElementById('progressTitle').textContent = p.customer + ' - é€²æ—ç®¡ç†';
  var html = ''; var order = Object.keys(taskNames);
  for(var oi=0; oi<order.length; oi++){
    var key = order[oi]; var t = p.progress[key] || {completed:false,date:'',state:''}; var dateText = t.date ? ' ('+formatDate(t.date)+')' : '';
    html += `
  <div class="progress-item ${t.completed?'completed':''}" style="padding:12px;border:2px solid #e9ecef;border-radius:12px;text-align:left">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <label style="display:flex;align-items:center;gap:8px;font-weight:700">
        <input type="checkbox" ${t.completed?'checked':''} onchange="updateModalProgress('${key}', this.checked)">
        ${taskNames[key]}<span style="font-weight:400">${dateText}</span>
      </label>
    </div>
    <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px">
      <input type="date" value="${t.date||''}" onchange="updateTaskDateInModal('${key}', this.value)" title="å®Œäº†æ—¥" />
    </div>
  </div>`;
  }
  document.getElementById('progressGrid').innerHTML = html; document.getElementById('progressModal').style.display='block'; document.body.classList.add('noscroll');
}
function updateModalProgress(taskKey, checked){
  if(progressEditingIndex<0) return; var p = projects[progressEditingIndex];
  p.progress[taskKey].completed = checked; touchProject(progressEditingIndex);
}
function updateTaskDateInModal(taskKey, val){
  if(progressEditingIndex<0) return; projects[progressEditingIndex].progress[taskKey].date = val; touchProject(progressEditingIndex);
}
function closeProgressModal(){ document.getElementById('progressModal').style.display='none'; document.body.classList.remove('noscroll'); if(progressEditingIndex>=0){ touchProject(progressEditingIndex); } renderCards(); }

/* ========= Project Modal ========= */
function openProjectModal(){
  editingIndex=-1; document.getElementById('modalTitle').textContent='æ–°è¦æ¡ˆä»¶è¿½åŠ ';
  document.getElementById('customerName').value=''; document.getElementById('memo').value=''; document.getElementById('newAssignee').value='';
  document.getElementById('specifications').selectedIndex=0;
  var sel = document.getElementById('assignedTo'); sel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  getDesigners().forEach(function(d){ sel.innerHTML += `<option>${d}</option>`; });
  var pm=document.getElementById('projectModal'); pm.style.display='flex'; document.body.classList.add('noscroll');
  wireModalAutosaveInputs();
}
function editProject(index){
  editingIndex=index; var p=projects[index];
  document.getElementById('modalTitle').textContent='æ¡ˆä»¶ç·¨é›†';
  document.getElementById('customerName').value=p.customer;
  document.getElementById('memo').value=p.memo||'';
  document.getElementById('specifications').value=p.specifications;
  var sel=document.getElementById('assignedTo'); sel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  getDesigners().forEach(function(d){ sel.innerHTML += `<option ${d===p.assignedTo?'selected':''}>${d}</option>`; });
  var pm=document.getElementById('projectModal'); pm.style.display='flex'; document.body.classList.add('noscroll');
  wireModalAutosaveInputs();
}
function saveProject(){
  var customer=document.getElementById('customerName').value.trim();
  var memo=document.getElementById('memo').value.trim();
  var assignedTo=document.getElementById('assignedTo').value || document.getElementById('newAssignee').value.trim();
  var specifications=document.getElementById('specifications').value;
  if(!customer || !assignedTo){ alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(assignedTo && getDesigners().indexOf(assignedTo)<0){ designers.push(assignedTo); saveDesigners(designers); updateTabs(); }
  var payload = { customer:customer, assignedTo:assignedTo, specifications:specifications, memo:memo, status: editingIndex>=0 ? projects[editingIndex].status : 'active', progress: editingIndex>=0 ? projects[editingIndex].progress : blankProgress(), updatedAt: Date.now() };
  ensureUID(payload);
  if(editingIndex>=0){ projects[editingIndex]=payload; }
  else {
    projects.push(payload);
    var arr = initOrder(payload.assignedTo,'ACTIVE'); if(arr.indexOf(payload.uid)<0){ arr.push(payload.uid); saveOrder(arr, payload.assignedTo, 'ACTIVE'); }
    var arrAll = initOrder('ALL','ACTIVE'); if(arrAll.indexOf(payload.uid)<0){ arrAll.push(payload.uid); saveOrder(arrAll, 'ALL','ACTIVE'); }
  }
  closeProjectModal(); updateTabs(); renderCards(); saveProjects(); alert('ä¿å­˜ã—ã¾ã—ãŸ');
}
function deleteProject(index){ if(confirm('ã“ã®æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ projects.splice(index,1); saveProjects(); updateTabs(); renderCards(); } }
function closeProjectModal(){ var pm=document.getElementById('projectModal'); pm.style.display='none'; document.body.classList.remove('noscroll'); }

function openDesignerModal(){ updateDesignerList(); var m=document.getElementById('designerModal'); m.style.display='flex'; document.body.classList.add('noscroll'); }
function updateDesignerList(){
  var ds=getDesigners(), html='<h3 style="margin-bottom:8px">æ—¢å­˜ã®è¨­è¨ˆå£«</h3>';
  ds.forEach(function(name){
    var count=projects.filter(function(p){return p.assignedTo===name;}).length;
    html += `<div class=\"designer-item\" style=\"display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid #e9ecef;border-radius:12px;margin-bottom:6px\">
    <span>${name} (${count}ä»¶)</span>
    <div style=\"display:flex;gap:6px\">
      <button class=\"card-btn card-btn-secondary\" onclick=\"editDesigner('${name}')\">æ”¹å</button>
      <button class=\"card-btn card-btn-danger\" onclick=\"removeDesigner('${name}')\">å‰Šé™¤</button>
    </div>
  </div>`;
  });
  document.getElementById('designerList').innerHTML=html;
}
function addDesigner(){ var name=document.getElementById('newDesignerName').value.trim(); if(!name){ alert('è¨­è¨ˆå£«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  var ds = getDesigners(); if(ds.indexOf(name)>=0){ alert('æ—¢ã«å­˜åœ¨ã™ã‚‹åå‰ã§ã™'); return; }
  designers.push(name); saveDesigners(designers); document.getElementById('newDesignerName').value=''; updateDesignerList(); updateTabs(); alert('è¨­è¨ˆå£«ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆæ¡ˆä»¶ãŒãªãã¦ã‚‚ã‚¿ãƒ–ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰');
}
function editDesigner(oldName){
  var newName=prompt('æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', oldName); if(!newName || newName===oldName) return;
  var ds = getDesigners(); if(ds.indexOf(newName)>=0){ alert('æ—¢ã«å­˜åœ¨ã™ã‚‹åå‰ã§ã™'); return; }
  designers = designers.filter(function(n){return n!==oldName;}); designers.push(newName); saveDesigners(designers);
  projects.forEach(function(p){ if(p.assignedTo===oldName) p.assignedTo=newName; });
  migrateDesignerOrderKey(oldName, newName);
  if(currentTab===oldName) currentTab=newName;
  saveProjects(); updateDesignerList(); updateTabs(); renderCards(); alert('åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
}
function removeDesigner(name){
  var have = projects.some(function(p){return p.assignedTo===name;});
  if(have){ alert('ã“ã®è¨­è¨ˆå£«ã¯æ¡ˆä»¶ã«å‰²å½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚æ¡ˆä»¶ã®æ‹…å½“ã‚’å¤‰æ›´ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚'); return; }
  designers = designers.filter(function(n){return n!==name;}); saveDesigners(designers); updateDesignerList(); updateTabs(); alert('è¨­è¨ˆå£«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}
function closeDesignerModal(){ var m=document.getElementById('designerModal'); m.style.display='none'; document.body.classList.remove('noscroll'); }

function exportJSON(){ var blob = new Blob([JSON.stringify(projects,null,2)], {type:'application/json'}); var a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='projects_backup.json'; a.click(); URL.revokeObjectURL(a.href); }
function exportCSV(){ var rows = [['é¡§å®¢','æ‹…å½“','ä»•æ§˜','çŠ¶æ…‹','é€²æ—%','æ›´æ–°æ—¥æ™‚','ãƒ¡ãƒ¢']]; projects.forEach(function(p){ rows.push([p.customer,p.assignedTo,p.specifications,p.status,calculateProgress(p),(new Date(p.updatedAt||Date.now())).toISOString(),(p.memo||'').replace(/\n/g,' ')]); }); var csv = rows.map(function(r){return r.map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}).join(',');}).join('\n'); var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); var a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='projects_export.csv'; a.click(); URL.revokeObjectURL(a.href); }
function resetData(){
  try{ lsRemove(STORAGE_KEY); lsRemove(DESIGNERS_KEY); }catch(e){}
  projects = deepClone(seedProjects); designers = loadDesigners(); updateTabs(); renderCards(); indicateSaved();
}
function importJSON(ev){
  var file = ev.target.files[0]; if(!file) return; var reader = new FileReader();
  reader.onload = function(){
    try{
      var data = JSON.parse(reader.result); if(!Array.isArray(data)) throw new Error('ä¸æ­£ãªå½¢å¼');
      projects = data; projects.forEach(ensureUID); saveProjects(); updateTabs(); renderCards(); alert('èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    }catch(e){ alert('èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); }
  };
  reader.readAsText(file,'utf-8');
}

window.addEventListener('click', function(e){
  if(e.target.classList && e.target.classList.contains('modal')){
    e.target.style.display='none';
    if(e.target.id==='progressModal' && progressEditingIndex>=0){ touchProject(progressEditingIndex); renderCards(); }
    document.body.classList.remove('noscroll');
  }
});

/* ===== è‡ªå‹•ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ ===== */
var _autosaveTimer = null, _snapshotTimer = null;
function scheduleAutoSave(){
  setSaving();
  if(_autosaveTimer) clearTimeout(_autosaveTimer);
  _autosaveTimer = setTimeout(function(){ saveProjects(); }, 1200);
}
function setSaving(){
  var el=document.getElementById('saveIndicator'); if(!el) return;
  el.classList.remove('saved'); el.classList.add('saving');
  var t=document.getElementById('saveText'); if(t) t.textContent='ä¿å­˜ä¸­â€¦';
}
function indicateSaved(){
  var el=document.getElementById('saveIndicator'); if(!el) return;
  el.classList.remove('saving'); el.classList.add('saved');
  var d=new Date(); var hh=String(d.getHours()).padStart(2,'0'); var mm=String(d.getMinutes()).padStart(2,'0'); var ss=String(d.getSeconds()).padStart(2,'0');
  var t=document.getElementById('saveText'); if(t) t.textContent='ä¿å­˜æ¸ˆã¿ ' + hh+':'+mm+':'+ss;
}
function startSnapshotTimer(){
  if(_snapshotTimer) clearInterval(_snapshotTimer);
  _snapshotTimer = setInterval(function(){
    lsSet(AUTO_SNAPSHOT_KEY, JSON.stringify({ts:Date.now(), projects:projects, designers:designers}));
  }, 30000);
}
/* ã“ã“ã‚’å®‰å…¨åŒ–ï¼šé‡è¤‡ãƒªã‚¹ãƒŠãƒ¼é˜²æ­¢ã®ãŸã‚ WeakSet ã‚’ä½¿ç”¨ */
const __wiredEditable = new WeakSet();
function wireEditableLiveSavingHint(){
  document.querySelectorAll('.editable').forEach(function(el){
    if(__wiredEditable.has(el)) return;
    el.addEventListener('input', setSaving, {passive:true});
    __wiredEditable.add(el);
  });
}
function wireModalAutosaveInputs(){
  ['customerName','memo','newAssignee'].forEach(function(id){
    var el=document.getElementById(id); if(el){ el.addEventListener('input', setSaving, {passive:true}); }
  });
  ['assignedTo','specifications'].forEach(function(id){
    var el=document.getElementById(id); if(el){ el.addEventListener('change', setSaving); }
  });
}
window.addEventListener('beforeunload', function(){
  try{
    document.querySelectorAll('.editable').forEach(function(el){ el.blur(); });
    if(_autosaveTimer) clearTimeout(_autosaveTimer);
    saveProjects();
  }catch(e){}
});
(function tryRecover(){
  try{
    var raw=lsGet(STORAGE_KEY);
    if(!raw || raw==='null'){
      var snap = lsGet(AUTO_SNAPSHOT_KEY);
      if(snap){
        var obj=JSON.parse(snap);
        if(obj && Array.isArray(obj.projects)){
          projects = obj.projects; designers = obj.designers || designers;
          projects.forEach(ensureUID); saveProjects();
        }
      }
    }
  }catch(e){}
})();

/* â˜… åˆæœŸã‚¨ãƒ©ãƒ¼é˜²æ­¢é–¢æ•°ï¼ˆå¿…é ˆï¼‰ */
function updateTabsIndicatorOnly(){ try{ setSaving(); }catch(e){} }

/* ===== Boot ===== */
window.addEventListener('DOMContentLoaded', function(){
  try{ updateTabs(); renderCards(); startSnapshotTimer(); indicateSaved(); }
  catch(e){
    console.error(e);
    var hdr=document.querySelector('.header');
    if(hdr){ var d=document.createElement('div'); d.style.cssText='background:#ffecec;color:#b00020;padding:8px 12px;border-radius:8px;margin-top:8px'; d.textContent='åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+e; hdr.appendChild(d);}
  }
});
window.onerror = function(msg, src, line, col){
  var hdr=document.querySelector('.header'); if(hdr){
    var d=document.createElement('div'); d.style.cssText='background:#ffecec;color:#b00020;padding:8px 12px;border-radius:8px;margin-top:8px';
    d.textContent='ã‚¨ãƒ©ãƒ¼: '+msg+' @'+line+':'+col; hdr.appendChild(d);
  }
};
</script>
</body>
</html>
