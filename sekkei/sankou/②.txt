<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™ºæ³¨ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            background: #e0e0e0;
            border: none;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #d0d0d0;
        }
        
        .tab.active {
            background: white;
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input[type="text"], input[type="date"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus, input[type="date"]:focus, textarea:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .email-output {
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            font-family: 'MS Gothic', monospace;
            white-space: pre-wrap;
            line-height: 1.8;
            min-height: 400px;
            font-size: 14px;
        }
        
        .copy-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .copy-button:hover {
            background: #2980b9;
        }
        
        .placeholder {
            color: #7f8c8d;
            font-style: italic;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .template-select {
            background: #3498db;
            color: white;
            font-weight: bold;
            font-size: 16px;
            padding: 12px;
        }
        
        .special-notes {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #856404;
        }

        .master-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .master-section h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .template-list {
            display: grid;
            gap: 15px;
        }
        
        .template-card {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        
        .template-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .template-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background: #3498db;
            color: white;
        }
        
        .btn-edit:hover {
            background: #2980b9;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c0392b;
        }
        
        .btn-add {
            background: #27ae60;
            color: white;
        }
        
        .btn-add:hover {
            background: #229954;
        }
        
        .btn-save {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            font-size: 16px;
        }
        
        .btn-save:hover {
            background: #2980b9;
        }
        
        .btn-cancel {
            background: #95a5a6;
            color: white;
            padding: 12px 25px;
            font-size: 16px;
        }
        
        .btn-cancel:hover {
            background: #7f8c8d;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            color: #000;
        }
        
        .sub-option-item {
            background: #e8f4f8;
            border: 1px solid #3498db;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .sub-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .info-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-box h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        
        textarea.template-textarea {
            min-height: 150px;
            font-family: 'MS Gothic', monospace;
        }
        
        .field-group {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .variable-tag {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            margin: 2px;
            font-size: 12px;
            font-family: monospace;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    
/* === Hide specialContent field (non-destructive) === */
#specialContent { display: none !important; }
label[for="specialContent"] { display: none !important; }

</style>
</head>
<body>
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('email')">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ä½œæˆ</button>
        <button class="tab" onclick="switchTab('master')">âš™ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</button>
    </div>
    
    <!-- ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¿ãƒ– -->
    <div id="emailTab" class="tab-content active">
        <div class="container">
            <h1>ğŸ“§ ç™ºæ³¨ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h1>
            
            <div class="form-section">
                <div class="form-group">
                    <label for="templateType">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ:</label>
                    <select id="templateType" class="template-select">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                
                <h3>ğŸ“ åŸºæœ¬æƒ…å ±å…¥åŠ›</h3>
                <div class="two-column">
                    <div class="form-group">
                        <label for="customerName">ãŠå®¢æ§˜å:</label>
                        <input type="text" id="customerName" placeholder="ä¾‹ï¼šå¤§æ±å¸‚æ·±é‡ã€€é“è„‡å½°ä¸€">
                        <div class="special-notes">
                            â€»ã€Œæ§˜é‚¸æ–°ç¯‰å·¥äº‹ã€ã¯è‡ªå‹•ã§è¿½åŠ ã•ã‚Œã¾ã™
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="staffName">æ‹…å½“è€…å:</label>
                        <input type="text" id="staffName" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" oninput="updateTemplate()">
                        <div class="special-notes">â€» ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ãƒ»ä»¶åã® {staffName} / ã€ã”æ‹…å½“è€…åã€‘ ã«å·®ã—è¾¼ã¾ã‚Œã¾ã™</div>
                    </div>
                    <div class="form-group">
                        <label for="dueDate">æœŸæ—¥:</label>
                        <input type="date" id="dueDate">
                        <div id="datePreview" class="special-notes"></div>
                    </div>
                </div>
                
                <div id="specificFields"></div>
            </div>
            
            <div>
                <h2>ğŸ“§ ä»¶å</h2>
                <div id="subjectOutput" class="email-output" style="min-height: 60px; background: #e8f4f8; border-color: #17a2b8;"></div>
                <button class="copy-button" onclick="copySubject()" style="background: #17a2b8;">ğŸ“§ ä»¶åã‚’ã‚³ãƒ”ãƒ¼</button>
                
                <h2>ğŸ“® ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</h2>
                <div id="emailAddressOutput" class="email-output" style="min-height: 60px; background: #f8e8f8; border-color: #e91e63;"></div>
                <button class="copy-button" onclick="copyEmailAddress()" style="background: #e91e63;">ğŸ“® ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼</button>
                
                <h2>ğŸ“¨ ç”Ÿæˆã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«</h2>
                <div id="emailOutput" class="email-output">
                    <span class="placeholder">ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ ã«æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è‡ªå‹•ã§ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</span>
                </div>
                <button class="copy-button" onclick="copyToClipboard()">ğŸ“‹ ãƒ¡ãƒ¼ãƒ«å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ã‚¿ãƒ– -->
    <div id="masterTab" class="tab-content">
        <div class="container">
            <h1>âš™ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ãƒã‚¹ã‚¿ãƒ¼</h1>
            
            <div class="master-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>ğŸ“‹ ç™»éŒ²æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§</h3>
                    <button class="btn-small btn-add" onclick="openNewTemplateModal()">â• æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </button>
                </div>
                <div id="templateList" class="template-list"></div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <div class="info-box">
                <h4>ğŸ’¡ ä½¿ç”¨ã§ãã‚‹å¤‰æ•°</h4>
                <p>ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã§ä»¥ä¸‹ã®å¤‰æ•°ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š</p>
                <span class="variable-tag">{customerName}</span>
                <span class="variable-tag">{dueDate}</span>
                <span class="variable-tag">{specialContent}</span>
                <span class="variable-tag">{staffName}</span>
                <p style="margin-top: 10px; font-size: 14px;">â€» å¤‰æ•°ã¯ {} ã§å›²ã‚“ã§ä½¿ç”¨ã—ã¦ãã ã•ã„</p>
            </div>
            
            <form id="templateForm" onsubmit="saveTemplate(event)">
                <div class="field-group">
                    <h4>ğŸ“ åŸºæœ¬æƒ…å ±</h4>
                    <div class="form-group">
                        <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDï¼ˆè‹±æ•°å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³å¯ï¼‰*</label>
                        <input type="text" id="editTemplateId" required pattern="[a-zA-Z0-9\-_]+" placeholder="ä¾‹: new-company">
                    </div>
                    
                    <div class="form-group">
                        <label>è¡¨ç¤ºåï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã§è¡¨ç¤ºã•ã‚Œã‚‹åå‰ï¼‰*</label>
                        <input type="text" id="editDisplayName" required placeholder="ä¾‹: æ–°ä¼šç¤¾åï¼ˆä½œæ¥­å†…å®¹ï¼‰">
                    </div>
                    
                    <div class="form-group">
                        <label>ä¼šç¤¾å *</label>
                        <input type="text" id="editCompany" required placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã€‡ã€‡">
                    </div>
                    
                    <div class="form-group">
                        <label>å®›å…ˆåï¼ˆæ”¹è¡Œã§è¤‡æ•°å¯ï¼‰*</label>
                        <textarea id="editContact" rows="3" required placeholder="ä¾‹: ç”°ä¸­æ§˜&#10;ä½è—¤æ§˜"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆè¤‡æ•°ã®å ´åˆã¯ã‚»ãƒŸã‚³ãƒ­ãƒ³ã§åŒºåˆ‡ã‚‹ï¼‰*</label>
                        <input type="text" id="editEmail" required placeholder="ä¾‹: tanaka@example.com; sato@example.com">
                    </div>
                    <div class="form-group">
                        <label>ã‚«ãƒ†ã‚´ãƒª *</label>
                        <select id="editCategory" required>
                            <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
                            <option value="IC">IC</option>
                        </select>
                        <div class="special-notes">â€» è¨­è¨ˆ / IC ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€ä¸€è¦§ã¨é¸æŠãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚°ãƒ«ãƒ¼ãƒ—ãŒå¤‰ã‚ã‚Šã¾ã™</div>
                    </div>
                </div>
                
                <div class="field-group">
                    <h4>ğŸ“§ ä»¶åè¨­å®š</h4>
                    <div class="form-group">
                        <label>ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ *</label>
                        <input type="text" id="editSubjectFormat" required placeholder="ä¾‹: {customerName}æ§˜ æ–°è¦ã€‡ã€‡ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}">
                        <div class="special-notes">
                            ä»¶åã§ã¯ {customerName} ã¨ {dueDate} ãŒä½¿ç”¨ã§ãã¾ã™
                        </div>
                    </div>
                </div>
                
                <div class="field-group">
                    <h4>âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h4>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ *</label>
                        <textarea id="editTemplate" class="template-textarea" required placeholder="ä¾‹:&#10;{company}&#10;{contact}&#10;&#10;ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚&#10;ã€ãŠå®¢æ§˜åã€‘ã€€{customerName}&#10;ã€ã€€å†…å®¹ã€€ã€‘ã€€{specialContent}&#10;ã€ã€€æœŸæ—¥ã€€ã€‘ã€€{dueDate}"></textarea>
                    </div>
                </div>
                
                <div class="field-group">
                    <h4>âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š</h4>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editHasSpecialContent" onchange="toggleSpecialContent()">
                            ç‰¹åˆ¥ãªå…¥åŠ›é …ç›®ã‚’è¿½åŠ ï¼ˆå†…å®¹è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
                        </label>
                        <div class="special-notes">
                            ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€Œå†…å®¹è©³ç´°ã€å…¥åŠ›æ¬„ãŒè¿½åŠ ã•ã‚Œã€{specialContent}å¤‰æ•°ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editHasSubOptions" onchange="toggleSubOptions()">
                            è¤‡æ•°ã®å®›å…ˆã‚’ç®¡ç†ï¼ˆã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰
                        </label>
                        <div class="special-notes">
                            ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨æ¥­è€…é¸æŠã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¿½åŠ ã•ã‚Œã¾ã™
                        </div>
                    </div>
                </div>
                
                <div id="subOptionsSection" style="display: none;">
                    <div class="field-group">
                        <h4>ğŸ‘¥ ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå®›å…ˆãƒªã‚¹ãƒˆï¼‰</h4>
                        <div id="subOptionsList"></div>
                        <button type="button" class="btn-small btn-add" onclick="addSubOption()">â• å®›å…ˆã‚’è¿½åŠ </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn-small btn-save">ğŸ’¾ ä¿å­˜</button>
                    <button type="button" class="btn-small btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <script>



        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let customTemplates = {};
        let deletedTemplates = [];
        let currentEditingId = null;
        let subOptionCounter = 0;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        const defaultTemplates = {
            panasonic: {
                displayName: "ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ãƒªãƒ“ãƒ³ã‚°è¿‘ç•¿ï¼ˆæ›æ°—å›³é¢ï¼‰",
                company: "ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ãƒªãƒ“ãƒ³ã‚°è¿‘ç•¿æ ªå¼ä¼šç¤¾",
                contact: "åŒ—æµ¦ã•ã¾",
                email: "kitaura.seiga@jp.panasonic.com",
                subjectFormat: "{customerName}æ§˜ æ–°è¦æ›æ°—å›³é¢ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}",
                templateText: `{company}
{contact}

ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ–°è¦æ›æ°—å›³é¢ä½œæˆãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
è©³ç´°ä¸‹è¨˜å‚ç…§ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

ã€ãŠå®¢æ§˜åã€‘ã€€{customerName}
ã€ã€€å†…å®¹ã€€ã€‘ã€€æ–°è¦æ›æ°—å›³é¢ä½œæˆä¾é ¼
ã€ã€€æœŸæ—¥ã€€ã€‘ã€€{dueDate}`,
                hasSpecialContent: false,
                hasSubOptions: false
            },
            
            plumbing: {
                displayName: "çµ¦æ’æ°´è¨­å‚™æ¥­è€…ï¼ˆçµ¦æ’æ°´è¨­å‚™å›³é¢ï¼‰",
                company: "çµ¦æ’æ°´è¨­å‚™æ¥­è€…",
                hasSubOptions: true,
                subjectFormat: "{customerName}æ§˜é‚¸ã€€æ–°è¦çµ¦æ’æ°´è¨­å‚™çµŒè·¯å›³ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}ä¸­",
                templateText: `{company}ã€€
{contact}

ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ–°è¦çµ¦æ’æ°´è¨­å‚™çµŒè·¯å›³ä½œæˆã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
è©³ç´°ä¸‹è¨˜å‚ç…§ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

ã€ãŠå®¢æ§˜åã€‘ã€€{customerName}
ã€ã€€å†…å®¹ã€€ã€‘ã€€æ–°è¦çµ¦æ’æ°´è¨­å‚™çµŒè·¯å›³ä½œæˆä¾é ¼
ã€ã€€æœŸæ—¥ã€€ã€‘ã€€{dueDate}
ä½œæˆã®éš›ã«**å‡¡ä¾‹ã®è¨˜è¼‰**ã‚‚åˆã‚ã›ã¦ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`,
                hasSpecialContent: false,
                subOptions: {
                    "spacebuild": {
                        company: "æ ªå¼ä¼šç¤¾ã‚¹ãƒšãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰",
                        contact: "å†¨é˜ªã•ã¾",
                        tel: "090 1144 9504",
                        email: "spacetomisaka@carol.ocn.ne.jp"
                    },
                    "daigo": {
                        company: "æ ªå¼ä¼šç¤¾ã€€å¤§äº”",
                        contact: "æ‘ç”°ã•ã¾", 
                        tel: "090 1223 6957",
                        email: "murata-n@daigo-inc.co.jp"
                    },
                    "kokoro": {
                        company: "æ ªå¼ä¼šç¤¾ã“ã“ã‚å»ºç¯‰å·¥æˆ¿",
                        contact: "å‰å²¡ã•ã¾",
                        tel: "090-6207-6659", 
                        email: "h.yoshioka_839@nz-gp.com"
                    },
                    "rivu": {
                        company: "æ ªå¼ä¼šç¤¾ãƒªãƒ´åŒ å»ºè¨­",
                        contact: "åˆ¥å½¹ã•ã¾",
                        tel: "080-3845-1839",
                        email: "becchaku@takumi-kyoto.co.jp"
                    },
                    "daikou": {
                        company: "å¤§å…‰å»ºè¨­æ ªå¼ä¼šç¤¾",
                        contact: "å—å²¡ã•ã¾",
                        tel: "090-1597-3656", 
                        email: "nobuyuki@daikou-co.jp"
                    },
                    "senmon": {
                        company: "æ ªå¼ä¼šç¤¾ã€€å°‚é–€è¨­å‚™",
                        contact: "æ‘ç”°ã•ã¾",
                        tel: "090-5667-7750",
                        email: "senmonsetubi6260@hera.eonet.ne.jp"
                    },
                    "hirata": {
                        company: "æ ªå¼ä¼šç¤¾ã€€å¹³ç”°è¨­å‚™å·¥ç”£", 
                        contact: "æ—ã•ã¾",
                        tel: "090-2196-2687",
                        email: "h.hayashi@eco.ocn.ne.jp"
                    },
                    "shinsei": {
                        company: "æ ªå¼ä¼šç¤¾ã€€ã‚·ãƒ³ã‚»ã‚¤è¨­å‚™",
                        contact: "çŸ³å·ã•ã¾",
                        tel: "080-3031-3876",
                        email: "ishikawa@shinseisetubi.jp"
                    },
                    "iwao": {
                        company: "ã‚¤ãƒ¯ã‚ªç”£æ¥­ã€€æ ªå¼ä¼šç¤¾",
                        contact: "å¤§ä¸Šã•ã¾", 
                        tel: "080-2531-4718",
                        email: "iwaosan@vesta.ocn.ne.jp"
                    },
                    "katagi": {
                        company: "æ ªå¼ä¼šç¤¾æ¨«å„€è¨­å‚™",
                        contact: "æ³‰æœ¬ã•ã¾",
                        tel: "080-1479-5838",
                        email: "katagisetsubi@gmail.com"
                    }
                }
            },
            
            ogura: {
                defaultSpecialContent: "ã‚µãƒƒã‚·ãƒ—ãƒ¬ã‚¼ãƒ³ã€é–‹å£éƒ¨ãƒªã‚¹ãƒˆã€ç„é–¢ãƒ—ãƒ¬ã‚¼ãƒ³(C10ã€€ã‚«ãƒ¼ãƒ ãƒ–ãƒ©ãƒƒã‚¯)",
                category: "è¨­è¨ˆ",
                displayName: "å°å€‰ã‚µãƒ³ãƒ€ã‚¤ãƒ³ï¼ˆã‚µãƒƒã‚·ãƒ—ãƒ¬ã‚¼ãƒ³ï¼‰",
                company: "å°å€‰ã‚µãƒ³ãƒ€ã‚¤ãƒ³æ ªå¼ä¼šç¤¾",
                contact: "äº•ä¸Šã•ã¾\né‡é–“ã•ã¾\né‡‘ã‚±æ±Ÿã•ã¾",
                email: "s_inoue@ogura-sundine.com; s.noma@ogura-sundine.com; ju-taku9@ogura-sundine.com",
                hasSpecialContent: true,
                subjectFormat: "{customerName}æ§˜é‚¸ã€€æ–°è¦ã‚µãƒƒã‚·ãƒ—ãƒ¬ã‚¼ãƒ³ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}",
                templateText: `{company}
{contact}

ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ–°è¦ã‚µãƒƒã‚·ãƒ—ãƒ¬ã‚¼ãƒ³é–¢ä¿‚ä½œæˆãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
è©³ç´°ä¸‹è¨˜å‚ç…§ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
æ³•22æ¡åœ°åŸŸã«ãªã‚Šã¾ã™ã€‚

ã€ãŠå®¢æ§˜åã€‘ã€€{customerName}
ã€ã€€å†…å®¹ã€€ã€‘ã€€{specialContent}
ã€ã€€æœŸæ—¥ã€€ã€‘ã€€{dueDate}`,
                hasSubOptions: false
            },
            
            senpaku: {
                displayName: "åƒåšç”£æ¥­ï¼ˆevoltzé…ç½®å›³ï¼‰",
                company: "åƒåšç”£æ¥­æ ªå¼ä¼šç¤¾",
                contact: "ã”æ‹…å½“è€…æ§˜",
                email: "evoltz@chihiro.co.jp",
                subjectFormat: "{customerName}æ§˜ æ–°è¦evoltzé…ç½®å›³ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}",
                templateText: `{company}
{contact}

ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ–°è¦evoltzé…ç½®å›³ä½œæˆãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
è©³ç´°ä¸‹è¨˜å‚ç…§ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

ã€ãŠå®¢æ§˜åã€‘ã€€{customerName}
ã€ã€€å†…å®¹ã€€ã€‘ã€€æ–°è¦evoltzé…ç½®å›³ä½œæˆä¾é ¼
ã€ã€€æœŸæ—¥ã€€ã€‘ã€€{dueDate}ä¸­`,
                hasSpecialContent: false,
                hasSubOptions: false
            }
    ,
    ic_panasonic_tategu: {
        displayName: "å»ºå…·ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ»è¦‹ç©ï¼ˆPanasonic è¿‘ç•¿ï¼‰",
        category: "IC",
        company: "ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ãƒªãƒ“ãƒ³ã‚°è¿‘ç•¿æ ªå¼ä¼šç¤¾",
        contact: "å ¤ æ§˜\nï¼ˆCCï¼‰åŒ—æµ¦ æ˜Ÿæ²³ æ§˜",
        email: "tsutsumi.yoshiaki@jp.panasonic.com; kitaura.seiga@jp.panasonic.com",
        hasSpecialContent: true,
        subjectFormat: "{customerName}æ§˜é‚¸ã€€å»ºå…·ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ»è¦‹ç©ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}",
        templateText: `{company}
{contact}

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ ªå¼ä¼šç¤¾Gãƒã‚¦ã‚¹ã€€è¨­è¨ˆéƒ¨ICã®ã€ã”æ‹…å½“è€…åã€‘ã¨ç”³ã—ã¾ã™ã€‚

ã€æ–°è¦ä¾é ¼ã€‘{customerName}
ã€ç´æœŸå¸Œæœ›ã€‘{dueDate}

å»ºå…·ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ»è¦‹ç©ã®ä½œæˆã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

{specialContent}`,
        hasSubOptions: false
    },

    ic_lighting: {
        displayName: "ç…§æ˜ãƒ—ãƒ©ãƒ³ï¼ˆã¾ã¨ã‚ï¼šODELIC/DAIKO/KOIZUMI/Panasonicï¼‰",
        category: "IC",
        company: "ç…§æ˜ãƒ¡ãƒ¼ã‚«ãƒ¼å„ç¤¾",
        hasSpecialContent: true,
        subjectFormat: "{customerName}æ§˜é‚¸ã€€ç…§æ˜ãƒ—ãƒ©ãƒ³ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}",
        templateText: `{company}
{contact}

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ ªå¼ä¼šç¤¾Gãƒã‚¦ã‚¹ã€€è¨­è¨ˆéƒ¨ICã®ã€ã”æ‹…å½“è€…åã€‘ã¨ç”³ã—ã¾ã™ã€‚

ã€æ–°è¦ç‰©ä»¶ã€‘{customerName}
ã€å¸Œæœ›ç´æœŸã€‘{dueDate}

ä¸‹è¨˜ãŠå®¢æ§˜ã‹ã‚‰ã®ã”è¦æœ›ã«ãªã‚Šã¾ã™ã€‚
{specialContent}

ãŠå¿™ã—ã„ã¨ã“ã‚æã‚Œå…¥ã‚Šã¾ã™ãŒã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`,
        hasSubOptions: true,
        subOptions: {
            odelic: {
                company: "ã‚ªãƒ¼ãƒ‡ãƒªãƒƒã‚¯æ ªå¼ä¼šç¤¾",
                contact: "ä¼Šè—¤ ç¾ç”±ç´€ æ§˜",
                tel: "080-1006-1562",
                email: "myito@odelic.co.jp"
            },
            daiko: {
                company: "å¤§å…‰é›»æ©Ÿæ ªå¼ä¼šç¤¾",
                contact: "çŸ³äº• å¤§è¼ æ§˜",
                tel: "090-4301-6438",
                email: "daiki_ishii@lighting-daiko.co.jp"
            },
            koizumi: {
                company: "ã‚³ã‚¤ã‚ºãƒŸç…§æ˜æ ªå¼ä¼šç¤¾",
                contact: "å‰å²¡ ã¾ã²ã‚ æ§˜",
                tel: "080-2437-2623",
                email: "ma-yoshioka@koizumi.co.jp"
            },
            panasonic: {
                company: "ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ï¼ˆã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ã‚¹ç¤¾ï¼‰",
                contact: "ä¸­ çŸ¥ç¾ æ§˜",
                tel: "090-3280-7300",
                email: "naka.tomomi@jp.panasonic.com"
            }
        }
    },

    ic_ncraft_iron: {
        displayName: "ã‚¢ã‚¤ã‚¢ãƒ³éšæ®µãƒ»æ‰‹æ‘ºï¼ˆNãã‚‰ãµã¨ï¼‰",
        category: "IC",
        company: "æ ªå¼ä¼šç¤¾Nãã‚‰ãµã¨",
        contact: "ä¸­æ‘ æ§˜",
        email: "info@n-craft.net",
        hasSpecialContent: true,
        subjectFormat: "{customerName}æ§˜é‚¸ã€€ã‚¢ã‚¤ã‚¢ãƒ³éšæ®µï¼æ‰‹æ‘ºã€€è¦‹ç©ãƒ»å›³é¢ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}",
        templateText: `{company}
{contact}

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ ªå¼ä¼šç¤¾Gãƒã‚¦ã‚¹ã€€è¨­è¨ˆéƒ¨ICã®ã€ã”æ‹…å½“è€…åã€‘ã¨ç”³ã—ã¾ã™ã€‚

ã€æ–°è¦ç‰©ä»¶ã€‘{customerName}
ã€ç´æœŸå¸Œæœ›ã€‘{dueDate}

è¦‹ç©ãƒ»å›³é¢ã®ä½œæˆã‚’ãŠé¡˜ã„è‡´ã—ã¾ã™ã€‚
ã‚ã‚ã›ã¦JWãƒ‡ãƒ¼ã‚¿ã‚‚ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

ã€éšé«˜ã€‘2980ãœ
ã€éšæ®µã€‘15æ®µ ã²ãªå£‡éšæ®µ
ã€å…±é€šã€‘ä¸­æ¡Ÿ1æœ¬ï¼ˆãƒ–ãƒ©ãƒƒã‚¯ï¼‰
ï¼ˆ1ï¼‰éšæ®µæ‰‹æ‘ºï¼ˆ3æ®µç›®ã€œ8æ®µç›®ï¼‰
ï¼ˆ2ï¼‰å¹ãæŠœã‘éƒ¨ æ‰‹æ‘º

{specialContent}

ãŠå¿™ã—ã„ã¨ã“ã‚æã‚Œå…¥ã‚Šã¾ã™ãŒã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`,
        hasSubOptions: false
    },

    ic_equipment_pb: {
        displayName: "è¨­å‚™PBãƒ»è¦‹ç©ï¼ˆã¾ã¨ã‚ï¼šPanasonic/ã‚¿ã‚«ãƒ©ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰/TOTO/LIXILï¼‰",
        category: "IC",
        company: "è¨­å‚™ãƒ¡ãƒ¼ã‚«ãƒ¼å„ç¤¾",
        hasSpecialContent: true,
        subjectFormat: "{customerName}æ§˜é‚¸ã€€è¨­å‚™PBè¦‹ç©ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}",
        templateText: `{company}
{contact}

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ ªå¼ä¼šç¤¾Gãƒã‚¦ã‚¹ã€€è¨­è¨ˆéƒ¨ICã®ã€ã”æ‹…å½“è€…åã€‘ã¨ç”³ã—ã¾ã™ã€‚

ã€ç‰©ä»¶åã€‘{customerName}
ã€å¸Œæœ›ç´æœŸã€‘{dueDate}

è¨­å‚™PBã€ãŠè¦‹ç©ã‚Šã®ä½œæˆã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
æ·»ä»˜è³‡æ–™ã®ã”ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

{specialContent}

ãŠå¿™ã—ã„ã¨ã“ã‚æã‚Œå…¥ã‚Šã¾ã™ãŒã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`,
        hasSubOptions: true,
        subOptions: {
            panasonic: {
                company: "ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ãƒªãƒ“ãƒ³ã‚°è¿‘ç•¿æ ªå¼ä¼šç¤¾",
                contact: "ç€¬å°¾ æ§˜",
                tel: "070-782-4226",
                email: "seo.ayumi@jp.panasonic.com"
            },
            takaden: {
                company: "ã‚¿ã‚«ãƒ©ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ï¼ˆæ ªå¼ä¼šç¤¾ãŸã‘ã§ã‚“ï¼‰",
                contact: "å¤§è¥¿ å¤§ æ§˜",
                tel: "080-2468-1924",
                email: "ohnishi@takeden.co.jp"
            },
            daiman: {
                company: "æ ªå¼ä¼šç¤¾å¤§è¬ï¼ˆTOTOï¼‰",
                contact: "ä¸­é‡ ç¥ä¸€æœ— æ§˜",
                tel: "080-3842-4687",
                email: "y.nakano@kk-daiman.co.jp"
            },
            lixil: {
                company: "æ ªå¼ä¼šç¤¾ã‚¯ãƒ¯ã‚¿ï¼ˆLIXILï¼‰",
                contact: "ä¸­é‡ é¼ æ§˜",
                tel: "070-6947-1233",
                email: "ryo.nakano@lixil.com"
            }
        }
    }

        };
// /* ogura defaultSpecialContent override (safety) */
try { if (defaultTemplates.ogura) defaultTemplates.ogura.defaultSpecialContent = "ã‚µãƒƒã‚·ãƒ—ãƒ¬ã‚¼ãƒ³ã€é–‹å£éƒ¨ãƒªã‚¹ãƒˆã€ç„é–¢ãƒ—ãƒ¬ã‚¼ãƒ³(C10ã€€ã‚«ãƒ¼ãƒ ãƒ–ãƒ©ãƒƒã‚¯)"; } catch(e){}
// /* ogura category override */ 
try { if (defaultTemplates.ogura) defaultTemplates.ogura.category = "è¨­è¨ˆ"; } catch(e){}
// === Injected categories for grouping ===
try {
    if (defaultTemplates.panasonic) defaultTemplates.panasonic.category = defaultTemplates.panasonic.category || "è¨­è¨ˆ";
    if (defaultTemplates.plumbing)  defaultTemplates.plumbing.category  = defaultTemplates.plumbing.category  || "è¨­è¨ˆ";
    if (defaultTemplates.senpaku)   defaultTemplates.senpaku.category   = defaultTemplates.senpaku.category   || "è¨­è¨ˆ";
    if (defaultTemplates.ogura)     defaultTemplates.ogura.category     = "è¨­è¨ˆ";
    // è¿½åŠ ICãƒ†ãƒ³ãƒ—ãƒ¬ç¾¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
    if (defaultTemplates.ic_panasonic_tategu) defaultTemplates.ic_panasonic_tategu.category = defaultTemplates.ic_panasonic_tategu.category || "IC";
    if (defaultTemplates.ic_lighting)         defaultTemplates.ic_lighting.category         = defaultTemplates.ic_lighting.category         || "IC";
    if (defaultTemplates.ic_ncraft_iron)      defaultTemplates.ic_ncraft_iron.category      = defaultTemplates.ic_ncraft_iron.category      || "IC";
    if (defaultTemplates.ic_equipment_pb)     defaultTemplates.ic_equipment_pb.category     = defaultTemplates.ic_equipment_pb.category     || "IC";
} catch(e){ console.warn("category inject failed", e); }

        
        // åˆæœŸåŒ–
        async function init() {
            await loadTemplates();
            updateTemplateSelector();
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸæ—¥è¨­å®š
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            document.getElementById('dueDate').value = nextWeek.toISOString().split('T')[0];
            
            updateTemplate();
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        async function loadTemplates() {
    try {
        const result = localStorage.getItem('custom_templates');
        if (result) {
            customTemplates = JSON.parse(result);
        } else {
            customTemplates = {};
        }
    } catch (error) {
        customTemplates = {};
    }
    try {
        const deletedResult = localStorage.getItem('deleted_templates');
        if (deletedResult) {
            deletedTemplates = JSON.parse(deletedResult);
        } else {
            deletedTemplates = [];
        }
    } catch (error) {
        deletedTemplates = [];
    }
}
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
        async function saveTemplates() {
            try {
                localStorage.setItem('custom_templates', JSON.stringify(customTemplates));
                localStorage.setItem('deleted_templates', JSON.stringify(deletedTemplates));
                return true;
            } catch (error) {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                return false;
            }
        }
        
        // å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—
        function getAllTemplates() {
            const all = {};
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ï¼‰
            for (const [key, value] of Object.entries(defaultTemplates)) {
                if (!deletedTemplates.includes(key)) {
                    all[key] = value;
                }
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            for (const [key, value] of Object.entries(customTemplates)) {
                all[key] = value;
            }
            
            return all;
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'email') {
                document.getElementById('emailTab').classList.add('active');
            } else if (tabName === 'master') {
                document.getElementById('masterTab').classList.add('active');
                renderTemplateList();
            }
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤º
        function renderTemplateList() {
            const container = document.getElementById('templateList');
            const templates = getAllTemplates();
            
            if (Object.keys(templates).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }
            
            let html = '';
            for (const [key, template] of Object.entries(templates)) {
                const isDefault = defaultTemplates.hasOwnProperty(key);
                const badgeColor = isDefault ? '#3498db' : '#27ae60';
                const badgeText = isDefault ? 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ' : 'ã‚«ã‚¹ã‚¿ãƒ ';
                
                html += `
                    <div class="template-card">
                        <div>
                            <h4>
                                ${template.displayName || template.company}
                                <span style="background: ${badgeColor}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; margin-left: 10px;">${badgeText}</span>
                            </h4>
                            <p style="margin: 5px 0; color: #666;">ä¼šç¤¾å: ${template.company}</p>
                            <p style="margin: 5px 0; color: #666;">å®›å…ˆ: ${template.contact || 'ã”æ‹…å½“è€…æ§˜'}</p>
                            <p style="margin: 5px 0; color: #666;">Email: ${template.email || 'ãªã—'}</p>
                            ${template.hasSubOptions ? '<p style="margin: 5px 0; color: #e67e22; font-weight: bold;">ğŸ“Œ ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚ã‚Š</p>' : ''}
                        </div>
                        <div class="template-card-actions">
                            <button class="btn-small btn-edit" onclick="editTemplateModal('${key}')">âœï¸ ç·¨é›†</button>
                            <button class="btn-small btn-delete" onclick="deleteTemplateConfirm('${key}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // å‰Šé™¤ç¢ºèª
        function deleteTemplateConfirm(templateId) {
            const allTemplates = { ...defaultTemplates, ...customTemplates };
            const template = allTemplates[templateId];
            
            if (!template) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const templateName = template.displayName || template.company;
            
            if (confirm(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${templateName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                const isDefault = defaultTemplates.hasOwnProperty(templateId);
                
                if (isDefault) {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯å‰Šé™¤ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    if (!deletedTemplates.includes(templateId)) {
                        deletedTemplates.push(templateId);
                    }
                } else {
                    // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯å®Œå…¨å‰Šé™¤
                    delete customTemplates[templateId];
                }
                
                // localStorageã«å³åº§ã«ä¿å­˜
                try {
                    localStorage.setItem('custom_templates', JSON.stringify(customTemplates));
                    localStorage.setItem('deleted_templates', JSON.stringify(deletedTemplates));
                    
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                    
                    // ç”»é¢ã‚’æ›´æ–°
                    renderTemplateList();
                    updateTemplateSelector();
                } catch (error) {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        }
        
        // æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
        function openNewTemplateModal() {
            currentEditingId = null;
            document.getElementById('modalTitle').textContent = 'æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ';
            document.getElementById('templateForm').reset();
            document.getElementById('editTemplateId').disabled = false;
            document.getElementById('subOptionsSection').style.display = 'none';
            document.getElementById('subOptionsList').innerHTML = '';
            
            var catSel = document.getElementById('editCategory'); if (catSel) catSel.value = 'è¨­è¨ˆ';
document.getElementById('templateModal').style.display = 'block';
        }
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        function editTemplateModal(templateId) {
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å–å¾—
            const template = customTemplates[templateId] || defaultTemplates[templateId];
            if (!template) return;
            
            const isDefault = defaultTemplates.hasOwnProperty(templateId) && !customTemplates.hasOwnProperty(templateId);
            
            currentEditingId = isDefault ? null : templateId;
            document.getElementById('modalTitle').textContent = isDefault ? 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã¨ã—ã¦ä¿å­˜ï¼‰' : 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†';
            
            document.getElementById('editTemplateId').value = templateId;
            document.getElementById('editTemplateId').disabled = isDefault ? false : true;
            document.getElementById('editDisplayName').value = template.displayName || '';
            document.getElementById('editCompany').value = template.company || '';
            document.getElementById('editContact').value = template.contact || '';
            document.getElementById('editEmail').value = template.email || '';
            document.getElementById('editSubjectFormat').value = template.subjectFormat || '';
            document.getElementById('editTemplate').value = template.templateText || '';
            document.getElementById('editHasSpecialContent').checked = template.hasSpecialContent || false;
            document.getElementById('editHasSubOptions').checked = template.hasSubOptions || false;
            
            // ã‚«ãƒ†ã‚´ãƒªåˆæœŸå€¤
            (function(){var el=document.getElementById('editCategory'); if(el){ el.value = template.category || 'è¨­è¨ˆ'; }})();
            toggleSubOptions();
if (template.hasSubOptions && template.subOptions) {
                document.getElementById('subOptionsList').innerHTML = '';
                subOptionCounter = 0;
                for (const [key, subData] of Object.entries(template.subOptions)) {
                    addSubOption(key, subData);
                }
            }
            
            document.getElementById('templateModal').style.display = 'block';
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('templateModal').style.display = 'none';
            currentEditingId = null;
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
        function saveTemplate(event) {
            event.preventDefault();
            
            const templateId = document.getElementById('editTemplateId').value.trim();
            const displayName = document.getElementById('editDisplayName').value.trim();
            const company = document.getElementById('editCompany').value.trim();
            const contact = document.getElementById('editContact').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const subjectFormat = document.getElementById('editSubjectFormat').value.trim();
            const templateText = document.getElementById('editTemplate').value.trim();
            const hasSpecialContent = document.getElementById('editHasSpecialContent').checked;
            const hasSubOptions = document.getElementById('editHasSubOptions').checked;
            const category = (document.getElementById('editCategory') && document.getElementById('editCategory').value) || 'è¨­è¨ˆ';
            
            // æ–°è¦ä½œæˆæ™‚ã®ã¿IDé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆç·¨é›†æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            if (!currentEditingId && customTemplates[templateId]) {
                alert('ã“ã®IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            const newTemplate = {
                
                category,displayName,
                company,
                contact,
                email,
                subjectFormat,
                templateText,
                hasSpecialContent,
                hasSubOptions
            };
            
            if (hasSubOptions) {
                newTemplate.subOptions = {};
                const subItems = document.querySelectorAll('.sub-option-item');
                
                subItems.forEach(item => {
                    const subId = item.querySelector('.sub-id').value.trim();
                    const subCompany = item.querySelector('.sub-company').value.trim();
                    const subContact = item.querySelector('.sub-contact').value.trim();
                    const subTel = item.querySelector('.sub-tel').value.trim();
                    const subEmail = item.querySelector('.sub-email').value.trim();
                    
                    if (subId && subCompany && subContact && subEmail) {
                        newTemplate.subOptions[subId] = {
                            company: subCompany,
                            contact: subContact,
                            tel: subTel,
                            email: subEmail
                        };
                    }
                });
            }
            
            const saveId = currentEditingId || templateId;
            customTemplates[saveId] = newTemplate;
            
            saveTemplates().then(success => {
                if (success) {
                    alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
                    closeModal();
                    renderTemplateList();
                    updateTemplateSelector();
                }
            });
        }
        
        // ãƒˆã‚°ãƒ«
        function toggleSubOptions() {
            const checked = document.getElementById('editHasSubOptions').checked;
            const section = document.getElementById('subOptionsSection');
            if (section) {
                section.style.display = checked ? 'block' : 'none';
            }
        }
        
        function toggleSpecialContent() {
            // å¿…è¦ã«å¿œã˜ã¦å‡¦ç†ã‚’è¿½åŠ 
        }
        
        // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ 
        function addSubOption(key = null, data = null) {
            const id = key || `sub_${Date.now()}_${subOptionCounter++}`;
            const container = document.getElementById('subOptionsList');
            
            const div = document.createElement('div');
            div.className = 'sub-option-item';
            div.innerHTML = `
                <div class="sub-option-header">
                    <strong>å®›å…ˆ #${container.children.length + 1}</strong>
                    <button type="button" class="btn-small btn-delete" onclick="this.parentElement.parentElement.remove()">å‰Šé™¤</button>
                </div>
                <div class="form-group">
                    <label>ID</label>
                    <input type="text" class="sub-id" value="${id}" required>
                </div>
                <div class="form-group">
                    <label>ä¼šç¤¾å</label>
                    <input type="text" class="sub-company" value="${data?.company || ''}" required>
                </div>
                <div class="form-group">
                    <label>æ‹…å½“è€…å</label>
                    <input type="text" class="sub-contact" value="${data?.contact || ''}" required>
                </div>
                <div class="form-group">
                    <label>é›»è©±ç•ªå·</label>
                    <input type="text" class="sub-tel" value="${data?.tel || ''}">
                </div>
                <div class="form-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="text" class="sub-email" value="${data?.email || ''}" required>
                </div>
            `;
            
            container.appendChild(div);
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°
        function updateTemplateSelector() {
            const selector = document.getElementById('templateType');
            if (!selector) return;
            
            const currentValue = selector.value;
            const templates = getAllTemplates();
            
            selector.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            
            for (const [key, template] of Object.entries(templates)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = template.displayName || template.company;
                selector.appendChild(option);
            }
            
            // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒï¼ˆã¾ã å­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            if (currentValue && templates[currentValue]) {
                selector.value = currentValue;
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®š
            selector.onchange = onTemplateChange;
            
            // ç¾åœ¨ã®é¸æŠã«åŸºã¥ã„ã¦æ›´æ–°
            if (selector.value) {
                onTemplateChange();
            }
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ™‚ã®å‡¦ç†
        function onTemplateChange() {
            // ã¾ãšç‰¹å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
            updateSpecificFields();
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ï¼ˆDOMæ›´æ–°ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ï¼‰
            setTimeout(function() {
                updateTemplate();
            }, 10);
        }
        
        // ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
        function updateSpecificFields() {
            const templateType = document.getElementById('templateType').value;
            const container = document.getElementById('specificFields');
            
            if (!container) {
                alert('ã‚¨ãƒ©ãƒ¼ï¼šspecificFieldsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!templateType) {
                container.innerHTML = '';
                return;
            }
            
            const templates = getAllTemplates();
            const template = templates[templateType];
            
            if (!template) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            if (template.hasSubOptions && template.subOptions) {
                html += `
                    <div class="form-group">
                        <label for="subOption">å®›å…ˆé¸æŠ:</label>
                        <select id="subOption" class="template-select" onchange="updateTemplate()">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                `;
                
                for (const [key, subData] of Object.entries(template.subOptions)) {
                    html += `<option value="${key}">${subData.company} (${subData.contact})</option>`;
                }
                
                html += `
                        </select>
                        <div id="contactInfo" class="special-notes"></div>
                    </div>
                `;
            }
            
            if (template.hasSpecialContent) {
                html += `
                    <div class="form-group">
                        <label for="specialContent">å†…å®¹è©³ç´°:</label>
                        <input type="text" id="specialContent" placeholder="è©³ç´°å†…å®¹ã‚’å…¥åŠ›" ${template.defaultSpecialContent ? ("value=\""+template.defaultSpecialContent.replace(/"/g, "&quot;")+"\"") : ""} oninput="updateTemplate()">
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function updateTemplate() {
            const templateType = document.getElementById('templateType').value;
            
            if (!templateType) {
                document.getElementById('emailOutput').innerHTML = '<span class="placeholder">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
                document.getElementById('subjectOutput').textContent = '';
                document.getElementById('emailAddressOutput').textContent = '';
                return;
            }
            
            const customerName = document.getElementById('customerName').value;
            const dueDate = document.getElementById('dueDate').value;
            const staffName = (document.getElementById('staffName') && document.getElementById('staffName').value) || '';
            
            const customerNameOnly = customerName || '[ãŠå®¢æ§˜å]';
            const fullCustomerName = customerName ? customerName + 'æ§˜é‚¸æ–°ç¯‰å·¥äº‹' : '[ãŠå®¢æ§˜å]æ§˜é‚¸æ–°ç¯‰å·¥äº‹';
            
            let formattedDate = dueDate;
            if (dueDate) {
                const date = new Date(dueDate);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
                formattedDate = `${month}/${day}(${dayOfWeek})`;
                
                const preview = document.getElementById('datePreview');
                if (preview) preview.textContent = `é¸æŠã•ã‚ŒãŸæ—¥ä»˜: ${month}æœˆ${day}æ—¥(${dayOfWeek})`;
            }
            
            const templates = getAllTemplates();
            const template = templates[templateType];
            
            if (!template) {
                document.getElementById('emailOutput').innerHTML = '<span class="placeholder">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>';
                document.getElementById('subjectOutput').textContent = '';
                document.getElementById('emailAddressOutput').textContent = '';
                return;
            }
            
            let emailContent = '';
            let subjectContent = '';
            let emailAddressContent = '';
            let specialContent = '';
            let company = template.company;
            let contact = template.contact;
            let email = template.email;
            
            const specialField = document.getElementById('specialContent');
            if (specialField) {
                specialContent = specialField.value || '[å†…å®¹è©³ç´°]';
            }
            
            
            // ogura ã®å†…å®¹è©³ç´°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‡ªå‹•è£œå®Œ
            if (templateType === 'ogura') {
                var _def = (getAllTemplates()['ogura'] && getAllTemplates()['ogura'].defaultSpecialContent)
                           || "ã‚µãƒƒã‚·ãƒ—ãƒ¬ã‚¼ãƒ³ã€é–‹å£éƒ¨ãƒªã‚¹ãƒˆã€ç„é–¢ãƒ—ãƒ¬ã‚¼ãƒ³(C10ã€€ã‚«ãƒ¼ãƒ ãƒ–ãƒ©ãƒƒã‚¯)";
                if (!specialContent || specialContent === '[å†…å®¹è©³ç´°]') {
                    specialContent = _def;
                    if (specialField) specialField.value = _def;
                }
            }
        // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®å‡¦ç†
            if (template.hasSubOptions && template.subOptions) {
                const subOption = document.getElementById('subOption');
                
                if (!subOption) {
                    // ã¾ã ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒä½œæˆã•ã‚Œã¦ã„ãªã„
                    document.getElementById('emailOutput').innerHTML = '<span class="placeholder">æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
                    document.getElementById('subjectOutput').textContent = '';
                    document.getElementById('emailAddressOutput').textContent = '';
                    return;
                }
                
                const selectedValue = subOption.value;
                
                if (!selectedValue) {
                    // æ¥­è€…ãŒé¸æŠã•ã‚Œã¦ã„ãªã„
                    document.getElementById('emailOutput').innerHTML = '<span class="placeholder">æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
                    document.getElementById('subjectOutput').textContent = '';
                    document.getElementById('emailAddressOutput').textContent = '';
                    return;
                }
                
                const subData = template.subOptions[selectedValue];
                if (subData) {
                    company = subData.company;
                    contact = subData.contact;
                    email = subData.email;
                    
                    const contactInfo = document.getElementById('contactInfo');
                    if (contactInfo) {
                        contactInfo.innerHTML = `<strong>é€£çµ¡å…ˆ:</strong> TEL: ${subData.tel} / Email: ${subData.email}`;
                    }
                }
            }
            
            // ãƒ¡ãƒ¼ãƒ«å†…å®¹ç”Ÿæˆ
            emailContent = template.templateText
                .replace(/{company}/g, company)
                .replace(/{contact}/g, contact)
                .replace(/{customerName}/g, fullCustomerName)
                .replace(/{dueDate}/g, formattedDate)
                .replace(/{specialContent}/g, specialContent);
            
            subjectContent = template.subjectFormat
                .replace(/{customerName}/g, customerNameOnly)
                .replace(/{dueDate}/g, formattedDate);
            
            emailAddressContent = email;
            
            emailContent = emailContent.replace(/\{staffName\}/g, staffName || '[æ‹…å½“è€…å]').replace(/ã€ã”æ‹…å½“è€…åã€‘/g, staffName || '[æ‹…å½“è€…å]');
            document.getElementById('emailOutput').textContent = emailContent;
            subjectContent = subjectContent.replace(/\{staffName\}/g, staffName || '[æ‹…å½“è€…å]').replace(/ã€ã”æ‹…å½“è€…åã€‘/g, staffName || '[æ‹…å½“è€…å]');
            document.getElementById('subjectOutput').textContent = subjectContent;
            document.getElementById('emailAddressOutput').textContent = emailAddressContent;
        }
        
        function copySubject() {
            const text = document.getElementById('subjectOutput').textContent;
            if (text) {
                navigator.clipboard.writeText(text);
                alert('ä»¶åã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }
        
        function copyEmailAddress() {
            const text = document.getElementById('emailAddressOutput').textContent;
            if (text) {
                navigator.clipboard.writeText(text);
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }
        
        function copyToClipboard() {
            const text = document.getElementById('emailOutput').textContent;
            if (text && !text.includes('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ')) {
                navigator.clipboard.writeText(text);
                alert('ãƒ¡ãƒ¼ãƒ«å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }
        
        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.onload = init;
    


</script>

<script>
// === UI overrides: category grouping (non-destructive) ===
function renderTemplateList() {
    const container = document.getElementById('templateList');
    const templates = getAllTemplates();
    if (!container) return;
    if (Object.keys(templates).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }
    const cats = {"è¨­è¨ˆ": [], "IC": [], "æœªåˆ†é¡": []};
    for (const [key, t] of Object.entries(templates)) {
        const c = t.category || "æœªåˆ†é¡";
        if (!cats[c]) cats[c] = [];
        cats[c].push([key, t]);
    }
    let html = '';
    for (const cat of ["è¨­è¨ˆ","IC","æœªåˆ†é¡"]) {
        const arr = cats[cat]; if (!arr || arr.length===0) continue;
        html += `<h3 style="color:#3498db; margin-top:30px;">ğŸ“‚ ${cat} ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>`;
        for (const [key, template] of arr) {
            const isDefault = ({}).hasOwnProperty.call(defaultTemplates, key);
            const badgeColor = isDefault ? '#3498db' : '#27ae60';
            const badgeText = isDefault ? 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ' : 'ã‚«ã‚¹ã‚¿ãƒ ';
            html += `
                <div class="template-card">
                    <div>
                        <h4>
                            ${template.displayName || template.company}
                            <span style="background: ${badgeColor}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; margin-left: 10px;">${badgeText}</span>
                        </h4>
                        <p style="margin: 5px 0; color: #666;">ä¼šç¤¾å: ${template.company}</p>
                        <p style="margin: 5px 0; color: #666;">å®›å…ˆ: ${template.contact || 'ã”æ‹…å½“è€…æ§˜'}</p>
                        <p style="margin: 5px 0; color: #666;">Email: ${template.email || 'ãªã—'}</p>
                        ${template.hasSubOptions ? '<p style="margin: 5px 0; color: #e67e22; font-weight: bold;">ğŸ“Œ ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚ã‚Š</p>' : ''}
                    </div>
                    <div class="template-card-actions">
                        <button class="btn-small btn-edit" onclick="editTemplateModal('${key}')">âœï¸ ç·¨é›†</button>
                        <button class="btn-small btn-delete" onclick="deleteTemplateConfirm('${key}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                </div>`;
        }
    }
    container.innerHTML = html;
}

function updateTemplateSelector() {
    const selector = document.getElementById('templateType');
    if (!selector) return;
    const currentValue = selector.value;
    const templates = getAllTemplates();
    selector.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    const cats = {"è¨­è¨ˆ": [], "IC": [], "æœªåˆ†é¡": []};
    for (const [key, t] of Object.entries(templates)) {
        const c = t.category || "æœªåˆ†é¡";
        if (!cats[c]) cats[c] = [];
        cats[c].push([key, t]);
    }
    for (const cat of ["è¨­è¨ˆ","IC","æœªåˆ†é¡"]) {
        const arr = cats[cat]; if (!arr || arr.length===0) continue;
        const og = document.createElement('optgroup');
        og.label = cat + " ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ";
        arr.forEach(([key, t]) => {
            const opt = document.createElement('option');
            opt.value = key;
            opt.textContent = t.displayName || t.company;
            og.appendChild(opt);
        });
        selector.appendChild(og);
    }
    selector.value = currentValue;
    selector.onchange = onTemplateChange;
    if (selector.value) onTemplateChange();
}
</script>


<script>
// === Non-destructive patch for specialContent ===
(function(){
  function hideSpecialGroup(){
    var sc = document.getElementById('specialContent');
    if (sc && sc.closest) {
      var grp = sc.closest('.form-group');
      if (grp) grp.style.display = 'none';
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', hideSpecialGroup);
  } else {
    hideSpecialGroup();
  }

  var _origUpdate = window.updateTemplate;
  window.updateTemplate = function(){
    try { if (typeof _origUpdate === 'function') _origUpdate(); } catch(e) {}
    try {
      var eo = document.getElementById('emailOutput');
      var so = document.getElementById('subjectOutput');
      if (eo && eo.textContent) eo.textContent = eo.textContent.replace(/\[å†…å®¹è©³ç´°\]/g, '');
      if (so && so.textContent) so.textContent = so.textContent.replace(/\[å†…å®¹è©³ç´°\]/g, '');
    } catch(e) {}
  };
})();
</script>


<!-- removed: unsafe delete of special option -->


<script>
// === ICç”¨ã€Œå¤‰æ›´ä¾é ¼ å®šå‹æ–‡ã«ç½®æ›ã€ãƒœã‚¿ãƒ³ï¼ˆéç ´å£Šãƒ©ãƒƒãƒ—ï¼‰ ===
(function(){
  // çŠ¶æ…‹ãƒ•ãƒ©ã‚°ï¼ˆONã®é–“ã¯å¸¸ã«æœ¬æ–‡ã‚’å¤‰æ›´ä¾é ¼ãƒ†ãƒ³ãƒ—ãƒ¬ã«ç½®æ›ï¼‰
  var icChangeReplaceMode = false;

  // å…±é€šæ–‡ã‚’ç”Ÿæˆï¼ˆ{customerName}/{dueDate}åŸ‹ã‚è¾¼ã¿ï¼‰
  function buildIcChangeNote(customerName, dueDate){
    const name = (customerName || '').trim() || 'ãŠå®¢æ§˜';
    const date = (dueDate || '').trim() || '0/00ï¼ˆï¼‰ä¸­';
    return [
      'ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚æ·»ä»˜è³‡æ–™ã®å†…å®¹ã§' + name + 'æ§˜ã®å¤‰æ›´ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚',
      '',
      'ç´æœŸå¸Œæœ›ï¼š' + date,
      '',
      'ã”ä¸æ˜ç‚¹ã”ã–ã„ã¾ã—ãŸã‚‰ãŠç”³ã—ä»˜ã‘ãã ã•ã„ã€‚',
      '',
      'ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚'
    ].join('\n');
  }

  // ãƒœã‚¿ãƒ³UIã‚’æ³¨å…¥
  function injectButtons(){
    if (document.getElementById('icChangeReplaceBtn')) return;
    const host = document.querySelector('.two-column') || document.querySelector('#mailForm') || document.body;
    const wrap = document.createElement('div');
    wrap.className = 'form-group';
    wrap.style.marginTop = '8px';
    wrap.innerHTML = [
      '<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">',
      '  <button type="button" id="icChangeReplaceBtn" class="btn-primary">å¤‰æ›´ä¾é ¼ã®å®šå‹æ–‡ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆICï¼‰</button>',
      '  <button type="button" id="icChangeRestoreBtn" class="btn-secondary">é€šå¸¸ãƒ†ãƒ³ãƒ—ãƒ¬ã«æˆ»ã™</button>',
      '  <span id="icChangeHint" class="special-notes">â€» ICã‚«ãƒ†ã‚´ãƒªã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿æœ‰åŠ¹ã€‚ONã®é–“ã¯æœ¬æ–‡ãŒç½®æ›ã•ã‚Œã¾ã™</span>',
      '</div>'
    ].join('');
    host.appendChild(wrap);

    // ãƒœã‚¿ãƒ³å‹•ä½œ
    document.getElementById('icChangeReplaceBtn').addEventListener('click', function(){
      icChangeReplaceMode = true;
      applyIfIC();
    });
    document.getElementById('icChangeRestoreBtn').addEventListener('click', function(){
      icChangeReplaceMode = false;
      // é€šå¸¸ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å†ç”Ÿæˆï¼ˆæ—¢å­˜ã®updateTemplateã‚’å‘¼ã¶ï¼‰
      if (typeof _origUpdate === 'function') _origUpdate();
    });

    updateButtonsState();
  }

  function isICTemplateSelected(){
    const key = (document.getElementById('templateType')||{}).value || '';
    const all = (window.getAllTemplates && window.getAllTemplates()) || {};
    const t = all[key] || {};
    return t.category === 'IC';
  }

  function updateButtonsState(){
    const onIC = isICTemplateSelected();
    const btn1 = document.getElementById('icChangeReplaceBtn');
    const btn2 = document.getElementById('icChangeRestoreBtn');
    const hint = document.getElementById('icChangeHint');
    if (btn1) {
      btn1.disabled = !onIC;
      btn1.title = onIC ? '' : 'ICãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠæ™‚ã«ä½¿ç”¨ã§ãã¾ã™';
    }
    if (btn2) {
      btn2.disabled = !onIC && !icChangeReplaceMode;
      btn2.title = onIC ? '' : 'ICãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠæ™‚ã«ä½¿ç”¨ã§ãã¾ã™';
    }
    if (hint) {
      hint.textContent = onIC ? 'ICãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠä¸­ï¼šãƒœã‚¿ãƒ³ã§æœ¬æ–‡ã‚’ç½®æ›ã§ãã¾ã™' : 'ICãƒ†ãƒ³ãƒ—ãƒ¬ã§ã¯ã‚ã‚Šã¾ã›ã‚“';
    }
  }

  // æœ¬æ–‡ã‚’ç½®æ›ï¼ˆIC + ãƒ¢ãƒ¼ãƒ‰ONã®ã¨ãï¼‰
  function applyIfIC(){
    if (!icChangeReplaceMode) return;
    if (!isICTemplateSelected()) return;
    const name = (document.getElementById('customerName')||{}).value || '';
    // æ—¢å­˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«åˆã‚ã›ã¦ dueDate ã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆâ€»å¿…è¦ãªã‚‰æ—¢å­˜ã®æ•´å½¢ã«åˆã‚ã›ã‚‹ï¼‰
    const due = (document.getElementById('dueDate')||{}).value || '';

    const note = buildIcChangeNote(name, due);
    const out = document.getElementById('emailOutput');
    if (out) out.textContent = note;
  
    // ä»¶åã«ã€Œå¤‰æ›´ä¾é ¼ ã€ã‚’ä»˜ä¸ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
    const subj = document.getElementById('subjectOutput');
    if (subj) {
      const base = (subj.textContent || '').replace(/^\s*å¤‰æ›´ä¾é ¼\s*/,'').trim();
      subj.textContent = ('å¤‰æ›´ä¾é ¼ ' + base).trim();
    }
}

  // updateTemplate ã‚’ãƒ©ãƒƒãƒ—ã—ã¦ã€æ¯å›ç½®æ›é©ç”¨ï¼ˆONã®ã¨ãã®ã¿ï¼‰
  const _origUpdate = window.updateTemplate;
  if(!document.getElementById('emailOutput')){ if(typeof _origUpdate==='function'){ _origUpdate(); } return; }
window.updateTemplate = function(){
    if (typeof _origUpdate === 'function') _origUpdate();
    try {
      updateButtonsState();
      if (icChangeReplaceMode) {
        applyIfIC();
      } else {
        const subj = document.getElementById('subjectOutput');
        if (subj) {
          const cleaned = (subj.textContent || '').replace(/^\s*å¤‰æ›´ä¾é ¼\s*/,'').trim();
          subj.textContent = cleaned;
        }
      }
    } catch(e){ console.warn(e); }
  };

  // åˆæœŸåŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){
      injectButtons();
      updateButtonsState();
    });
  } else {
    injectButtons();
    updateButtonsState();
  }
})();
</script>


<script>
// === Auto-Save (draft) for mail composer â€” non-destructive patch ===
(function(){
  const KEY = 'mailComposerAutosaveV1';
  let timer = null;
  let restoring = false;

  function $id(id){ return document.getElementById(id); }

  function getState(){
    return {
      templateType: ($id('templateType')||{}).value || '',
      subOption: ($id('subOptionSelect')||{}).value || '',
      customerName: ($id('customerName')||{}).value || '',
      staffName: ($id('staffName')||{}).value || '',
      dueDate: ($id('dueDate')||{}).value || '',
      subject: ($id('subjectOutput')||{}).textContent || '',
      emailBody: ($id('emailOutput')||{}).textContent || ''
    };
  }

  function setState(s){
    if (!s) return;
    restoring = true;
    try {
      if ($id('templateType') && s.templateType) {
        $id('templateType').value = s.templateType;
        if (typeof window.onTemplateChange === 'function') window.onTemplateChange();
      }
      // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãƒ†ãƒ³ãƒ—ãƒ¬é©ç”¨å¾Œã«
      setTimeout(function(){
        if ($id('subOptionSelect') && s.subOption) $id('subOptionSelect').value = s.subOption;
        if ($id('customerName') && s.customerName) $id('customerName').value = s.customerName;
        if ($id('staffName') && s.staffName) $id('staffName').value = s.staffName;
        if ($id('dueDate') && s.dueDate) $id('dueDate').value = s.dueDate;
        if (typeof window.updateTemplate === 'function') window.updateTemplate();
      }, 50);
    } finally {
      setTimeout(function(){ restoring = false; }, 100);
    }
  }

  function save(){
    try {
      localStorage.setItem(KEY, JSON.stringify(getState()));
      const ind = $id('autosaveIndicator');
      if (ind) {
        ind.textContent = 'è‡ªå‹•ä¿å­˜æ¸ˆã¿';
        ind.style.opacity = '1';
        setTimeout(()=>{ ind.style.opacity = '0.7'; }, 800);
      }
    } catch(e){ console.warn('autosave failed', e); }
  }

  function load(){
    try {
      const raw = localStorage.getItem(KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e){ return null; }
  }

  function clearDraft(){
    try {
      localStorage.removeItem(KEY);
      const ind = $id('autosaveIndicator');
      if (ind) {
        ind.textContent = 'ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã—ãŸ';
        ind.style.opacity = '1';
        setTimeout(()=>{ ind.style.opacity = '0.7'; }, 800);
      }
    } catch(e){}
  }

  function schedule(){
    if (restoring) return;
    if (timer) clearTimeout(timer);
    timer = setTimeout(save, 400);
  }

  function attach(){
    const fields = ['templateType','subOptionSelect','customerName','staffName','dueDate'];
    fields.forEach(id=>{
      const el = $id(id);
      if (!el) return;
      el.addEventListener('input', schedule);
      el.addEventListener('change', schedule);
    });
    // æ—¢å­˜ã®updateTemplateãƒ©ãƒƒãƒ—ã‚‚è€ƒæ…®ã—ã¦ã€DOMæ›´æ–°å¾Œã«ã‚‚å®šæœŸä¿å­˜
    setInterval(function(){
      if (document.hasFocus()) save();
    }, 10000);
  }

  // UI: indicator & clear button
  function injectUI(){
    if ($id('autosaveIndicator')) return;
    const host = document.querySelector('.two-column') || document.getElementById('mailForm') || document.body;
    const box = document.createElement('div');
    box.style.display = 'flex';
    box.style.alignItems = 'center';
    box.style.gap = '8px';
    box.style.margin = '4px 0 8px 0';
    box.innerHTML = `
      <span id="autosaveIndicator" class="special-notes" style="opacity:.7">è‡ªå‹•ä¿å­˜ã‚ªãƒ³</span>
      <button type="button" id="clearDraftBtn" class="btn-secondary" style="padding:4px 8px;">ä¸‹æ›¸ãã‚’å‰Šé™¤</button>
    `;
    host.parentNode.insertBefore(box, host);
    const btn = document.getElementById('clearDraftBtn');
    btn.addEventListener('click', function(){
      clearDraft();
    });
  }

  function init(){
    injectUI();
    attach();
    const s = load();
    if (s) setState(s);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>


<script>
// === Remove all "ç‰¹åˆ¥ãªå…¥åŠ›é …ç›®ï¼ˆå†…å®¹è©³ç´°ï¼‰" UI safely (with hidden stub) ===
(function(){
  function removeSpecialOption(scope){
    try{
      const labels = (scope || document).querySelectorAll('label');
      labels.forEach(lb => {
        const t = (lb.textContent || '').replace(/\s+/g,'').trim();
        if (t.includes('ç‰¹åˆ¥ãªå…¥åŠ›é …ç›®ã‚’è¿½åŠ ') && t.includes('å†…å®¹è©³ç´°')){
          const grp = lb.closest('.form-group') || lb.parentElement;
          if (grp) grp.remove();
          // èª¬æ˜ãƒãƒ¼ãƒˆã‚‚å‰Šé™¤
          if (grp && grp.nextElementSibling && /(specialContent|\{specialContent\}|å†…å®¹è©³ç´°)/.test(grp.nextElementSibling.textContent||'')){
            grp.nextElementSibling.remove();
          }
        }
      });
      // hidden stub
      const host = document.getElementById('editTemplateModal') || document.body;
      if (!document.getElementById('editHasSpecialContent')){
        const stub = document.createElement('input');
        stub.type = 'checkbox';
        stub.id = 'editHasSpecialContent';
        stub.style.display = 'none';
        host.appendChild(stub);
      }
    }catch(e){ console.warn('removeSpecialOption failed', e); }
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', () => removeSpecialOption());
  } else {
    removeSpecialOption();
  }
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚‚æ¯å›å®Ÿè¡Œ
  const _origEditModal = window.editTemplateModal;
  window.editTemplateModal = function(id){
    if (typeof _origEditModal === 'function') _origEditModal(id);
    setTimeout(() => removeSpecialOption(document.getElementById('editTemplateModal')), 0);
  };
  const _origOpenNew = window.openNewTemplateModal;
  window.openNewTemplateModal = function(){
    if (typeof _origOpenNew === 'function') _origOpenNew();
    setTimeout(() => removeSpecialOption(document.getElementById('editTemplateModal')), 0);
  };
})();
</script>


<script>
// === Template Manager: Auto-Save Draft (non-destructive) ===
(function(){
  const DRAFT_PREFIX = 'tplDraft::';

  function $id(id){ return document.getElementById(id); }
  function getCurrentDraftKey(){
    const id = ($id('editTemplateId')||{}).value || '__new__';
    return DRAFT_PREFIX + id;
  }
  function collectFields(){
    const subOptions = [];
    const list = $id('subOptionsList');
    if (list){
      list.querySelectorAll('.sub-option-item').forEach(row => {
        const get = name => (row.querySelector(`[name="${name}"]`)||{}).value || '';
        subOptions.push({
          id: get('sub-id'), company: get('sub-company'), contact: get('sub-contact'),
          tel: get('sub-tel'), email: get('sub-email')
        });
      });
    }
    return {
      id: ($id('editTemplateId')||{}).value || '',
      displayName: ($id('editDisplayName')||{}).value || '',
      company: ($id('editCompany')||{}).value || '',
      contact: ($id('editContact')||{}).value || '',
      email: ($id('editEmail')||{}).value || '',
      subjectFormat: ($id('editSubjectFormat')||{}).value || '',
      templateText: ($id('editTemplateText')||{}).value || '',
      hasSubOptions: ($id('editHasSubOptions')||{}).checked || false,
      category: ($id('editCategory')||{}).value || '',
      subOptions
    };
  }
  function restoreFields(data){
    if (!data) return;
    const apply = (id, v) => { if ($id(id) && v != null) $id(id).value = v; };
    apply('editTemplateId', data.id);
    apply('editDisplayName', data.displayName);
    apply('editCompany', data.company);
    apply('editContact', data.contact);
    apply('editEmail', data.email);
    apply('editSubjectFormat', data.subjectFormat);
    apply('editTemplateText', data.templateText);
    if ($id('editHasSubOptions')) $id('editHasSubOptions').checked = !!data.hasSubOptions;
    if ($id('editCategory')) $id('editCategory').value = data.category || ($id('editCategory').value||'è¨­è¨ˆ');

    // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¾©å…ƒï¼ˆç°¡æ˜“ï¼šä¸€æ—¦ã‚¯ãƒªã‚¢ã—ã¦è¿½åŠ ï¼‰
    const list = $id('subOptionsList');
    if (list && Array.isArray(data.subOptions)){
      list.innerHTML = '';
      data.subOptions.forEach(op => {
        if (typeof window.addSubOptionRow === 'function'){
          window.addSubOptionRow(op);
        }
      });
    }
  }
  function saveDraft(){
    try {
      const key = getCurrentDraftKey();
      localStorage.setItem(key, JSON.stringify(collectFields()));
      const ind = document.getElementById('tplAutosaveIndicator');
      if (ind){
        ind.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ä¸‹æ›¸ãè‡ªå‹•ä¿å­˜æ¸ˆã¿';
        ind.style.opacity = '1';
        setTimeout(()=>ind.style.opacity=0.7, 800);
      }
    } catch(e){ console.warn('template draft save failed', e); }
  }
  function loadDraft(key){ try{ const raw = localStorage.getItem(key); return raw? JSON.parse(raw): null; }catch(e){ return null; } }
  function clearDraft(key){ try{ localStorage.removeItem(key); }catch(e){} }

  // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒ•ãƒƒã‚¯ã—ã¦è‡ªå‹•ä¿å­˜
  function attachAutosave(){
    const ids = ['editTemplateId','editDisplayName','editCompany','editContact','editEmail','editSubjectFormat','editTemplateText','editHasSubOptions','editCategory'];
    ids.forEach(id => {
      const el = $id(id);
      if (!el) return;
      const ev = (el.type === 'checkbox') ? 'change' : 'input';
      el.addEventListener(ev, saveDraft);
    });
    // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡Œã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå‹•çš„ï¼‰
    const list = $id('subOptionsList');
    if (list){
      list.addEventListener('input', saveDraft);
      list.addEventListener('change', saveDraft);
    }
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«èµ·å‹•æ™‚ã«ãƒ‰ãƒ©ãƒ•ãƒˆå¾©å…ƒUIã‚’æ³¨å…¥
  function injectIndicator(){
    if (document.getElementById('tplAutosaveIndicator')) return;
    const host = document.querySelector('#editTemplateModal .modal-content h2');
    if (!host) return;
    const span = document.createElement('span');
    span.id = 'tplAutosaveIndicator';
    span.className = 'special-notes';
    span.style.marginLeft = '8px';
    span.style.opacity = '0.7';
    span.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ä¸‹æ›¸ãè‡ªå‹•ä¿å­˜ã‚ªãƒ³';
    host.appendChild(span);
    // å¾©å…ƒ/å‰Šé™¤ã®ãƒŸãƒ‹ãƒœã‚¿ãƒ³
    const btnWrap = document.createElement('div');
    btnWrap.style.marginTop = '6px';
    btnWrap.innerHTML = '<button type="button" id="tplDraftClear" class="btn-secondary btn-small">ä¸‹æ›¸ãã‚’å‰Šé™¤</button>';
    host.parentElement.insertBefore(btnWrap, host.nextSibling);
    btnWrap.querySelector('#tplDraftClear').addEventListener('click', function(){
      clearDraft(getCurrentDraftKey());
      const ind = document.getElementById('tplAutosaveIndicator');
      if (ind){ ind.textContent = 'ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã—ãŸ'; }
    });
  }

  // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èµ·å‹•é–¢æ•°ã‚’ãƒ©ãƒƒãƒ—
  const _origEdit = window.editTemplateModal;
  window.editTemplateModal = function(id){
    if (typeof _origEdit === 'function') _origEdit(id);
    setTimeout(function(){
      injectIndicator();
      attachAutosave();
      // æ—¢å­˜IDç”¨ã®ãƒ‰ãƒ©ãƒ•ãƒˆãŒã‚ã‚Œã°å¾©å…ƒ
      const key = DRAFT_PREFIX + (document.getElementById('editTemplateId')?.value || '__new__');
      const data = loadDraft(key);
      if (data) restoreFields(data);
    },0);
  };
  const _origNew = window.openNewTemplateModal;
  window.openNewTemplateModal = function(){
    if (typeof _origNew === 'function') _origNew();
    setTimeout(function(){
      injectIndicator();
      attachAutosave();
      // æ–°è¦ç”¨ã®ä¸‹æ›¸ã
      const data = loadDraft(DRAFT_PREFIX + '__new__');
      if (data) restoreFields(data);
    },0);
  };
})();
</script>


<script>
// === Template Manager: Auto-Commit Persistï¼ˆç·¨é›†ï¼å³ä¿å­˜ã§å¸¸æ™‚ä¿æŒï¼‰ ===
(function(){
  let debounce = null;
  let lastCommittedId = null;

  function $id(id){ return document.getElementById(id); }
  function readJSON(key, fallback){ try{ const raw = localStorage.getItem(key); return raw? JSON.parse(raw): fallback; }catch(e){ return fallback; } }
  function writeJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function collectPayload(){
    const payload = {
      category: ($id('editCategory')||{}).value || 'è¨­è¨ˆ',
      displayName: ($id('editDisplayName')||{}).value || '',
      company: ($id('editCompany')||{}).value || '',
      contact: ($id('editContact')||{}).value || '',
      email: ($id('editEmail')||{}).value || '',
      subjectFormat: ($id('editSubjectFormat')||{}).value || '',
      templateText: ($id('editTemplate')||{}).value || '',
      hasSpecialContent: false,
      hasSubOptions: ($id('editHasSubOptions')||{}).checked || false
    };
    // subOptions
    const list = $id('subOptionsList');
    if (list){
      payload.subOptions = {};
      list.querySelectorAll('.sub-option-item').forEach(row => {
        const id = (row.querySelector('.sub-id')||{}).value || '';
        if (!id) return;
        payload.subOptions[id] = {
          company: (row.querySelector('.sub-company')||{}).value || '',
          contact: (row.querySelector('.sub-contact')||{}).value || '',
          tel:     (row.querySelector('.sub-tel')||{}).value     || '',
          email:   (row.querySelector('.sub-email')||{}).value   || ''
        };
      });
    }
    return payload;
  }

  function commitNow(){
    const id = ($id('editTemplateId')||{}).value || '';
    if (!id) return; // IDãŒãªã„ã¨ä¿å­˜ã‚­ãƒ¼ã«ã§ããªã„
    let custom = readJSON('custom_templates', {});
    // IDå¤‰æ›´æ™‚ã®ã‚­ãƒ¼ç§»å‹•
    if (lastCommittedId && lastCommittedId !== id && custom[lastCommittedId]) {
      delete custom[lastCommittedId];
    }
    custom[id] = collectPayload();
    writeJSON('custom_templates', custom);

    // å‰Šé™¤ãƒªã‚¹ãƒˆã‹ã‚‰ã®å¾©å¸°
    const del = readJSON('deleted_templates', []);
    const idx = del.indexOf(id);
    if (idx !== -1) {
      del.splice(idx, 1);
      writeJSON('deleted_templates', del);
    }

    lastCommittedId = id;

    // ä¸€è¦§ã¨ã‚»ãƒ¬ã‚¯ã‚¿ã‚’å³æ™‚åæ˜ 
    try {
      if (typeof window.renderTemplateList === 'function') window.renderTemplateList();
      if (typeof window.updateTemplateSelector === 'function') window.updateTemplateSelector();
      const ttl = document.getElementById('modalTitle');
      if (ttl && !ttl.textContent.includes('ï¼ˆè‡ªå‹•ä¿å­˜æ¸ˆã¿ï¼‰')) {
        ttl.textContent += 'ï¼ˆè‡ªå‹•ä¿å­˜æ¸ˆã¿ï¼‰';
      }
    } catch(e){}
  }

  function schedule(){ if (debounce) clearTimeout(debounce); debounce = setTimeout(commitNow, 300); }

  function attachAutoCommit(){
    const ids = ['editTemplateId','editDisplayName','editCompany','editContact','editEmail','editSubjectFormat','editTemplate','editCategory','editHasSubOptions'];
    ids.forEach(id => {
      const el = $id(id);
      if (!el) return;
      const ev = (el.type === 'checkbox') ? 'change' : 'input';
      el.addEventListener(ev, schedule);
    });
    const list = $id('subOptionsList');
    if (list){
      list.addEventListener('input', schedule);
      list.addEventListener('change', schedule);
    }
    // é·ç§»ã‚„é–‰ã˜ã‚‹å‰ã‚‚ç¢ºå®š
    window.addEventListener('beforeunload', commitNow);
  }

  // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èµ·å‹•é–¢æ•°ã‚’ãƒ©ãƒƒãƒ—
  const _openNew = window.openNewTemplateModal;
  window.openNewTemplateModal = function(){
    if (typeof _openNew === 'function') _openNew();
    setTimeout(()=>{
      attachAutoCommit();
      lastCommittedId = ($id('editTemplateId')||{}).value || null;
      const h2 = document.querySelector('#templateModal .modal-header h2');
      if (h2 && !document.getElementById('tplAutoCommitBadge')) {
        const b = document.createElement('span');
        b.id = 'tplAutoCommitBadge'; b.className = 'special-notes'; b.style.marginLeft = '8px';
        b.textContent = 'ï¼ˆå…¥åŠ›ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼‰';
        h2.appendChild(b);
      }
    },0);
  };

  const _edit = window.editTemplateModal;
  window.editTemplateModal = function(id){
    if (typeof _edit === 'function') _edit(id);
    setTimeout(()=>{
      attachAutoCommit();
      lastCommittedId = ($id('editTemplateId')||{}).value || id || null;
      const h2 = document.querySelector('#templateModal .modal-header h2');
      if (h2 && !document.getElementById('tplAutoCommitBadge')) {
        const b = document.createElement('span');
        b.id = 'tplAutoCommitBadge'; b.className = 'special-notes'; b.style.marginLeft = '8px';
        b.textContent = 'ï¼ˆå…¥åŠ›ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼‰';
        h2.appendChild(b);
      }
    },0);
  };
})();
</script>


<script>
// === UIã‚³ãƒ”ãƒ¼ä¿®æ­£ãƒ‘ãƒƒãƒï¼ˆæ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ—¥æœ¬èªè¡¨ç¾ã‚’è‡ªç„¶ã«ï¼‰ ===
(function(){
  function setLabel(forId, text){
    var lb = document.querySelector('#editTemplateModal label[for="'+forId+'"], #templateModal label[for="'+forId+'"]');
    if (lb) lb.textContent = text;
  }
  function setPlaceholder(id, text){
    var el = document.getElementById(id);
    if (el) el.placeholder = text;
  }
  function renamePrimaryBtn(text){
    var btn = document.querySelector('#templateModal .modal-footer .btn-primary');
    if (btn) btn.textContent = text;
  }
  function renameSecondaryBtn(text){
    var btn = document.querySelector('#templateModal .modal-footer .btn-secondary');
    if (btn) btn.textContent = text;
  }
  function renameHeader(text){
    var h2 = document.querySelector('#templateModal .modal-header h2, #editTemplateModal .modal-header h2');
    if (h2) h2.textContent = text;
  }
  function tweakSubOptionLabels(scope){
    var root = scope || document;
    // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡Œã®è¦‹å‡ºã—/ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’è‡ªç„¶ãªæ—¥æœ¬èªã«
    (root.querySelectorAll('.sub-option-item') || []).forEach(function(row){
      var id = row.querySelector('.sub-id');
      var company = row.querySelector('.sub-company');
      var contact = row.querySelector('.sub-contact');
      var tel = row.querySelector('.sub-tel');
      var email = row.querySelector('.sub-email');
      if (id) id.placeholder = 'IDï¼ˆä¾‹ï¼španasonicï¼‰';
      if (company) company.placeholder = 'ä¼šç¤¾å';
      if (contact) contact.placeholder = 'å®›å…ˆæ‹…å½“è€…';
      if (tel) tel.placeholder = 'é›»è©±ç•ªå·';
      if (email) email.placeholder = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹';
    });
    var addBtn = root.querySelector('#addSubOptionBtn, .add-sub-option');
    if (addBtn) addBtn.textContent = 'ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ';
  }
  function tweakCategoryLabel(){
    // ã‚«ãƒ†ã‚´ãƒªã®ãƒ©ã‚¸ã‚ª/ã‚»ãƒ¬ã‚¯ãƒˆ
    var lb = document.querySelector('#templateModal label[for="editCategory"], #editTemplateModal label[for="editCategory"]');
    if (lb) lb.textContent = 'ã‚«ãƒ†ã‚´ãƒª *';
  }
  function applyForNew(){
    renameHeader('æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ');
    setLabel('editTemplateId','ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID *');
    setLabel('editDisplayName','è¡¨ç¤ºå *');
    setLabel('editCompany','ä¼šç¤¾å');
    setLabel('editContact','å®›å…ˆæ‹…å½“è€…');
    setLabel('editEmail','ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆè¤‡æ•°ã¯ ; åŒºåˆ‡ã‚Šï¼‰');
    setLabel('editSubjectFormat','ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ');
    setLabel('editTemplate','æœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ');
    tweakCategoryLabel();
    setPlaceholder('editTemplateId','ä¾‹ï¼šic_change_request');
    setPlaceholder('editDisplayName','ä¾‹ï¼šå¤‰æ›´ä¾é ¼ï¼ˆICå…±é€šï¼‰');
    setPlaceholder('editCompany','ä¾‹ï¼šãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ãƒªãƒ“ãƒ³ã‚°è¿‘ç•¿æ ªå¼ä¼šç¤¾');
    setPlaceholder('editContact','ä¾‹ï¼šå ¤ æ§˜');
    setPlaceholder('editEmail','ä¾‹ï¼šxxx@example.com; yyy@example.com');
    setPlaceholder('editSubjectFormat','ä¾‹ï¼š{customerName}æ§˜é‚¸ å¤‰æ›´ä¾é ¼ æœŸæ—¥{dueDate}');
    renamePrimaryBtn('ä½œæˆ');
    renameSecondaryBtn('ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
    tweakSubOptionLabels(document);
  }
  function applyForEdit(){
    renameHeader('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç·¨é›†');
    setLabel('editTemplateId','ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID *');
    setLabel('editDisplayName','è¡¨ç¤ºå *');
    setLabel('editCompany','ä¼šç¤¾å');
    setLabel('editContact','å®›å…ˆæ‹…å½“è€…');
    setLabel('editEmail','ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆè¤‡æ•°ã¯ ; åŒºåˆ‡ã‚Šï¼‰');
    setLabel('editSubjectFormat','ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ');
    setLabel('editTemplate','æœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ');
    tweakCategoryLabel();
    renamePrimaryBtn('ä¿å­˜');
    renameSecondaryBtn('ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
    tweakSubOptionLabels(document);
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«èµ·å‹•ã‚’ãƒ•ãƒƒã‚¯ã—ã¦ã€éƒ½åº¦ã‚³ãƒ”ãƒ¼ã‚’æ•´ãˆã‚‹
  var _openNew = window.openNewTemplateModal;
  window.openNewTemplateModal = function(){
    if (typeof _openNew === 'function') _openNew();
    setTimeout(applyForNew, 0);
  };
  var _edit = window.editTemplateModal;
  window.editTemplateModal = function(id){
    if (typeof _edit === 'function') _edit(id);
    setTimeout(applyForEdit, 0);
  };

  // ã™ã§ã«é–‹ã„ã¦ã„ã‚‹å ´åˆï¼ˆå†èª­ã¿è¾¼ã¿ç›´å¾Œãªã©ï¼‰ã«ã‚‚é©ç”¨
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){
      if (document.getElementById('templateModal')?.style?.display !== 'none') applyForNew();
      if (document.getElementById('editTemplateModal')?.style?.display !== 'none') applyForEdit();
    });
  } else {
    if (document.getElementById('templateModal')) applyForNew();
    if (document.getElementById('editTemplateModal')) applyForEdit();
  }

  // ã€Œã®ã‚ã€ãªã©ä¸è‡ªç„¶ãªåŠ©è©ãŒæ®‹ã£ã¦ã„ã‚‹æ—§ã‚³ãƒ”ãƒ¼ãŒã‚ã‚Œã°ã€æœ€å°é™ã§ç½®æ›
  // â€» æ–‡æ›¸å…¨ä½“ã®ä¸€æ‹¬ç½®æ›ã¯å‰¯ä½œç”¨ãŒå‡ºã‚‹ãŸã‚ã€è¦‹å‡ºã—è¦ç´ ã«é™å®š
  (function cleanupHeadings(){
    var heads = document.querySelectorAll('#templateModal .modal-header h2, #editTemplateModal .modal-header h2, h3, h4');
    heads.forEach(function(h){
      var t = (h.textContent || '');
      t = t.replace('æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆã®ã‚','æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ');
      t = t.replace('æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆã®ã¯','æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ');
      h.textContent = t;
    });
  })();
})();
</script>


<script>
// === ã€Œã‚ã€åˆæœŸå€¤ãƒ»ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€æƒé™¤ãƒ‘ãƒƒãƒï¼ˆæ–°è¦/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸¡å¯¾å¿œï¼‰ ===
(function(){
  const TARGETS = [
    'editDisplayName','editCompany','editContact','editEmail',
    'editSubjectFormat','editTemplate','editTemplateId'
  ];

  function clearWaIn(scope){
    const root = scope || document;
    TARGETS.forEach(id=>{
      const el = root.getElementById && root.getElementById(id);
      if (!el) return;
      if (typeof el.value === 'string' && el.value.trim() === 'ã‚') el.value = '';
      if (typeof el.placeholder === 'string' && el.placeholder.trim() === 'ã‚') el.placeholder = '';
    });
    // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡Œï¼ˆå‹•çš„ï¼‰
    (root.querySelectorAll && root.querySelectorAll('.sub-option-item'))?.forEach(row=>{
      ['.sub-id','.sub-company','.sub-contact','.sub-tel','.sub-email'].forEach(sel=>{
        const f = row.querySelector(sel);
        if (!f) return;
        if (typeof f.value === 'string' && f.value.trim() === 'ã‚') f.value = '';
        if (typeof f.placeholder === 'string' && f.placeholder.trim() === 'ã‚') f.placeholder = '';
      });
    });
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«èµ·å‹•ãƒ•ãƒƒã‚¯ï¼šé–‹ã„ãŸç›´å¾Œã«æƒé™¤
  const _openNew = window.openNewTemplateModal;
  window.openNewTemplateModal = function(){
    if (typeof _openNew === 'function') _openNew();
    setTimeout(()=> clearWaIn(document.getElementById('templateModal') || document), 0);
  };
  const _edit = window.editTemplateModal;
  window.editTemplateModal = function(id){
    if (typeof _edit === 'function') _edit(id);
    setTimeout(()=> clearWaIn(document.getElementById('editTemplateModal') || document), 0);
  };

  // åˆæœŸè¡¨ç¤ºã‚„å‹•çš„è¿½åŠ ã«ã‚‚å¯¾å¿œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=> clearWaIn(document));
  } else {
    clearWaIn(document);
  }

  // MutationObserverã§å¾ŒæŒ¿å…¥ã•ã‚Œã¦ã‚‚æƒé™¤
  const mo = new MutationObserver(muts=>{
    muts.forEach(m=> m.addedNodes && m.addedNodes.forEach(n=>{
      if (n.nodeType === 1) clearWaIn(n);
    }));
  });
  try { mo.observe(document.documentElement, {childList:true, subtree:true}); } catch(e){}
})();
</script>


<script>
// === ã€Œã‚ã€é™¤å»ãƒ»å¼·åŒ–ç‰ˆï¼šã™ã¹ã¦ã® input/textarea ã‚’ç¶²ç¾…ï¼ˆæ–°è¦/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼å‹•çš„ç”Ÿæˆå¯¾å¿œï¼‰ ===
(function(){
  function clearWa(root){
    var scope = root || document;
    var nodes = scope.querySelectorAll('input, textarea');
    nodes.forEach(function(el){
      try{
        if (typeof el.value === 'string' && el.value.trim() === 'ã‚') el.value = '';
        if (typeof el.placeholder === 'string' && el.placeholder.trim() === 'ã‚') el.placeholder = '';
      }catch(e){}
    });
  }

  // ä½•åº¦ã‹å¾Œè¿½ã„ã§æƒé™¤ï¼ˆåˆæœŸåŒ–â†’éåŒæœŸã‚»ãƒƒãƒˆâ†’ã‚ªãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆç­‰ã«å¯¾å¿œï¼‰
  function multiSweep(root){
    clearWa(root);
    setTimeout(function(){ clearWa(root); }, 50);
    setTimeout(function(){ clearWa(root); }, 200);
    setTimeout(function(){ clearWa(root); }, 500);
  }

  var _openNew = window.openNewTemplateModal;
  window.openNewTemplateModal = function(){
    if (typeof _openNew === 'function') _openNew();
    setTimeout(function(){
      var modal = document.getElementById('templateModal') || document.getElementById('editTemplateModal') || document;
      multiSweep(modal);
    }, 0);
  };

  var _edit = window.editTemplateModal;
  window.editTemplateModal = function(id){
    if (typeof _edit === 'function') _edit(id);
    setTimeout(function(){
      var modal = document.getElementById('editTemplateModal') || document.getElementById('templateModal') || document;
      multiSweep(modal);
    }, 0);
  };

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚‚ä¸€åº¦
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ multiSweep(document); });
  } else {
    multiSweep(document);
  }

  // å¾Œã‹ã‚‰å·®ã—è¾¼ã¾ã‚Œã¦ã‚‚å³æƒé™¤
  try{
    var mo = new MutationObserver(function(muts){
      muts.forEach(function(m){
        (m.addedNodes || []).forEach(function(n){
          if (n.nodeType === 1) multiSweep(n);
        });
      });
    });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }catch(e){}
})();
</script>


<script>
// === dueDatePatchV1: æœŸæ—¥å…¥åŠ›ã®å¤‰æ›´ã‚’ç¢ºå®Ÿã«åæ˜ ï¼ˆéç ´å£Šãƒ»è¿½è¨˜ã®ã¿ï¼‰ ===
(function(){
  function bindDueDate(){
    var d = document.getElementById('dueDate');
    if(!d) return;
    if(!d.__boundDueDatePatchV1){
      d.addEventListener('input', function(){ try{ updateTemplate(); }catch(e){} });
      d.addEventListener('change', function(){ try{ updateTemplate(); }catch(e){} });
      d.__boundDueDatePatchV1 = true;
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bindDueDate);
  }else{
    bindDueDate();
  }
})();
</script>

</body>
</html>
<!-- management-edit-guard: injected to avoid breaking edit modal -->
