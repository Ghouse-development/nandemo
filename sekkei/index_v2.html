<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¨­è¨ˆãƒ»ICæ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | Gãƒã‚¦ã‚¹</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary-color: #4A90E2;
  --primary-hover: #357ABD;
  --secondary-color: #50E3C2;
  --danger-color: #E94B3C;
  --warning-color: #F5A623;
  --success-color: #7ED321;
  --text-primary: #2C3E50;
  --text-secondary: #7F8C8D;
  --text-muted: #BDC3C7;
  --bg-primary: #FFFFFF;
  --bg-secondary: #F8F9FA;
  --bg-tertiary: #ECF0F1;
  --border-color: #E1E8ED;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
}

body {
  font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-secondary);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #FFFFFF;
  padding: 20px;
}

.login-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 48px;
  box-shadow: var(--shadow-md);
  max-width: 420px;
  width: 100%;
  text-align: center;
}

.login-card h1 {
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 12px;
}

.login-card p {
  color: var(--text-secondary);
  margin-bottom: 24px;
  font-size: 15px;
}

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
.main-container {
  display: none;
  max-width: 1800px;
  margin: 0 auto;
  background: var(--bg-secondary);
  min-height: 100vh;
}

.main-container.show {
  display: block;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header {
  background: white;
  border-bottom: 1px solid var(--border-color);
  padding: 16px 32px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 24px;
}

.logo {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary-color);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

/* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.tabs-nav {
  background: white;
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  display: flex;
  gap: 8px;
}

.tab-nav-btn {
  padding: 16px 24px;
  border: none;
  background: transparent;
  font-size: 15px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab-nav-btn:hover {
  color: var(--text-primary);
  background: var(--bg-secondary);
}

.tab-nav-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
.tab-panel {
  display: none;
}

.tab-panel.active {
  display: block;
}

/* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
.toolbar {
  background: white;
  padding: 20px 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.toolbar-left {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  flex: 1;
}

.toolbar-right {
  display: flex;
  gap: 12px;
}

/* ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚¿ãƒ– */
.designer-tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.designer-tab {
  padding: 8px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.designer-tab:hover {
  background: var(--bg-tertiary);
}

.designer-tab.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* ãƒœã‚¿ãƒ³ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-hover);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
}

.btn-secondary:hover {
  opacity: 0.9;
}

.btn-ghost {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-primary);
}

.btn-ghost:hover {
  background: var(--bg-secondary);
}

.btn-danger {
  background: var(--danger-color);
  color: white;
}

.btn-danger:hover {
  opacity: 0.9;
}

.btn-small {
  padding: 6px 12px;
  font-size: 13px;
}

/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
.input, .select {
  padding: 10px 14px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  background: white;
  transition: all 0.2s;
}

.input:focus, .select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.input {
  min-width: 200px;
}

/* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
.cards-container {
  padding: 32px;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
  gap: 24px;
}

/* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰ */
.project-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s;
}

.project-card:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--bg-secondary);
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.card-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 12px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 600;
}

.badge-primary {
  background: #E8F4FD;
  color: var(--primary-color);
}

.badge-success {
  background: #E6F9F0;
  color: var(--success-color);
}

/* é€²æ—ãƒãƒ¼ */
.progress-section {
  margin-bottom: 20px;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.progress-label {
  font-size: 14px;
  color: var(--text-secondary);
}

.progress-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary-color);
}

.progress-bar {
  height: 8px;
  background: var(--bg-secondary);
  border-radius: 999px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
  transition: width 0.3s ease;
  border-radius: 999px;
}

/* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.task-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  font-size: 13px;
  transition: all 0.2s;
}

.task-item:hover {
  background: var(--bg-tertiary);
}

.task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.task-label {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
}

.task-email-btn {
  padding: 4px 8px;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transition: all 0.2s;
}

.task-item:hover .task-email-btn {
  opacity: 1;
}

.task-email-btn:hover {
  background: var(--primary-hover);
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

.modal.show {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: var(--radius-lg);
  width: min(800px, 90vw);
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
}

.modal-header {
  padding: 24px 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
}

.close {
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.2s;
}

.close:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.modal-body {
  padding: 32px;
}

.modal-footer {
  padding: 20px 32px;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

/* ãƒ•ã‚©ãƒ¼ãƒ  */
.form-group {
  margin-bottom: 24px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.form-textarea {
  min-height: 120px;
  resize: vertical;
}

.form-hint {
  margin-top: 6px;
  font-size: 13px;
  color: var(--text-muted);
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-saving {
  background: #FFF4E6;
  color: var(--warning-color);
}

.status-saving .status-dot {
  background: var(--warning-color);
  animation: pulse 1.5s infinite;
}

.status-saved {
  background: #E6F9F0;
  color: var(--success-color);
}

.status-saved .status-dot {
  background: var(--success-color);
}

.status-error {
  background: #FFE6E6;
  color: var(--danger-color);
}

.status-error .status-dot {
  background: var(--danger-color);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ãƒ†ãƒ¼ãƒ–ãƒ« */
.table-container {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table thead {
  background: var(--bg-secondary);
}

.table th {
  padding: 16px 20px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table td {
  padding: 16px 20px;
  border-top: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-primary);
}

.table tbody tr:hover {
  background: var(--bg-secondary);
}

/* ç©ºçŠ¶æ…‹ */
.empty-state {
  padding: 80px 40px;
  text-align: center;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-description {
  font-size: 14px;
  margin-bottom: 24px;
}

/* ãƒ¡ãƒ¼ãƒ«å‡ºåŠ› */
.email-output {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 20px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.8;
  white-space: pre-wrap;
  margin: 16px 0;
  max-height: 400px;
  overflow-y: auto;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 1200px) {
  .cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
  }
}

@media (max-width: 768px) {
  .header {
    padding: 12px 16px;
  }

  .toolbar {
    padding: 16px;
  }

  .cards-container {
    padding: 16px;
  }

  .cards-grid {
    grid-template-columns: 1fr;
  }

  .tasks-grid {
    grid-template-columns: 1fr;
  }

  .modal-content {
    width: 95vw;
  }

  .modal-body {
    padding: 20px;
  }
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
.spinner {
  border: 3px solid var(--bg-secondary);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 40px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 16px 24px;
  box-shadow: var(--shadow-lg);
  display: none;
  align-items: center;
  gap: 12px;
  z-index: 2000;
}

.toast.show {
  display: flex;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-success {
  border-left: 4px solid var(--success-color);
}

.toast-error {
  border-left: 4px solid var(--danger-color);
}

.toast-warning {
  border-left: 4px solid var(--warning-color);
}
</style>
</head>
<body>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="loginContainer" class="login-container">
  <div class="login-card">
    <h1>è¨­è¨ˆãƒ»ICæ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
    <div style="margin-bottom: 20px;">
      <input type="email" class="form-input" id="loginEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width: 100%; margin-bottom: 12px;">
      <input type="password" class="form-input" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width: 100%;">
    </div>
    <button class="btn btn-primary" style="width: 100%;" onclick="signIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div id="mainContainer" class="main-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-left">
      <div class="logo">Gãƒã‚¦ã‚¹ è¨­è¨ˆç®¡ç†</div>
    </div>
    <div class="header-right">
      <div class="status-indicator status-saved" id="statusIndicator">
        <span class="status-dot"></span>
        <span id="statusText">ä¿å­˜æ¸ˆã¿</span>
      </div>
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName" class="user-name"></span>
      </div>
      <button class="btn btn-ghost btn-small" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <nav class="tabs-nav">
    <button class="tab-nav-btn active" onclick="switchTab('projects', this)">ğŸ“‹ æ¡ˆä»¶ç®¡ç†</button>
    <button class="tab-nav-btn" onclick="switchTab('templates', this)">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
    <button class="tab-nav-btn" onclick="switchTab('vendors', this)">ğŸ‘¥ æ¥­è€…ç®¡ç†</button>
    <button class="tab-nav-btn" onclick="switchTab('mappings', this)">ğŸ”— ã‚¿ã‚¹ã‚¯è¨­å®š</button>
  </nav>

  <!-- æ¡ˆä»¶ç®¡ç†ã‚¿ãƒ– -->
  <div id="projectsTab" class="tab-panel active">
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="designer-tabs" id="designerTabs"></div>
        <input type="text" class="input" id="searchQuery" placeholder="æ¤œç´¢..." oninput="renderProjects()">
        <select class="select" id="specFilter" onchange="renderProjects()">
          <option value="">ã™ã¹ã¦ã®ä»•æ§˜</option>
          <option>LIFE</option>
          <option>LIFE+</option>
          <option>HOURS</option>
          <option>LACIE</option>
          <option>LIFEãƒªãƒŸ</option>
          <option>LIFE+ãƒªãƒŸ</option>
        </select>
      </div>
      <div class="toolbar-right">
        <button class="btn btn-ghost" onclick="openDesignerModal()">è¨­è¨ˆå£«ç®¡ç†</button>
        <button class="btn btn-primary" onclick="openProjectModal()">+ æ¡ˆä»¶è¿½åŠ </button>
      </div>
    </div>
    <div class="cards-container">
      <div class="cards-grid" id="projectsGrid"></div>
      <div class="empty-state" id="emptyProjects" style="display: none;">
        <div class="empty-icon">ğŸ“‹</div>
        <div class="empty-title">æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>
        <div class="empty-description">ã€Œæ¡ˆä»¶è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ–°ã—ã„æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
        <button class="btn btn-primary" onclick="openProjectModal()">+ æ¡ˆä»¶è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ãƒ– -->
  <div id="templatesTab" class="tab-panel">
    <div class="toolbar">
      <div class="toolbar-left">
        <select class="select" id="categoryFilter" onchange="renderTemplates()">
          <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
          <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
          <option value="IC">IC</option>
        </select>
      </div>
      <div class="toolbar-right">
        <button class="btn btn-primary" onclick="openTemplateModal()">+ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </button>
      </div>
    </div>
    <div class="cards-container">
      <div class="table-container" id="templatesTable"></div>
    </div>
  </div>

  <!-- æ¥­è€…ç®¡ç†ã‚¿ãƒ– -->
  <div id="vendorsTab" class="tab-panel">
    <div class="toolbar">
      <div class="toolbar-left">
        <select class="select" id="vendorTemplateFilter" onchange="renderVendors()">
          <option value="">ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</option>
        </select>
      </div>
      <div class="toolbar-right">
        <button class="btn btn-primary" onclick="openVendorModal()">+ æ¥­è€…è¿½åŠ </button>
      </div>
    </div>
    <div class="cards-container">
      <div class="table-container" id="vendorsTable"></div>
    </div>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯è¨­å®šã‚¿ãƒ– -->
  <div id="mappingsTab" class="tab-panel">
    <div class="cards-container">
      <div style="background: white; border-radius: var(--radius-lg); padding: 32px;">
        <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">ã‚¿ã‚¹ã‚¯ã¨ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç´ã¥ã‘è¨­å®š</h2>
        <p style="margin-bottom: 32px; color: var(--text-secondary);">å„ã‚¿ã‚¹ã‚¯ã§ä½¿ç”¨ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚è¨­å®šå¾Œã€æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã®ã‚¿ã‚¹ã‚¯ã‹ã‚‰ç›´æ¥ãƒ¡ãƒ¼ãƒ«ä½œæˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
        <div id="mappingsGrid" style="display: grid; gap: 16px;"></div>
        <div style="margin-top: 32px; text-align: right;">
          <button class="btn btn-primary" onclick="saveMappings()">è¨­å®šã‚’ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ¡ˆä»¶è¿½åŠ /ç·¨é›† -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="projectModalTitle">æ¡ˆä»¶è¿½åŠ </h2>
      <button class="close" onclick="closeProjectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ãŠå®¢æ§˜å *</label>
        <input type="text" class="form-input" id="projectCustomer" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒæ§˜">
      </div>
      <div class="form-group">
        <label class="form-label">æ‹…å½“è¨­è¨ˆå£« *</label>
        <select class="form-select" id="projectAssignedTo"></select>
      </div>
      <div class="form-group">
        <label class="form-label">ä»•æ§˜</label>
        <select class="form-select" id="projectSpecifications">
          <option>LIFE</option>
          <option>LIFE+</option>
          <option>HOURS</option>
          <option>LACIE</option>
          <option>LIFEãƒªãƒŸ</option>
          <option>LIFE+ãƒªãƒŸ</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢</label>
        <textarea class="form-textarea" id="projectMemo" placeholder="è¦æœ›ãƒ»æ³¨æ„ç‚¹ãªã©"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveProject()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ /ç·¨é›† -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="templateModalTitle">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </h2>
      <button class="close" onclick="closeTemplateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID *</label>
        <input type="text" class="form-input" id="templateId" placeholder="ä¾‹ï¼šnew-template">
        <div class="form-hint">è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½</div>
      </div>
      <div class="form-group">
        <label class="form-label">è¡¨ç¤ºå *</label>
        <input type="text" class="form-input" id="templateDisplayName" placeholder="ä¾‹ï¼šæ–°ä¼šç¤¾åï¼ˆä½œæ¥­å†…å®¹ï¼‰">
      </div>
      <div class="form-group">
        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
        <select class="form-select" id="templateCategory">
          <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
          <option value="IC">IC</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ä¼šç¤¾å *</label>
        <input type="text" class="form-input" id="templateCompany" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã€‡ã€‡">
      </div>
      <div class="form-group">
        <label class="form-label">å®›å…ˆå</label>
        <input type="text" class="form-input" id="templateContact" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="text" class="form-input" id="templateEmail" placeholder="ä¾‹ï¼štanaka@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ *</label>
        <input type="text" class="form-input" id="templateSubjectFormat" placeholder="ä¾‹ï¼š{customerName}æ§˜ æ–°è¦ã€‡ã€‡ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}">
        <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{customerName}, {dueDate}, {staffName}</div>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ *</label>
        <textarea class="form-textarea" id="templateText" rows="10" placeholder="ä¾‹:&#10;{company}&#10;{contact}&#10;&#10;ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚"></textarea>
        <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTemplateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveTemplate()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ¥­è€…è¿½åŠ /ç·¨é›† -->
<div id="vendorModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="vendorModalTitle">æ¥­è€…è¿½åŠ </h2>
      <button class="close" onclick="closeVendorModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ *</label>
        <select class="form-select" id="vendorTemplateId"></select>
        <div class="form-hint">ã“ã®æ¥­è€…ãŒã©ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ç´ã¥ãã‹ã‚’é¸æŠ</div>
      </div>
      <div class="form-group">
        <label class="form-label">æ¥­è€…ID *</label>
        <input type="text" class="form-input" id="vendorId" placeholder="ä¾‹ï¼šnew-vendor">
        <div class="form-hint">è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½</div>
      </div>
      <div class="form-group">
        <label class="form-label">ä¼šç¤¾å *</label>
        <input type="text" class="form-input" id="vendorCompany" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã€‡ã€‡">
      </div>
      <div class="form-group">
        <label class="form-label">æ‹…å½“è€…å *</label>
        <input type="text" class="form-input" id="vendorContact" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜">
      </div>
      <div class="form-group">
        <label class="form-label">é›»è©±ç•ªå·</label>
        <input type="text" class="form-input" id="vendorTel" placeholder="ä¾‹ï¼š090-1234-5678">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
        <input type="text" class="form-input" id="vendorEmail" placeholder="ä¾‹ï¼štanaka@example.com">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeVendorModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveVendor()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šè¨­è¨ˆå£«ç®¡ç† -->
<div id="designerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">è¨­è¨ˆå£«ç®¡ç†</h2>
      <button class="close" onclick="closeDesignerModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">æ–°ã—ã„è¨­è¨ˆå£«ã‚’è¿½åŠ </label>
        <div style="display: flex; gap: 12px;">
          <input type="text" class="form-input" id="newDesignerName" placeholder="è¨­è¨ˆå£«å" style="flex: 1;">
          <button class="btn btn-primary" onclick="addDesigner()">è¿½åŠ </button>
        </div>
      </div>
      <div id="designerList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeDesignerModal()">å®Œäº†</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ¡ãƒ¼ãƒ«ä½œæˆ -->
<div id="emailModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ä½œæˆ</h2>
      <button class="close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div class="modal-body" id="emailComposerContent"></div>
  </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
<div id="toast" class="toast"></div>

<script>
// ============================================
// SupabaseåˆæœŸåŒ–
// ============================================
const SUPABASE_URL = 'https://twzsirpfudqwboeyakta.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3enNpcnBmdWRxd2JvZXlha3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzM4NjgsImV4cCI6MjA3NzAwOTg2OH0.E_8GxfsO6Scjc0dDoEoyxq3i4lfvNxYZvnSL1OlSDSM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentUser = null;
let projects = [];
let designers = [];
let emailTemplates = [];
let vendors = [];
let taskMappings = {};
let currentDesignerTab = 'ALL';
let editingProjectId = null;
let editingTemplateId = null;
let editingVendorId = null;

// ã‚¿ã‚¹ã‚¯å®šç¾©
const TASK_NAMES = {
  meeting0: '0å›ç›®æ‰“åˆã›',
  floorPlan: 'é–“å–ã‚Šç¢ºå®š',
  initialPrep: 'åˆå›æº–å‚™',
  finalDrawing: 'ç¢ºå®šå›³é¢',
  checklist: 'ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ',
  workingDrawing: 'å®Ÿæ–½å›³ä¾é ¼',
  plumbing: 'çµ¦æ’æ°´',
  ventilation: 'æ›æ°—',
  solar: 'å¤ªé™½å…‰',
  evoltz: 'ã‚¨ãƒœãƒ«ãƒ„',
  sash: 'ã‚µãƒƒã‚·ä¾é ¼',
  structure: 'æ§‹é€ ä¾é ¼',
  groundSurvey: 'åœ°ç›¤èª¿æŸ»',
  application: 'ç”³è«‹ä¾é ¼',
  exterior: 'å¤–æ§‹ä¾é ¼',
  dandori: 'ãƒ€ãƒ³ãƒ‰ãƒªUP'
};

// ============================================
// èªè¨¼å‡¦ç†
// ============================================
async function signIn() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  if (!email || !password) {
    showToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  try {
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });

    if (error) throw error;

    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ - onAuthStateChangeã§å‡¦ç†ã•ã‚Œã‚‹ã®ã§reloadã¯ä¸è¦
  } catch (error) {
    console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
  }
}

async function signOut() {
  try {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
    location.reload();
  } catch (error) {
    console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();

  if (session) {
    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContainer').classList.add('show');

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤ºï¼ˆ@ã‚ˆã‚Šå‰ã®éƒ¨åˆ†ï¼‰
    const displayName = currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = displayName;

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã‚’è¨­å®š
    document.getElementById('userAvatar').src = 'https://via.placeholder.com/32/4A90E2/FFFFFF?text=' + displayName.charAt(0).toUpperCase();

    await init();
  } else {
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContainer').classList.remove('show');
  }
}

// èªè¨¼çŠ¶æ…‹å¤‰æ›´ã‚’ç›£è¦–
supabase.auth.onAuthStateChange(async (event, session) => {
  // SIGNED_INã‚¤ãƒ™ãƒ³ãƒˆã¯åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿å‡¦ç†
  if (event === 'SIGNED_IN' && !currentUser) {
    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContainer').classList.add('show');

    const displayName = currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userAvatar').src = 'https://via.placeholder.com/32/4A90E2/FFFFFF?text=' + displayName.charAt(0).toUpperCase();

    await init();
  } else if (event === 'SIGNED_OUT') {
    location.reload();
  }
});

// ============================================
// åˆæœŸåŒ–
// ============================================
async function init() {
  showStatus('èª­ã¿è¾¼ã¿ä¸­...', 'saving');
  try {
    await Promise.all([
      loadDesigners(),
      loadProjects(),
      loadEmailTemplates(),
      loadVendors(),
      loadTaskMappings()
    ]);

    renderDesignerTabs();
    renderProjects();
    renderTemplates();
    renderVendors();
    renderMappings();

    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  } catch (error) {
    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
  }
}

// ============================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// ============================================
async function loadDesigners() {
  const { data, error } = await supabase
    .from('designers')
    .select('*')
    .order('name');
  if (error) throw error;
  designers = data || [];
}

async function loadProjects() {
  const { data, error } = await supabase
    .from('projects')
    .select('*')
    .order('created_at', { ascending: false });
  if (error) throw error;
  projects = data || [];
}

async function loadEmailTemplates() {
  const { data, error } = await supabase
    .from('email_templates')
    .select('*')
    .order('display_name');
  if (error) throw error;
  emailTemplates = data || [];
}

async function loadVendors() {
  const { data, error } = await supabase
    .from('template_vendors')
    .select('*')
    .order('company');
  if (error) throw error;
  vendors = data || [];
}

async function loadTaskMappings() {
  const { data, error } = await supabase
    .from('task_template_mappings')
    .select('*');
  if (error) throw error;
  taskMappings = {};
  (data || []).forEach(mapping => {
    taskMappings[mapping.task_key] = mapping.template_id;
  });
}

// ============================================
// UIåˆ¶å¾¡
// ============================================
function switchTab(tabName, element) {
  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) {
    element.classList.add('active');
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼štabNameã«åŸºã¥ã„ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
    const buttons = document.querySelectorAll('.tab-nav-btn');
    buttons.forEach((btn, index) => {
      const tabs = ['projects', 'templates', 'vendors', 'mappings'];
      if (tabs[index] === tabName) {
        btn.classList.add('active');
      }
    });
  }
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');
}

function showStatus(message, type) {
  const indicator = document.getElementById('statusIndicator');
  const text = document.getElementById('statusText');
  indicator.className = 'status-indicator status-' + type;
  text.textContent = message;
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.className = 'toast toast-' + type + ' show';
  toast.textContent = message;
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// ============================================
// æ¡ˆä»¶ç®¡ç†
// ============================================
function renderDesignerTabs() {
  const container = document.getElementById('designerTabs');
  const activeCount = projects.filter(p => p.status !== 'completed').length;

  let html = `<button class="designer-tab ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="setDesignerTab('ALL')">å…¨æ¡ˆä»¶ (${activeCount})</button>`;

  designers.forEach(designer => {
    const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
    html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
  });

  container.innerHTML = html;
}

function setDesignerTab(name) {
  currentDesignerTab = name;
  renderDesignerTabs();
  renderProjects();
}

function renderProjects() {
  const container = document.getElementById('projectsGrid');
  const emptyState = document.getElementById('emptyProjects');

  let filtered = projects.filter(p => {
    if (currentDesignerTab !== 'ALL' && p.assigned_to !== currentDesignerTab) return false;
    if (p.status === 'completed') return false;

    const query = document.getElementById('searchQuery').value.toLowerCase();
    if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

    const specFilter = document.getElementById('specFilter').value;
    if (specFilter && p.specifications !== specFilter) return false;

    return true;
  });

  if (filtered.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  container.style.display = 'grid';
  emptyState.style.display = 'none';
  container.innerHTML = filtered.map(project => renderProjectCard(project)).join('');
}

function renderProjectCard(project) {
  const progress = calculateProgress(project);
  const progressData = project.progress || {};

  const tasksHtml = Object.keys(TASK_NAMES).map(key => {
    const task = progressData[key] || { completed: false, date: '', state: '' };
    const hasMapping = taskMappings[key];
    const emailBtn = hasMapping ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')">ğŸ“§</button>` : '';

    return `
      <div class="task-item">
        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}
          onchange="updateTaskStatus('${project.id}', '${key}', this.checked)">
        <span class="task-label">${TASK_NAMES[key]}</span>
        ${emailBtn}
      </div>
    `;
  }).join('');

  return `
    <div class="project-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            ${project.customer}
            <span class="badge badge-primary">${project.specifications || 'LIFE'}</span>
          </div>
          <div class="card-subtitle">æ‹…å½“ï¼š${project.assigned_to}</div>
        </div>
        <button class="btn btn-ghost btn-small" onclick="editProject('${project.id}')">ç·¨é›†</button>
      </div>
      <div class="progress-section">
        <div class="progress-header">
          <span class="progress-label">é€²æ—çŠ¶æ³</span>
          <span class="progress-value">${progress}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%"></div>
        </div>
      </div>
      <div class="tasks-grid">${tasksHtml}</div>
      ${project.memo ? `<div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md); margin-top: 16px; font-size: 14px; color: var(--text-secondary);">${project.memo}</div>` : ''}
      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--bg-secondary); display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 13px; color: var(--text-muted);">æ›´æ–°: ${formatDateTime(project.updated_at)}</span>
        <button class="btn btn-danger btn-small" onclick="deleteProject('${project.id}')">å‰Šé™¤</button>
      </div>
    </div>
  `;
}

function calculateProgress(project) {
  const progressData = project.progress || {};
  const keys = Object.keys(TASK_NAMES);
  const completed = keys.filter(key => progressData[key]?.completed).length;
  return Math.round((completed / keys.length) * 100);
}

function formatDateTime(dateStr) {
  if (!dateStr) return 'â€”';
  const d = new Date(dateStr);
  return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

async function updateTaskStatus(projectId, taskKey, completed) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].completed = completed;
  if (completed && !progressData[taskKey].date) {
    progressData[taskKey].date = new Date().toISOString().split('T')[0];
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

function openProjectModal(projectId = null) {
  editingProjectId = projectId;
  const modal = document.getElementById('projectModal');
  const title = document.getElementById('projectModalTitle');

  if (projectId) {
    const project = projects.find(p => p.id === projectId);
    title.textContent = 'æ¡ˆä»¶ç·¨é›†';
    document.getElementById('projectCustomer').value = project.customer;
    document.getElementById('projectAssignedTo').value = project.assigned_to;
    document.getElementById('projectSpecifications').value = project.specifications || 'LIFE';
    document.getElementById('projectMemo').value = project.memo || '';
  } else {
    title.textContent = 'æ¡ˆä»¶è¿½åŠ ';
    document.getElementById('projectCustomer').value = '';
    document.getElementById('projectSpecifications').value = 'LIFE';
    document.getElementById('projectMemo').value = '';
  }

  const assignedToSelect = document.getElementById('projectAssignedTo');
  assignedToSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
    designers.map(d => `<option value="${d.name}">${d.name}</option>`).join('');

  modal.classList.add('show');
}

function closeProjectModal() {
  document.getElementById('projectModal').classList.remove('show');
  editingProjectId = null;
}

async function saveProject() {
  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value;
  const specifications = document.getElementById('projectSpecifications').value;
  const memo = document.getElementById('projectMemo').value.trim();

  if (!customer || !assignedTo) {
    showToast('ãŠå®¢æ§˜åã¨æ‹…å½“è¨­è¨ˆå£«ã¯å¿…é ˆã§ã™', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const blankProgress = {};
  Object.keys(TASK_NAMES).forEach(key => {
    blankProgress[key] = { completed: false, date: '', state: '' };
  });

  if (editingProjectId) {
    const project = projects.find(p => p.id === editingProjectId);
    const { error } = await supabase
      .from('projects')
      .update({
        customer,
        assigned_to: assignedTo,
        specifications,
        memo,
        updated_at: new Date().toISOString()
      })
      .eq('id', editingProjectId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    Object.assign(project, { customer, assigned_to: assignedTo, specifications, memo, updated_at: new Date().toISOString() });
  } else {
    const newProject = {
      uid: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      customer,
      assigned_to: assignedTo,
      specifications,
      memo,
      status: 'active',
      progress: blankProgress,
      created_by: currentUser.id
    };

    const { data, error } = await supabase
      .from('projects')
      .insert([newProject])
      .select();

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    projects.unshift(data[0]);
  }

  closeProjectModal();
  renderDesignerTabs();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('æ¡ˆä»¶ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

function editProject(projectId) {
  openProjectModal(projectId);
}

async function deleteProject(projectId) {
  if (!confirm('ã“ã®æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .delete()
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  projects = projects.filter(p => p.id !== projectId);
  renderDesignerTabs();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// è¨­è¨ˆå£«ç®¡ç†
// ============================================
function openDesignerModal() {
  renderDesignerList();
  document.getElementById('designerModal').classList.add('show');
}

function closeDesignerModal() {
  document.getElementById('designerModal').classList.remove('show');
}

function renderDesignerList() {
  const container = document.getElementById('designerList');
  container.innerHTML = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">ç™»éŒ²æ¸ˆã¿è¨­è¨ˆå£«</h3>' +
    '<div class="table-container"><table class="table"><thead><tr><th>è¨­è¨ˆå£«å</th><th>æ‹…å½“æ¡ˆä»¶æ•°</th><th>æ“ä½œ</th></tr></thead><tbody>' +
    designers.map(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      return `
        <tr>
          <td><strong>${designer.name}</strong></td>
          <td>${count}ä»¶</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteDesigner('${designer.id}')">å‰Šé™¤</button></td>
        </tr>
      `;
    }).join('') +
    '</tbody></table></div>';
}

async function addDesigner() {
  const name = document.getElementById('newDesignerName').value.trim();
  if (!name) {
    showToast('è¨­è¨ˆå£«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹è¨­è¨ˆå£«åã§ã™', 'error');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');
  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, created_by: currentUser.id }])
    .select();

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerName').value = '';
  renderDesignerList();
  renderDesignerTabs();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('è¨­è¨ˆå£«ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteDesigner(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('ã“ã®è¨­è¨ˆå£«ã¯æ¡ˆä»¶ã«å‰²å½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚æ¡ˆä»¶ã®æ‹…å½“ã‚’å¤‰æ›´ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  if (!confirm(`${designer.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerList();
  renderDesignerTabs();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('è¨­è¨ˆå£«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
// ============================================
function renderTemplates() {
  const container = document.getElementById('templatesTable');
  const categoryFilter = document.getElementById('categoryFilter').value;

  let filtered = emailTemplates;
  if (categoryFilter) {
    filtered = emailTemplates.filter(t => t.category === categoryFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“§</div><div class="empty-title">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-description">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¦ã€æ¡ˆä»¶ã‹ã‚‰ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã§ãã¾ã™</div><button class="btn btn-primary" onclick="openTemplateModal()">+ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>è¡¨ç¤ºå</th>
          <th>ã‚«ãƒ†ã‚´ãƒª</th>
          <th>ä¼šç¤¾å</th>
          <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(template => `
          <tr>
            <td><strong>${template.display_name}</strong></td>
            <td><span class="badge ${template.category === 'IC' ? 'badge-success' : 'badge-primary'}">${template.category}</span></td>
            <td>${template.company}</td>
            <td>${template.email || 'â€”'}</td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost btn-small" onclick="editTemplate('${template.id}')">ç·¨é›†</button>
                <button class="btn btn-danger btn-small" onclick="deleteTemplate('${template.id}')">å‰Šé™¤</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function openTemplateModal(templateId = null) {
  editingTemplateId = templateId;
  const modal = document.getElementById('templateModal');
  const title = document.getElementById('templateModalTitle');

  if (templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    title.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†';
    document.getElementById('templateId').value = template.template_id;
    document.getElementById('templateId').disabled = true;
    document.getElementById('templateDisplayName').value = template.display_name;
    document.getElementById('templateCategory').value = template.category;
    document.getElementById('templateCompany').value = template.company;
    document.getElementById('templateContact').value = template.contact || '';
    document.getElementById('templateEmail').value = template.email || '';
    document.getElementById('templateSubjectFormat').value = template.subject_format || '';
    document.getElementById('templateText').value = template.template_text || '';
  } else {
    title.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ ';
    document.getElementById('templateId').value = '';
    document.getElementById('templateId').disabled = false;
    document.getElementById('templateDisplayName').value = '';
    document.getElementById('templateCategory').value = 'è¨­è¨ˆ';
    document.getElementById('templateCompany').value = '';
    document.getElementById('templateContact').value = '';
    document.getElementById('templateEmail').value = '';
    document.getElementById('templateSubjectFormat').value = '';
    document.getElementById('templateText').value = '';
  }

  modal.classList.add('show');
}

function closeTemplateModal() {
  document.getElementById('templateModal').classList.remove('show');
  editingTemplateId = null;
}

async function saveTemplate() {
  const templateId = document.getElementById('templateId').value.trim();
  const displayName = document.getElementById('templateDisplayName').value.trim();
  const category = document.getElementById('templateCategory').value;
  const company = document.getElementById('templateCompany').value.trim();
  const contact = document.getElementById('templateContact').value.trim();
  const email = document.getElementById('templateEmail').value.trim();
  const subjectFormat = document.getElementById('templateSubjectFormat').value.trim();
  const templateText = document.getElementById('templateText').value.trim();

  if (!templateId || !displayName || !company || !subjectFormat || !templateText) {
    showToast('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const templateData = {
    template_id: templateId,
    display_name: displayName,
    category,
    company,
    contact,
    email,
    subject_format: subjectFormat,
    template_text: templateText,
    has_special_content: false,
    has_sub_options: false,
    created_by: currentUser.id
  };

  if (editingTemplateId) {
    const { error } = await supabase
      .from('email_templates')
      .update(templateData)
      .eq('id', editingTemplateId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    const template = emailTemplates.find(t => t.id === editingTemplateId);
    Object.assign(template, templateData);
  } else {
    const { data, error } = await supabase
      .from('email_templates')
      .insert([templateData])
      .select();

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    emailTemplates.push(data[0]);
  }

  closeTemplateModal();
  renderTemplates();
  renderMappings();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

function editTemplate(templateId) {
  openTemplateModal(templateId);
}

async function deleteTemplate(templateId) {
  if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('email_templates')
    .delete()
    .eq('id', templateId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  emailTemplates = emailTemplates.filter(t => t.id !== templateId);
  renderTemplates();
  renderMappings();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// æ¥­è€…ç®¡ç†
// ============================================
function renderVendors() {
  const container = document.getElementById('vendorsTable');
  const filterSelect = document.getElementById('vendorTemplateFilter');
  const templateFilter = filterSelect.value;

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¡¨ç¤ºï¼‰
  filterSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</option>' +
    emailTemplates.map(t =>
      `<option value="${t.template_id}">${t.display_name}</option>`
    ).join('');
  if (templateFilter) filterSelect.value = templateFilter;

  let filtered = vendors;
  if (templateFilter) {
    filtered = vendors.filter(v => v.template_id === templateFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-title">æ¥­è€…æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-description">æ¥­è€…æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ä½¿ç”¨ã§ãã¾ã™</div><button class="btn btn-primary" onclick="openVendorModal()">+ æ¥­è€…è¿½åŠ </button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>ä¼šç¤¾å</th>
          <th>æ‹…å½“è€…</th>
          <th>é›»è©±ç•ªå·</th>
          <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
          <th>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(vendor => {
          const template = emailTemplates.find(t => t.template_id === vendor.template_id);
          return `
            <tr>
              <td><strong>${vendor.company}</strong></td>
              <td>${vendor.contact}</td>
              <td>${vendor.tel || 'â€”'}</td>
              <td>${vendor.email}</td>
              <td>${template ? template.display_name : 'â€”'}</td>
              <td>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-ghost btn-small" onclick="editVendor('${vendor.id}')">ç·¨é›†</button>
                  <button class="btn btn-danger btn-small" onclick="deleteVendor('${vendor.id}')">å‰Šé™¤</button>
                </div>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

function openVendorModal(vendorId = null) {
  editingVendorId = vendorId;
  const modal = document.getElementById('vendorModal');
  const title = document.getElementById('vendorModalTitle');

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°
  const templateSelect = document.getElementById('vendorTemplateId');
  templateSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
    emailTemplates.map(t => `<option value="${t.template_id}">${t.display_name}</option>`).join('');

  if (vendorId) {
    const vendor = vendors.find(v => v.id === vendorId);
    title.textContent = 'æ¥­è€…ç·¨é›†';
    document.getElementById('vendorTemplateId').value = vendor.template_id;
    document.getElementById('vendorId').value = vendor.vendor_id;
    document.getElementById('vendorId').disabled = true;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact;
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email;
  } else {
    title.textContent = 'æ¥­è€…è¿½åŠ ';
    document.getElementById('vendorTemplateId').value = '';
    document.getElementById('vendorId').value = '';
    document.getElementById('vendorId').disabled = false;
    document.getElementById('vendorCompany').value = '';
    document.getElementById('vendorContact').value = '';
    document.getElementById('vendorTel').value = '';
    document.getElementById('vendorEmail').value = '';
  }

  modal.classList.add('show');
}

function closeVendorModal() {
  document.getElementById('vendorModal').classList.remove('show');
  editingVendorId = null;
}

async function saveVendor() {
  const templateId = document.getElementById('vendorTemplateId').value;
  const vendorId = document.getElementById('vendorId').value.trim();
  const company = document.getElementById('vendorCompany').value.trim();
  const contact = document.getElementById('vendorContact').value.trim();
  const tel = document.getElementById('vendorTel').value.trim();
  const email = document.getElementById('vendorEmail').value.trim();

  if (!templateId || !vendorId || !company || !contact || !email) {
    showToast('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const vendorData = {
    template_id: templateId,
    vendor_id: vendorId,
    company,
    contact,
    tel,
    email,
    created_by: currentUser.id
  };

  if (editingVendorId) {
    const { error } = await supabase
      .from('template_vendors')
      .update(vendorData)
      .eq('id', editingVendorId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    const vendor = vendors.find(v => v.id === editingVendorId);
    Object.assign(vendor, vendorData);
  } else {
    const { data, error } = await supabase
      .from('template_vendors')
      .insert([vendorData])
      .select();

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    vendors.push(data[0]);
  }

  closeVendorModal();
  renderVendors();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('æ¥­è€…æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

function editVendor(vendorId) {
  openVendorModal(vendorId);
}

async function deleteVendor(vendorId) {
  if (!confirm('ã“ã®æ¥­è€…æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('template_vendors')
    .delete()
    .eq('id', vendorId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  vendors = vendors.filter(v => v.id !== vendorId);
  renderVendors();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('æ¥­è€…æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ã‚¿ã‚¹ã‚¯-ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç´ã¥ã‘
// ============================================
function renderMappings() {
  const container = document.getElementById('mappingsGrid');

  container.innerHTML = Object.keys(TASK_NAMES).map(taskKey => {
    const templateOptions = emailTemplates.map(t =>
      `<option value="${t.template_id}" ${taskMappings[taskKey] === t.template_id ? 'selected' : ''}>
        ${t.display_name} (${t.category})
      </option>`
    ).join('');

    return `
      <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
        <label style="flex: 0 0 200px; font-weight: 600;">${TASK_NAMES[taskKey]}</label>
        <select class="form-select" id="mapping_${taskKey}" style="flex: 1;">
          <option value="">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—</option>
          ${templateOptions}
        </select>
      </div>
    `;
  }).join('');
}

async function saveMappings() {
  showStatus('ä¿å­˜ä¸­...', 'saving');

  const newMappings = {};
  Object.keys(TASK_NAMES).forEach(taskKey => {
    const select = document.getElementById('mapping_' + taskKey);
    if (select && select.value) {
      newMappings[taskKey] = select.value;
    }
  });

  // æ—¢å­˜ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‰Šé™¤
  const { error: deleteError } = await supabase
    .from('task_template_mappings')
    .delete()
    .neq('id', '00000000-0000-0000-0000-000000000000');

  if (deleteError) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + deleteError.message, 'error');
    return;
  }

  // æ–°ã—ã„ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æŒ¿å…¥
  const mappingsToInsert = Object.keys(newMappings).map(taskKey => ({
    task_key: taskKey,
    template_id: newMappings[taskKey]
  }));

  if (mappingsToInsert.length > 0) {
    const { error: insertError } = await supabase
      .from('task_template_mappings')
      .insert(mappingsToInsert);

    if (insertError) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + insertError.message, 'error');
      return;
    }
  }

  taskMappings = newMappings;
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¿ã‚¹ã‚¯è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ãƒ¡ãƒ¼ãƒ«ä½œæˆ
// ============================================
function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const templateId = taskMappings[taskKey];
  if (!templateId) {
    showToast('ã“ã®ã‚¿ã‚¹ã‚¯ã«ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã€Œã‚¿ã‚¹ã‚¯è¨­å®šã€ã‚¿ãƒ–ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) {
    showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  const taskDate = project.progress?.[taskKey]?.date;
  const dueDate = taskDate || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  content.innerHTML = `
    <div class="form-group">
      <label class="form-label">æ‹…å½“è€…åï¼ˆç½²åç”¨ï¼‰</label>
      <input type="text" class="form-input" id="emailStaffName" value="${project.assigned_to}">
    </div>
    <div class="form-group">
      <label class="form-label">æœŸæ—¥</label>
      <input type="date" class="form-input" id="emailDueDate" value="${dueDate}">
    </div>
    <div class="form-group">
      <label class="form-label">å†…å®¹è©³ç´°ï¼ˆä»»æ„ï¼‰</label>
      <textarea class="form-textarea" id="emailSpecialContent" placeholder="å¿…è¦ã«å¿œã˜ã¦è©³ç´°ã‚’å…¥åŠ›"></textarea>
    </div>
    <button class="btn btn-primary" onclick="generateEmail('${project.id}', '${taskKey}')">ãƒ¡ãƒ¼ãƒ«ã‚’ç”Ÿæˆ</button>
    <div id="generatedEmailSection" style="display: none; margin-top: 32px;">
      <h3 style="margin-bottom: 12px; font-size: 18px; font-weight: 600;">ğŸ“§ ä»¶å</h3>
      <div id="emailSubject" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailSubject')">ä»¶åã‚’ã‚³ãƒ”ãƒ¼</button>

      <h3 style="margin: 24px 0 12px; font-size: 18px; font-weight: 600;">ğŸ“® å®›å…ˆ</h3>
      <div id="emailAddress" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailAddress')">å®›å…ˆã‚’ã‚³ãƒ”ãƒ¼</button>

      <h3 style="margin: 24px 0 12px; font-size: 18px; font-weight: 600;">ğŸ“¨ æœ¬æ–‡</h3>
      <div id="emailBody" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailBody')">æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
  `;

  modal.classList.add('show');
}

function generateEmail(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const templateId = taskMappings[taskKey];
  const template = emailTemplates.find(t => t.template_id === templateId);

  const staffName = document.getElementById('emailStaffName').value.trim();
  const dueDate = document.getElementById('emailDueDate').value;
  const specialContent = document.getElementById('emailSpecialContent').value.trim();

  const replacements = {
    '{customerName}': project.customer,
    '{dueDate}': dueDate,
    '{staffName}': staffName,
    '{company}': template.company,
    '{contact}': template.contact || 'ã”æ‹…å½“è€…æ§˜',
    '{specialContent}': specialContent || ''
  };

  let subject = template.subject_format;
  let body = template.template_text;

  Object.keys(replacements).forEach(key => {
    const regex = new RegExp(key.replace(/[{}]/g, '\\$&'), 'g');
    subject = subject.replace(regex, replacements[key]);
    body = body.replace(regex, replacements[key]);
  });

  document.getElementById('emailSubject').textContent = subject;
  document.getElementById('emailAddress').textContent = template.email || 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
  document.getElementById('emailBody').textContent = body;
  document.getElementById('generatedEmailSection').style.display = 'block';
}

function copyText(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent;

  navigator.clipboard.writeText(text).then(() => {
    showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
  }).catch(err => {
    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
    showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  });
}

function closeEmailModal() {
  document.getElementById('emailModal').classList.remove('show');
}

// ============================================
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
// ============================================
window.addEventListener('DOMContentLoaded', () => {
  checkAuth();
});
</script>
</body>
</html>
