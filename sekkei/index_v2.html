<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>設計・IC業務管理システム | Gハウス</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary-color: #4A90E2;
  --primary-hover: #357ABD;
  --secondary-color: #50E3C2;
  --danger-color: #E94B3C;
  --warning-color: #F5A623;
  --success-color: #7ED321;
  --text-primary: #2C3E50;
  --text-secondary: #7F8C8D;
  --text-muted: #BDC3C7;
  --bg-primary: #FFFFFF;
  --bg-secondary: #F8F9FA;
  --bg-tertiary: #ECF0F1;
  --border-color: #E1E8ED;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
}

body {
  font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-secondary);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ログイン画面 */
.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #FFFFFF;
  padding: 20px;
}

.login-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 48px;
  box-shadow: var(--shadow-md);
  max-width: 420px;
  width: 100%;
  text-align: center;
}

.login-card h1 {
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 12px;
}

.login-card p {
  color: var(--text-secondary);
  margin-bottom: 24px;
  font-size: 15px;
}

/* メインコンテナ */
.main-container {
  display: none;
  max-width: 1800px;
  margin: 0 auto;
  background: var(--bg-secondary);
  min-height: 100vh;
}

.main-container.show {
  display: block;
}

/* ヘッダー */
.header {
  background: white;
  border-bottom: 1px solid var(--border-color);
  padding: 16px 32px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 24px;
}

.logo {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary-color);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

/* カテゴリ切り替えメニュー */
.category-switch-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  min-width: 180px;
}

.category-switch-menu button {
  display: block;
  width: 100%;
  padding: 12px 16px;
  text-align: left;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-primary);
  transition: background 0.2s;
}

.category-switch-menu button:hover {
  background: var(--bg-secondary);
}

.category-switch-menu button:first-child {
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.category-switch-menu button:last-child {
  border-radius: 0 0 var(--radius-md) var(--radius-md);
}

/* タブナビゲーション */
.tabs-nav {
  background: white;
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  display: flex;
  gap: 8px;
}

.tab-nav-btn {
  padding: 16px 24px;
  border: none;
  background: transparent;
  font-size: 15px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab-nav-btn:hover {
  color: var(--text-primary);
  background: var(--bg-secondary);
}

.tab-nav-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

/* コンテンツエリア */
.tab-panel {
  display: none;
}

.tab-panel.active {
  display: block;
}

/* ツールバー */
.toolbar {
  background: white;
  padding: 20px 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.toolbar-left {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  flex: 1;
}

.toolbar-right {
  display: flex;
  gap: 12px;
}

/* デザイナータブ */
.designer-tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.designer-tab {
  padding: 8px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.designer-tab:hover {
  background: var(--bg-tertiary);
}

.designer-group-label {
  width: 100%;
  padding: 8px 12px;
  margin-top: 12px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border-radius: 8px;
  border-left: 3px solid var(--primary-color);
}

.designer-tab.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* ボタン */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), #357ABD);
  color: white;
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.2);
}

.btn-primary:hover {
  background: linear-gradient(135deg, var(--primary-hover), #2E6BA8);
  box-shadow: 0 4px 16px rgba(74, 144, 226, 0.3);
  transform: translateY(-2px);
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
}

.btn-secondary:hover {
  opacity: 0.9;
}

.btn-ghost {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-primary);
}

.btn-ghost:hover {
  background: var(--bg-secondary);
}

.btn-danger {
  background: var(--danger-color);
  color: white;
}

.btn-danger:hover {
  opacity: 0.9;
}

.btn-small {
  padding: 6px 12px;
  font-size: 13px;
}

/* 入力フィールド */
.input, .select {
  padding: 10px 14px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  background: white;
  transition: all 0.2s;
}

.input:focus, .select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.input {
  min-width: 200px;
}

/* カードグリッド */
.cards-container {
  padding: 32px;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
  gap: 24px;
}

/* プロジェクトカード */
.project-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.project-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
  opacity: 0;
  transition: opacity 0.3s;
}

.project-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-4px);
  border-color: var(--primary-color);
}

.project-card:hover::before {
  opacity: 1;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--bg-secondary);
}

.card-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 12px;
  line-height: 1.3;
  letter-spacing: -0.02em;
}

.card-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  font-weight: 500;
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: 5px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.3px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.badge-primary {
  background: linear-gradient(135deg, #E8F4FD, #D6EBFF);
  color: var(--primary-color);
  border: 1px solid rgba(74, 144, 226, 0.2);
}

.badge-success {
  background: linear-gradient(135deg, #E6F9F0, #D1F2E6);
  color: var(--success-color);
  border: 1px solid rgba(80, 200, 120, 0.2);
}

.badge-secondary {
  background: linear-gradient(135deg, #F0F0F0, #E5E5E5);
  color: var(--text-secondary);
  border: 1px solid rgba(100, 100, 100, 0.2);
}

/* 業者カード */
.vendor-card {
  background: white;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* カテゴリフィルター */
.category-filter-btn {
  padding: 8px 16px;
  background: white;
  border: 2px solid var(--border-color);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.category-filter-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--bg-secondary);
}

.category-filter-btn.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* チェックボックスラベル */
.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}

.checkbox-label input[type="checkbox"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
}

.checkbox-label span {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

/* 進捗バー */
.progress-section {
  margin-bottom: 20px;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.progress-label {
  font-size: 14px;
  color: var(--text-secondary);
}

.progress-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary-color);
}

.progress-bar {
  height: 10px;
  background: var(--bg-secondary);
  border-radius: 999px;
  overflow: hidden;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4A90E2, #50C878);
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 999px;
  box-shadow: 0 0 8px rgba(74, 144, 226, 0.4);
  position: relative;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* タスクリスト */
.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.task-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  font-size: 14px;
  transition: all 0.2s;
  border: 1px solid transparent;
}

.task-item:hover {
  background: white;
  border-color: var(--border-color);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  transform: translateX(4px);
}

.task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.task-state-select {
  height: 30px;
  padding: 0 8px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background: #fff;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 80px;
  flex-shrink: 0;
}

.task-state-select.state-yellow {
  background: #fff8d6;
  border-color: #f4e2a0;
  color: #7a5b00;
}

.task-state-select.state-green {
  background: #e8f7e8;
  border-color: #b9e4b9;
  color: #0f5132;
}

.task-label {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
}

.task-email-btn {
  width: 32px;
  height: 32px;
  padding: 0;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.task-email-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
}

.template-select-btn {
  width: 100%;
  padding: 16px;
  background: white;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.template-select-btn:hover {
  border-color: var(--primary-color);
  background: var(--bg-secondary);
  transform: translateX(4px);
}

/* モーダル */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

.modal.show {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 16px;
  width: min(800px, 90vw);
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  padding: 28px 32px;
  border-bottom: 2px solid var(--bg-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(180deg, #fafbfc, white);
}

.modal-title {
  font-size: 24px;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text-primary);
}

.close {
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.2s;
}

.close:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.modal-body {
  padding: 32px;
}

.modal-footer {
  padding: 20px 32px;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

/* フォーム */
.form-group {
  margin-bottom: 24px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s;
  background: white;
}

.form-input:hover, .form-select:hover, .form-textarea:hover {
  border-color: #c5d1de;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.12);
  background: #fafbfc;
}

.form-textarea {
  min-height: 120px;
  resize: vertical;
}

.form-hint {
  margin-top: 6px;
  font-size: 13px;
  color: var(--text-muted);
}

/* ステータスインジケーター */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-saving {
  background: #FFF4E6;
  color: var(--warning-color);
}

.status-saving .status-dot {
  background: var(--warning-color);
  animation: pulse 1.5s infinite;
}

.status-saved {
  background: #E6F9F0;
  color: var(--success-color);
}

.status-saved .status-dot {
  background: var(--success-color);
}

.status-error {
  background: #FFE6E6;
  color: var(--danger-color);
}

.status-error .status-dot {
  background: var(--danger-color);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* テーブル */
.table-container {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table thead {
  background: linear-gradient(180deg, #f8f9fa, #f0f1f3);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
}

.table th {
  padding: 18px 20px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table td {
  padding: 16px 20px;
  border-top: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-primary);
}

.table tbody tr:nth-child(even) {
  background: #fafbfc;
}

.table tbody tr:hover {
  background: #f0f7ff;
  box-shadow: inset 0 0 0 1px rgba(74, 144, 226, 0.1);
  transition: all 0.2s;
}

/* 空状態 */
.empty-state {
  padding: 80px 40px;
  text-align: center;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-description {
  font-size: 14px;
  margin-bottom: 24px;
}

/* メール出力 */
.email-output {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 20px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.8;
  white-space: pre-wrap;
  margin: 16px 0;
  max-height: 400px;
  overflow-y: auto;
}

/* レスポンシブ */
@media (max-width: 1200px) {
  .cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
  }
}

@media (max-width: 768px) {
  .header {
    padding: 12px 16px;
  }

  .toolbar {
    padding: 16px;
  }

  .cards-container {
    padding: 16px;
  }

  .cards-grid {
    grid-template-columns: 1fr;
  }

  .tasks-grid {
    grid-template-columns: 1fr;
  }

  .modal-content {
    width: 95vw;
  }

  .modal-body {
    padding: 20px;
  }
}

/* ローディングスピナー */
.spinner {
  border: 3px solid var(--bg-secondary);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 40px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ドラッグ&ドロップ */
.draggable-row {
  cursor: move;
  transition: all 0.2s;
}

.draggable-row:hover {
  background: var(--bg-secondary);
}

.draggable-row.dragging {
  opacity: 0.5;
  background: var(--bg-hover);
}

.draggable-row.drag-over {
  border-top: 3px solid var(--primary-color);
}

.drag-handle {
  cursor: grab;
  color: var(--text-secondary);
  font-size: 18px;
  padding: 0 8px;
  user-select: none;
}

.drag-handle:active {
  cursor: grabbing;
}

/* トースト通知 */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 16px 24px;
  box-shadow: var(--shadow-lg);
  display: none;
  align-items: center;
  gap: 12px;
  z-index: 2000;
}

.toast.show {
  display: flex;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-success {
  border-left: 4px solid var(--success-color);
}

.toast-error {
  border-left: 4px solid var(--danger-color);
}

.toast-warning {
  border-left: 4px solid var(--warning-color);
}

/* サイドバーレイアウト */
.app-layout {
  display: flex;
  height: calc(100vh - 64px);
  overflow: hidden;
}

.sidebar {
  width: 280px;
  background: white;
  border-right: 2px solid var(--border-color);
  overflow-y: auto;
  flex-shrink: 0;
}

.sidebar-section {
  padding: 16px;
  border-bottom: 1px solid var(--border-color);
}

.sidebar-section-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 4px;
  font-size: 14px;
  font-weight: 500;
}

.sidebar-item:hover {
  background: var(--bg-secondary);
}

.sidebar-item.active {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
}

.sidebar-item-label {
  flex: 1;
}

.sidebar-item-count {
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.1);
}

.sidebar-item.active .sidebar-item-count {
  background: rgba(255, 255, 255, 0.2);
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* サブタブナビゲーション */
.sub-tabs-nav {
  display: flex;
  gap: 8px;
  padding: 16px 24px 0 24px;
  background: white;
  border-bottom: 2px solid var(--border-color);
  overflow-x: auto;
}

.sub-tab-btn {
  padding: 12px 20px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
  white-space: nowrap;
}

.sub-tab-btn:hover {
  color: var(--primary-color);
  background: var(--bg-secondary);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

.sub-tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  max-height: calc(100vh - 180px);
}

.sub-tab-panel.active {
  display: block;
}

.table-container {
  overflow-y: auto;
  max-height: calc(100vh - 350px);
}

.cards-grid {
  overflow-y: auto;
  max-height: calc(100vh - 300px);
}

/* 業者カード */
.vendor-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  margin-bottom: 16px;
}

.vendor-info > div {
  padding: 6px 0;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-info strong {
  color: var(--text-primary);
  font-weight: 600;
  min-width: 80px;
  display: inline-block;
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}
</style>
</head>
<body>

<!-- ログイン画面 -->
<div id="loginContainer" class="login-container">
  <div class="login-card">
    <h1>設計・IC業務管理システム</h1>
    <p>メールアドレスとパスワードでログインしてください</p>
    <form onsubmit="signIn(); return false;" style="margin-bottom: 20px;">
      <input type="email" class="form-input" id="loginEmail" placeholder="メールアドレス" style="width: 100%; margin-bottom: 12px;" required>
      <input type="password" class="form-input" id="loginPassword" placeholder="パスワード" style="width: 100%; margin-bottom: 16px;" required>
      <button type="submit" class="btn btn-primary" style="width: 100%;">ログイン</button>
    </form>
  </div>
</div>

<!-- アカウント選択画面 -->
<div id="accountSelectContainer" class="login-container" style="display: none;">
  <div class="login-card">
    <h1>アカウント選択</h1>
    <p>ご利用の業務を選択してください</p>
    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 24px;">
      <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="selectAccountType('設計')">
        📐 設計担当
      </button>
      <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="selectAccountType('IC')">
        🎨 IC担当
      </button>
      <button class="btn btn-secondary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="selectAccountType('admin')">
        👑 管理者（全権限）
      </button>
    </div>
  </div>
</div>

<!-- メインアプリケーション -->
<div id="mainContainer" class="main-container">
  <!-- ヘッダー -->
  <header class="header">
    <div class="header-left">
      <div class="logo">Gハウス 設計管理</div>
    </div>
    <div class="header-right">
      <div class="status-indicator status-saved" id="statusIndicator">
        <span class="status-dot"></span>
        <span id="statusText">保存済み</span>
      </div>
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName" class="user-name"></span>
      </div>
      <div style="position: relative;">
        <button class="btn btn-ghost btn-small" onclick="toggleCategorySwitcher()" id="categorySwitchBtn" style="display: none;">
          <span id="currentCategoryLabel">📐 設計</span> ▼
        </button>
        <div id="categorySwitchMenu" class="category-switch-menu" style="display: none;">
          <button onclick="switchCategory('設計')">📐 設計担当</button>
          <button onclick="switchCategory('IC')">🎨 IC担当</button>
          <button onclick="switchCategory('admin')">👑 管理者</button>
        </div>
      </div>
      <button class="btn btn-ghost btn-small" onclick="signOut()">ログアウト</button>
    </div>
  </header>

  <!-- アプリレイアウト -->
  <div class="app-layout">
    <!-- サイドバー -->
    <aside class="sidebar">
      <div id="sidebarContent"></div>
    </aside>

    <!-- メインコンテンツ -->
    <main class="main-content">
      <!-- タブナビゲーション -->
      <nav class="tabs-nav">
        <button class="tab-nav-btn active" onclick="switchMainTab('projects', this)">📋 案件管理</button>
        <button class="tab-nav-btn" onclick="switchMainTab('settings', this)">⚙️ 設定</button>
      </nav>

      <!-- 案件管理タブ -->
      <div id="projectsTab" class="tab-panel active">
        <div class="toolbar">
          <div class="toolbar-left">
            <input type="text" class="input" id="searchQuery" placeholder="検索..." oninput="renderProjects()">
            <select class="select" id="specFilter" onchange="renderProjects()">
              <option value="">すべての商品</option>
              <option>LIFE</option>
              <option>LIFE+</option>
              <option>HOURS</option>
              <option>LACIE</option>
              <option>LIFEリミ</option>
              <option>LIFE+リミ</option>
            </select>
            <select class="select" id="archiveFilter" onchange="renderProjects()" style="margin-left: 12px;">
              <option value="active">アクティブのみ</option>
              <option value="all">すべて表示</option>
              <option value="archived">完了済みのみ</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-ghost" onclick="exportJSON()">JSON出力</button>
            <button class="btn btn-ghost" onclick="exportCSV()">CSV出力</button>
            <button class="btn btn-primary" onclick="openProjectModal()">+ 案件追加</button>
      </div>
    </div>
    <div class="cards-container">
      <div class="cards-grid" id="projectsGrid"></div>
      <div class="empty-state" id="emptyProjects" style="display: none;">
        <div class="empty-icon">📋</div>
        <div class="empty-title">案件がありません</div>
        <div class="empty-description">「案件追加」ボタンから新しい案件を登録してください</div>
        <button class="btn btn-primary" onclick="openProjectModal()">+ 案件追加</button>
      </div>
    </div>
  </div>

      <!-- 設定タブ -->
      <div id="settingsTab" class="tab-panel">
        <!-- サブタブナビゲーション -->
        <nav class="sub-tabs-nav">
          <button class="sub-tab-btn active" onclick="switchSubTab('staff', this)">👥 スタッフ管理</button>
          <button class="sub-tab-btn" onclick="switchSubTab('vendors', this)">🏢 業者・メール管理</button>
          <button class="sub-tab-btn" onclick="switchSubTab('categories', this)">🏷️ カテゴリ管理</button>
          <button class="sub-tab-btn" onclick="switchSubTab('tasks', this)">✅ タスク管理</button>
          <button class="sub-tab-btn" onclick="switchSubTab('products', this)">📦 商品管理</button>
        </nav>

        <!-- スタッフ管理 -->
        <div id="staffPanel" class="sub-tab-panel active">
          <div style="max-width: 1000px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">スタッフ管理</h2>
            <div class="form-group">
              <label class="form-label">新しいスタッフを追加</label>
              <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
                <input type="text" class="form-input" id="newDesignerNameInline" placeholder="スタッフ名">
                <select class="form-select" id="newDesignerCategoryInline" style="width: 150px;">
                  <option value="設計">設計担当</option>
                  <option value="IC">IC担当</option>
                </select>
                <button class="btn btn-primary" onclick="addDesignerInline()">追加</button>
              </div>
            </div>
            <div id="designerListInline" style="margin-top: 24px;"></div>
          </div>
        </div>

        <!-- 業者管理 -->
        <div id="vendorsPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <div id="categoryFilters"></div>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openVendorModalV2()">+ 業者追加</button>
            </div>
          </div>
          <div id="vendorsGrid" class="cards-grid"></div>
        </div>

        <!-- カテゴリ管理 -->
        <div id="categoriesPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">業者カテゴリ管理</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">業者を分類するカテゴリを追加・編集・削除できます。</p>
            <div class="form-group">
              <label class="form-label">新しいカテゴリを追加</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newCategoryNameInline" placeholder="カテゴリ名（例：電気工事）" style="flex: 1;">
                <button class="btn btn-primary" onclick="addCategoryInline()">追加</button>
              </div>
            </div>
            <div id="categoriesGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- タスク管理 -->
        <div id="tasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <select class="select" id="taskCategoryFilterInline" onchange="renderTasksManagement()">
                <option value="">すべて</option>
                <option value="設計">設計用タスク</option>
                <option value="IC">IC用タスク</option>
              </select>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openTaskModal()">+ タスク追加</button>
            </div>
          </div>
          <div id="tasksGrid"></div>
        </div>

        <!-- 商品管理 -->
        <div id="productsPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">商品マスタ管理</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">案件で選択できる商品を管理します。</p>
            <div class="form-group">
              <label class="form-label">新しい商品を追加</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newProductNameInline" placeholder="商品名（例：LIFE、LIFE+、HOURS）" style="flex: 1;">
                <button class="btn btn-primary" onclick="addProductInline()">追加</button>
              </div>
            </div>
            <div id="productsGrid" style="margin-top: 32px;"></div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- モーダル：案件追加/編集 -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="projectModalTitle">案件追加</h2>
      <button class="close" onclick="closeProjectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">お客様名 *</label>
        <input type="text" class="form-input" id="projectCustomer" placeholder="例：田中太郎様">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div class="form-group">
          <label class="form-label">担当設計士（設計） *</label>
          <select class="form-select" id="projectAssignedTo"></select>
        </div>
        <div class="form-group">
          <label class="form-label">担当設計士（IC）</label>
          <select class="form-select" id="projectIcAssignee">
            <option value="">未定</option>
          </select>
          <div class="form-hint" style="font-size: 11px;">後から追加可能</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">商品</label>
        <select class="form-select" id="projectSpecifications"></select>
      </div>
      <div class="form-group">
        <label class="form-label">メモ</label>
        <textarea class="form-textarea" id="projectMemo" placeholder="要望・注意点など"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeProjectModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="saveProject()">保存</button>
    </div>
  </div>
</div>

<!-- モーダル：メールテンプレート追加/編集 -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="templateModalTitle">テンプレート追加</h2>
      <button class="close" onclick="closeTemplateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">テンプレートID *</label>
        <input type="text" class="form-input" id="templateId" placeholder="例：new-template">
        <div class="form-hint">英数字とハイフンのみ使用可能</div>
      </div>
      <div class="form-group">
        <label class="form-label">表示名 *</label>
        <input type="text" class="form-input" id="templateDisplayName" placeholder="例：新会社名（作業内容）">
      </div>
      <div class="form-group">
        <label class="form-label">カテゴリ *</label>
        <select class="form-select" id="templateCategory">
          <option value="設計">設計</option>
          <option value="IC">IC</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">会社名 *</label>
        <input type="text" class="form-input" id="templateCompany" placeholder="例：株式会社〇〇">
      </div>
      <div class="form-group">
        <label class="form-label">宛先名</label>
        <input type="text" class="form-input" id="templateContact" placeholder="例：田中様">
      </div>
      <div class="form-group">
        <label class="form-label">メールアドレス</label>
        <input type="text" class="form-input" id="templateEmail" placeholder="例：tanaka@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">件名フォーマット *</label>
        <input type="text" class="form-input" id="templateSubjectFormat" placeholder="例：{customerName}様 新規〇〇作成依頼　期日{dueDate}">
        <div class="form-hint">使用可能：{customerName}, {dueDate}, {staffName}</div>
      </div>
      <div class="form-group">
        <label class="form-label">メール本文 *</label>
        <textarea class="form-textarea" id="templateText" rows="10" placeholder="例:&#10;{company}&#10;{contact}&#10;&#10;いつもお世話になっております。"></textarea>
        <div class="form-hint">使用可能：{company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTemplateModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="saveTemplate()">保存</button>
    </div>
  </div>
</div>

<!-- モーダル：スタッフ管理 -->
<div id="designerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">スタッフ管理</h2>
      <button class="close" onclick="closeDesignerModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">新しいスタッフを追加</label>
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
          <input type="text" class="form-input" id="newDesignerName" placeholder="スタッフ名">
          <select class="form-select" id="newDesignerCategory" style="width: 150px;">
            <option value="設計">設計担当</option>
            <option value="IC">IC担当</option>
          </select>
          <button class="btn btn-primary" onclick="addDesigner()">追加</button>
        </div>
      </div>
      <div id="designerList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeDesignerModal()">完了</button>
    </div>
  </div>
</div>

<!-- モーダル：メール作成 -->
<div id="emailModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title">📧 メール作成</h2>
      <button class="close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div class="modal-body" id="emailComposerContent"></div>
  </div>
</div>

<!-- モーダル：業者追加/編集V2 -->
<div id="vendorModalV2" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title" id="vendorModalTitle">業者追加</h2>
      <button class="close" onclick="closeVendorModalV2()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="vendorForm">
        <input type="hidden" id="vendorId">

        <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">基本情報</h3>

        <div class="form-group">
          <label class="form-label">会社名 *</label>
          <input type="text" class="form-input" id="vendorCompany" placeholder="例：株式会社〇〇" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">担当者名</label>
            <input type="text" class="form-input" id="vendorContact" placeholder="例：田中様">
          </div>

          <div class="form-group">
            <label class="form-label">電話番号</label>
            <input type="text" class="form-input" id="vendorTel" placeholder="例：090-1234-5678">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">メールアドレス</label>
            <input type="email" class="form-input" id="vendorEmail" placeholder="例：tanaka@example.com">
          </div>

          <div class="form-group">
            <label class="form-label">カテゴリ</label>
            <select class="form-select" id="vendorCategory"></select>
          </div>
        </div>

        <h3 style="margin: 24px 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">メールテンプレート</h3>

        <div class="form-group">
          <label class="form-label">件名フォーマット</label>
          <input type="text" class="form-input" id="vendorSubject" placeholder="例：{customerName}様 新規〇〇作成依頼　期日{dueDate}">
          <div class="form-hint">使用可能：{customerName}, {dueDate}, {staffName}</div>
        </div>

        <div class="form-group">
          <label class="form-label">メール本文</label>
          <textarea class="form-textarea" id="vendorTemplate" rows="8" placeholder="例:&#10;{company}&#10;{contact}&#10;&#10;いつもお世話になっております。"></textarea>
          <div class="form-hint">使用可能：{company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="vendorHasSpecial" onchange="toggleSpecialContent()">
            <span>特別コンテンツを使用する</span>
          </label>
        </div>

        <div id="specialContentGroup" style="display: none;">
          <div class="form-group">
            <label class="form-label">デフォルト特別コンテンツ</label>
            <textarea class="form-textarea" id="vendorSpecialContent" rows="3" placeholder="例：サッシプレゼン、開口部リスト、玄関プレゼン(C10 カームブラック)"></textarea>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeVendorModalV2()">キャンセル</button>
      <button class="btn btn-primary" onclick="saveVendorV2()">保存</button>
    </div>
  </div>
</div>

<!-- モーダル：カテゴリ追加/編集 -->
<div id="categoryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="categoryModalTitle">カテゴリ追加</h2>
      <button class="close" onclick="closeCategoryModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="categoryForm">
        <input type="hidden" id="categoryId">

        <div class="form-group">
          <label class="form-label">カテゴリ名 *</label>
          <input type="text" class="form-input" id="categoryName" placeholder="例：設備" required>
        </div>

        <div class="form-group">
          <label class="form-label">表示順</label>
          <input type="number" class="form-input" id="categoryOrder" placeholder="1" min="1">
          <div class="form-hint">小さい数字ほど先に表示されます</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCategoryModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="saveCategory()">保存</button>
    </div>
  </div>
</div>

<!-- モーダル：タスク追加/編集 -->
<div id="taskModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="taskModalTitle">タスク追加</h2>
      <button class="close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="taskForm">
        <input type="hidden" id="taskId">

        <div class="form-group">
          <label class="form-label">タスクキー *</label>
          <input type="text" class="form-input" id="taskKey" placeholder="例：meeting0" required>
          <div class="form-hint">英数字とアンダースコアのみ使用可能（システム内部ID）</div>
        </div>

        <div class="form-group">
          <label class="form-label">タスク名 *</label>
          <input type="text" class="form-input" id="taskName" placeholder="例：0回目打合せ" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">カテゴリ *</label>
            <select class="form-select" id="taskCategory" required>
              <option value="設計">設計</option>
              <option value="IC">IC</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">表示順</label>
            <input type="number" class="form-input" id="taskOrder" placeholder="1" min="1">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasState" onchange="toggleTaskState()">
            <span>状態管理を有効にする</span>
          </label>
          <div class="form-hint">チェックすると「依頼済」「保存済」などの状態を選択可能になります</div>
        </div>

        <div id="stateOptionsGroup" style="display: none;">
          <div class="form-group">
            <label class="form-label">状態オプション（JSON配列）</label>
            <input type="text" class="form-input" id="taskStateOptions" placeholder='例：["", "依頼済", "保存済"]'>
            <div class="form-hint">JSON配列形式で入力してください。最初の要素は空文字列("")を推奨</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">紐づけ業者（複数選択可）</label>
          <div id="taskVendorSelection" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
            <!-- ベンダーのチェックボックスリストがここに表示される -->
          </div>
          <div class="form-hint">このタスクから直接メールを送信する業者を選択してください</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTaskModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="saveTask()">保存</button>
    </div>
  </div>
</div>

<!-- モーダル：スタッフ認証設定 -->
<div id="designerAuthModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title">🔑 スタッフ認証設定</h2>
      <button class="close" onclick="closeDesignerAuthModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="designerAuthForm">
        <input type="hidden" id="authDesignerId">

        <div class="form-group">
          <label class="form-label">スタッフ名</label>
          <input type="text" class="form-input" id="authDesignerName" disabled>
        </div>

        <div class="form-group">
          <label class="form-label">メールアドレス（ログインID） *</label>
          <input type="email" class="form-input" id="authDesignerEmail" placeholder="例：yamada@ghouse.jp" required>
          <div class="form-hint">このメールアドレスでログインできるようになります</div>
        </div>

        <div class="form-group">
          <label class="form-label">パスワード *</label>
          <input type="password" class="form-input" id="authDesignerPassword" placeholder="8文字以上" required>
          <div class="form-hint">8文字以上で設定してください</div>
        </div>

        <div class="form-group">
          <label class="form-label">パスワード（確認） *</label>
          <input type="password" class="form-input" id="authDesignerPasswordConfirm" placeholder="もう一度入力">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeDesignerAuthModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="saveDesignerAuth()">保存</button>
    </div>
  </div>
</div>

<!-- トースト通知 -->
<div id="toast" class="toast"></div>

<script>
// ============================================
// Supabase初期化
// ============================================
const SUPABASE_URL = 'https://twzsirpfudqwboeyakta.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3enNpcnBmdWRxd2JvZXlha3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzM4NjgsImV4cCI6MjA3NzAwOTg2OH0.E_8GxfsO6Scjc0dDoEoyxq3i4lfvNxYZvnSL1OlSDSM';

// Supabase CDNのロード確認
if (!window.supabase) {
  console.error('❌ Supabase CDN が読み込まれていません！');
  alert('Supabase CDN が読み込まれていません。ページを再読み込みしてください。');
}

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
console.log('✅ Supabase初期化完了:', SUPABASE_URL);

// グローバル変数
let currentUser = null;
let currentDesigner = null;
let currentUserCategory = null; // 'admin' | '設計' | 'IC'
let projects = [];
let designers = [];
let emailTemplates = [];
let vendors = [];
let taskMappings = {};
let currentDesignerTab = 'ALL';
let editingProjectId = null;
let editingTemplateId = null;
let editingVendorId = null;

// 新システム用変数
let vendorCategories = [];
let tasksV2 = [];
let vendorsV2 = [];
let taskVendorMappings = [];
let products = [];

// 無限ループ防止フラグ
let isHandlingHashChange = false;

// 担当者のカテゴリに応じたタスクリストを取得（新システム）
function getTasksForAssignee(assigneeName) {
  const designer = designers.find(d => d.name === assigneeName);
  const category = designer?.category || '設計';

  // tasksV2が空の場合は空配列を返す
  if (!tasksV2 || tasksV2.length === 0) {
    console.warn('⚠️ tasksV2テーブルにデータがありません。migration_customizable_system.sqlを実行してください。');
    return [];
  }

  return tasksV2.filter(t => t.category === category).sort((a, b) => a.display_order - b.display_order);
}

// タスクの状態オプションを取得（新システム）
function getTaskStateOptions(taskKey) {
  const task = tasksV2.find(t => t.task_key === taskKey);
  if (!task || !task.has_state || !task.state_options) return null;
  return task.state_options;
}

// ============================================
// 認証処理
// ============================================
async function signIn() {
  console.log('🔐 ログイン処理開始...');

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  console.log('📧 入力されたメール:', email);

  if (!email || !password) {
    console.error('❌ メールアドレスまたはパスワードが空です');
    showToast('メールアドレスとパスワードを入力してください', 'error');
    return;
  }

  if (!window.supabase) {
    console.error('❌ Supabase CDNが読み込まれていません');
    showToast('エラー: Supabaseが初期化されていません。ページを再読み込みしてください。', 'error');
    return;
  }

  try {
    console.log('🔄 Supabase認証リクエスト送信中...');
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });

    if (error) {
      console.error('❌ Supabase認証エラー:', error);
      throw error;
    }

    console.log('✅ ログイン成功:', data.user.email);
    // ログイン成功 - onAuthStateChangeで処理されるのでreloadは不要
  } catch (error) {
    console.error('❌ ログインエラー:', error);
    showToast('ログインに失敗しました: ' + error.message, 'error');
  }
}

async function signOut() {
  try {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
    location.reload();
  } catch (error) {
    console.error('ログアウトエラー:', error);
    showToast('ログアウトに失敗しました', 'error');
  }
}

async function checkAuth() {
  console.log('🔍 認証状態をチェック中...');
  const { data: { session } } = await supabase.auth.getSession();

  if (session) {
    console.log('✅ セッション検出:', session.user.email);
    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jpの場合はアカウント選択画面を表示
    if (currentUser.email === 'admin@ghouse.jp') {
      console.log('👑 管理者ログイン - アカウント選択画面を表示');
      document.getElementById('accountSelectContainer').style.display = 'flex';
      return;
    }

    // その他の場合は設計士情報を取得してcategoryを判定
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      console.log('✅ 設計士情報取得:', currentDesigner.name, '/', currentUserCategory);
    } else {
      console.warn('⚠️ 設計士情報が見つかりません:', currentUser.email);
    }

    // メインコンテナを表示
    document.getElementById('mainContainer').classList.add('show');

    // メールアドレスからユーザー名を表示（@より前の部分）
    const displayName = currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = displayName;

    // デフォルトアバターを設定
    document.getElementById('userAvatar').src = 'https://via.placeholder.com/32/4A90E2/FFFFFF?text=' + displayName.charAt(0).toUpperCase();

    await init();

    // 初期化完了後にURL直接アクセスの処理を実行（1回だけ）
    if (!window.location.hash || window.location.hash === '#') {
      window.location.hash = 'projects';
    }
  } else {
    console.log('❌ セッションなし - ログイン画面を表示');
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContainer').classList.remove('show');
  }
}

// 認証処理中フラグ
let isAuthProcessing = false;

// 認証状態変更を監視
supabase.auth.onAuthStateChange(async (event, session) => {
  console.log('🔔 認証イベント:', event, 'currentUser:', currentUser?.email, 'processing:', isAuthProcessing);

  if (event === 'SIGNED_IN' && !currentUser && !isAuthProcessing) {
    isAuthProcessing = true;
    console.log('✅ SIGNED_IN イベント処理開始:', session.user.email);

    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jpの場合はアカウント選択画面を表示
    if (currentUser.email === 'admin@ghouse.jp') {
      console.log('👑 管理者ログイン - アカウント選択画面を表示');
      document.getElementById('accountSelectContainer').style.display = 'flex';
      isAuthProcessing = false;
      return;
    }

    // その他の場合は設計士情報を取得してcategoryを判定
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      console.log('✅ 設計士情報取得:', currentDesigner.name, '/', currentUserCategory);
    } else {
      console.warn('⚠️ 設計士情報が見つかりません:', currentUser.email);
    }

    // メインコンテナを表示
    document.getElementById('mainContainer').classList.add('show');

    const displayName = currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userAvatar').src = 'https://via.placeholder.com/32/4A90E2/FFFFFF?text=' + displayName.charAt(0).toUpperCase();

    await init();
    isAuthProcessing = false;
  } else if (event === 'SIGNED_OUT') {
    console.log('👋 SIGNED_OUT イベント');
    location.reload();
  } else {
    console.log('⏭️ イベントをスキップ');
  }
});

// アカウントタイプ選択
async function selectAccountType(category) {
  console.log('🎯 アカウントタイプ選択:', category);
  currentUserCategory = category;
  document.getElementById('accountSelectContainer').style.display = 'none';
  document.getElementById('mainContainer').classList.add('show');

  const displayName = currentUser.email.split('@')[0];
  document.getElementById('userName').textContent = displayName;
  document.getElementById('userAvatar').src = 'https://via.placeholder.com/32/4A90E2/FFFFFF?text=' + displayName.charAt(0).toUpperCase();

  // 切り替えボタンを表示
  updateCategorySwitchButton();

  await init();

  // 初期化完了後にデフォルトタブを設定（1回だけ）
  if (!window.location.hash || window.location.hash === '#') {
    window.location.hash = 'projects';
  }

  console.log('✅ アカウントタイプ選択完了');
}

// カテゴリ切り替えボタンの表示更新
function updateCategorySwitchButton() {
  const btn = document.getElementById('categorySwitchBtn');
  const label = document.getElementById('currentCategoryLabel');

  if (currentUserCategory === '設計') {
    label.textContent = '📐 設計';
  } else if (currentUserCategory === 'IC') {
    label.textContent = '🎨 IC';
  } else if (currentUserCategory === 'admin') {
    label.textContent = '👑 管理者';
  }

  btn.style.display = 'block';
}

// カテゴリ切り替えメニューの開閉
function toggleCategorySwitcher() {
  const menu = document.getElementById('categorySwitchMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// メニュー外クリックで閉じる
document.addEventListener('click', function(e) {
  const menu = document.getElementById('categorySwitchMenu');
  const btn = document.getElementById('categorySwitchBtn');
  if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.style.display = 'none';
  }
});

// カテゴリ切り替え
async function switchCategory(category) {
  console.log('🔄 カテゴリ切り替え:', category);

  // メニューを閉じる
  document.getElementById('categorySwitchMenu').style.display = 'none';

  // 同じカテゴリなら何もしない
  if (currentUserCategory === category) {
    console.log('⏭️ 同じカテゴリのためスキップ');
    return;
  }

  // カテゴリを更新
  currentUserCategory = category;

  // ボタン表示を更新
  updateCategorySwitchButton();

  // データを再読み込み
  showStatus('読み込み中...', 'saving');
  await init();

  showToast(`${category === 'admin' ? '管理者' : category + '担当'}画面に切り替えました`, 'success');
  console.log('✅ カテゴリ切り替え完了');
}

// ============================================
// 初期化
// ============================================
async function init() {
  console.log('🚀 初期化開始...');
  showStatus('読み込み中...', 'saving');

  try {
    console.log('📦 データ読み込み開始...');
    const results = await Promise.allSettled([
      loadDesigners(),
      loadCurrentDesigner(),
      loadProjects(),
      loadEmailTemplates(),
      loadVendors(),
      loadTaskMappings(),
      loadVendorCategories(),
      loadTasksV2(),
      loadVendorsV2(),
      loadTaskVendorMappings(),
      loadProducts()
    ]);

    // 各結果を確認
    results.forEach((result, index) => {
      const names = ['設計士', '現在の設計士', '案件', 'テンプレート', '業者', 'タスク設定'];
      if (result.status === 'rejected') {
        console.error(`❌ ${names[index]}の読み込み失敗:`, result.reason);
      } else {
        console.log(`✅ ${names[index]}の読み込み成功`);
      }
    });

    // 失敗したものがあればエラーを表示
    const failedCount = results.filter(r => r.status === 'rejected').length;
    if (failedCount > 0) {
      console.warn(`⚠️ ${failedCount}件のデータ読み込みに失敗しました`);
      showToast(`${failedCount}件のデータ読み込みに失敗しました。コンソールを確認してください。`, 'error');
    }

    // 業者データとカテゴリデータをマージ（両方の読み込みが完了した後に実行）
    mergeVendorCategories();

    console.log('🎨 画面描画開始...');
    renderSidebar();
    renderProjects();
    renderTemplates();
    renderVendors();
    renderMappings();

    // 新システムのUI初期化
    populateVendorCategoryDropdown();
    populateProductDropdown();

    // 新システムの各管理画面の初期描画
    console.log('🎨 新システム描画開始:', {
      vendorsV2Length: vendorsV2.length,
      vendorCategoriesLength: vendorCategories.length,
      tasksV2Length: tasksV2.length,
      taskVendorMappingsLength: taskVendorMappings.length
    });

    renderDesignerListInline();  // スタッフ管理
    renderCategoryFilters();      // カテゴリフィルター
    renderVendorsV2();            // 業者管理
    renderCategoriesList();       // カテゴリ管理
    renderTasksManagement();      // タスク管理
    renderProductsList();         // 商品管理

    console.log('✅ 初期化完了');
    showStatus('保存済み', 'saved');
  } catch (error) {
    console.error('❌ 初期化エラー:', error);
    showStatus('エラー', 'error');
    showToast('データの読み込みに失敗しました: ' + error.message, 'error');
  }
}

// ============================================
// データ読み込み
// ============================================
async function loadDesigners() {
  console.log('🔄 設計士データ読み込み開始...');

  try {
    const { data, error, count } = await supabase
      .from('designers')
      .select('*', { count: 'exact' })
      .order('display_order');

    console.log('📡 Supabaseレスポンス:', {
      success: !error,
      dataLength: data?.length || 0,
      count: count,
      error: error,
      rawDataSample: data?.slice(0, 3)
    });

    if (error) {
      console.error('❌ 設計士データ読み込みエラー:', error);
      console.error('エラー詳細:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      designers = [];
      return;
    }

    designers = data || [];

    // カテゴリごとの内訳を表示
    const byCategory = designers.reduce((acc, d) => {
      const cat = d.category || '(なし)';
      acc[cat] = (acc[cat] || 0) + 1;
      return acc;
    }, {});

    console.log('✅ 設計士データ読み込み完了:', {
      総数: designers.length,
      カテゴリ別: byCategory,
      サンプル: designers.slice(0, 3).map(d => ({ name: d.name, category: d.category, email: d.email }))
    });

    if (designers.length === 0) {
      console.warn('⚠️ 警告: 設計士データが0件です！Supabaseのテーブルにデータがあるか確認してください。');
    }
  } catch (err) {
    console.error('❌ loadDesigners()で予期しないエラー:', err);
    designers = [];
  }
}

async function loadCurrentDesigner() {
  if (!currentUser || !currentUser.email) return;

  // admin@ghouse.jpの場合は設計士を特定しない（全案件閲覧可能）
  if (currentUser.email === 'admin@ghouse.jp') {
    currentDesigner = null;
    return;
  }

  const { data, error } = await supabase
    .from('designers')
    .select('*')
    .eq('email', currentUser.email)
    .single();

  if (error) {
    console.warn('設計士情報の取得に失敗:', error);
    currentDesigner = null;
    return;
  }

  currentDesigner = data;
  console.log('現在の設計士:', currentDesigner);
}

async function loadProjects() {
  console.log('🔄 案件データ読み込み中...');
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('*')
      .order('created_at', { ascending: false });
    if (error) {
      console.error('❌ 案件データ読み込みエラー:', error);
      projects = [];
      return;
    }
    projects = data || [];
    console.log('✅ 案件データ読み込み完了:', projects.length, '件');
  } catch (err) {
    console.error('❌ loadProjects()で予期しないエラー:', err);
    projects = [];
  }
}

async function loadEmailTemplates() {
  console.log('🔄 メールテンプレートデータ読み込み中...');
  try {
    const { data, error } = await supabase
      .from('email_templates')
      .select('*')
      .order('display_name');
    if (error) {
      console.error('❌ メールテンプレートデータ読み込みエラー:', error);
      emailTemplates = [];
      return;
    }
    emailTemplates = data || [];
    console.log('✅ メールテンプレートデータ読み込み完了:', emailTemplates.length, '件');
  } catch (err) {
    console.error('❌ loadEmailTemplates()で予期しないエラー:', err);
    emailTemplates = [];
  }
}

async function loadVendors() {
  console.log('🔄 業者データ読み込み中...');
  try {
    const { data, error } = await supabase
      .from('template_vendors')
      .select('*')
      .order('company');
    if (error) {
      console.error('❌ 業者データ読み込みエラー:', error);
      vendors = [];
      return;
    }
    vendors = data || [];
    console.log('✅ 業者データ読み込み完了:', vendors.length, '件');
  } catch (err) {
    console.error('❌ loadVendors()で予期しないエラー:', err);
    vendors = [];
  }
}

async function loadTaskMappings() {
  console.log('🔄 タスクマッピングデータ読み込み中...');
  try {
    const { data, error } = await supabase
      .from('task_template_mappings')
      .select('*');
    if (error) {
      console.error('❌ タスクマッピングデータ読み込みエラー:', error);
      taskMappings = {};
      return;
    }
    taskMappings = {};
    (data || []).forEach(mapping => {
      taskMappings[mapping.task_key] = mapping.template_id;
    });
    console.log('✅ タスクマッピングデータ読み込み完了:', Object.keys(taskMappings).length, '件');
  } catch (err) {
    console.error('❌ loadTaskMappings()で予期しないエラー:', err);
    taskMappings = {};
  }
}

// 新システム用データ読み込み
async function loadVendorCategories() {
  const { data, error } = await supabase
    .from('vendor_categories')
    .select('*')
    .order('display_order');
  if (!error) vendorCategories = data || [];
  console.log('✅ 業者カテゴリ読み込み完了:', vendorCategories.length, '件');
}

async function loadTasksV2() {
  const { data, error } = await supabase
    .from('tasks')
    .select('*')
    .order('display_order');
  if (!error) tasksV2 = data || [];
  console.log('✅ タスク読み込み完了:', tasksV2.length, '件');
}

async function loadVendorsV2() {
  console.log('🔄 業者データ読み込み開始...', {
    timestamp: new Date().toISOString()
  });

  const { data, error } = await supabase
    .from('vendors_v2')
    .select('*')
    .order('company');

  console.log('📡 loadVendorsV2 Supabaseレスポンス:', {
    success: !error,
    dataLength: data?.length || 0,
    error: error,
    rawDataSample: data?.slice(0, 2)
  });

  if (error) {
    console.error('❌ 業者読み込みエラー:', error);
    vendorsV2 = [];
    return;
  }

  vendorsV2 = data || [];
  console.log('✅ 業者読み込み完了:', {
    count: vendorsV2.length,
    vendors: vendorsV2
  });
}

function mergeVendorCategories() {
  console.log('🔗 mergeVendorCategories() 開始:', {
    vendorsV2Length: vendorsV2.length,
    vendorCategoriesLength: vendorCategories.length,
    vendorCategories: vendorCategories
  });

  // カテゴリ情報を業者データにマージ（Promise.allSettled完了後に呼び出す）
  if (vendorsV2.length > 0 && vendorCategories.length > 0) {
    vendorsV2 = vendorsV2.map(vendor => {
      const category = vendorCategories.find(c => c.id === vendor.category_id);
      return {
        ...vendor,
        vendor_categories: category ? { name: category.name } : null
      };
    });
    console.log('✅ 業者-カテゴリマージ完了:', vendorsV2.slice(0, 2));
  } else {
    console.warn('⚠️ マージスキップ:', {
      vendorsV2Empty: vendorsV2.length === 0,
      vendorCategoriesEmpty: vendorCategories.length === 0
    });
  }
}

async function loadTaskVendorMappings() {
  console.log('🔄 タスク-業者紐づけデータ読み込み開始...', {
    timestamp: new Date().toISOString()
  });

  const { data, error } = await supabase
    .from('task_vendor_mappings_v2')
    .select('*');

  console.log('📡 loadTaskVendorMappings Supabaseレスポンス:', {
    success: !error,
    dataLength: data?.length || 0,
    error: error,
    rawDataSample: data?.slice(0, 3)
  });

  if (!error) taskVendorMappings = data || [];

  console.log('✅ タスク-業者紐づけ読み込み完了:', {
    count: taskVendorMappings.length,
    mappings: taskVendorMappings
  });
}

async function loadProducts() {
  const { data, error } = await supabase
    .from('products')
    .select('*')
    .order('display_order');
  if (!error && data) {
    products = data;
  } else {
    // テーブルが存在しない場合のフォールバック
    products = [
      { id: '1', name: 'LIFE', display_order: 1 },
      { id: '2', name: 'LIFE+', display_order: 2 },
      { id: '3', name: 'HOURS', display_order: 3 },
      { id: '4', name: 'LACIE', display_order: 4 },
      { id: '5', name: 'LIFEリミ', display_order: 5 },
      { id: '6', name: 'LIFE+リミ', display_order: 6 }
    ];
  }
  console.log('✅ 商品読み込み完了:', products.length, '件');
}

// ============================================
// 業者管理V2
// ============================================
let currentCategoryFilter = 'ALL';

function renderVendorsV2() {
  console.log('📞 renderVendorsV2() 呼び出し開始');
  console.log('📊 vendorsV2配列の状態:', {
    length: vendorsV2.length,
    data: vendorsV2.slice(0, 3),
    全データ: vendorsV2
  });

  const container = document.getElementById('vendorsGrid');
  console.log('🎯 vendorsGrid要素:', container ? 'found ✓' : 'NOT FOUND ✗');

  if (!container) {
    console.error('❌ CRITICAL: vendorsGrid要素が見つかりません！');
    console.log('📍 現在のDOM状態:', document.getElementById('vendorsPanel'));
    return;
  }

  console.log('🔍 renderVendorsV2():', {
    totalVendors: vendorsV2.length,
    currentFilter: currentCategoryFilter,
    vendors: vendorsV2
  });

  const filtered = currentCategoryFilter === 'ALL'
    ? vendorsV2
    : vendorsV2.filter(v => v.category_id === currentCategoryFilter);

  console.log('🔍 フィルター後の業者数:', filtered.length);

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">📦</div><p>業者が登録されていません<br><small>「+ 業者追加」ボタンから登録してください</small></p></div>';
    return;
  }

  container.innerHTML = filtered.map(vendor => {
    const categoryName = vendor.vendor_categories?.name || '未分類';
    return `
      <div class="vendor-card">
        <div class="vendor-header">
          <h3>${vendor.company}</h3>
          <span class="badge badge-primary">${categoryName}</span>
        </div>
        <div class="vendor-info">
          <div><strong>担当者:</strong> ${vendor.contact || '-'}</div>
          <div><strong>TEL:</strong> ${vendor.tel || '-'}</div>
          <div><strong>Email:</strong> ${vendor.email || '-'}</div>
        </div>
        <div class="vendor-actions">
          <button class="btn btn-secondary btn-small" onclick="editVendorV2('${vendor.id}')">編集</button>
          <button class="btn btn-danger btn-small" onclick="deleteVendorV2('${vendor.id}')">削除</button>
        </div>
      </div>
    `;
  }).join('');
}

function setCategoryFilter(categoryId) {
  currentCategoryFilter = categoryId;
  document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  renderVendorsV2();
}

function openVendorModalV2(vendorId = null) {
  const modal = document.getElementById('vendorModalV2');
  const title = document.getElementById('vendorModalTitle');

  // カテゴリドロップダウンを更新
  populateVendorCategoryDropdown();

  if (vendorId) {
    const vendor = vendorsV2.find(v => v.id === vendorId);
    if (!vendor) return;

    title.textContent = '業者編集';
    document.getElementById('vendorId').value = vendor.id;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact || '';
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email || '';
    document.getElementById('vendorCategory').value = vendor.category_id || '';
    document.getElementById('vendorSubject').value = vendor.subject_format || '';
    document.getElementById('vendorTemplate').value = vendor.template_text || '';
    document.getElementById('vendorHasSpecial').checked = vendor.has_special_content || false;
    document.getElementById('vendorSpecialContent').value = vendor.default_special_content || '';
    toggleSpecialContent();
  } else {
    title.textContent = '業者追加';
    document.getElementById('vendorForm').reset();
    document.getElementById('vendorId').value = '';
    document.getElementById('vendorHasSpecial').checked = false;
    toggleSpecialContent();
  }

  modal.style.display = 'flex';
}

function closeVendorModalV2() {
  document.getElementById('vendorModalV2').style.display = 'none';
}

function toggleSpecialContent() {
  const hasSpecial = document.getElementById('vendorHasSpecial').checked;
  const specialGroup = document.getElementById('specialContentGroup');
  specialGroup.style.display = hasSpecial ? 'block' : 'none';
}

async function saveVendorV2() {
  const id = document.getElementById('vendorId').value;
  const company = document.getElementById('vendorCompany').value.trim();
  const contact = document.getElementById('vendorContact').value.trim();
  const tel = document.getElementById('vendorTel').value.trim();
  const email = document.getElementById('vendorEmail').value.trim();
  const categoryId = document.getElementById('vendorCategory').value;
  const subjectFormat = document.getElementById('vendorSubject').value.trim();
  const templateText = document.getElementById('vendorTemplate').value.trim();
  const hasSpecial = document.getElementById('vendorHasSpecial').checked;
  const specialContent = document.getElementById('vendorSpecialContent').value.trim();

  if (!company) {
    showToast('会社名を入力してください', 'error');
    return;
  }

  showStatus('保存中...', 'saving');

  const vendorData = {
    company,
    contact: contact || null,
    tel: tel || null,
    email: email || null,
    category_id: categoryId || null,
    subject_format: subjectFormat || null,
    template_text: templateText || null,
    has_special_content: hasSpecial,
    default_special_content: hasSpecial ? specialContent : null
  };

  let result;
  if (id) {
    result = await supabase
      .from('vendors_v2')
      .update(vendorData)
      .eq('id', id)
      .select('*, vendor_categories(name)');
  } else {
    result = await supabase
      .from('vendors_v2')
      .insert([vendorData])
      .select('*, vendor_categories(name)');
  }

  if (result.error) {
    showStatus('保存失敗', 'error');
    showToast('保存に失敗しました: ' + result.error.message, 'error');
    return;
  }

  showStatus('保存完了', 'success');
  showToast(id ? '業者を更新しました' : '業者を追加しました', 'success');
  closeVendorModalV2();
  await loadVendorsV2();
  renderVendorsV2();
}

function editVendorV2(vendorId) {
  openVendorModalV2(vendorId);
}

async function deleteVendorV2(vendorId) {
  const vendor = vendorsV2.find(v => v.id === vendorId);
  if (!vendor) return;

  if (!confirm(`「${vendor.company}」を削除しますか？`)) return;

  showStatus('削除中...', 'saving');

  const { error } = await supabase
    .from('vendors_v2')
    .delete()
    .eq('id', vendorId);

  if (error) {
    showStatus('削除失敗', 'error');
    showToast('削除に失敗しました: ' + error.message, 'error');
    return;
  }

  showStatus('削除完了', 'success');
  showToast('業者を削除しました', 'success');
  await loadVendorsV2();
  renderVendorsV2();
}

// ============================================
// カテゴリ管理
// ============================================
function renderCategoriesList() {
  const container = document.getElementById('categoriesGrid');
  if (!container) return;

  if (vendorCategories.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">🏷️</div><p>カテゴリが登録されていません</p></div>';
    return;
  }

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>表示順</th>
            <th>カテゴリ名</th>
            <th>業者数</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          ${vendorCategories.map(cat => {
            const count = vendorsV2.filter(v => v.category_id === cat.id).length;
            return `
              <tr>
                <td>${cat.display_order}</td>
                <td><strong>${cat.name}</strong></td>
                <td>${count}社</td>
                <td>
                  <button class="btn btn-secondary btn-small" onclick="editCategory('${cat.id}')">編集</button>
                  <button class="btn btn-danger btn-small" onclick="deleteCategory('${cat.id}')">削除</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function openCategoryModal(categoryId = null) {
  const modal = document.getElementById('categoryModal');
  const title = document.getElementById('categoryModalTitle');

  if (categoryId) {
    const category = vendorCategories.find(c => c.id === categoryId);
    if (!category) return;

    title.textContent = 'カテゴリ編集';
    document.getElementById('categoryId').value = category.id;
    document.getElementById('categoryName').value = category.name;
    document.getElementById('categoryOrder').value = category.display_order;
  } else {
    title.textContent = 'カテゴリ追加';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryOrder').value = vendorCategories.length + 1;
  }

  modal.style.display = 'flex';
}

function closeCategoryModal() {
  document.getElementById('categoryModal').style.display = 'none';
}

async function saveCategory() {
  const id = document.getElementById('categoryId').value;
  const name = document.getElementById('categoryName').value.trim();
  const order = parseInt(document.getElementById('categoryOrder').value) || 0;

  if (!name) {
    showToast('カテゴリ名を入力してください', 'error');
    return;
  }

  showStatus('保存中...', 'saving');

  const categoryData = {
    name,
    display_order: order
  };

  let result;
  if (id) {
    result = await supabase
      .from('vendor_categories')
      .update(categoryData)
      .eq('id', id)
      .select();
  } else {
    result = await supabase
      .from('vendor_categories')
      .insert([categoryData])
      .select();
  }

  if (result.error) {
    showStatus('保存失敗', 'error');
    showToast('保存に失敗しました: ' + result.error.message, 'error');
    return;
  }

  showStatus('保存完了', 'success');
  showToast(id ? 'カテゴリを更新しました' : 'カテゴリを追加しました', 'success');
  closeCategoryModal();
  await loadVendorCategories();
  renderCategoriesList();
  renderCategoryFilters();
}

function editCategory(categoryId) {
  openCategoryModal(categoryId);
}

async function deleteCategory(categoryId) {
  const category = vendorCategories.find(c => c.id === categoryId);
  if (!category) return;

  const vendorCount = vendorsV2.filter(v => v.category_id === categoryId).length;
  if (vendorCount > 0) {
    showToast(`このカテゴリには${vendorCount}社の業者が紐づいています。先に業者を削除してください。`, 'error');
    return;
  }

  if (!confirm(`カテゴリ「${category.name}」を削除しますか？`)) return;

  showStatus('削除中...', 'saving');

  const { error } = await supabase
    .from('vendor_categories')
    .delete()
    .eq('id', categoryId);

  if (error) {
    showStatus('削除失敗', 'error');
    showToast('削除に失敗しました: ' + error.message, 'error');
    return;
  }

  showStatus('削除完了', 'success');
  showToast('カテゴリを削除しました', 'success');
  await loadVendorCategories();
  renderCategoriesList();
  renderCategoryFilters();
}

function renderCategoryFilters() {
  const container = document.getElementById('categoryFilters');
  if (!container) return;

  let html = `<button class="category-filter-btn ${currentCategoryFilter === 'ALL' ? 'active' : ''}" onclick="setCategoryFilter('ALL')">全て (${vendorsV2.length})</button>`;

  vendorCategories.forEach(cat => {
    const count = vendorsV2.filter(v => v.category_id === cat.id).length;
    html += `<button class="category-filter-btn ${currentCategoryFilter === cat.id ? 'active' : ''}" onclick="setCategoryFilter('${cat.id}')">${cat.name} (${count})</button>`;
  });

  container.innerHTML = html;
}

// ============================================
// 商品管理
// ============================================
function renderProductsList() {
  const container = document.getElementById('productsGrid');
  if (!container) return;

  if (products.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">📦</div><p>商品が登録されていません</p></div>';
    return;
  }

  container.innerHTML = '<div class="table-container"><table class="table"><thead><tr><th>商品名</th><th>表示順</th><th>操作</th></tr></thead><tbody>' +
    products.map(product => `
      <tr>
        <td><strong>${product.name}</strong></td>
        <td>${product.display_order}</td>
        <td><button class="btn btn-danger btn-small" onclick="deleteProductInline('${product.id}')">削除</button></td>
      </tr>
    `).join('') +
    '</tbody></table></div>';
}

async function addProductInline() {
  const name = document.getElementById('newProductNameInline').value.trim();

  if (!name) {
    showToast('商品名を入力してください', 'error');
    return;
  }

  if (products.find(p => p.name === name)) {
    showToast('既に存在する商品名です', 'error');
    return;
  }

  showStatus('追加中...', 'saving');

  const maxDisplayOrder = products.length > 0 ? Math.max(...products.map(p => p.display_order || 0)) : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('products')
    .insert([{ name, display_order: newDisplayOrder }])
    .select();

  if (error) {
    // テーブルが存在しない場合、ローカルに追加
    products.push({ id: Date.now().toString(), name, display_order: newDisplayOrder });
    document.getElementById('newProductNameInline').value = '';
    renderProductsList();
    populateProductDropdown();
    showStatus('保存済み', 'saved');
    showToast('商品を追加しました（ローカルのみ）', 'success');
    return;
  }

  products.push(data[0]);
  document.getElementById('newProductNameInline').value = '';
  renderProductsList();
  populateProductDropdown();
  showStatus('保存済み', 'saved');
  showToast('商品を追加しました', 'success');
}

async function deleteProductInline(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;

  if (!confirm(`商品「${product.name}」を削除しますか？`)) return;

  showStatus('削除中...', 'saving');

  const { error } = await supabase
    .from('products')
    .delete()
    .eq('id', productId);

  if (error && !error.message.includes('does not exist')) {
    showStatus('エラー', 'error');
    showToast('削除に失敗しました: ' + error.message, 'error');
    return;
  }

  products = products.filter(p => p.id !== productId);
  renderProductsList();
  populateProductDropdown();
  showStatus('保存済み', 'saved');
  showToast('商品を削除しました', 'success');
}

function populateProductDropdown() {
  const select = document.getElementById('projectSpecifications');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">選択してください</option>' +
    products.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

  if (currentValue) select.value = currentValue;
}

// ============================================
// タスク管理
// ============================================
function renderTasksManagement() {
  const container = document.getElementById('tasksGrid');
  if (!container) return;

  const sekkeiTasks = tasksV2.filter(t => t.category === '設計');
  const icTasks = tasksV2.filter(t => t.category === 'IC');

  container.innerHTML = `
    <div class="tasks-section">
      <h3 style="margin: 0 0 16px; font-size: 18px; font-weight: 600;">設計タスク (${sekkeiTasks.length}件)</h3>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>表示順</th>
              <th>タスク名</th>
              <th>状態管理</th>
              <th>紐づけ業者</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            ${sekkeiTasks.map(task => renderTaskRow(task)).join('')}
          </tbody>
        </table>
      </div>
    </div>
    <div class="tasks-section" style="margin-top: 32px;">
      <h3 style="margin: 0 0 16px; font-size: 18px; font-weight: 600;">ICタスク (${icTasks.length}件)</h3>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>表示順</th>
              <th>タスク名</th>
              <th>状態管理</th>
              <th>紐づけ業者</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            ${icTasks.map(task => renderTaskRow(task)).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderTaskRow(task) {
  const mappings = taskVendorMappings.filter(m => m.task_id === task.id);
  const vendorNames = mappings.map(m => {
    const vendor = vendorsV2.find(v => v.id === m.vendor_id);
    return vendor ? vendor.company : '不明';
  }).join(', ');

  const stateInfo = task.has_state ?
    `<span class="badge badge-success">あり</span>` :
    `<span class="badge badge-secondary">なし</span>`;

  return `
    <tr>
      <td>${task.display_order}</td>
      <td><strong>${task.task_name}</strong></td>
      <td>${stateInfo}</td>
      <td>${vendorNames || '-'}</td>
      <td>
        <button class="btn btn-secondary btn-small" onclick="editTask('${task.id}')">編集</button>
        <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')">削除</button>
      </td>
    </tr>
  `;
}

function openTaskModal(taskId = null) {
  const modal = document.getElementById('taskModal');
  const title = document.getElementById('taskModalTitle');

  if (taskId) {
    const task = tasksV2.find(t => t.id === taskId);
    if (!task) return;

    title.textContent = 'タスク編集';
    document.getElementById('taskId').value = task.id;
    document.getElementById('taskKey').value = task.task_key;
    document.getElementById('taskName').value = task.task_name;
    document.getElementById('taskCategory').value = task.category;
    document.getElementById('taskOrder').value = task.display_order;
    document.getElementById('taskHasState').checked = task.has_state;
    document.getElementById('taskStateOptions').value = task.state_options ? JSON.stringify(task.state_options) : '';
    toggleTaskState();
    populateTaskVendorSelection(taskId);
  } else {
    title.textContent = 'タスク追加';
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskCategory').value = '設計';
    document.getElementById('taskOrder').value = tasksV2.length + 1;
    document.getElementById('taskHasState').checked = false;
    toggleTaskState();
    populateTaskVendorSelection(null);
  }

  modal.style.display = 'flex';
}

function populateTaskVendorSelection(taskId) {
  const container = document.getElementById('taskVendorSelection');
  if (!container) return;

  // 現在のタスクに紐づいている業者IDリストを取得
  const currentMappings = taskId ? taskVendorMappings.filter(m => m.task_id === taskId).map(m => m.vendor_id) : [];

  // カテゴリごとにグループ化して表示
  const categories = [...new Set(vendorsV2.map(v => v.vendor_categories?.name || '未分類'))].sort();

  container.innerHTML = categories.map(category => {
    const categoryVendors = vendorsV2.filter(v => (v.vendor_categories?.name || '未分類') === category);

    return `
      <div style="margin-bottom: 12px;">
        <div style="font-weight: 600; color: #4A90E2; margin-bottom: 4px; font-size: 12px;">${category}</div>
        ${categoryVendors.map(vendor => `
          <label style="display: block; padding: 4px 0; cursor: pointer;">
            <input type="checkbox"
                   value="${vendor.id}"
                   ${currentMappings.includes(vendor.id) ? 'checked' : ''}
                   style="margin-right: 8px;">
            ${vendor.company}
          </label>
        `).join('')}
      </div>
    `;
  }).join('');
}

function closeTaskModal() {
  document.getElementById('taskModal').style.display = 'none';
}

function toggleTaskState() {
  const hasState = document.getElementById('taskHasState').checked;
  const stateGroup = document.getElementById('stateOptionsGroup');
  stateGroup.style.display = hasState ? 'block' : 'none';
}

async function saveTask() {
  const id = document.getElementById('taskId').value;
  const taskKey = document.getElementById('taskKey').value.trim();
  const taskName = document.getElementById('taskName').value.trim();
  const category = document.getElementById('taskCategory').value;
  const order = parseInt(document.getElementById('taskOrder').value) || 0;
  const hasState = document.getElementById('taskHasState').checked;
  const stateOptionsStr = document.getElementById('taskStateOptions').value.trim();

  if (!taskKey || !taskName) {
    showToast('タスクキーとタスク名を入力してください', 'error');
    return;
  }

  let stateOptions = null;
  if (hasState && stateOptionsStr) {
    try {
      stateOptions = JSON.parse(stateOptionsStr);
    } catch (e) {
      showToast('状態オプションのJSON形式が正しくありません', 'error');
      return;
    }
  }

  showStatus('保存中...', 'saving');

  const taskData = {
    task_key: taskKey,
    task_name: taskName,
    category,
    display_order: order,
    has_state: hasState,
    state_options: stateOptions
  };

  let result;
  if (id) {
    result = await supabase
      .from('tasks')
      .update(taskData)
      .eq('id', id)
      .select();
  } else {
    result = await supabase
      .from('tasks')
      .insert([taskData])
      .select();
  }

  if (result.error) {
    showStatus('保存失敗', 'error');
    showToast('保存に失敗しました: ' + result.error.message, 'error');
    return;
  }

  // 業者紐づけの保存
  const savedTaskId = id || result.data[0].id;
  await saveTaskVendorMappings(savedTaskId);

  showStatus('保存完了', 'success');
  showToast(id ? 'タスクを更新しました' : 'タスクを追加しました', 'success');
  closeTaskModal();
  await loadTasksV2();
  await loadTaskVendorMappings();
  renderTasksManagement();
}

async function saveTaskVendorMappings(taskId) {
  // 選択された業者IDを取得
  const checkboxes = document.querySelectorAll('#taskVendorSelection input[type="checkbox"]:checked');
  const selectedVendorIds = Array.from(checkboxes).map(cb => cb.value);

  // 既存の紐づけを全削除
  await supabase
    .from('task_vendor_mappings_v2')
    .delete()
    .eq('task_id', taskId);

  // 新しい紐づけを作成
  if (selectedVendorIds.length > 0) {
    const mappings = selectedVendorIds.map(vendorId => ({
      task_id: taskId,
      vendor_id: vendorId
    }));

    const { error } = await supabase
      .from('task_vendor_mappings_v2')
      .insert(mappings);

    if (error) {
      console.error('業者紐づけ保存エラー:', error);
      showToast('業者紐づけの保存に失敗しました', 'error');
    }
  }
}

function editTask(taskId) {
  openTaskModal(taskId);
}

async function deleteTask(taskId) {
  const task = tasksV2.find(t => t.id === taskId);
  if (!task) return;

  if (!confirm(`タスク「${task.task_name}」を削除しますか？`)) return;

  showStatus('削除中...', 'saving');

  const { error } = await supabase
    .from('tasks')
    .delete()
    .eq('id', taskId);

  if (error) {
    showStatus('削除失敗', 'error');
    showToast('削除に失敗しました: ' + error.message, 'error');
    return;
  }

  showStatus('削除完了', 'success');
  showToast('タスクを削除しました', 'success');
  await loadTasksV2();
  renderTasksManagement();
}

// ============================================
// UI制御
// ============================================
// サイドバー描画
function renderSidebar() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = designers.filter(d => d.category === '設計').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = designers.filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const allCount = projects.filter(p => p.status !== 'completed').length;

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">全案件</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
    </div>
  `;

  if (sekkeiDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">📐 設計担当</div>';
    sekkeiDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label">${designer.name}</span>
          <span class="sidebar-item-count">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  if (icDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">🎨 IC担当</div>';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label">${designer.name}</span>
          <span class="sidebar-item-count">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  container.innerHTML = html;
}

function selectDesigner(name) {
  currentDesignerTab = name;

  // URLを更新
  updateURLWithDesigner(name);

  renderSidebar();
  renderProjects();
}

// メインタブ切り替え
function switchMainTab(tabName, element) {
  console.log('📑 switchMainTab 開始:', {
    tabName: tabName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // URLを更新（handleHashChange処理中でない場合のみ）
  if (!isHandlingHashChange && window.location.hash !== '#' + tabName) {
    console.log('🔗 switchMainTab: URLを更新:', tabName);
    window.location.hash = tabName;
  } else {
    console.log('⏸️ switchMainTab: URL更新をスキップ (isHandlingHashChange=' + isHandlingHashChange + ')');
  }
}

// サブタブ切り替え
function switchSubTab(panelName, element) {
  console.log('📑 switchSubTab 開始:', {
    panelName: panelName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.sub-tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(panelName + 'Panel').classList.add('active');

  // URLを更新（handleHashChange処理中でない場合のみ）
  if (!isHandlingHashChange && window.location.hash !== `#settings/${panelName}`) {
    console.log('🔗 switchSubTab: URLを更新:', panelName);
    window.location.hash = `settings/${panelName}`;
  } else {
    console.log('⏸️ switchSubTab: URL更新をスキップ (isHandlingHashChange=' + isHandlingHashChange + ')');
  }

  // サブタブ切り替え時に対応する描画関数を実行
  switch(panelName) {
    case 'staff':
      renderDesignerListInline();
      break;
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
    case 'products':
      renderProductsList();
      break;
  }
}

// 旧switchTab関数（互換性のため残す）
function switchTab(tabName, element) {
  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) {
    element.classList.add('active');
  } else {
    // フォールバック：tabNameに基づいてアクティブなボタンを見つける
    const buttons = document.querySelectorAll('.tab-nav-btn');
    buttons.forEach((btn, index) => {
      const tabs = ['projects', 'vendors', 'categories', 'tasks', 'settings'];
      if (tabs[index] === tabName) {
        btn.classList.add('active');
      }
    });
  }
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // タブ切り替え時に対応する描画関数を実行
  switch(tabName) {
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
  }
}

// カテゴリドロップダウンを動的に生成
function populateVendorCategoryDropdown() {
  const dropdown = document.getElementById('vendorCategory');
  if (!dropdown) return;

  dropdown.innerHTML = '<option value="">カテゴリを選択...</option>' +
    vendorCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
}

function showStatus(message, type) {
  const indicator = document.getElementById('statusIndicator');
  const text = document.getElementById('statusText');
  indicator.className = 'status-indicator status-' + type;
  text.textContent = message;
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.className = 'toast toast-' + type + ' show';
  toast.textContent = message;
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// ============================================
// メール作成（新システム）
// ============================================
function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  if (!taskDef) {
    showToast('タスク定義が見つかりません', 'error');
    return;
  }

  // このタスクに紐づく業者を取得
  const mappings = taskVendorMappings.filter(m => m.task_id === taskDef.id);
  const linkedVendors = mappings.map(m => vendorsV2.find(v => v.id === m.vendor_id)).filter(v => v);

  if (linkedVendors.length === 0) {
    showToast('このタスクには業者が紐づいていません', 'error');
    return;
  }

  if (linkedVendors.length === 1) {
    // 業者が1つの場合は直接メール作成画面を表示
    openEmailComposer(project, taskDef, linkedVendors[0]);
  } else {
    // 業者が複数の場合は選択画面を表示
    showVendorSelection(project, taskDef, linkedVendors);
  }
}

function showVendorSelection(project, taskDef, vendors) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  content.innerHTML = `
    <h3 style="margin-bottom: 16px;">業者を選択してください</h3>
    <div style="display: flex; flex-direction: column; gap: 12px;">
      ${vendors.map(vendor => `
        <button class="template-select-btn" onclick="openEmailComposer(
          projects.find(p => p.id === '${project.id}'),
          tasksV2.find(t => t.id === '${taskDef.id}'),
          vendorsV2.find(v => v.id === '${vendor.id}')
        )">
          <div style="font-weight: 600; margin-bottom: 4px;">${vendor.company}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">${vendor.contact || ''}</div>
        </button>
      `).join('')}
    </div>
  `;

  modal.style.display = 'flex';
}

function openEmailComposer(project, taskDef, vendor) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // 現在の担当者情報を取得
  const assignee = designers.find(d => d.name === project.assigned_to);
  const staffName = assignee?.name || project.assigned_to;

  // 期日を計算（今日+1週間）
  const dueDate = new Date();
  dueDate.setDate(dueDate.getDate() + 7);
  const dueDateStr = `${dueDate.getMonth() + 1}/${dueDate.getDate()}`;

  // 変数置換用のデータ
  const variables = {
    company: vendor.company,
    contact: vendor.contact || '',
    customerName: project.customer,
    dueDate: dueDateStr,
    staffName: staffName,
    specialContent: vendor.default_special_content || ''
  };

  // 件名と本文の置換
  let subject = vendor.subject_format || '';
  let body = vendor.template_text || '';

  Object.keys(variables).forEach(key => {
    const regex = new RegExp(`\\{${key}\\}`, 'g');
    subject = subject.replace(regex, variables[key]);
    body = body.replace(regex, variables[key]);
  });

  // メール作成UI
  content.innerHTML = `
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <div>
        <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">業者</div>
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
          <div style="font-weight: 600;">${vendor.company}</div>
          <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${vendor.contact || ''}</div>
        </div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">宛先</label>
        <input type="email" id="emailTo" class="form-input" value="${vendor.email || ''}" placeholder="メールアドレス">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">件名</label>
        <input type="text" id="emailSubject" class="form-input" value="${subject}">
      </div>

      ${vendor.has_special_content ? `
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">特別コンテンツ</label>
          <textarea id="emailSpecialContent" class="form-textarea" rows="3">${vendor.default_special_content || ''}</textarea>
          <div class="form-hint">本文中の {specialContent} に置換されます</div>
        </div>
      ` : ''}

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">期日</label>
        <input type="text" id="emailDueDate" class="form-input" value="${dueDateStr}">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">本文プレビュー</label>
        <textarea id="emailBody" class="form-textarea" rows="15">${body}</textarea>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-ghost" onclick="closeEmailModal()">キャンセル</button>
        <button class="btn btn-primary" onclick="copyEmailToClipboard()">📋 クリップボードにコピー</button>
      </div>
    </div>
  `;

  // 特別コンテンツや期日の変更時に本文を更新
  if (vendor.has_special_content) {
    document.getElementById('emailSpecialContent').addEventListener('input', () => updateEmailBody(vendor, variables));
  }
  document.getElementById('emailDueDate').addEventListener('input', () => updateEmailBody(vendor, variables));

  modal.style.display = 'flex';
}

function updateEmailBody(vendor, baseVariables) {
  const specialContent = document.getElementById('emailSpecialContent')?.value || baseVariables.specialContent;
  const dueDate = document.getElementById('emailDueDate').value;

  const variables = { ...baseVariables, specialContent, dueDate };

  let body = vendor.template_text || '';
  Object.keys(variables).forEach(key => {
    const regex = new RegExp(`\\{${key}\\}`, 'g');
    body = body.replace(regex, variables[key]);
  });

  document.getElementById('emailBody').value = body;
}

function copyEmailToClipboard() {
  const to = document.getElementById('emailTo').value;
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;

  const emailText = `To: ${to}\nSubject: ${subject}\n\n${body}`;

  navigator.clipboard.writeText(emailText).then(() => {
    showToast('クリップボードにコピーしました', 'success');
  }).catch(err => {
    showToast('コピーに失敗しました', 'error');
  });
}

function closeEmailModal() {
  document.getElementById('emailModal').style.display = 'none';
}

// ============================================
// 案件管理
// ============================================
function renderDesignerTabs() {
  const container = document.getElementById('designerTabs');
  if (!container) {
    console.warn('⚠️ designerTabs要素が見つかりません');
    return;
  }

  console.log('🎨 担当者タブ描画:', {
    総スタッフ数: designers.length,
    設計担当: designers.filter(d => d.category === '設計').length,
    IC担当: designers.filter(d => d.category === 'IC').length,
    案件数: projects.length
  });

  const activeCount = projects.filter(p => p.status !== 'completed').length;

  let html = `<button class="designer-tab ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="setDesignerTab('ALL')">全案件 (${activeCount})</button>`;

  // 設計担当
  const sekkeiDesigners = designers.filter(d => d.category === '設計');
  console.log('📐 設計担当:', sekkeiDesigners.map(d => d.name));
  if (sekkeiDesigners.length > 0) {
    html += '<div class="designer-group-label">設計担当</div>';
    sekkeiDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  } else {
    console.warn('⚠️ 設計担当が0名です');
  }

  // IC担当
  const icDesigners = designers.filter(d => d.category === 'IC');
  console.log('🎨 IC担当:', icDesigners.map(d => d.name));
  if (icDesigners.length > 0) {
    html += '<div class="designer-group-label">IC担当</div>';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  }

  container.innerHTML = html;
}

function setDesignerTab(name) {
  currentDesignerTab = name;

  // URLを更新
  updateURLWithDesigner(name);

  renderDesignerTabs();
  renderProjects();
}

function renderProjects() {
  const container = document.getElementById('projectsGrid');
  const emptyState = document.getElementById('emptyProjects');

  let filtered = projects.filter(p => {
    // 担当者フィルター（設計またはIC担当者）
    if (currentDesignerTab !== 'ALL' &&
        p.assigned_to !== currentDesignerTab &&
        p.ic_assignee !== currentDesignerTab) return false;

    // アーカイブフィルター
    const archiveFilter = document.getElementById('archiveFilter').value;
    const isArchived = p.is_archived || false;
    if (archiveFilter === 'active' && isArchived) return false;
    if (archiveFilter === 'archived' && !isArchived) return false;

    const query = document.getElementById('searchQuery').value.toLowerCase();
    if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

    const specFilter = document.getElementById('specFilter').value;
    if (specFilter && p.specifications !== specFilter) return false;

    return true;
  });

  if (filtered.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  container.style.display = 'grid';
  emptyState.style.display = 'none';
  container.innerHTML = filtered.map(project => renderProjectCard(project)).join('');
}

function renderProjectCard(project) {
  const progress = calculateProgress(project);
  const progressData = project.progress || {};

  // 担当者のカテゴリに応じたタスクリストを取得（新システム）
  const tasks = getTasksForAssignee(project.assigned_to);

  const tasksHtml = tasks.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '' };

    // メールボタン（タスクに業者が紐づいている場合のみ表示）
    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const emailBtn = hasVendor ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="メール作成">📧</button>` : '';

    // デバッグ: メールボタンが表示される条件を確認
    if (taskDef.task_key === 'ventilation' || taskDef.task_key === 'plumbing') {
      console.log('📧 メールボタン判定:', {
        taskKey: taskDef.task_key,
        taskName: taskDef.task_name,
        taskId: taskDef.id,
        hasVendor: hasVendor,
        taskVendorMappingsCount: taskVendorMappings.length,
        matchingMappings: taskVendorMappings.filter(m => m.task_id === taskDef.id)
      });
    }

    // 状態セレクトの生成（タスクに状態管理が有効な場合のみ）
    let stateSelect = '';
    const stateOptions = getTaskStateOptions(key);
    if (stateOptions && Array.isArray(stateOptions)) {
      const stateClass = task.state === '依頼済' ? 'state-yellow' : task.state === '保存済' ? 'state-green' : '';
      stateSelect = `
        <select class="task-state-select ${stateClass}"
          onchange="updateTaskState('${project.id}', '${key}', this.value)">
          ${stateOptions.map(state =>
            `<option value="${state}" ${task.state === state ? 'selected' : ''}>${state || '-'}</option>`
          ).join('')}
        </select>
      `;
    }

    return `
      <div class="task-item">
        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}
          onchange="updateTaskStatus('${project.id}', '${key}', this.checked)">
        <span class="task-label">${taskDef.task_name}</span>
        ${stateSelect}
        ${emailBtn}
      </div>
    `;
  }).join('');

  return `
    <div class="project-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            ${project.customer}
            <span class="badge badge-primary">${project.specifications || 'LIFE'}</span>
            ${project.is_archived ? '<span class="badge badge-success">完了済み</span>' : ''}
          </div>
          <div class="card-subtitle">
            設計：${project.assigned_to}
            ${project.ic_assignee ? ` / IC：${project.ic_assignee}` : ''}
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          ${project.is_archived
            ? `<button class="btn btn-success btn-small" onclick="toggleArchive('${project.id}', false)">復元</button>`
            : `<button class="btn btn-warning btn-small" onclick="toggleArchive('${project.id}', true)">完了済みにする</button>`
          }
          <button class="btn btn-ghost btn-small" onclick="editProject('${project.id}')">編集</button>
        </div>
      </div>
      <div class="progress-section">
        <div class="progress-header">
          <span class="progress-label">進捗状況</span>
          <span class="progress-value">${progress}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%"></div>
        </div>
      </div>
      <div class="tasks-grid">${tasksHtml}</div>
      ${project.memo ? `<div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md); margin-top: 16px; font-size: 14px; color: var(--text-secondary);">${project.memo}</div>` : ''}
      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--bg-secondary); display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 13px; color: var(--text-muted);">更新: ${formatDateTime(project.updated_at)}</span>
        <button class="btn btn-danger btn-small" onclick="deleteProject('${project.id}')">削除</button>
      </div>
    </div>
  `;
}

function calculateProgress(project) {
  const progressData = project.progress || {};
  const tasks = getTasksForAssignee(project.assigned_to);
  if (tasks.length === 0) return 0;
  const completed = tasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / tasks.length) * 100);
}

function formatDateTime(dateStr) {
  if (!dateStr) return '—';
  const d = new Date(dateStr);
  return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

async function updateTaskStatus(projectId, taskKey, completed) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].completed = completed;
  if (completed && !progressData[taskKey].date) {
    progressData[taskKey].date = new Date().toISOString().split('T')[0];
  }

  showStatus('保存中...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('エラー', 'error');
    showToast('保存に失敗しました: ' + error.message, 'error');
    return;
  }

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('保存済み', 'saved');
}

async function updateTaskState(projectId, taskKey, state) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = state;

  showStatus('保存中...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('エラー', 'error');
    showToast('保存に失敗しました: ' + error.message, 'error');
    return;
  }

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('保存済み', 'saved');
}

function openProjectModal(projectId = null) {
  console.log('📝 openProjectModal() 呼び出し:', projectId);
  console.log('👥 designers配列:', designers);

  editingProjectId = projectId;
  const modal = document.getElementById('projectModal');
  const title = document.getElementById('projectModalTitle');

  console.log('🎯 modal要素:', modal);
  console.log('🎯 title要素:', title);

  if (projectId) {
    const project = projects.find(p => p.id === projectId);
    title.textContent = '案件編集';
    document.getElementById('projectCustomer').value = project.customer;
    document.getElementById('projectAssignedTo').value = project.assigned_to;
    document.getElementById('projectIcAssignee').value = project.ic_assignee || '';
    document.getElementById('projectSpecifications').value = project.specifications || 'LIFE';
    document.getElementById('projectMemo').value = project.memo || '';
  } else {
    title.textContent = '案件追加';
    document.getElementById('projectCustomer').value = '';
    document.getElementById('projectIcAssignee').value = '';
    document.getElementById('projectSpecifications').value = 'LIFE';
    document.getElementById('projectMemo').value = '';
  }

  // 設計担当者（設計カテゴリのみ）を埋める
  console.log('🔧 設計担当者をフィルタリング中...');
  const sekkeiDesigners = designers.filter(d => d.category === '設計');
  console.log('✅ 設計担当者:', sekkeiDesigners);

  const assignedToSelect = document.getElementById('projectAssignedTo');
  console.log('🎯 assignedToSelect要素:', assignedToSelect);

  if (assignedToSelect) {
    assignedToSelect.innerHTML = '<option value="">選択してください</option>' +
      sekkeiDesigners.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
  }

  // IC担当者（ICカテゴリのみ）を埋める
  console.log('🔧 IC担当者をフィルタリング中...');
  const icDesigners = designers.filter(d => d.category === 'IC');
  console.log('✅ IC担当者:', icDesigners);

  const icAssigneeSelect = document.getElementById('projectIcAssignee');
  console.log('🎯 icAssigneeSelect要素:', icAssigneeSelect);

  if (icAssigneeSelect) {
    icAssigneeSelect.innerHTML = '<option value="">未定</option>' +
      icDesigners.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
  }

  console.log('🎬 モーダルを表示します...');
  modal.classList.add('show');
  console.log('✅ openProjectModal() 完了');
}

function closeProjectModal() {
  document.getElementById('projectModal').classList.remove('show');
  editingProjectId = null;
}

async function saveProject() {
  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value;
  const icAssignee = document.getElementById('projectIcAssignee').value; // IC担当者（オプショナル）
  const specifications = document.getElementById('projectSpecifications').value;
  const memo = document.getElementById('projectMemo').value.trim();

  if (!customer || !assignedTo) {
    showToast('お客様名と担当設計士（設計）は必須です', 'error');
    return;
  }

  showStatus('保存中...', 'saving');

  // 担当設計士（設計）のIDを取得
  const designer = designers.find(d => d.name === assignedTo);
  const designerId = designer ? designer.id : null;

  // IC担当者のIDを取得（空文字列の場合はnull）
  const icDesigner = icAssignee ? designers.find(d => d.name === icAssignee) : null;
  const icDesignerId = icDesigner ? icDesigner.id : null;

  const blankProgress = {};
  Object.keys(TASK_NAMES).forEach(key => {
    blankProgress[key] = { completed: false, date: '', state: '' };
  });

  if (editingProjectId) {
    const project = projects.find(p => p.id === editingProjectId);
    const { error } = await supabase
      .from('projects')
      .update({
        customer,
        assigned_to: assignedTo,
        designer_id: designerId,
        ic_assignee: icAssignee || null,
        ic_designer_id: icDesignerId,
        specifications,
        memo,
        updated_at: new Date().toISOString()
      })
      .eq('id', editingProjectId);

    if (error) {
      showStatus('エラー', 'error');
      showToast('保存に失敗しました: ' + error.message, 'error');
      return;
    }

    Object.assign(project, {
      customer,
      assigned_to: assignedTo,
      ic_assignee: icAssignee || null,
      ic_designer_id: icDesignerId,
      specifications,
      memo,
      updated_at: new Date().toISOString()
    });
  } else {
    const newProject = {
      uid: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      customer,
      assigned_to: assignedTo,
      designer_id: designerId,
      ic_assignee: icAssignee || null,
      ic_designer_id: icDesignerId,
      specifications,
      memo,
      status: 'active',
      progress: blankProgress,
      created_by: currentUser.id
    };

    const { data, error } = await supabase
      .from('projects')
      .insert([newProject])
      .select();

    if (error) {
      showStatus('エラー', 'error');
      showToast('保存に失敗しました: ' + error.message, 'error');
      return;
    }

    projects.unshift(data[0]);
  }

  closeProjectModal();
  renderDesignerTabs();
  renderProjects();
  showStatus('保存済み', 'saved');
  showToast('案件を保存しました', 'success');
}

function editProject(projectId) {
  openProjectModal(projectId);
}

async function deleteProject(projectId) {
  if (!confirm('この案件を削除しますか？')) return;

  showStatus('削除中...', 'saving');
  const { error } = await supabase
    .from('projects')
    .delete()
    .eq('id', projectId);

  if (error) {
    showStatus('エラー', 'error');
    showToast('削除に失敗しました: ' + error.message, 'error');
    return;
  }

  projects = projects.filter(p => p.id !== projectId);
  renderDesignerTabs();
  renderProjects();
  showStatus('保存済み', 'saved');
  showToast('案件を削除しました', 'success');
}

async function toggleArchive(projectId, isArchived) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const message = isArchived ? '完了済みにしますか？' : '案件を復元しますか？';
  if (!confirm(message)) return;

  showStatus('更新中...', 'saving');

  const updateData = {
    is_archived: isArchived,
    archived_at: isArchived ? new Date().toISOString() : null
  };

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', projectId);

  if (error) {
    showStatus('エラー', 'error');
    showToast('更新に失敗しました: ' + error.message, 'error');
    return;
  }

  // ローカルデータを更新
  project.is_archived = isArchived;
  project.archived_at = updateData.archived_at;

  renderProjects();
  showStatus('保存済み', 'saved');
  showToast(isArchived ? '案件を完了済みにしました' : '案件を復元しました', 'success');
}

// ============================================
// 設計士管理
// ============================================
function openDesignerModal() {
  renderDesignerList();
  document.getElementById('designerModal').classList.add('show');
}

function closeDesignerModal() {
  document.getElementById('designerModal').classList.remove('show');
}

function renderDesignerList() {
  const container = document.getElementById('designerList');

  // カテゴリで並び替え（設計→IC）
  const sortedDesigners = [...designers].sort((a, b) => {
    if (a.category === '設計' && b.category === 'IC') return -1;
    if (a.category === 'IC' && b.category === '設計') return 1;
    return (a.display_order || 999) - (b.display_order || 999);
  });

  container.innerHTML = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">登録済みスタッフ（' + designers.length + '名）</h3>' +
    '<div class="table-container"><table class="table"><thead><tr><th>スタッフ名</th><th>カテゴリ</th><th>担当案件数</th><th>操作</th></tr></thead><tbody>' +
    sortedDesigners.map(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      const categoryLabel = designer.category === '設計' ? '設計担当' : 'IC担当';
      return `
        <tr>
          <td><strong>${designer.name}</strong></td>
          <td><span class="badge ${designer.category === '設計' ? 'badge-primary' : 'badge-success'}">${categoryLabel}</span></td>
          <td>${count}件</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteDesigner('${designer.id}')">削除</button></td>
        </tr>
      `;
    }).join('') +
    '</tbody></table></div>';
}

async function addDesigner() {
  const name = document.getElementById('newDesignerName').value.trim();
  const category = document.getElementById('newDesignerCategory').value;

  if (!name) {
    showToast('スタッフ名を入力してください', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('既に存在するスタッフ名です', 'error');
    return;
  }

  showStatus('追加中...', 'saving');

  // 同じカテゴリの最大display_orderを取得して+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('エラー', 'error');
    showToast('追加に失敗しました: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerName').value = '';
  renderDesignerList();
  renderDesignerTabs();
  showStatus('保存済み', 'saved');
  showToast('スタッフを追加しました', 'success');
}

async function deleteDesigner(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('このスタッフは案件に割当てられています。案件の担当を変更してから削除してください。', 'error');
    return;
  }

  if (!confirm(`${designer.name}を削除しますか？`)) return;

  showStatus('削除中...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('エラー', 'error');
    showToast('削除に失敗しました: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerList();
  renderDesignerListInline();
  renderSidebar();
  showStatus('保存済み', 'saved');
  showToast('スタッフを削除しました', 'success');
}

// インライン版スタッフ管理関数
function renderDesignerListInline() {
  const container = document.getElementById('designerListInline');
  if (!container) return;

  const sekkeiDesigners = [...designers].filter(d => d.category === '設計').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = [...designers].filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));

  let html = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">登録済みスタッフ（' + designers.length + '名）</h3>';
  html += '<p style="color: var(--text-secondary); margin-bottom: 16px;">💡 行をドラッグ&ドロップして表示順序を変更できます</p>';

  // 設計担当
  if (sekkeiDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--primary-color);">📐 設計担当</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>スタッフ名</th><th>メールアドレス</th><th>担当案件数</th><th>操作</th></tr></thead><tbody id="sekkeiTbody">';
    sekkeiDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      const emailDisplay = designer.email && !designer.email.includes('@temp.local') ? designer.email : '<span style="color: var(--text-muted);">未設定</span>';
      // 認証設定は管理者または本人のみ
      const canManageAuth = currentUserCategory === 'admin' || designer.id === currentDesigner?.id;
      const authButton = canManageAuth ? `<button class="btn btn-secondary btn-small" onclick="openDesignerAuthModal('${designer.id}')" style="margin-right: 8px;">🔑 認証設定</button>` : '';
      html += `
        <tr class="draggable-row" draggable="true" data-designer-id="${designer.id}" data-category="設計">
          <td><span class="drag-handle">≡</span></td>
          <td><strong>${designer.name}</strong></td>
          <td>${emailDisplay}</td>
          <td>${count}件</td>
          <td>
            ${authButton}
            <button class="btn btn-danger btn-small" onclick="deleteDesignerInline('${designer.id}')">削除</button>
          </td>
        </tr>
      `;
    });
    html += '</tbody></table></div>';
  }

  // IC担当
  if (icDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--success-color);">🎨 IC担当</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>スタッフ名</th><th>メールアドレス</th><th>担当案件数</th><th>操作</th></tr></thead><tbody id="icTbody">';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      const emailDisplay = designer.email && !designer.email.includes('@temp.local') ? designer.email : '<span style="color: var(--text-muted);">未設定</span>';
      // 認証設定は管理者または本人のみ
      const canManageAuth = currentUserCategory === 'admin' || designer.id === currentDesigner?.id;
      const authButton = canManageAuth ? `<button class="btn btn-secondary btn-small" onclick="openDesignerAuthModal('${designer.id}')" style="margin-right: 8px;">🔑 認証設定</button>` : '';
      html += `
        <tr class="draggable-row" draggable="true" data-designer-id="${designer.id}" data-category="IC">
          <td><span class="drag-handle">≡</span></td>
          <td><strong>${designer.name}</strong></td>
          <td>${emailDisplay}</td>
          <td>${count}件</td>
          <td>
            ${authButton}
            <button class="btn btn-danger btn-small" onclick="deleteDesignerInline('${designer.id}')">削除</button>
          </td>
        </tr>
      `;
    });
    html += '</tbody></table></div>';
  }

  container.innerHTML = html;

  // ドラッグ&ドロップイベント設定
  setupDragAndDrop();
}

async function addDesignerInline() {
  const name = document.getElementById('newDesignerNameInline').value.trim();
  const category = document.getElementById('newDesignerCategoryInline').value;

  if (!name) {
    showToast('スタッフ名を入力してください', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('既に存在するスタッフ名です', 'error');
    return;
  }

  showStatus('追加中...', 'saving');

  // 同じカテゴリの最大display_orderを取得して+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('エラー', 'error');
    showToast('追加に失敗しました: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerNameInline').value = '';
  renderDesignerListInline();
  renderSidebar();
  showStatus('保存済み', 'saved');
  showToast('スタッフを追加しました', 'success');
}

async function deleteDesignerInline(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('このスタッフは案件に割当てられています。案件の担当を変更してから削除してください。', 'error');
    return;
  }

  if (!confirm(`${designer.name}を削除しますか？`)) return;

  showStatus('削除中...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('エラー', 'error');
    showToast('削除に失敗しました: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerListInline();
  renderSidebar();
  showStatus('保存済み', 'saved');
  showToast('スタッフを削除しました', 'success');
}

// ============================================
// スタッフ認証設定
// ============================================
function openDesignerAuthModal(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  document.getElementById('authDesignerId').value = designer.id;
  document.getElementById('authDesignerName').value = designer.name;
  document.getElementById('authDesignerEmail').value = designer.email && !designer.email.includes('@temp.local') ? designer.email : '';
  document.getElementById('authDesignerPassword').value = '';
  document.getElementById('authDesignerPasswordConfirm').value = '';

  document.getElementById('designerAuthModal').classList.add('show');
}

function closeDesignerAuthModal() {
  document.getElementById('designerAuthModal').classList.remove('show');
}

async function saveDesignerAuth() {
  const designerId = document.getElementById('authDesignerId').value;
  const email = document.getElementById('authDesignerEmail').value.trim();
  const password = document.getElementById('authDesignerPassword').value;
  const passwordConfirm = document.getElementById('authDesignerPasswordConfirm').value;

  // バリデーション
  if (!email) {
    showToast('メールアドレスを入力してください', 'error');
    return;
  }

  if (!password) {
    showToast('パスワードを入力してください', 'error');
    return;
  }

  if (password.length < 8) {
    showToast('パスワードは8文字以上で設定してください', 'error');
    return;
  }

  if (password !== passwordConfirm) {
    showToast('パスワードが一致しません', 'error');
    return;
  }

  showStatus('保存中...', 'saving');

  try {
    const designer = designers.find(d => d.id === designerId);
    const oldEmail = designer.email;

    console.log('🔐 ユーザーアカウント作成開始:', { email, designerId });

    // 1. Supabase Authにユーザーを作成
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        data: {
          name: designer.name,
          designer_id: designerId
        },
        emailRedirectTo: window.location.origin
      }
    });

    console.log('🔐 signUp結果:', { authData, authError });

    if (authError) {
      // ユーザーが既に存在する場合は、パスワードだけを更新できないので警告
      if (authError.message.includes('already registered')) {
        showToast('⚠️ このメールアドレスは既に登録されています。パスワードの変更が必要な場合は、ログイン画面の「パスワードを忘れた」から変更してください。', 'error');
      } else {
        throw authError;
      }
    } else {
      console.log('✅ Supabase Authにユーザー作成完了:', authData.user?.id);
    }

    // 2. designersテーブルのemailを更新
    const { error: updateError } = await supabase
      .from('designers')
      .update({ email: email })
      .eq('id', designerId);

    if (updateError) {
      console.error('❌ designers更新エラー:', updateError);
      showStatus('エラー', 'error');
      showToast('メールアドレスの保存に失敗しました: ' + updateError.message, 'error');
      return;
    }

    console.log('✅ designersテーブル更新完了');

    // 3. デザイナー配列を更新
    const designerIndex = designers.findIndex(d => d.id === designerId);
    if (designerIndex !== -1) {
      designers[designerIndex].email = email;
    }

    closeDesignerAuthModal();
    renderDesignerListInline();
    showStatus('保存済み', 'saved');

    if (authError && authError.message.includes('already registered')) {
      showToast('メールアドレスを保存しました（アカウントは既に存在します）', 'success');
    } else {
      showToast('✅ ログインアカウントを作成しました！このメールアドレスとパスワードでログインできます。', 'success', 5000);
    }

  } catch (error) {
    console.error('❌ 認証設定エラー:', error);
    showStatus('エラー', 'error');
    showToast('認証設定に失敗しました: ' + error.message, 'error');
  }
}

// ドラッグ&ドロップ処理
let draggedElement = null;

function setupDragAndDrop() {
  const draggableRows = document.querySelectorAll('.draggable-row');

  draggableRows.forEach(row => {
    row.addEventListener('dragstart', handleDragStart);
    row.addEventListener('dragover', handleDragOver);
    row.addEventListener('drop', handleDrop);
    row.addEventListener('dragend', handleDragEnd);
    row.addEventListener('dragleave', handleDragLeave);
  });
}

function handleDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }

  // 同じカテゴリ内でのみドロップ可能
  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  if (draggedCategory === targetCategory && this !== draggedElement) {
    this.classList.add('drag-over');
  }

  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  // 同じカテゴリ内でのみドロップ実行
  if (draggedCategory === targetCategory && draggedElement !== this) {
    const draggedId = draggedElement.dataset.designerId;
    const targetId = this.dataset.designerId;

    // 順序を入れ替え
    updateDesignerOrder(draggedId, targetId, draggedCategory);
  }

  this.classList.remove('drag-over');
  return false;
}

function handleDragEnd(e) {
  this.classList.remove('dragging');

  const allRows = document.querySelectorAll('.draggable-row');
  allRows.forEach(row => {
    row.classList.remove('drag-over');
  });
}

function handleDragLeave(e) {
  this.classList.remove('drag-over');
}

async function updateDesignerOrder(draggedId, targetId, category) {
  showStatus('並び替え中...', 'saving');

  // 該当カテゴリのスタッフを取得
  const categoryDesigners = designers.filter(d => d.category === category);

  // ドラッグされたスタッフとターゲットスタッフを見つける
  const draggedIndex = categoryDesigners.findIndex(d => d.id === draggedId);
  const targetIndex = categoryDesigners.findIndex(d => d.id === targetId);

  // 配列を並び替え
  const [draggedDesigner] = categoryDesigners.splice(draggedIndex, 1);
  categoryDesigners.splice(targetIndex, 0, draggedDesigner);

  // display_orderを再計算
  const updates = [];
  for (let i = 0; i < categoryDesigners.length; i++) {
    const designer = categoryDesigners[i];
    const newOrder = i + 1;

    if (designer.display_order !== newOrder) {
      updates.push({
        id: designer.id,
        display_order: newOrder
      });

      // ローカルデータも更新
      const localDesigner = designers.find(d => d.id === designer.id);
      if (localDesigner) {
        localDesigner.display_order = newOrder;
      }
    }
  }

  // Supabaseに一括更新
  for (const update of updates) {
    const { error } = await supabase
      .from('designers')
      .update({ display_order: update.display_order })
      .eq('id', update.id);

    if (error) {
      console.error('並び替えエラー:', error);
      showStatus('エラー', 'error');
      showToast('並び替えに失敗しました: ' + error.message, 'error');
      return;
    }
  }

  // UI更新
  renderDesignerListInline();
  renderSidebar();
  showStatus('保存済み', 'saved');
  showToast('並び替えを保存しました', 'success');
}

// インライン版カテゴリ追加
async function addCategoryInline() {
  const name = document.getElementById('newCategoryNameInline').value.trim();

  if (!name) {
    showToast('カテゴリ名を入力してください', 'error');
    return;
  }

  if (vendorCategories.find(c => c.name === name)) {
    showToast('既に存在するカテゴリ名です', 'error');
    return;
  }

  showStatus('追加中...', 'saving');
  const { data, error } = await supabase
    .from('vendor_categories')
    .insert([{ name, display_order: vendorCategories.length + 1 }])
    .select();

  if (error) {
    showStatus('エラー', 'error');
    showToast('追加に失敗しました: ' + error.message, 'error');
    return;
  }

  vendorCategories.push(data[0]);
  document.getElementById('newCategoryNameInline').value = '';
  renderCategoriesList();
  renderCategoryFilters();
  populateVendorCategoryDropdown();
  showStatus('保存済み', 'saved');
  showToast('カテゴリを追加しました', 'success');
}

// ============================================
// メールテンプレート管理
// ============================================
function renderTemplates() {
  const container = document.getElementById('templatesTable');
  if (!container) return; // 要素が存在しない場合は何もしない

  const categoryFilterEl = document.getElementById('categoryFilter');
  const categoryFilter = categoryFilterEl ? categoryFilterEl.value : null;

  let filtered = emailTemplates;

  // currentUserCategoryに応じてフィルタリング（管理者以外）
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  // さらにカテゴリフィルタを適用
  if (categoryFilter) {
    filtered = filtered.filter(t => t.category === categoryFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">📧</div><div class="empty-title">テンプレートがありません</div><div class="empty-description">メールテンプレートを追加して、案件からワンクリックでメールを作成できます</div><button class="btn btn-primary" onclick="openTemplateModal()">+ テンプレート追加</button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>表示名</th>
          <th>カテゴリ</th>
          <th>会社名</th>
          <th>メールアドレス</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(template => `
          <tr>
            <td><strong>${template.display_name}</strong></td>
            <td><span class="badge ${template.category === 'IC' ? 'badge-success' : 'badge-primary'}">${template.category}</span></td>
            <td>${template.company}</td>
            <td>${template.email || '—'}</td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost btn-small" onclick="editTemplate('${template.id}')">編集</button>
                <button class="btn btn-danger btn-small" onclick="deleteTemplate('${template.id}')">削除</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function openTemplateModal(templateId = null) {
  editingTemplateId = templateId;
  const modal = document.getElementById('templateModal');
  const title = document.getElementById('templateModalTitle');

  if (templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    title.textContent = 'テンプレート編集';
    document.getElementById('templateId').value = template.template_id;
    document.getElementById('templateId').disabled = true;
    document.getElementById('templateDisplayName').value = template.display_name;
    document.getElementById('templateCategory').value = template.category;
    document.getElementById('templateCompany').value = template.company;
    document.getElementById('templateContact').value = template.contact || '';
    document.getElementById('templateEmail').value = template.email || '';
    document.getElementById('templateSubjectFormat').value = template.subject_format || '';
    document.getElementById('templateText').value = template.template_text || '';
  } else {
    title.textContent = 'テンプレート追加';
    document.getElementById('templateId').value = '';
    document.getElementById('templateId').disabled = false;
    document.getElementById('templateDisplayName').value = '';
    document.getElementById('templateCategory').value = '設計';
    document.getElementById('templateCompany').value = '';
    document.getElementById('templateContact').value = '';
    document.getElementById('templateEmail').value = '';
    document.getElementById('templateSubjectFormat').value = '';
    document.getElementById('templateText').value = '';
  }

  modal.classList.add('show');
}

function closeTemplateModal() {
  document.getElementById('templateModal').classList.remove('show');
  editingTemplateId = null;
}

async function saveTemplate() {
  const templateId = document.getElementById('templateId').value.trim();
  const displayName = document.getElementById('templateDisplayName').value.trim();
  const category = document.getElementById('templateCategory').value;
  const company = document.getElementById('templateCompany').value.trim();
  const contact = document.getElementById('templateContact').value.trim();
  const email = document.getElementById('templateEmail').value.trim();
  const subjectFormat = document.getElementById('templateSubjectFormat').value.trim();
  const templateText = document.getElementById('templateText').value.trim();

  if (!templateId || !displayName || !company || !subjectFormat || !templateText) {
    showToast('必須項目を入力してください', 'error');
    return;
  }

  showStatus('保存中...', 'saving');

  const templateData = {
    template_id: templateId,
    display_name: displayName,
    category,
    company,
    contact,
    email,
    subject_format: subjectFormat,
    template_text: templateText,
    has_special_content: false,
    has_sub_options: false,
    created_by: currentUser.id
  };

  if (editingTemplateId) {
    const { error } = await supabase
      .from('email_templates')
      .update(templateData)
      .eq('id', editingTemplateId);

    if (error) {
      showStatus('エラー', 'error');
      showToast('保存に失敗しました: ' + error.message, 'error');
      return;
    }

    const template = emailTemplates.find(t => t.id === editingTemplateId);
    Object.assign(template, templateData);
  } else {
    const { data, error } = await supabase
      .from('email_templates')
      .insert([templateData])
      .select();

    if (error) {
      showStatus('エラー', 'error');
      showToast('保存に失敗しました: ' + error.message, 'error');
      return;
    }

    emailTemplates.push(data[0]);
  }

  closeTemplateModal();
  renderTemplates();
  renderMappings();
  showStatus('保存済み', 'saved');
  showToast('テンプレートを保存しました', 'success');
}

function editTemplate(templateId) {
  openTemplateModal(templateId);
}

async function deleteTemplate(templateId) {
  if (!confirm('このテンプレートを削除しますか？')) return;

  showStatus('削除中...', 'saving');
  const { error } = await supabase
    .from('email_templates')
    .delete()
    .eq('id', templateId);

  if (error) {
    showStatus('エラー', 'error');
    showToast('削除に失敗しました: ' + error.message, 'error');
    return;
  }

  emailTemplates = emailTemplates.filter(t => t.id !== templateId);
  renderTemplates();
  renderMappings();
  showStatus('保存済み', 'saved');
  showToast('テンプレートを削除しました', 'success');
}

// ============================================
// 業者管理
// ============================================
function renderVendors() {
  const container = document.getElementById('vendorsTable');
  if (!container) return; // 要素が存在しない場合は何もしない

  const filterSelect = document.getElementById('vendorTemplateFilter');
  if (!filterSelect) return; // 要素が存在しない場合は何もしない

  const templateFilter = filterSelect.value;

  // フィルターオプションを更新（すべてのテンプレートを表示）
  filterSelect.innerHTML = '<option value="">すべてのテンプレート</option>' +
    emailTemplates.map(t =>
      `<option value="${t.template_id}">${t.display_name}</option>`
    ).join('');
  if (templateFilter) filterSelect.value = templateFilter;

  let filtered = vendors;
  if (templateFilter) {
    filtered = vendors.filter(v => v.template_id === templateFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">👥</div><div class="empty-title">業者情報がありません</div><div class="empty-description">業者情報を登録すると、メールテンプレートで使用できます</div><button class="btn btn-primary" onclick="openVendorModal()">+ 業者追加</button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>会社名</th>
          <th>担当者</th>
          <th>電話番号</th>
          <th>メールアドレス</th>
          <th>テンプレート</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(vendor => {
          const template = emailTemplates.find(t => t.template_id === vendor.template_id);
          return `
            <tr>
              <td><strong>${vendor.company}</strong></td>
              <td>${vendor.contact}</td>
              <td>${vendor.tel || '—'}</td>
              <td>${vendor.email}</td>
              <td>${template ? template.display_name : '—'}</td>
              <td>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-ghost btn-small" onclick="editVendor('${vendor.id}')">編集</button>
                  <button class="btn btn-danger btn-small" onclick="deleteVendor('${vendor.id}')">削除</button>
                </div>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

function openVendorModal(vendorId = null) {
  editingVendorId = vendorId;
  const modal = document.getElementById('vendorModal');
  const title = document.getElementById('vendorModalTitle');

  // テンプレートセレクトを更新
  const templateSelect = document.getElementById('vendorTemplateId');
  templateSelect.innerHTML = '<option value="">選択してください</option>' +
    emailTemplates.map(t => `<option value="${t.template_id}">${t.display_name}</option>`).join('');

  if (vendorId) {
    const vendor = vendors.find(v => v.id === vendorId);
    title.textContent = '業者編集';
    document.getElementById('vendorTemplateId').value = vendor.template_id;
    document.getElementById('vendorId').value = vendor.vendor_id;
    document.getElementById('vendorId').disabled = true;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact;
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email;
  } else {
    title.textContent = '業者追加';
    document.getElementById('vendorTemplateId').value = '';
    document.getElementById('vendorId').value = '';
    document.getElementById('vendorId').disabled = false;
    document.getElementById('vendorCompany').value = '';
    document.getElementById('vendorContact').value = '';
    document.getElementById('vendorTel').value = '';
    document.getElementById('vendorEmail').value = '';
  }

  modal.classList.add('show');
}

function closeVendorModal() {
  document.getElementById('vendorModal').classList.remove('show');
  editingVendorId = null;
}

async function saveVendor() {
  const templateId = document.getElementById('vendorTemplateId').value;
  const vendorId = document.getElementById('vendorId').value.trim();
  const company = document.getElementById('vendorCompany').value.trim();
  const contact = document.getElementById('vendorContact').value.trim();
  const tel = document.getElementById('vendorTel').value.trim();
  const email = document.getElementById('vendorEmail').value.trim();

  if (!templateId || !vendorId || !company || !contact || !email) {
    showToast('必須項目を入力してください', 'error');
    return;
  }

  showStatus('保存中...', 'saving');

  const vendorData = {
    template_id: templateId,
    vendor_id: vendorId,
    company,
    contact,
    tel,
    email,
    created_by: currentUser.id
  };

  if (editingVendorId) {
    const { error } = await supabase
      .from('template_vendors')
      .update(vendorData)
      .eq('id', editingVendorId);

    if (error) {
      showStatus('エラー', 'error');
      showToast('保存に失敗しました: ' + error.message, 'error');
      return;
    }

    const vendor = vendors.find(v => v.id === editingVendorId);
    Object.assign(vendor, vendorData);
  } else {
    const { data, error } = await supabase
      .from('template_vendors')
      .insert([vendorData])
      .select();

    if (error) {
      showStatus('エラー', 'error');
      showToast('保存に失敗しました: ' + error.message, 'error');
      return;
    }

    vendors.push(data[0]);
  }

  closeVendorModal();
  renderVendors();
  showStatus('保存済み', 'saved');
  showToast('業者情報を保存しました', 'success');
}

function editVendor(vendorId) {
  openVendorModal(vendorId);
}

async function deleteVendor(vendorId) {
  if (!confirm('この業者情報を削除しますか？')) return;

  showStatus('削除中...', 'saving');
  const { error } = await supabase
    .from('template_vendors')
    .delete()
    .eq('id', vendorId);

  if (error) {
    showStatus('エラー', 'error');
    showToast('削除に失敗しました: ' + error.message, 'error');
    return;
  }

  vendors = vendors.filter(v => v.id !== vendorId);
  renderVendors();
  showStatus('保存済み', 'saved');
  showToast('業者情報を削除しました', 'success');
}

// ============================================
// タスク-テンプレート紐づけ
// ============================================
function renderMappings() {
  const container = document.getElementById('mappingsGrid');
  if (!container) return; // 要素が存在しない場合は何もしない

  // 旧システムは使用しないため、空のメッセージを表示
  container.innerHTML = '<div class="empty-state"><div class="empty-icon">⚙️</div><div class="empty-title">タスク-テンプレート紐づけは旧システムです</div><div class="empty-description">新システムでは「✅ タスク管理」から業者を紐づけてください</div></div>';
  return;

  container.innerHTML = Object.keys({}).map(taskKey => {
    const templateOptions = emailTemplates.map(t =>
      `<option value="${t.template_id}" ${taskMappings[taskKey] === t.template_id ? 'selected' : ''}>
        ${t.display_name} (${t.category})
      </option>`
    ).join('');

    return `
      <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
        <label style="flex: 0 0 200px; font-weight: 600;">${TASK_NAMES[taskKey]}</label>
        <select class="form-select" id="mapping_${taskKey}" style="flex: 1;">
          <option value="">メールテンプレートなし</option>
          ${templateOptions}
        </select>
      </div>
    `;
  }).join('');
}

async function saveMappings() {
  showStatus('保存中...', 'saving');

  const newMappings = {};
  Object.keys(TASK_NAMES).forEach(taskKey => {
    const select = document.getElementById('mapping_' + taskKey);
    if (select && select.value) {
      newMappings[taskKey] = select.value;
    }
  });

  // 既存のマッピングを削除
  const { error: deleteError } = await supabase
    .from('task_template_mappings')
    .delete()
    .neq('id', '00000000-0000-0000-0000-000000000000');

  if (deleteError) {
    showStatus('エラー', 'error');
    showToast('保存に失敗しました: ' + deleteError.message, 'error');
    return;
  }

  // 新しいマッピングを挿入
  const mappingsToInsert = Object.keys(newMappings).map(taskKey => ({
    task_key: taskKey,
    template_id: newMappings[taskKey]
  }));

  if (mappingsToInsert.length > 0) {
    const { error: insertError } = await supabase
      .from('task_template_mappings')
      .insert(mappingsToInsert);

    if (insertError) {
      showStatus('エラー', 'error');
      showToast('保存に失敗しました: ' + insertError.message, 'error');
      return;
    }
  }

  taskMappings = newMappings;
  renderProjects();
  showStatus('保存済み', 'saved');
  showToast('タスク設定を保存しました', 'success');
}

// ============================================
function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const templateId = taskMappings[taskKey];
  if (!templateId) {
    showToast('このタスクにメールテンプレートが設定されていません。\n「タスク設定」タブから設定してください。', 'error');
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) {
    showToast('テンプレートが見つかりません', 'error');
    return;
  }

  const taskDate = project.progress?.[taskKey]?.date;
  const dueDate = taskDate || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // テンプレートの業者リストを取得
  const templateVendors = vendors.filter(v => v.template_id === templateId);
  const hasVendorOptions = template.has_sub_options && templateVendors.length > 0;

  // 業者選択ドロップダウン
  let vendorSelectHtml = '';
  if (hasVendorOptions) {
    vendorSelectHtml = `
      <div class="form-group">
        <label class="form-label">業者選択</label>
        <select class="form-select" id="emailVendorSelect" onchange="updateVendorInfo('${templateId}')">
          <option value="">業者を選択してください</option>
          ${templateVendors.map(v => `<option value="${v.id}">${v.company} - ${v.contact}</option>`).join('')}
        </select>
      </div>
    `;
  }

  content.innerHTML = `
    <div class="form-group">
      <label class="form-label">担当者名（署名用）</label>
      <input type="text" class="form-input" id="emailStaffName" value="${project.assigned_to}">
    </div>
    <div class="form-group">
      <label class="form-label">期日</label>
      <input type="date" class="form-input" id="emailDueDate" value="${dueDate}">
    </div>
    ${vendorSelectHtml}
    <div class="form-group">
      <label class="form-label">内容詳細（任意）</label>
      <textarea class="form-textarea" id="emailSpecialContent" placeholder="必要に応じて詳細を入力"></textarea>
    </div>
    <button class="btn btn-primary" onclick="generateEmail('${project.id}', '${taskKey}')">メールを生成</button>
    <div id="generatedEmailSection" style="display: none; margin-top: 32px;">
      <h3 style="margin-bottom: 12px; font-size: 18px; font-weight: 600;">📧 件名</h3>
      <div id="emailSubject" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailSubject')">件名をコピー</button>

      <h3 style="margin: 24px 0 12px; font-size: 18px; font-weight: 600;">📮 宛先</h3>
      <div id="emailAddress" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailAddress')">宛先をコピー</button>

      <h3 style="margin: 24px 0 12px; font-size: 18px; font-weight: 600;">📨 本文</h3>
      <div id="emailBody" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailBody')">本文をコピー</button>
    </div>
  `;

  modal.classList.add('show');
}

// 業者選択時に情報を更新
function updateVendorInfo(templateId) {
  const select = document.getElementById('emailVendorSelect');
  if (!select) return;

  // 選択されていない場合は何もしない
  if (!select.value) return;

  // 選択された業者を取得
  const selectedVendor = vendors.find(v => v.id === select.value);
  if (selectedVendor) {
    // 特別なフィードバックは不要（generateEmail時に使用）
    console.log('業者選択:', selectedVendor.company);
  }
}

function generateEmail(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const templateId = taskMappings[taskKey];
  const template = emailTemplates.find(t => t.template_id === templateId);

  const staffName = document.getElementById('emailStaffName').value.trim();
  const dueDate = document.getElementById('emailDueDate').value;
  const specialContent = document.getElementById('emailSpecialContent').value.trim();

  // 業者選択がある場合は業者情報を使用
  let company = template.company;
  let contact = template.contact || 'ご担当者様';
  let email = template.email;

  const vendorSelect = document.getElementById('emailVendorSelect');
  if (vendorSelect && vendorSelect.value) {
    const selectedVendor = vendors.find(v => v.id === vendorSelect.value);
    if (selectedVendor) {
      company = selectedVendor.company;
      contact = selectedVendor.contact;
      email = selectedVendor.email;
    }
  }

  const replacements = {
    '{customerName}': project.customer,
    '{dueDate}': dueDate,
    '{staffName}': staffName,
    '{company}': company,
    '{contact}': contact,
    '{specialContent}': specialContent || template.default_special_content || ''
  };

  let subject = template.subject_format;
  let body = template.template_text;

  Object.keys(replacements).forEach(key => {
    const regex = new RegExp(key.replace(/[{}]/g, '\\$&'), 'g');
    subject = subject.replace(regex, replacements[key]);
    body = body.replace(regex, replacements[key]);
  });

  document.getElementById('emailSubject').textContent = subject;
  document.getElementById('emailAddress').textContent = email || 'メールアドレスが設定されていません';
  document.getElementById('emailBody').textContent = body;
  document.getElementById('generatedEmailSection').style.display = 'block';
}

function copyText(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent;

  navigator.clipboard.writeText(text).then(() => {
    showToast('コピーしました！', 'success');
  }).catch(err => {
    console.error('コピーに失敗:', err);
    showToast('コピーに失敗しました', 'error');
  });
}

// ============================================
// タスクからのメール作成機能
// ============================================
async function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('案件が見つかりません', 'error');
    return;
  }

  // タスクに関連するテンプレートを取得
  const mapping = taskMappings[taskKey];

  // マッピングがない場合はテンプレート選択画面を表示
  if (!mapping) {
    showTemplateSelector(projectId, taskKey);
    return;
  }

  const template = emailTemplates.find(t => t.template_id === mapping);
  if (!template) {
    showToast('テンプレートが見つかりません', 'error');
    return;
  }

  // 担当者情報を取得
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  // モーダルコンテンツを作成
  const composerHTML = createEmailComposer(project, template, staffName, taskKey);
  document.getElementById('emailComposerContent').innerHTML = composerHTML;

  // モーダルを表示
  document.getElementById('emailModal').classList.add('show');
}

// テンプレート選択画面を表示
function showTemplateSelector(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const currentTaskNames = getTaskNames();
  const taskName = currentTaskNames[taskKey];

  // 現在のカテゴリに応じたテンプレートをフィルタ
  const availableTemplates = emailTemplates.filter(t => t.category === currentUserCategory);

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 8px; color: var(--text-primary);">メールテンプレート選択</h3>
      <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 14px;">
        案件：${project.customer} ／ タスク：${taskName}
      </p>

      <div style="display: grid; gap: 12px;">
        ${availableTemplates.map(template => `
          <button class="template-select-btn" onclick="selectTemplateForTask('${projectId}', '${taskKey}', '${template.template_id}')">
            <div style="font-weight: 600; margin-bottom: 4px;">${template.display_name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${template.company}</div>
          </button>
        `).join('')}
      </div>

      ${availableTemplates.length === 0 ? '<p style="text-align: center; padding: 32px; color: var(--text-muted);">利用可能なテンプレートがありません</p>' : ''}
    </div>
  `;

  document.getElementById('emailComposerContent').innerHTML = html;
  document.getElementById('emailModal').classList.add('show');
}

// テンプレート選択後にメール作成画面を表示
function selectTemplateForTask(projectId, taskKey, templateId) {
  const project = projects.find(p => p.id === projectId);
  const template = emailTemplates.find(t => t.template_id === templateId);
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  const composerHTML = createEmailComposer(project, template, staffName, taskKey);
  document.getElementById('emailComposerContent').innerHTML = composerHTML;
}

function createEmailComposer(project, template, staffName, taskKey) {
  const hasSubOptions = template.has_sub_options;
  const hasSpecialContent = template.has_special_content;

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 16px; color: var(--text-primary);">${template.display_name}</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div class="form-group">
          <label class="form-label">お客様名:</label>
          <input type="text" class="form-input" id="modalCustomerName" value="${project.customer}" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label class="form-label">担当者名:</label>
          <input type="text" class="form-input" id="modalStaffName" value="${staffName}" oninput="updateModalEmail()">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">期日:</label>
        <input type="date" class="form-input" id="modalDueDate" oninput="updateModalEmail()">
      </div>
  `;

  if (hasSpecialContent) {
    const defaultContent = template.default_special_content || '';
    html += `
      <div class="form-group">
        <label class="form-label">特記事項:</label>
        <textarea class="form-textarea" id="modalSpecialContent" rows="4" oninput="updateModalEmail()">${defaultContent}</textarea>
      </div>
    `;
  }

  if (hasSubOptions) {
    const templateVendors = vendors.filter(v => v.template_id === template.template_id);
    html += `
      <div class="form-group">
        <label class="form-label">業者選択:</label>
        <select class="form-select" id="modalVendorSelect" onchange="updateModalEmail()">
          <option value="">選択してください</option>
          ${templateVendors.map(v => `<option value="${v.vendor_id}">${v.company}</option>`).join('')}
        </select>
      </div>
    `;
  }

  html += `
    </div>

    <div style="margin-top: 24px;">
      <h3 style="margin-bottom: 12px; color: var(--text-primary);">📬 生成されたメール</h3>

      <div class="form-group">
        <label class="form-label">件名:</label>
        <div id="modalEmailSubject" style="padding: 12px; background: #f8f9fa; border-radius: 8px; font-weight: 500;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailSubject')" style="margin-top: 8px;">📋 件名をコピー</button>
      </div>

      <div class="form-group">
        <label class="form-label">送信先:</label>
        <div id="modalEmailAddress" style="padding: 12px; background: #f8f9fa; border-radius: 8px; color: var(--primary-color);"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailAddress')" style="margin-top: 8px;">📋 アドレスをコピー</button>
      </div>

      <div class="form-group">
        <label class="form-label">本文:</label>
        <div id="modalEmailBody" style="padding: 16px; background: #f8f9fa; border-radius: 8px; white-space: pre-wrap; line-height: 1.8; min-height: 200px;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailBody')" style="margin-top: 8px;">📋 本文をコピー</button>
      </div>
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeEmailModal()">閉じる</button>
      <button class="btn btn-primary" onclick="markTaskAsRequested('${project.id}', '${taskKey}')">依頼済みにする</button>
    </div>
  `;

  // データを保存（updateModalEmailで使用）
  window.__currentEmailData = {
    project,
    template,
    staffName,
    taskKey
  };

  // 初回メール生成
  setTimeout(() => updateModalEmail(), 100);

  return html;
}

function updateModalEmail() {
  if (!window.__currentEmailData) return;

  const { project, template } = window.__currentEmailData;

  const customerName = document.getElementById('modalCustomerName')?.value || project.customer;
  const staffName = document.getElementById('modalStaffName')?.value || '';
  const dueDate = document.getElementById('modalDueDate')?.value || '';
  const specialContent = document.getElementById('modalSpecialContent')?.value || template.default_special_content || '';
  const vendorSelect = document.getElementById('modalVendorSelect');
  const selectedVendorId = vendorSelect?.value || '';

  let subject = template.subject_format || '';
  let body = template.template_text || '';
  let email = template.email || '';
  let company = template.company || '';
  let contact = template.contact || '';

  // サブオプションがある場合は業者情報を使用
  if (template.has_sub_options && selectedVendorId) {
    const vendor = vendors.find(v => v.template_id === template.template_id && v.vendor_id === selectedVendorId);
    if (vendor) {
      company = vendor.company;
      contact = vendor.contact || 'ご担当者様';
      email = vendor.email || '';
    }
  }

  // 変数を置換
  subject = subject
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{dueDate\}/g, dueDate);

  body = body
    .replace(/\{company\}/g, company)
    .replace(/\{contact\}/g, contact)
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{staffName\}/g, staffName)
    .replace(/\{dueDate\}/g, dueDate)
    .replace(/\{specialContent\}/g, specialContent);

  // 表示を更新
  const subjectEl = document.getElementById('modalEmailSubject');
  const addressEl = document.getElementById('modalEmailAddress');
  const bodyEl = document.getElementById('modalEmailBody');

  if (subjectEl) subjectEl.textContent = subject;
  if (addressEl) addressEl.textContent = email;
  if (bodyEl) bodyEl.textContent = body;
}

function copyModalText(elementId) {
  const text = document.getElementById(elementId)?.textContent;
  if (!text || text.includes('{') || text.includes('選択してください')) {
    showToast('コピーできる内容がありません', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('コピーしました！', 'success');
  }).catch(err => {
    console.error('コピーに失敗:', err);
    showToast('コピーに失敗しました', 'error');
  });
}

async function markTaskAsRequested(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = '依頼済';

  showStatus('保存中...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    console.error('更新エラー:', error);
    showStatus('エラー', 'error');
    showToast('保存に失敗しました', 'error');
    return;
  }

  project.progress = progressData;
  renderProjects();
  closeEmailModal();
  showStatus('保存済み', 'saved');
  showToast('依頼済みに更新しました', 'success');
}

function closeEmailModal() {
  document.getElementById('emailModal').classList.remove('show');
  window.__currentEmailData = null;
}

// ============================================
// 独立したメール作成機能（削除予定）
// ============================================
function updateStandaloneEmail() {
  const templateSelect = document.getElementById('standaloneTemplateSelect');
  const templateId = templateSelect.value;

  if (!templateId) {
    // テンプレート未選択時はクリア
    document.getElementById('standaloneEmailSubject').textContent = '';
    document.getElementById('standaloneEmailAddress').textContent = '';
    document.getElementById('standaloneEmailBody').textContent = '';
    document.getElementById('standaloneVendorGroup').style.display = 'none';
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) return;

  // 特記事項フィールドの表示/非表示
  if (template.has_special_content) {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'block';
  } else {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
  }

  // 入力値を取得
  const customerName = document.getElementById('standaloneCustomerName').value.trim();
  const staffName = document.getElementById('standaloneStaffName').value.trim();
  const dueDate = document.getElementById('standaloneDueDate').value;
  const specialContent = document.getElementById('standaloneSpecialContent').value.trim();

  // サブオプション（業者選択）があるテンプレートの場合
  if (template.has_sub_options) {
    document.getElementById('standaloneVendorGroup').style.display = 'block';
    const vendorSelect = document.getElementById('standaloneVendorSelect');
    const selectedVendorId = vendorSelect.value;

    // 業者選択ドロップダウンを更新
    if (vendorSelect.options.length === 0) {
      const templateVendors = vendors.filter(v => v.template_id === templateId);
      vendorSelect.innerHTML = '<option value="">業者を選択してください</option>' +
        templateVendors.map(v =>
          `<option value="${v.vendor_id}">${v.company}</option>`
        ).join('');
    }

    if (!selectedVendorId) {
      // 業者未選択時はメール生成しない
      document.getElementById('standaloneEmailSubject').textContent = '業者を選択してください';
      document.getElementById('standaloneEmailAddress').textContent = '';
      document.getElementById('standaloneEmailBody').textContent = '';
      return;
    }

    const vendor = vendors.find(v => v.template_id === templateId && v.vendor_id === selectedVendorId);
    if (!vendor) return;

    // 業者情報で変数を置換
    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{お客様名}')
      .replace(/\{dueDate\}/g, dueDate || '{期日}');

    body = body
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || 'ご担当者様')
      .replace(/\{customerName\}/g, customerName || '{お客様名}')
      .replace(/\{staffName\}/g, staffName || '{担当者名}')
      .replace(/\{dueDate\}/g, dueDate || '{期日}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = vendor.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  } else {
    // サブオプションなしテンプレート
    document.getElementById('standaloneVendorGroup').style.display = 'none';

    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{お客様名}')
      .replace(/\{dueDate\}/g, dueDate || '{期日}');

    body = body
      .replace(/\{company\}/g, template.company)
      .replace(/\{contact\}/g, template.contact || 'ご担当者様')
      .replace(/\{customerName\}/g, customerName || '{お客様名}')
      .replace(/\{staffName\}/g, staffName || '{担当者名}')
      .replace(/\{dueDate\}/g, dueDate || '{期日}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = template.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  }
}

function copyStandaloneText(elementId) {
  const text = document.getElementById(elementId).textContent;
  if (!text || text.includes('{') || text.includes('選択してください')) {
    showToast('コピーできる内容がありません', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('コピーしました', 'success');
  }).catch(err => {
    console.error('コピーに失敗:', err);
    showToast('コピーに失敗しました', 'error');
  });
}

function populateStandaloneTemplateSelect() {
  const select = document.getElementById('standaloneTemplateSelect');
  if (!select) return;

  // currentUserCategoryに応じてフィルタリング
  let filtered = emailTemplates;
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  select.innerHTML = '<option value="">テンプレートを選択してください</option>' +
    filtered.map(t =>
      `<option value="${t.template_id}">${t.display_name}</option>`
    ).join('');
}

// ============================================
// エクスポート機能
// ============================================
function exportJSON() {
  if (projects.length === 0) {
    showToast('エクスポートする案件がありません', 'error');
    return;
  }

  const dataStr = JSON.stringify(projects, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `projects_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);

  showToast('JSONファイルをエクスポートしました', 'success');
}

function exportCSV() {
  if (projects.length === 0) {
    showToast('エクスポートする案件がありません', 'error');
    return;
  }

  // CSVヘッダー
  const headers = ['顧客名', '担当者', '商品', '進捗率', 'メモ', '作成日', '更新日'];

  // CSVボディ
  const rows = projects.map(p => {
    const progress = calculateProgress(p);
    return [
      `"${(p.customer || '').replace(/"/g, '""')}"`,
      `"${(p.assigned_to || '').replace(/"/g, '""')}"`,
      `"${(p.specifications || 'LIFE').replace(/"/g, '""')}"`,
      `${progress}%`,
      `"${(p.memo || '').replace(/"/g, '""')}"`,
      `"${p.created_at || ''}"`,
      `"${p.updated_at || ''}"`
    ].join(',');
  });

  const csvContent = [headers.join(','), ...rows].join('\n');

  // BOM付きUTF-8でエクスポート（Excel対応）
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const dataBlob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `projects_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url);

  showToast('CSVファイルをエクスポートしました', 'success');
}

// ============================================
// ドラッグ&ドロップ並び替え
// ============================================
let draggedProject = null;

function enableDragAndDrop() {
  // プロジェクトカードにドラッグ可能属性を追加
  const updateDraggable = () => {
    const cards = document.querySelectorAll('.project-card');
    cards.forEach((card, index) => {
      card.setAttribute('draggable', 'true');
      card.dataset.projectIndex = index;

      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragover', handleDragOver);
      card.addEventListener('drop', handleDrop);
      card.addEventListener('dragend', handleDragEnd);
    });
  };

  // 初回とrenderProjects後に実行
  updateDraggable();

  // MutationObserverでDOM変更を監視
  const observer = new MutationObserver(updateDraggable);
  const container = document.getElementById('projectsContainer');
  if (container) {
    observer.observe(container, { childList: true, subtree: true });
  }
}

function handleDragStart(e) {
  draggedProject = this;
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  if (draggedProject !== this) {
    const draggedIndex = parseInt(draggedProject.dataset.projectIndex);
    const targetIndex = parseInt(this.dataset.projectIndex);

    // 配列の順序を入れ替え
    const temp = projects[draggedIndex];
    projects.splice(draggedIndex, 1);
    projects.splice(targetIndex, 0, temp);

    // 再描画
    renderProjects();
  }

  return false;
}

function handleDragEnd(e) {
  this.style.opacity = '1';

  // すべてのドラッグ状態をリセット
  const cards = document.querySelectorAll('.project-card');
  cards.forEach(card => {
    card.classList.remove('over');
  });
}

// ============================================
// URL直接アクセス機能（ハッシュルーティング）
// ============================================
function updateURLWithDesigner(designerName) {
  const currentHash = window.location.hash.substring(1); // #を除去
  const [pathPart] = currentHash.split('?');
  const mainTab = pathPart.split('/')[0] || 'projects';

  // 新しいURLを構築
  let newHash = mainTab;
  if (designerName !== 'ALL') {
    newHash += `?designer=${encodeURIComponent(designerName)}`;
  }

  // hashchangeイベントを発火させずにURLを更新
  history.replaceState(null, '', `#${newHash}`);
}

function handleHashChange() {
  // 無限ループ防止
  if (isHandlingHashChange) {
    console.log('⏸️ handleHashChange: すでに処理中のためスキップ');
    return;
  }

  const hash = window.location.hash.substring(1); // #を除去
  console.log('🔗 handleHashChange 開始:', {
    hash: hash,
    timestamp: new Date().toISOString(),
    vendorsV2Length: vendorsV2.length,
    taskVendorMappingsLength: taskVendorMappings.length
  });

  if (!hash) return;

  isHandlingHashChange = true;

  // URLパラメータを分離（例: projects?designer=箕浦）
  const [pathPart, queryPart] = hash.split('?');
  const [mainTab, subTab] = pathPart.split('/');

  // URLパラメータを解析
  const params = new URLSearchParams(queryPart || '');
  const designerParam = params.get('designer');

  // 担当者フィルターを復元
  if (designerParam) {
    currentDesignerTab = designerParam;
    // サイドバーとプロジェクト表示を更新（タブ切り替え後に実行）
    setTimeout(() => {
      renderSidebar();
      if (mainTab === 'projects') {
        renderProjects();
      }
    }, 150);
  }

  // メインタブの切り替え
  if (mainTab === 'projects') {
    const btn = document.querySelector('.tab-nav-btn');
    if (btn) switchMainTab('projects', btn);
  } else if (mainTab === 'settings') {
    const btn = document.querySelectorAll('.tab-nav-btn')[1];
    if (btn) switchMainTab('settings', btn);

    // サブタブの切り替え
    if (subTab) {
      setTimeout(() => {
        const subTabMap = {
          'staff': 0,
          'vendors': 1,
          'categories': 2,
          'tasks': 3,
          'products': 4
        };
        const index = subTabMap[subTab];
        if (index !== undefined) {
          const subBtn = document.querySelectorAll('.sub-tab-btn')[index];
          if (subBtn) switchSubTab(subTab, subBtn);
        }
        // フラグをリセット（遅延後）
        setTimeout(() => {
          isHandlingHashChange = false;
          console.log('✅ handleHashChange完了');
        }, 150);
      }, 100);
    } else {
      // サブタブがない場合はすぐにフラグをリセット
      setTimeout(() => {
        isHandlingHashChange = false;
        console.log('✅ handleHashChange完了');
      }, 150);
    }
  } else {
    // 不明なタブの場合はすぐにフラグをリセット
    isHandlingHashChange = false;
  }
}

// ハッシュ変更時のリスナー
window.addEventListener('hashchange', handleHashChange);

// ============================================
// ページ読み込み時
// ============================================
window.addEventListener('DOMContentLoaded', () => {
  checkAuth();
  // URL直接アクセスの処理はcheckAuth() → init()完了後に自動実行される
});
</script>
</body>
</html>
