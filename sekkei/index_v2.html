<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¨­è¨ˆãƒ»ICæ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | Gãƒã‚¦ã‚¹</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary-color: #4A90E2;
  --primary-hover: #357ABD;
  --secondary-color: #50E3C2;
  --danger-color: #E94B3C;
  --warning-color: #F5A623;
  --success-color: #7ED321;
  --text-primary: #2C3E50;
  --text-secondary: #7F8C8D;
  --text-muted: #BDC3C7;
  --bg-primary: #FFFFFF;
  --bg-secondary: #F8F9FA;
  --bg-tertiary: #ECF0F1;
  --border-color: #E1E8ED;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
}

body {
  font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-secondary);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #FFFFFF;
  padding: 20px;
}

.login-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 48px;
  box-shadow: var(--shadow-md);
  max-width: 420px;
  width: 100%;
  text-align: center;
}

.login-card h1 {
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 12px;
}

.login-card p {
  color: var(--text-secondary);
  margin-bottom: 24px;
  font-size: 15px;
}

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
.main-container {
  display: none;
  max-width: 1800px;
  margin: 0 auto;
  background: var(--bg-secondary);
  min-height: 100vh;
}

.main-container.show {
  display: block;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header {
  background: white;
  border-bottom: 1px solid var(--border-color);
  padding: 16px 32px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 24px;
}

.logo {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary-color);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

/* ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.category-switch-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  min-width: 180px;
}

.category-switch-menu button {
  display: block;
  width: 100%;
  padding: 12px 16px;
  text-align: left;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-primary);
  transition: background 0.2s;
}

.category-switch-menu button:hover {
  background: var(--bg-secondary);
}

.category-switch-menu button:first-child {
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.category-switch-menu button:last-child {
  border-radius: 0 0 var(--radius-md) var(--radius-md);
}

/* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.tabs-nav {
  background: white;
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  display: flex;
  gap: 8px;
}

.tab-nav-btn {
  padding: 16px 24px;
  border: none;
  background: transparent;
  font-size: 15px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab-nav-btn:hover {
  color: var(--text-primary);
  background: var(--bg-secondary);
}

.tab-nav-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
.tab-panel {
  display: none;
}

.tab-panel.active {
  display: block;
}

/* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
.toolbar {
  background: white;
  padding: 20px 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.toolbar-left {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  flex: 1;
}

.toolbar-right {
  display: flex;
  gap: 12px;
}

/* ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚¿ãƒ– */
.designer-tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.designer-tab {
  padding: 8px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.designer-tab:hover {
  background: var(--bg-tertiary);
}

.designer-group-label {
  width: 100%;
  padding: 8px 12px;
  margin-top: 12px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border-radius: 8px;
  border-left: 3px solid var(--primary-color);
}

.designer-tab.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* ãƒœã‚¿ãƒ³ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), #357ABD);
  color: white;
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.2);
}

.btn-primary:hover {
  background: linear-gradient(135deg, var(--primary-hover), #2E6BA8);
  box-shadow: 0 4px 16px rgba(74, 144, 226, 0.3);
  transform: translateY(-2px);
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
}

.btn-secondary:hover {
  opacity: 0.9;
}

.btn-ghost {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-primary);
}

.btn-ghost:hover {
  background: var(--bg-secondary);
}

.btn-danger {
  background: var(--danger-color);
  color: white;
}

.btn-danger:hover {
  opacity: 0.9;
}

.btn-small {
  padding: 6px 12px;
  font-size: 13px;
}

/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
.input, .select {
  padding: 10px 14px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  background: white;
  transition: all 0.2s;
}

.input:focus, .select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.input {
  min-width: 200px;
}

/* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
.cards-container {
  padding: 32px;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
  gap: 24px;
}

/* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰ */
.project-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.project-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
  opacity: 0;
  transition: opacity 0.3s;
}

.project-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-4px);
  border-color: var(--primary-color);
}

.project-card:hover::before {
  opacity: 1;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--bg-secondary);
}

.card-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 12px;
  line-height: 1.3;
  letter-spacing: -0.02em;
}

.card-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  font-weight: 500;
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: 5px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.3px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.badge-primary {
  background: linear-gradient(135deg, #E8F4FD, #D6EBFF);
  color: var(--primary-color);
  border: 1px solid rgba(74, 144, 226, 0.2);
}

.badge-success {
  background: linear-gradient(135deg, #E6F9F0, #D1F2E6);
  color: var(--success-color);
  border: 1px solid rgba(80, 200, 120, 0.2);
}

.badge-secondary {
  background: linear-gradient(135deg, #F0F0F0, #E5E5E5);
  color: var(--text-secondary);
  border: 1px solid rgba(100, 100, 100, 0.2);
}

/* æ¥­è€…ã‚«ãƒ¼ãƒ‰ */
.vendor-card {
  background: white;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
.category-filter-btn {
  padding: 8px 16px;
  background: white;
  border: 2px solid var(--border-color);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.category-filter-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--bg-secondary);
}

.category-filter-btn.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ©ãƒ™ãƒ« */
.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}

.checkbox-label input[type="checkbox"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
}

.checkbox-label span {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

/* é€²æ—ãƒãƒ¼ */
.progress-section {
  margin-bottom: 20px;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.progress-label {
  font-size: 14px;
  color: var(--text-secondary);
}

.progress-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary-color);
}

.progress-bar {
  height: 10px;
  background: var(--bg-secondary);
  border-radius: 999px;
  overflow: hidden;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4A90E2, #50C878);
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 999px;
  box-shadow: 0 0 8px rgba(74, 144, 226, 0.4);
  position: relative;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.task-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  font-size: 14px;
  transition: all 0.2s;
  border: 1px solid transparent;
}

.task-item:hover {
  background: white;
  border-color: var(--border-color);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  transform: translateX(4px);
}

.task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.task-state-select {
  height: 30px;
  padding: 0 8px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background: #fff;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 80px;
  flex-shrink: 0;
}

.task-state-select.state-yellow {
  background: #fff8d6;
  border-color: #f4e2a0;
  color: #7a5b00;
}

.task-state-select.state-green {
  background: #e8f7e8;
  border-color: #b9e4b9;
  color: #0f5132;
}

.task-label {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
}

.task-email-btn {
  width: 32px;
  height: 32px;
  padding: 0;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.task-email-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
}

.template-select-btn {
  width: 100%;
  padding: 16px;
  background: white;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.template-select-btn:hover {
  border-color: var(--primary-color);
  background: var(--bg-secondary);
  transform: translateX(4px);
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

.modal.show {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 16px;
  width: min(800px, 90vw);
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  padding: 28px 32px;
  border-bottom: 2px solid var(--bg-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(180deg, #fafbfc, white);
}

.modal-title {
  font-size: 24px;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text-primary);
}

.close {
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.2s;
}

.close:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.modal-body {
  padding: 32px;
}

.modal-footer {
  padding: 20px 32px;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

/* ãƒ•ã‚©ãƒ¼ãƒ  */
.form-group {
  margin-bottom: 24px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s;
  background: white;
}

.form-input:hover, .form-select:hover, .form-textarea:hover {
  border-color: #c5d1de;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.12);
  background: #fafbfc;
}

.form-textarea {
  min-height: 120px;
  resize: vertical;
}

.form-hint {
  margin-top: 6px;
  font-size: 13px;
  color: var(--text-muted);
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-saving {
  background: #FFF4E6;
  color: var(--warning-color);
}

.status-saving .status-dot {
  background: var(--warning-color);
  animation: pulse 1.5s infinite;
}

.status-saved {
  background: #E6F9F0;
  color: var(--success-color);
}

.status-saved .status-dot {
  background: var(--success-color);
}

.status-error {
  background: #FFE6E6;
  color: var(--danger-color);
}

.status-error .status-dot {
  background: var(--danger-color);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ãƒ†ãƒ¼ãƒ–ãƒ« */
.table-container {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table thead {
  background: linear-gradient(180deg, #f8f9fa, #f0f1f3);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
}

.table th {
  padding: 18px 20px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table td {
  padding: 16px 20px;
  border-top: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-primary);
}

.table tbody tr:nth-child(even) {
  background: #fafbfc;
}

.table tbody tr:hover {
  background: #f0f7ff;
  box-shadow: inset 0 0 0 1px rgba(74, 144, 226, 0.1);
  transition: all 0.2s;
}

/* ç©ºçŠ¶æ…‹ */
.empty-state {
  padding: 80px 40px;
  text-align: center;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-description {
  font-size: 14px;
  margin-bottom: 24px;
}

/* ãƒ¡ãƒ¼ãƒ«å‡ºåŠ› */
.email-output {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 20px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.8;
  white-space: pre-wrap;
  margin: 16px 0;
  max-height: 400px;
  overflow-y: auto;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 1200px) {
  .cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
  }
}

@media (max-width: 768px) {
  .header {
    padding: 12px 16px;
  }

  .toolbar {
    padding: 16px;
  }

  .cards-container {
    padding: 16px;
  }

  .cards-grid {
    grid-template-columns: 1fr;
  }

  .tasks-grid {
    grid-template-columns: 1fr;
  }

  .modal-content {
    width: 95vw;
  }

  .modal-body {
    padding: 20px;
  }
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
.spinner {
  border: 3px solid var(--bg-secondary);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 40px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
.draggable-row {
  cursor: move;
  transition: all 0.2s;
}

.draggable-row:hover {
  background: var(--bg-secondary);
}

.draggable-row.dragging {
  opacity: 0.5;
  background: var(--bg-hover);
}

.draggable-row.drag-over {
  border-top: 3px solid var(--primary-color);
}

.drag-handle {
  cursor: grab;
  color: var(--text-secondary);
  font-size: 18px;
  padding: 0 8px;
  user-select: none;
}

.drag-handle:active {
  cursor: grabbing;
}

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 16px 24px;
  box-shadow: var(--shadow-lg);
  display: none;
  align-items: center;
  gap: 12px;
  z-index: 2000;
}

.toast.show {
  display: flex;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-success {
  border-left: 4px solid var(--success-color);
}

.toast-error {
  border-left: 4px solid var(--danger-color);
}

.toast-warning {
  border-left: 4px solid var(--warning-color);
}

/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.app-layout {
  display: flex;
  height: calc(100vh - 64px);
  overflow: hidden;
}

.sidebar {
  width: 280px;
  background: white;
  border-right: 2px solid var(--border-color);
  overflow-y: auto;
  flex-shrink: 0;
}

.sidebar-section {
  padding: 16px;
  border-bottom: 1px solid var(--border-color);
}

.sidebar-section-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 4px;
  font-size: 14px;
  font-weight: 500;
}

.sidebar-item:hover {
  background: var(--bg-secondary);
}

.sidebar-item.active {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
}

.sidebar-item-label {
  flex: 1;
}

.sidebar-item-count {
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.1);
}

.sidebar-item.active .sidebar-item-count {
  background: rgba(255, 255, 255, 0.2);
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.sub-tabs-nav {
  display: flex;
  gap: 8px;
  padding: 16px 24px 0 24px;
  background: white;
  border-bottom: 2px solid var(--border-color);
  overflow-x: auto;
}

.sub-tab-btn {
  padding: 12px 20px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
  white-space: nowrap;
}

.sub-tab-btn:hover {
  color: var(--primary-color);
  background: var(--bg-secondary);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

.sub-tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  max-height: calc(100vh - 180px);
}

.sub-tab-panel.active {
  display: block;
}

.table-container {
  overflow-y: auto;
  max-height: calc(100vh - 350px);
}

.cards-grid {
  overflow-y: auto;
  max-height: calc(100vh - 300px);
}
</style>
</head>
<body>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="loginContainer" class="login-container">
  <div class="login-card">
    <h1>è¨­è¨ˆãƒ»ICæ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
    <form onsubmit="signIn(); return false;" style="margin-bottom: 20px;">
      <input type="email" class="form-input" id="loginEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width: 100%; margin-bottom: 12px;" required>
      <input type="password" class="form-input" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width: 100%; margin-bottom: 16px;" required>
      <button type="submit" class="btn btn-primary" style="width: 100%;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </form>
  </div>
</div>

<!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠç”»é¢ -->
<div id="accountSelectContainer" class="login-container" style="display: none;">
  <div class="login-card">
    <h1>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠ</h1>
    <p>ã”åˆ©ç”¨ã®æ¥­å‹™ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 24px;">
      <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="selectAccountType('è¨­è¨ˆ')">
        ğŸ“ è¨­è¨ˆæ‹…å½“
      </button>
      <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="selectAccountType('IC')">
        ğŸ¨ ICæ‹…å½“
      </button>
      <button class="btn btn-secondary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="selectAccountType('admin')">
        ğŸ‘‘ ç®¡ç†è€…ï¼ˆå…¨æ¨©é™ï¼‰
      </button>
    </div>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div id="mainContainer" class="main-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-left">
      <div class="logo">Gãƒã‚¦ã‚¹ è¨­è¨ˆç®¡ç†</div>
    </div>
    <div class="header-right">
      <div class="status-indicator status-saved" id="statusIndicator">
        <span class="status-dot"></span>
        <span id="statusText">ä¿å­˜æ¸ˆã¿</span>
      </div>
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName" class="user-name"></span>
      </div>
      <div style="position: relative;">
        <button class="btn btn-ghost btn-small" onclick="toggleCategorySwitcher()" id="categorySwitchBtn" style="display: none;">
          <span id="currentCategoryLabel">ğŸ“ è¨­è¨ˆ</span> â–¼
        </button>
        <div id="categorySwitchMenu" class="category-switch-menu" style="display: none;">
          <button onclick="switchCategory('è¨­è¨ˆ')">ğŸ“ è¨­è¨ˆæ‹…å½“</button>
          <button onclick="switchCategory('IC')">ğŸ¨ ICæ‹…å½“</button>
          <button onclick="switchCategory('admin')">ğŸ‘‘ ç®¡ç†è€…</button>
        </div>
      </div>
      <button class="btn btn-ghost btn-small" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <!-- ã‚¢ãƒ—ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="app-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="sidebar">
      <div id="sidebarContent"></div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
      <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="tabs-nav">
        <button class="tab-nav-btn active" onclick="switchMainTab('projects', this)">ğŸ“‹ æ¡ˆä»¶ç®¡ç†</button>
        <button class="tab-nav-btn" onclick="switchMainTab('settings', this)">âš™ï¸ è¨­å®š</button>
      </nav>

      <!-- æ¡ˆä»¶ç®¡ç†ã‚¿ãƒ– -->
      <div id="projectsTab" class="tab-panel active">
        <div class="toolbar">
          <div class="toolbar-left">
            <input type="text" class="input" id="searchQuery" placeholder="æ¤œç´¢..." oninput="renderProjects()">
            <select class="select" id="specFilter" onchange="renderProjects()">
              <option value="">ã™ã¹ã¦ã®å•†å“</option>
              <option>LIFE</option>
              <option>LIFE+</option>
              <option>HOURS</option>
              <option>LACIE</option>
              <option>LIFEãƒªãƒŸ</option>
              <option>LIFE+ãƒªãƒŸ</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-ghost" onclick="exportJSON()">JSONå‡ºåŠ›</button>
            <button class="btn btn-ghost" onclick="exportCSV()">CSVå‡ºåŠ›</button>
            <button class="btn btn-primary" onclick="openProjectModal()">+ æ¡ˆä»¶è¿½åŠ </button>
      </div>
    </div>
    <div class="cards-container">
      <div class="cards-grid" id="projectsGrid"></div>
      <div class="empty-state" id="emptyProjects" style="display: none;">
        <div class="empty-icon">ğŸ“‹</div>
        <div class="empty-title">æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>
        <div class="empty-description">ã€Œæ¡ˆä»¶è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ–°ã—ã„æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
        <button class="btn btn-primary" onclick="openProjectModal()">+ æ¡ˆä»¶è¿½åŠ </button>
      </div>
    </div>
  </div>

      <!-- è¨­å®šã‚¿ãƒ– -->
      <div id="settingsTab" class="tab-panel">
        <!-- ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="sub-tabs-nav">
          <button class="sub-tab-btn active" onclick="switchSubTab('staff', this)">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('vendors', this)">ğŸ¢ æ¥­è€…ãƒ»ãƒ¡ãƒ¼ãƒ«ç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('categories', this)">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('tasks', this)">âœ… ã‚¿ã‚¹ã‚¯ç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('products', this)">ğŸ“¦ å•†å“ç®¡ç†</button>
        </nav>

        <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† -->
        <div id="staffPanel" class="sub-tab-panel active">
          <div style="max-width: 1000px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h2>
            <div class="form-group">
              <label class="form-label">æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </label>
              <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
                <input type="text" class="form-input" id="newDesignerNameInline" placeholder="ã‚¹ã‚¿ãƒƒãƒ•å">
                <select class="form-select" id="newDesignerCategoryInline" style="width: 150px;">
                  <option value="è¨­è¨ˆ">è¨­è¨ˆæ‹…å½“</option>
                  <option value="IC">ICæ‹…å½“</option>
                </select>
                <button class="btn btn-primary" onclick="addDesignerInline()">è¿½åŠ </button>
              </div>
            </div>
            <div id="designerListInline" style="margin-top: 24px;"></div>
          </div>
        </div>

        <!-- æ¥­è€…ç®¡ç† -->
        <div id="vendorsPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <div id="categoryFilters"></div>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openVendorModalV2()">+ æ¥­è€…è¿½åŠ </button>
            </div>
          </div>
          <div id="vendorsGrid" class="cards-grid"></div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç† -->
        <div id="categoriesPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">æ¥­è€…ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">æ¥­è€…ã‚’åˆ†é¡ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚</p>
            <div class="form-group">
              <label class="form-label">æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newCategoryNameInline" placeholder="ã‚«ãƒ†ã‚´ãƒªåï¼ˆä¾‹ï¼šé›»æ°—å·¥äº‹ï¼‰" style="flex: 1;">
                <button class="btn btn-primary" onclick="addCategoryInline()">è¿½åŠ </button>
              </div>
            </div>
            <div id="categoriesGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ç®¡ç† -->
        <div id="tasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <select class="select" id="taskCategoryFilterInline" onchange="renderTasksManagement()">
                <option value="">ã™ã¹ã¦</option>
                <option value="è¨­è¨ˆ">è¨­è¨ˆç”¨ã‚¿ã‚¹ã‚¯</option>
                <option value="IC">ICç”¨ã‚¿ã‚¹ã‚¯</option>
              </select>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openTaskModal()">+ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
            </div>
          </div>
          <div id="tasksGrid"></div>
        </div>

        <!-- å•†å“ç®¡ç† -->
        <div id="productsPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">å•†å“ãƒã‚¹ã‚¿ç®¡ç†</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">æ¡ˆä»¶ã§é¸æŠã§ãã‚‹å•†å“ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
            <div class="form-group">
              <label class="form-label">æ–°ã—ã„å•†å“ã‚’è¿½åŠ </label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newProductNameInline" placeholder="å•†å“åï¼ˆä¾‹ï¼šLIFEã€LIFE+ã€HOURSï¼‰" style="flex: 1;">
                <button class="btn btn-primary" onclick="addProductInline()">è¿½åŠ </button>
              </div>
            </div>
            <div id="productsGrid" style="margin-top: 32px;"></div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ¡ˆä»¶è¿½åŠ /ç·¨é›† -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="projectModalTitle">æ¡ˆä»¶è¿½åŠ </h2>
      <button class="close" onclick="closeProjectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ãŠå®¢æ§˜å *</label>
        <input type="text" class="form-input" id="projectCustomer" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒæ§˜">
      </div>
      <div class="form-group">
        <label class="form-label">æ‹…å½“è¨­è¨ˆå£« *</label>
        <select class="form-select" id="projectAssignedTo"></select>
      </div>
      <div class="form-group">
        <label class="form-label">å•†å“</label>
        <select class="form-select" id="projectSpecifications"></select>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢</label>
        <textarea class="form-textarea" id="projectMemo" placeholder="è¦æœ›ãƒ»æ³¨æ„ç‚¹ãªã©"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveProject()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ /ç·¨é›† -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="templateModalTitle">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </h2>
      <button class="close" onclick="closeTemplateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID *</label>
        <input type="text" class="form-input" id="templateId" placeholder="ä¾‹ï¼šnew-template">
        <div class="form-hint">è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½</div>
      </div>
      <div class="form-group">
        <label class="form-label">è¡¨ç¤ºå *</label>
        <input type="text" class="form-input" id="templateDisplayName" placeholder="ä¾‹ï¼šæ–°ä¼šç¤¾åï¼ˆä½œæ¥­å†…å®¹ï¼‰">
      </div>
      <div class="form-group">
        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
        <select class="form-select" id="templateCategory">
          <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
          <option value="IC">IC</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ä¼šç¤¾å *</label>
        <input type="text" class="form-input" id="templateCompany" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã€‡ã€‡">
      </div>
      <div class="form-group">
        <label class="form-label">å®›å…ˆå</label>
        <input type="text" class="form-input" id="templateContact" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="text" class="form-input" id="templateEmail" placeholder="ä¾‹ï¼štanaka@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ *</label>
        <input type="text" class="form-input" id="templateSubjectFormat" placeholder="ä¾‹ï¼š{customerName}æ§˜ æ–°è¦ã€‡ã€‡ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}">
        <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{customerName}, {dueDate}, {staffName}</div>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ *</label>
        <textarea class="form-textarea" id="templateText" rows="10" placeholder="ä¾‹:&#10;{company}&#10;{contact}&#10;&#10;ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚"></textarea>
        <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTemplateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveTemplate()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† -->
<div id="designerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h2>
      <button class="close" onclick="closeDesignerModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </label>
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
          <input type="text" class="form-input" id="newDesignerName" placeholder="ã‚¹ã‚¿ãƒƒãƒ•å">
          <select class="form-select" id="newDesignerCategory" style="width: 150px;">
            <option value="è¨­è¨ˆ">è¨­è¨ˆæ‹…å½“</option>
            <option value="IC">ICæ‹…å½“</option>
          </select>
          <button class="btn btn-primary" onclick="addDesigner()">è¿½åŠ </button>
        </div>
      </div>
      <div id="designerList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeDesignerModal()">å®Œäº†</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ¡ãƒ¼ãƒ«ä½œæˆ -->
<div id="emailModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ä½œæˆ</h2>
      <button class="close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div class="modal-body" id="emailComposerContent"></div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ¥­è€…è¿½åŠ /ç·¨é›†V2 -->
<div id="vendorModalV2" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title" id="vendorModalTitle">æ¥­è€…è¿½åŠ </h2>
      <button class="close" onclick="closeVendorModalV2()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="vendorForm">
        <input type="hidden" id="vendorId">

        <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">åŸºæœ¬æƒ…å ±</h3>

        <div class="form-group">
          <label class="form-label">ä¼šç¤¾å *</label>
          <input type="text" class="form-input" id="vendorCompany" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã€‡ã€‡" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">æ‹…å½“è€…å</label>
            <input type="text" class="form-input" id="vendorContact" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜">
          </div>

          <div class="form-group">
            <label class="form-label">é›»è©±ç•ªå·</label>
            <input type="text" class="form-input" id="vendorTel" placeholder="ä¾‹ï¼š090-1234-5678">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" class="form-input" id="vendorEmail" placeholder="ä¾‹ï¼štanaka@example.com">
          </div>

          <div class="form-group">
            <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
            <select class="form-select" id="vendorCategory"></select>
          </div>
        </div>

        <h3 style="margin: 24px 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>

        <div class="form-group">
          <label class="form-label">ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</label>
          <input type="text" class="form-input" id="vendorSubject" placeholder="ä¾‹ï¼š{customerName}æ§˜ æ–°è¦ã€‡ã€‡ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}">
          <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{customerName}, {dueDate}, {staffName}</div>
        </div>

        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡</label>
          <textarea class="form-textarea" id="vendorTemplate" rows="8" placeholder="ä¾‹:&#10;{company}&#10;{contact}&#10;&#10;ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚"></textarea>
          <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="vendorHasSpecial" onchange="toggleSpecialContent()">
            <span>ç‰¹åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½¿ç”¨ã™ã‚‹</span>
          </label>
        </div>

        <div id="specialContentGroup" style="display: none;">
          <div class="form-group">
            <label class="form-label">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç‰¹åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</label>
            <textarea class="form-textarea" id="vendorSpecialContent" rows="3" placeholder="ä¾‹ï¼šã‚µãƒƒã‚·ãƒ—ãƒ¬ã‚¼ãƒ³ã€é–‹å£éƒ¨ãƒªã‚¹ãƒˆã€ç„é–¢ãƒ—ãƒ¬ã‚¼ãƒ³(C10 ã‚«ãƒ¼ãƒ ãƒ–ãƒ©ãƒƒã‚¯)"></textarea>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeVendorModalV2()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveVendorV2()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚«ãƒ†ã‚´ãƒªè¿½åŠ /ç·¨é›† -->
<div id="categoryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="categoryModalTitle">ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </h2>
      <button class="close" onclick="closeCategoryModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="categoryForm">
        <input type="hidden" id="categoryId">

        <div class="form-group">
          <label class="form-label">ã‚«ãƒ†ã‚´ãƒªå *</label>
          <input type="text" class="form-input" id="categoryName" placeholder="ä¾‹ï¼šè¨­å‚™" required>
        </div>

        <div class="form-group">
          <label class="form-label">è¡¨ç¤ºé †</label>
          <input type="number" class="form-input" id="categoryOrder" placeholder="1" min="1">
          <div class="form-hint">å°ã•ã„æ•°å­—ã»ã©å…ˆã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCategoryModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveCategory()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›† -->
<div id="taskModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="taskModalTitle">ã‚¿ã‚¹ã‚¯è¿½åŠ </h2>
      <button class="close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="taskForm">
        <input type="hidden" id="taskId">

        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¹ã‚¯ã‚­ãƒ¼ *</label>
          <input type="text" class="form-input" id="taskKey" placeholder="ä¾‹ï¼šmeeting0" required>
          <div class="form-hint">è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨å¯èƒ½ï¼ˆã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨IDï¼‰</div>
        </div>

        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¹ã‚¯å *</label>
          <input type="text" class="form-input" id="taskName" placeholder="ä¾‹ï¼š0å›ç›®æ‰“åˆã›" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
            <select class="form-select" id="taskCategory" required>
              <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
              <option value="IC">IC</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">è¡¨ç¤ºé †</label>
            <input type="number" class="form-input" id="taskOrder" placeholder="1" min="1">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasState" onchange="toggleTaskState()">
            <span>çŠ¶æ…‹ç®¡ç†ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
          </label>
          <div class="form-hint">ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€Œä¾é ¼æ¸ˆã€ã€Œä¿å­˜æ¸ˆã€ãªã©ã®çŠ¶æ…‹ã‚’é¸æŠå¯èƒ½ã«ãªã‚Šã¾ã™</div>
        </div>

        <div id="stateOptionsGroup" style="display: none;">
          <div class="form-group">
            <label class="form-label">çŠ¶æ…‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆJSONé…åˆ—ï¼‰</label>
            <input type="text" class="form-input" id="taskStateOptions" placeholder='ä¾‹ï¼š["", "ä¾é ¼æ¸ˆ", "ä¿å­˜æ¸ˆ"]'>
            <div class="form-hint">JSONé…åˆ—å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æœ€åˆã®è¦ç´ ã¯ç©ºæ–‡å­—åˆ—("")ã‚’æ¨å¥¨</div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveTask()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
<div id="toast" class="toast"></div>

<script>
// ============================================
// SupabaseåˆæœŸåŒ–
// ============================================
const SUPABASE_URL = 'https://twzsirpfudqwboeyakta.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3enNpcnBmdWRxd2JvZXlha3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzM4NjgsImV4cCI6MjA3NzAwOTg2OH0.E_8GxfsO6Scjc0dDoEoyxq3i4lfvNxYZvnSL1OlSDSM';

// Supabase CDNã®ãƒ­ãƒ¼ãƒ‰ç¢ºèª
if (!window.supabase) {
  console.error('âŒ Supabase CDN ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼');
  alert('Supabase CDN ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
}

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
console.log('âœ… SupabaseåˆæœŸåŒ–å®Œäº†:', SUPABASE_URL);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentUser = null;
let currentDesigner = null;
let currentUserCategory = null; // 'admin' | 'è¨­è¨ˆ' | 'IC'
let projects = [];
let designers = [];
let emailTemplates = [];
let vendors = [];
let taskMappings = {};
let currentDesignerTab = 'ALL';
let editingProjectId = null;
let editingTemplateId = null;
let editingVendorId = null;

// æ–°ã‚·ã‚¹ãƒ†ãƒ ç”¨å¤‰æ•°
let vendorCategories = [];
let tasksV2 = [];
let vendorsV2 = [];
let taskVendorMappings = [];
let products = [];

// æ‹…å½“è€…ã®ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
function getTasksForAssignee(assigneeName) {
  const designer = designers.find(d => d.name === assigneeName);
  const category = designer?.category || 'è¨­è¨ˆ';

  // tasksV2ãŒç©ºã®å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™
  if (!tasksV2 || tasksV2.length === 0) {
    console.warn('âš ï¸ tasksV2ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚migration_customizable_system.sqlã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
    return [];
  }

  return tasksV2.filter(t => t.category === category).sort((a, b) => a.display_order - b.display_order);
}

// ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
function getTaskStateOptions(taskKey) {
  const task = tasksV2.find(t => t.task_key === taskKey);
  if (!task || !task.has_state || !task.state_options) return null;
  return task.state_options;
}

// ============================================
// èªè¨¼å‡¦ç†
// ============================================
async function signIn() {
  console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹...');

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  console.log('ğŸ“§ å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«:', email);

  if (!email || !password) {
    console.error('âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã§ã™');
    showToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (!window.supabase) {
    console.error('âŒ Supabase CDNãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
    showToast('ã‚¨ãƒ©ãƒ¼: SupabaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  try {
    console.log('ğŸ”„ Supabaseèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });

    if (error) {
      console.error('âŒ Supabaseèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }

    console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', data.user.email);
    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ - onAuthStateChangeã§å‡¦ç†ã•ã‚Œã‚‹ã®ã§reloadã¯ä¸è¦
  } catch (error) {
    console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
  }
}

async function signOut() {
  try {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
    location.reload();
  } catch (error) {
    console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

async function checkAuth() {
  console.log('ğŸ” èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
  const { data: { session } } = await supabase.auth.getSession();

  if (session) {
    console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œå‡º:', session.user.email);
    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jpã®å ´åˆã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
    if (currentUser.email === 'admin@ghouse.jp') {
      console.log('ğŸ‘‘ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º');
      document.getElementById('accountSelectContainer').style.display = 'flex';
      return;
    }

    // ãã®ä»–ã®å ´åˆã¯è¨­è¨ˆå£«æƒ…å ±ã‚’å–å¾—ã—ã¦categoryã‚’åˆ¤å®š
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      console.log('âœ… è¨­è¨ˆå£«æƒ…å ±å–å¾—:', currentDesigner.name, '/', currentUserCategory);
    } else {
      console.warn('âš ï¸ è¨­è¨ˆå£«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', currentUser.email);
    }

    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
    document.getElementById('mainContainer').classList.add('show');

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤ºï¼ˆ@ã‚ˆã‚Šå‰ã®éƒ¨åˆ†ï¼‰
    const displayName = currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = displayName;

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã‚’è¨­å®š
    document.getElementById('userAvatar').src = 'https://via.placeholder.com/32/4A90E2/FFFFFF?text=' + displayName.charAt(0).toUpperCase();

    await init();
  } else {
    console.log('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã— - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º');
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContainer').classList.remove('show');
  }
}

// èªè¨¼å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°
let isAuthProcessing = false;

// èªè¨¼çŠ¶æ…‹å¤‰æ›´ã‚’ç›£è¦–
supabase.auth.onAuthStateChange(async (event, session) => {
  console.log('ğŸ”” èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆ:', event, 'currentUser:', currentUser?.email, 'processing:', isAuthProcessing);

  if (event === 'SIGNED_IN' && !currentUser && !isAuthProcessing) {
    isAuthProcessing = true;
    console.log('âœ… SIGNED_IN ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†é–‹å§‹:', session.user.email);

    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jpã®å ´åˆã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
    if (currentUser.email === 'admin@ghouse.jp') {
      console.log('ğŸ‘‘ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º');
      document.getElementById('accountSelectContainer').style.display = 'flex';
      isAuthProcessing = false;
      return;
    }

    // ãã®ä»–ã®å ´åˆã¯è¨­è¨ˆå£«æƒ…å ±ã‚’å–å¾—ã—ã¦categoryã‚’åˆ¤å®š
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      console.log('âœ… è¨­è¨ˆå£«æƒ…å ±å–å¾—:', currentDesigner.name, '/', currentUserCategory);
    } else {
      console.warn('âš ï¸ è¨­è¨ˆå£«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', currentUser.email);
    }

    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
    document.getElementById('mainContainer').classList.add('show');

    const displayName = currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userAvatar').src = 'https://via.placeholder.com/32/4A90E2/FFFFFF?text=' + displayName.charAt(0).toUpperCase();

    await init();
    isAuthProcessing = false;
  } else if (event === 'SIGNED_OUT') {
    console.log('ğŸ‘‹ SIGNED_OUT ã‚¤ãƒ™ãƒ³ãƒˆ');
    location.reload();
  } else {
    console.log('â­ï¸ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—');
  }
});

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ
async function selectAccountType(category) {
  console.log('ğŸ¯ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ:', category);
  currentUserCategory = category;
  document.getElementById('accountSelectContainer').style.display = 'none';
  document.getElementById('mainContainer').classList.add('show');

  const displayName = currentUser.email.split('@')[0];
  document.getElementById('userName').textContent = displayName;
  document.getElementById('userAvatar').src = 'https://via.placeholder.com/32/4A90E2/FFFFFF?text=' + displayName.charAt(0).toUpperCase();

  // åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  updateCategorySwitchButton();

  await init();
  console.log('âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠå®Œäº†');
}

// ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
function updateCategorySwitchButton() {
  const btn = document.getElementById('categorySwitchBtn');
  const label = document.getElementById('currentCategoryLabel');

  if (currentUserCategory === 'è¨­è¨ˆ') {
    label.textContent = 'ğŸ“ è¨­è¨ˆ';
  } else if (currentUserCategory === 'IC') {
    label.textContent = 'ğŸ¨ IC';
  } else if (currentUserCategory === 'admin') {
    label.textContent = 'ğŸ‘‘ ç®¡ç†è€…';
  }

  btn.style.display = 'block';
}

// ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰
function toggleCategorySwitcher() {
  const menu = document.getElementById('categorySwitchMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.addEventListener('click', function(e) {
  const menu = document.getElementById('categorySwitchMenu');
  const btn = document.getElementById('categorySwitchBtn');
  if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.style.display = 'none';
  }
});

// ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ
async function switchCategory(category) {
  console.log('ğŸ”„ ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ:', category);

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
  document.getElementById('categorySwitchMenu').style.display = 'none';

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªãªã‚‰ä½•ã‚‚ã—ãªã„
  if (currentUserCategory === category) {
    console.log('â­ï¸ åŒã˜ã‚«ãƒ†ã‚´ãƒªã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
    return;
  }

  // ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°
  currentUserCategory = category;

  // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
  updateCategorySwitchButton();

  // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
  showStatus('èª­ã¿è¾¼ã¿ä¸­...', 'saving');
  await init();

  showToast(`${category === 'admin' ? 'ç®¡ç†è€…' : category + 'æ‹…å½“'}ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'success');
  console.log('âœ… ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆå®Œäº†');
}

// ============================================
// åˆæœŸåŒ–
// ============================================
async function init() {
  console.log('ğŸš€ åˆæœŸåŒ–é–‹å§‹...');
  showStatus('èª­ã¿è¾¼ã¿ä¸­...', 'saving');

  try {
    console.log('ğŸ“¦ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');
    const results = await Promise.allSettled([
      loadDesigners(),
      loadCurrentDesigner(),
      loadProjects(),
      loadEmailTemplates(),
      loadVendors(),
      loadTaskMappings(),
      loadVendorCategories(),
      loadTasksV2(),
      loadVendorsV2(),
      loadTaskVendorMappings(),
      loadProducts()
    ]);

    // å„çµæœã‚’ç¢ºèª
    results.forEach((result, index) => {
      const names = ['è¨­è¨ˆå£«', 'ç¾åœ¨ã®è¨­è¨ˆå£«', 'æ¡ˆä»¶', 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 'æ¥­è€…', 'ã‚¿ã‚¹ã‚¯è¨­å®š'];
      if (result.status === 'rejected') {
        console.error(`âŒ ${names[index]}ã®èª­ã¿è¾¼ã¿å¤±æ•—:`, result.reason);
      } else {
        console.log(`âœ… ${names[index]}ã®èª­ã¿è¾¼ã¿æˆåŠŸ`);
      }
    });

    // å¤±æ•—ã—ãŸã‚‚ã®ãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    const failedCount = results.filter(r => r.status === 'rejected').length;
    if (failedCount > 0) {
      console.warn(`âš ï¸ ${failedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`);
      showToast(`${failedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'error');
    }

    console.log('ğŸ¨ ç”»é¢æç”»é–‹å§‹...');
    renderSidebar();
    renderProjects();
    renderTemplates();
    renderVendors();
    renderMappings();

    // æ–°ã‚·ã‚¹ãƒ†ãƒ ã®UIåˆæœŸåŒ–
    populateVendorCategoryDropdown();
    populateProductDropdown();

    console.log('âœ… åˆæœŸåŒ–å®Œäº†');
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  } catch (error) {
    console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
  }
}

// ============================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// ============================================
async function loadDesigners() {
  console.log('ğŸ”„ è¨­è¨ˆå£«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');

  try {
    const { data, error, count } = await supabase
      .from('designers')
      .select('*', { count: 'exact' })
      .order('display_order');

    console.log('ğŸ“¡ Supabaseãƒ¬ã‚¹ãƒãƒ³ã‚¹:', {
      success: !error,
      dataLength: data?.length || 0,
      count: count,
      error: error,
      rawDataSample: data?.slice(0, 3)
    });

    if (error) {
      console.error('âŒ è¨­è¨ˆå£«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      designers = [];
      return;
    }

    designers = data || [];

    // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®å†…è¨³ã‚’è¡¨ç¤º
    const byCategory = designers.reduce((acc, d) => {
      const cat = d.category || '(ãªã—)';
      acc[cat] = (acc[cat] || 0) + 1;
      return acc;
    }, {});

    console.log('âœ… è¨­è¨ˆå£«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', {
      ç·æ•°: designers.length,
      ã‚«ãƒ†ã‚´ãƒªåˆ¥: byCategory,
      ã‚µãƒ³ãƒ—ãƒ«: designers.slice(0, 3).map(d => ({ name: d.name, category: d.category, email: d.email }))
    });

    if (designers.length === 0) {
      console.warn('âš ï¸ è­¦å‘Š: è¨­è¨ˆå£«ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™ï¼Supabaseã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
  } catch (err) {
    console.error('âŒ loadDesigners()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    designers = [];
  }
}

async function loadCurrentDesigner() {
  if (!currentUser || !currentUser.email) return;

  // admin@ghouse.jpã®å ´åˆã¯è¨­è¨ˆå£«ã‚’ç‰¹å®šã—ãªã„ï¼ˆå…¨æ¡ˆä»¶é–²è¦§å¯èƒ½ï¼‰
  if (currentUser.email === 'admin@ghouse.jp') {
    currentDesigner = null;
    return;
  }

  const { data, error } = await supabase
    .from('designers')
    .select('*')
    .eq('email', currentUser.email)
    .single();

  if (error) {
    console.warn('è¨­è¨ˆå£«æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
    currentDesigner = null;
    return;
  }

  currentDesigner = data;
  console.log('ç¾åœ¨ã®è¨­è¨ˆå£«:', currentDesigner);
}

async function loadProjects() {
  console.log('ğŸ”„ æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('*')
      .order('created_at', { ascending: false });
    if (error) {
      console.error('âŒ æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      projects = [];
      return;
    }
    projects = data || [];
    console.log('âœ… æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', projects.length, 'ä»¶');
  } catch (err) {
    console.error('âŒ loadProjects()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    projects = [];
  }
}

async function loadEmailTemplates() {
  console.log('ğŸ”„ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
  try {
    const { data, error } = await supabase
      .from('email_templates')
      .select('*')
      .order('display_name');
    if (error) {
      console.error('âŒ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      emailTemplates = [];
      return;
    }
    emailTemplates = data || [];
    console.log('âœ… ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', emailTemplates.length, 'ä»¶');
  } catch (err) {
    console.error('âŒ loadEmailTemplates()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    emailTemplates = [];
  }
}

async function loadVendors() {
  console.log('ğŸ”„ æ¥­è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
  try {
    const { data, error } = await supabase
      .from('template_vendors')
      .select('*')
      .order('company');
    if (error) {
      console.error('âŒ æ¥­è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      vendors = [];
      return;
    }
    vendors = data || [];
    console.log('âœ… æ¥­è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', vendors.length, 'ä»¶');
  } catch (err) {
    console.error('âŒ loadVendors()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    vendors = [];
  }
}

async function loadTaskMappings() {
  console.log('ğŸ”„ ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
  try {
    const { data, error } = await supabase
      .from('task_template_mappings')
      .select('*');
    if (error) {
      console.error('âŒ ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      taskMappings = {};
      return;
    }
    taskMappings = {};
    (data || []).forEach(mapping => {
      taskMappings[mapping.task_key] = mapping.template_id;
    });
    console.log('âœ… ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(taskMappings).length, 'ä»¶');
  } catch (err) {
    console.error('âŒ loadTaskMappings()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    taskMappings = {};
  }
}

// æ–°ã‚·ã‚¹ãƒ†ãƒ ç”¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function loadVendorCategories() {
  const { data, error } = await supabase
    .from('vendor_categories')
    .select('*')
    .order('display_order');
  if (!error) vendorCategories = data || [];
  console.log('âœ… æ¥­è€…ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿å®Œäº†:', vendorCategories.length, 'ä»¶');
}

async function loadTasksV2() {
  const { data, error } = await supabase
    .from('tasks')
    .select('*')
    .order('display_order');
  if (!error) tasksV2 = data || [];
  console.log('âœ… ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿å®Œäº†:', tasksV2.length, 'ä»¶');
}

async function loadVendorsV2() {
  console.log('ğŸ”„ æ¥­è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');

  const { data, error } = await supabase
    .from('vendors_v2')
    .select('*')
    .order('company');

  if (error) {
    console.error('âŒ æ¥­è€…èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    vendorsV2 = [];
    return;
  }

  vendorsV2 = data || [];
  console.log('âœ… æ¥­è€…èª­ã¿è¾¼ã¿å®Œäº†:', vendorsV2.length, 'ä»¶', vendorsV2);

  // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã‚’åˆ¥é€”å–å¾—ã—ã¦ãƒãƒ¼ã‚¸
  if (vendorsV2.length > 0 && vendorCategories.length > 0) {
    vendorsV2 = vendorsV2.map(vendor => {
      const category = vendorCategories.find(c => c.id === vendor.category_id);
      return {
        ...vendor,
        vendor_categories: category ? { name: category.name } : null
      };
    });
  }
}

async function loadTaskVendorMappings() {
  const { data, error } = await supabase
    .from('task_vendor_mappings_v2')
    .select('*');
  if (!error) taskVendorMappings = data || [];
  console.log('âœ… ã‚¿ã‚¹ã‚¯-æ¥­è€…ç´ã¥ã‘èª­ã¿è¾¼ã¿å®Œäº†:', taskVendorMappings.length, 'ä»¶');
}

async function loadProducts() {
  const { data, error } = await supabase
    .from('products')
    .select('*')
    .order('display_order');
  if (!error && data) {
    products = data;
  } else {
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    products = [
      { id: '1', name: 'LIFE', display_order: 1 },
      { id: '2', name: 'LIFE+', display_order: 2 },
      { id: '3', name: 'HOURS', display_order: 3 },
      { id: '4', name: 'LACIE', display_order: 4 },
      { id: '5', name: 'LIFEãƒªãƒŸ', display_order: 5 },
      { id: '6', name: 'LIFE+ãƒªãƒŸ', display_order: 6 }
    ];
  }
  console.log('âœ… å•†å“èª­ã¿è¾¼ã¿å®Œäº†:', products.length, 'ä»¶');
}

// ============================================
// æ¥­è€…ç®¡ç†V2
// ============================================
let currentCategoryFilter = 'ALL';

function renderVendorsV2() {
  const container = document.getElementById('vendorsGrid');
  if (!container) {
    console.warn('âš ï¸ vendorsGridè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }

  console.log('ğŸ” renderVendorsV2():', {
    totalVendors: vendorsV2.length,
    currentFilter: currentCategoryFilter,
    vendors: vendorsV2
  });

  const filtered = currentCategoryFilter === 'ALL'
    ? vendorsV2
    : vendorsV2.filter(v => v.category_id === currentCategoryFilter);

  console.log('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®æ¥­è€…æ•°:', filtered.length);

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><p>æ¥­è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><small>ã€Œ+ æ¥­è€…è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</small></p></div>';
    return;
  }

  container.innerHTML = filtered.map(vendor => {
    const categoryName = vendor.vendor_categories?.name || 'æœªåˆ†é¡';
    return `
      <div class="vendor-card">
        <div class="vendor-header">
          <h3>${vendor.company}</h3>
          <span class="badge badge-primary">${categoryName}</span>
        </div>
        <div class="vendor-info">
          <div><strong>æ‹…å½“è€…:</strong> ${vendor.contact || '-'}</div>
          <div><strong>TEL:</strong> ${vendor.tel || '-'}</div>
          <div><strong>Email:</strong> ${vendor.email || '-'}</div>
        </div>
        <div class="vendor-actions">
          <button class="btn btn-secondary btn-small" onclick="editVendorV2('${vendor.id}')">ç·¨é›†</button>
          <button class="btn btn-danger btn-small" onclick="deleteVendorV2('${vendor.id}')">å‰Šé™¤</button>
        </div>
      </div>
    `;
  }).join('');
}

function setCategoryFilter(categoryId) {
  currentCategoryFilter = categoryId;
  document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  renderVendorsV2();
}

function openVendorModalV2(vendorId = null) {
  const modal = document.getElementById('vendorModalV2');
  const title = document.getElementById('vendorModalTitle');

  // ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
  populateVendorCategoryDropdown();

  if (vendorId) {
    const vendor = vendorsV2.find(v => v.id === vendorId);
    if (!vendor) return;

    title.textContent = 'æ¥­è€…ç·¨é›†';
    document.getElementById('vendorId').value = vendor.id;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact || '';
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email || '';
    document.getElementById('vendorCategory').value = vendor.category_id || '';
    document.getElementById('vendorSubject').value = vendor.subject_format || '';
    document.getElementById('vendorTemplate').value = vendor.template_text || '';
    document.getElementById('vendorHasSpecial').checked = vendor.has_special_content || false;
    document.getElementById('vendorSpecialContent').value = vendor.default_special_content || '';
    toggleSpecialContent();
  } else {
    title.textContent = 'æ¥­è€…è¿½åŠ ';
    document.getElementById('vendorForm').reset();
    document.getElementById('vendorId').value = '';
    document.getElementById('vendorHasSpecial').checked = false;
    toggleSpecialContent();
  }

  modal.style.display = 'flex';
}

function closeVendorModalV2() {
  document.getElementById('vendorModalV2').style.display = 'none';
}

function toggleSpecialContent() {
  const hasSpecial = document.getElementById('vendorHasSpecial').checked;
  const specialGroup = document.getElementById('specialContentGroup');
  specialGroup.style.display = hasSpecial ? 'block' : 'none';
}

async function saveVendorV2() {
  const id = document.getElementById('vendorId').value;
  const company = document.getElementById('vendorCompany').value.trim();
  const contact = document.getElementById('vendorContact').value.trim();
  const tel = document.getElementById('vendorTel').value.trim();
  const email = document.getElementById('vendorEmail').value.trim();
  const categoryId = document.getElementById('vendorCategory').value;
  const subjectFormat = document.getElementById('vendorSubject').value.trim();
  const templateText = document.getElementById('vendorTemplate').value.trim();
  const hasSpecial = document.getElementById('vendorHasSpecial').checked;
  const specialContent = document.getElementById('vendorSpecialContent').value.trim();

  if (!company) {
    showToast('ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const vendorData = {
    company,
    contact: contact || null,
    tel: tel || null,
    email: email || null,
    category_id: categoryId || null,
    subject_format: subjectFormat || null,
    template_text: templateText || null,
    has_special_content: hasSpecial,
    default_special_content: hasSpecial ? specialContent : null
  };

  let result;
  if (id) {
    result = await supabase
      .from('vendors_v2')
      .update(vendorData)
      .eq('id', id)
      .select('*, vendor_categories(name)');
  } else {
    result = await supabase
      .from('vendors_v2')
      .insert([vendorData])
      .select('*, vendor_categories(name)');
  }

  if (result.error) {
    showStatus('ä¿å­˜å¤±æ•—', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error.message, 'error');
    return;
  }

  showStatus('ä¿å­˜å®Œäº†', 'success');
  showToast(id ? 'æ¥­è€…ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'æ¥­è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
  closeVendorModalV2();
  await loadVendorsV2();
  renderVendorsV2();
}

function editVendorV2(vendorId) {
  openVendorModalV2(vendorId);
}

async function deleteVendorV2(vendorId) {
  const vendor = vendorsV2.find(v => v.id === vendorId);
  if (!vendor) return;

  if (!confirm(`ã€Œ${vendor.company}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');

  const { error } = await supabase
    .from('vendors_v2')
    .delete()
    .eq('id', vendorId);

  if (error) {
    showStatus('å‰Šé™¤å¤±æ•—', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  showStatus('å‰Šé™¤å®Œäº†', 'success');
  showToast('æ¥­è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  await loadVendorsV2();
  renderVendorsV2();
}

// ============================================
// ã‚«ãƒ†ã‚´ãƒªç®¡ç†
// ============================================
function renderCategoriesList() {
  const container = document.getElementById('categoriesGrid');
  if (!container) return;

  if (vendorCategories.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ·ï¸</div><p>ã‚«ãƒ†ã‚´ãƒªãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
    return;
  }

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>è¡¨ç¤ºé †</th>
            <th>ã‚«ãƒ†ã‚´ãƒªå</th>
            <th>æ¥­è€…æ•°</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${vendorCategories.map(cat => {
            const count = vendorsV2.filter(v => v.category_id === cat.id).length;
            return `
              <tr>
                <td>${cat.display_order}</td>
                <td><strong>${cat.name}</strong></td>
                <td>${count}ç¤¾</td>
                <td>
                  <button class="btn btn-secondary btn-small" onclick="editCategory('${cat.id}')">ç·¨é›†</button>
                  <button class="btn btn-danger btn-small" onclick="deleteCategory('${cat.id}')">å‰Šé™¤</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function openCategoryModal(categoryId = null) {
  const modal = document.getElementById('categoryModal');
  const title = document.getElementById('categoryModalTitle');

  if (categoryId) {
    const category = vendorCategories.find(c => c.id === categoryId);
    if (!category) return;

    title.textContent = 'ã‚«ãƒ†ã‚´ãƒªç·¨é›†';
    document.getElementById('categoryId').value = category.id;
    document.getElementById('categoryName').value = category.name;
    document.getElementById('categoryOrder').value = category.display_order;
  } else {
    title.textContent = 'ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryOrder').value = vendorCategories.length + 1;
  }

  modal.style.display = 'flex';
}

function closeCategoryModal() {
  document.getElementById('categoryModal').style.display = 'none';
}

async function saveCategory() {
  const id = document.getElementById('categoryId').value;
  const name = document.getElementById('categoryName').value.trim();
  const order = parseInt(document.getElementById('categoryOrder').value) || 0;

  if (!name) {
    showToast('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const categoryData = {
    name,
    display_order: order
  };

  let result;
  if (id) {
    result = await supabase
      .from('vendor_categories')
      .update(categoryData)
      .eq('id', id)
      .select();
  } else {
    result = await supabase
      .from('vendor_categories')
      .insert([categoryData])
      .select();
  }

  if (result.error) {
    showStatus('ä¿å­˜å¤±æ•—', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error.message, 'error');
    return;
  }

  showStatus('ä¿å­˜å®Œäº†', 'success');
  showToast(id ? 'ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
  closeCategoryModal();
  await loadVendorCategories();
  renderCategoriesList();
  renderCategoryFilters();
}

function editCategory(categoryId) {
  openCategoryModal(categoryId);
}

async function deleteCategory(categoryId) {
  const category = vendorCategories.find(c => c.id === categoryId);
  if (!category) return;

  const vendorCount = vendorsV2.filter(v => v.category_id === categoryId).length;
  if (vendorCount > 0) {
    showToast(`ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯${vendorCount}ç¤¾ã®æ¥­è€…ãŒç´ã¥ã„ã¦ã„ã¾ã™ã€‚å…ˆã«æ¥­è€…ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚`, 'error');
    return;
  }

  if (!confirm(`ã‚«ãƒ†ã‚´ãƒªã€Œ${category.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');

  const { error } = await supabase
    .from('vendor_categories')
    .delete()
    .eq('id', categoryId);

  if (error) {
    showStatus('å‰Šé™¤å¤±æ•—', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  showStatus('å‰Šé™¤å®Œäº†', 'success');
  showToast('ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  await loadVendorCategories();
  renderCategoriesList();
  renderCategoryFilters();
}

function renderCategoryFilters() {
  const container = document.getElementById('categoryFilters');
  if (!container) return;

  let html = `<button class="category-filter-btn ${currentCategoryFilter === 'ALL' ? 'active' : ''}" onclick="setCategoryFilter('ALL')">å…¨ã¦ (${vendorsV2.length})</button>`;

  vendorCategories.forEach(cat => {
    const count = vendorsV2.filter(v => v.category_id === cat.id).length;
    html += `<button class="category-filter-btn ${currentCategoryFilter === cat.id ? 'active' : ''}" onclick="setCategoryFilter('${cat.id}')">${cat.name} (${count})</button>`;
  });

  container.innerHTML = html;
}

// ============================================
// å•†å“ç®¡ç†
// ============================================
function renderProductsList() {
  const container = document.getElementById('productsGrid');
  if (!container) return;

  if (products.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><p>å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
    return;
  }

  container.innerHTML = '<div class="table-container"><table class="table"><thead><tr><th>å•†å“å</th><th>è¡¨ç¤ºé †</th><th>æ“ä½œ</th></tr></thead><tbody>' +
    products.map(product => `
      <tr>
        <td><strong>${product.name}</strong></td>
        <td>${product.display_order}</td>
        <td><button class="btn btn-danger btn-small" onclick="deleteProductInline('${product.id}')">å‰Šé™¤</button></td>
      </tr>
    `).join('') +
    '</tbody></table></div>';
}

async function addProductInline() {
  const name = document.getElementById('newProductNameInline').value.trim();

  if (!name) {
    showToast('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (products.find(p => p.name === name)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹å•†å“åã§ã™', 'error');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');

  const maxDisplayOrder = products.length > 0 ? Math.max(...products.map(p => p.display_order || 0)) : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('products')
    .insert([{ name, display_order: newDisplayOrder }])
    .select();

  if (error) {
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã«è¿½åŠ 
    products.push({ id: Date.now().toString(), name, display_order: newDisplayOrder });
    document.getElementById('newProductNameInline').value = '';
    renderProductsList();
    populateProductDropdown();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰', 'success');
    return;
  }

  products.push(data[0]);
  document.getElementById('newProductNameInline').value = '';
  renderProductsList();
  populateProductDropdown();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteProductInline(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;

  if (!confirm(`å•†å“ã€Œ${product.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');

  const { error } = await supabase
    .from('products')
    .delete()
    .eq('id', productId);

  if (error && !error.message.includes('does not exist')) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  products = products.filter(p => p.id !== productId);
  renderProductsList();
  populateProductDropdown();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

function populateProductDropdown() {
  const select = document.getElementById('projectSpecifications');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
    products.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

  if (currentValue) select.value = currentValue;
}

// ============================================
// ã‚¿ã‚¹ã‚¯ç®¡ç†
// ============================================
function renderTasksManagement() {
  const container = document.getElementById('tasksGrid');
  if (!container) return;

  const sekkeiTasks = tasksV2.filter(t => t.category === 'è¨­è¨ˆ');
  const icTasks = tasksV2.filter(t => t.category === 'IC');

  container.innerHTML = `
    <div class="tasks-section">
      <h3 style="margin: 0 0 16px; font-size: 18px; font-weight: 600;">è¨­è¨ˆã‚¿ã‚¹ã‚¯ (${sekkeiTasks.length}ä»¶)</h3>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>è¡¨ç¤ºé †</th>
              <th>ã‚¿ã‚¹ã‚¯å</th>
              <th>çŠ¶æ…‹ç®¡ç†</th>
              <th>ç´ã¥ã‘æ¥­è€…</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${sekkeiTasks.map(task => renderTaskRow(task)).join('')}
          </tbody>
        </table>
      </div>
    </div>
    <div class="tasks-section" style="margin-top: 32px;">
      <h3 style="margin: 0 0 16px; font-size: 18px; font-weight: 600;">ICã‚¿ã‚¹ã‚¯ (${icTasks.length}ä»¶)</h3>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>è¡¨ç¤ºé †</th>
              <th>ã‚¿ã‚¹ã‚¯å</th>
              <th>çŠ¶æ…‹ç®¡ç†</th>
              <th>ç´ã¥ã‘æ¥­è€…</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${icTasks.map(task => renderTaskRow(task)).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderTaskRow(task) {
  const mappings = taskVendorMappings.filter(m => m.task_id === task.id);
  const vendorNames = mappings.map(m => {
    const vendor = vendorsV2.find(v => v.id === m.vendor_id);
    return vendor ? vendor.company : 'ä¸æ˜';
  }).join(', ');

  const stateInfo = task.has_state ?
    `<span class="badge badge-success">ã‚ã‚Š</span>` :
    `<span class="badge badge-secondary">ãªã—</span>`;

  return `
    <tr>
      <td>${task.display_order}</td>
      <td><strong>${task.task_name}</strong></td>
      <td>${stateInfo}</td>
      <td>${vendorNames || '-'}</td>
      <td>
        <button class="btn btn-secondary btn-small" onclick="editTask('${task.id}')">ç·¨é›†</button>
        <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')">å‰Šé™¤</button>
      </td>
    </tr>
  `;
}

function openTaskModal(taskId = null) {
  const modal = document.getElementById('taskModal');
  const title = document.getElementById('taskModalTitle');

  if (taskId) {
    const task = tasksV2.find(t => t.id === taskId);
    if (!task) return;

    title.textContent = 'ã‚¿ã‚¹ã‚¯ç·¨é›†';
    document.getElementById('taskId').value = task.id;
    document.getElementById('taskKey').value = task.task_key;
    document.getElementById('taskName').value = task.task_name;
    document.getElementById('taskCategory').value = task.category;
    document.getElementById('taskOrder').value = task.display_order;
    document.getElementById('taskHasState').checked = task.has_state;
    document.getElementById('taskStateOptions').value = task.state_options ? JSON.stringify(task.state_options) : '';
    toggleTaskState();
  } else {
    title.textContent = 'ã‚¿ã‚¹ã‚¯è¿½åŠ ';
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskCategory').value = 'è¨­è¨ˆ';
    document.getElementById('taskOrder').value = tasksV2.length + 1;
    document.getElementById('taskHasState').checked = false;
    toggleTaskState();
  }

  modal.style.display = 'flex';
}

function closeTaskModal() {
  document.getElementById('taskModal').style.display = 'none';
}

function toggleTaskState() {
  const hasState = document.getElementById('taskHasState').checked;
  const stateGroup = document.getElementById('stateOptionsGroup');
  stateGroup.style.display = hasState ? 'block' : 'none';
}

async function saveTask() {
  const id = document.getElementById('taskId').value;
  const taskKey = document.getElementById('taskKey').value.trim();
  const taskName = document.getElementById('taskName').value.trim();
  const category = document.getElementById('taskCategory').value;
  const order = parseInt(document.getElementById('taskOrder').value) || 0;
  const hasState = document.getElementById('taskHasState').checked;
  const stateOptionsStr = document.getElementById('taskStateOptions').value.trim();

  if (!taskKey || !taskName) {
    showToast('ã‚¿ã‚¹ã‚¯ã‚­ãƒ¼ã¨ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  let stateOptions = null;
  if (hasState && stateOptionsStr) {
    try {
      stateOptions = JSON.parse(stateOptionsStr);
    } catch (e) {
      showToast('çŠ¶æ…‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const taskData = {
    task_key: taskKey,
    task_name: taskName,
    category,
    display_order: order,
    has_state: hasState,
    state_options: stateOptions
  };

  let result;
  if (id) {
    result = await supabase
      .from('tasks')
      .update(taskData)
      .eq('id', id)
      .select();
  } else {
    result = await supabase
      .from('tasks')
      .insert([taskData])
      .select();
  }

  if (result.error) {
    showStatus('ä¿å­˜å¤±æ•—', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error.message, 'error');
    return;
  }

  showStatus('ä¿å­˜å®Œäº†', 'success');
  showToast(id ? 'ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
  closeTaskModal();
  await loadTasksV2();
  renderTasksManagement();
}

function editTask(taskId) {
  openTaskModal(taskId);
}

async function deleteTask(taskId) {
  const task = tasksV2.find(t => t.id === taskId);
  if (!task) return;

  if (!confirm(`ã‚¿ã‚¹ã‚¯ã€Œ${task.task_name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');

  const { error } = await supabase
    .from('tasks')
    .delete()
    .eq('id', taskId);

  if (error) {
    showStatus('å‰Šé™¤å¤±æ•—', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  showStatus('å‰Šé™¤å®Œäº†', 'success');
  showToast('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  await loadTasksV2();
  renderTasksManagement();
}

// ============================================
// UIåˆ¶å¾¡
// ============================================
// ã‚µã‚¤ãƒ‰ãƒãƒ¼æç”»
function renderSidebar() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = designers.filter(d => d.category === 'è¨­è¨ˆ').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = designers.filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const allCount = projects.filter(p => p.status !== 'completed').length;

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">å…¨æ¡ˆä»¶</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
    </div>
  `;

  if (sekkeiDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">ğŸ“ è¨­è¨ˆæ‹…å½“</div>';
    sekkeiDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label">${designer.name}</span>
          <span class="sidebar-item-count">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  if (icDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">ğŸ¨ ICæ‹…å½“</div>';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label">${designer.name}</span>
          <span class="sidebar-item-count">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  container.innerHTML = html;
}

function selectDesigner(name) {
  currentDesignerTab = name;
  renderSidebar();
  renderProjects();
}

// ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchMainTab(tabName, element) {
  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // URLã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®ãƒãƒƒã‚·ãƒ¥ã¨ç•°ãªã‚‹å ´åˆã®ã¿ï¼‰
  if (window.location.hash !== '#' + tabName) {
    window.location.hash = tabName;
  }
}

// ã‚µãƒ–ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchSubTab(panelName, element) {
  document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.sub-tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(panelName + 'Panel').classList.add('active');

  // URLã‚’æ›´æ–°ï¼ˆè¨­å®šã‚¿ãƒ–å†…ã®ã‚µãƒ–ã‚¿ãƒ–ï¼‰
  if (window.location.hash !== `#settings/${panelName}`) {
    window.location.hash = `settings/${panelName}`;
  }

  // ã‚µãƒ–ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å¯¾å¿œã™ã‚‹æç”»é–¢æ•°ã‚’å®Ÿè¡Œ
  switch(panelName) {
    case 'staff':
      renderDesignerListInline();
      break;
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
    case 'products':
      renderProductsList();
      break;
  }
}

// æ—§switchTabé–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
function switchTab(tabName, element) {
  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) {
    element.classList.add('active');
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼štabNameã«åŸºã¥ã„ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
    const buttons = document.querySelectorAll('.tab-nav-btn');
    buttons.forEach((btn, index) => {
      const tabs = ['projects', 'vendors', 'categories', 'tasks', 'settings'];
      if (tabs[index] === tabName) {
        btn.classList.add('active');
      }
    });
  }
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å¯¾å¿œã™ã‚‹æç”»é–¢æ•°ã‚’å®Ÿè¡Œ
  switch(tabName) {
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
  }
}

// ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
function populateVendorCategoryDropdown() {
  const dropdown = document.getElementById('vendorCategory');
  if (!dropdown) return;

  dropdown.innerHTML = '<option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ...</option>' +
    vendorCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
}

function showStatus(message, type) {
  const indicator = document.getElementById('statusIndicator');
  const text = document.getElementById('statusText');
  indicator.className = 'status-indicator status-' + type;
  text.textContent = message;
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.className = 'toast toast-' + type + ' show';
  toast.textContent = message;
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// ============================================
// ãƒ¡ãƒ¼ãƒ«ä½œæˆï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
// ============================================
function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  if (!taskDef) {
    showToast('ã‚¿ã‚¹ã‚¯å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  // ã“ã®ã‚¿ã‚¹ã‚¯ã«ç´ã¥ãæ¥­è€…ã‚’å–å¾—
  const mappings = taskVendorMappings.filter(m => m.task_id === taskDef.id);
  const linkedVendors = mappings.map(m => vendorsV2.find(v => v.id === m.vendor_id)).filter(v => v);

  if (linkedVendors.length === 0) {
    showToast('ã“ã®ã‚¿ã‚¹ã‚¯ã«ã¯æ¥­è€…ãŒç´ã¥ã„ã¦ã„ã¾ã›ã‚“', 'error');
    return;
  }

  if (linkedVendors.length === 1) {
    // æ¥­è€…ãŒ1ã¤ã®å ´åˆã¯ç›´æ¥ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’è¡¨ç¤º
    openEmailComposer(project, taskDef, linkedVendors[0]);
  } else {
    // æ¥­è€…ãŒè¤‡æ•°ã®å ´åˆã¯é¸æŠç”»é¢ã‚’è¡¨ç¤º
    showVendorSelection(project, taskDef, linkedVendors);
  }
}

function showVendorSelection(project, taskDef, vendors) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  content.innerHTML = `
    <h3 style="margin-bottom: 16px;">æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
    <div style="display: flex; flex-direction: column; gap: 12px;">
      ${vendors.map(vendor => `
        <button class="template-select-btn" onclick="openEmailComposer(
          projects.find(p => p.id === '${project.id}'),
          tasksV2.find(t => t.id === '${taskDef.id}'),
          vendorsV2.find(v => v.id === '${vendor.id}')
        )">
          <div style="font-weight: 600; margin-bottom: 4px;">${vendor.company}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">${vendor.contact || ''}</div>
        </button>
      `).join('')}
    </div>
  `;

  modal.style.display = 'flex';
}

function openEmailComposer(project, taskDef, vendor) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // ç¾åœ¨ã®æ‹…å½“è€…æƒ…å ±ã‚’å–å¾—
  const assignee = designers.find(d => d.name === project.assigned_to);
  const staffName = assignee?.name || project.assigned_to;

  // æœŸæ—¥ã‚’è¨ˆç®—ï¼ˆä»Šæ—¥+1é€±é–“ï¼‰
  const dueDate = new Date();
  dueDate.setDate(dueDate.getDate() + 7);
  const dueDateStr = `${dueDate.getMonth() + 1}/${dueDate.getDate()}`;

  // å¤‰æ•°ç½®æ›ç”¨ã®ãƒ‡ãƒ¼ã‚¿
  const variables = {
    company: vendor.company,
    contact: vendor.contact || '',
    customerName: project.customer,
    dueDate: dueDateStr,
    staffName: staffName,
    specialContent: vendor.default_special_content || ''
  };

  // ä»¶åã¨æœ¬æ–‡ã®ç½®æ›
  let subject = vendor.subject_format || '';
  let body = vendor.template_text || '';

  Object.keys(variables).forEach(key => {
    const regex = new RegExp(`\\{${key}\\}`, 'g');
    subject = subject.replace(regex, variables[key]);
    body = body.replace(regex, variables[key]);
  });

  // ãƒ¡ãƒ¼ãƒ«ä½œæˆUI
  content.innerHTML = `
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <div>
        <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">æ¥­è€…</div>
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
          <div style="font-weight: 600;">${vendor.company}</div>
          <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${vendor.contact || ''}</div>
        </div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">å®›å…ˆ</label>
        <input type="email" id="emailTo" class="form-input" value="${vendor.email || ''}" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ä»¶å</label>
        <input type="text" id="emailSubject" class="form-input" value="${subject}">
      </div>

      ${vendor.has_special_content ? `
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ç‰¹åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</label>
          <textarea id="emailSpecialContent" class="form-textarea" rows="3">${vendor.default_special_content || ''}</textarea>
          <div class="form-hint">æœ¬æ–‡ä¸­ã® {specialContent} ã«ç½®æ›ã•ã‚Œã¾ã™</div>
        </div>
      ` : ''}

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">æœŸæ—¥</label>
        <input type="text" id="emailDueDate" class="form-input" value="${dueDateStr}">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">æœ¬æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
        <textarea id="emailBody" class="form-textarea" rows="15">${body}</textarea>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-ghost" onclick="closeEmailModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="copyEmailToClipboard()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  `;

  // ç‰¹åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚„æœŸæ—¥ã®å¤‰æ›´æ™‚ã«æœ¬æ–‡ã‚’æ›´æ–°
  if (vendor.has_special_content) {
    document.getElementById('emailSpecialContent').addEventListener('input', () => updateEmailBody(vendor, variables));
  }
  document.getElementById('emailDueDate').addEventListener('input', () => updateEmailBody(vendor, variables));

  modal.style.display = 'flex';
}

function updateEmailBody(vendor, baseVariables) {
  const specialContent = document.getElementById('emailSpecialContent')?.value || baseVariables.specialContent;
  const dueDate = document.getElementById('emailDueDate').value;

  const variables = { ...baseVariables, specialContent, dueDate };

  let body = vendor.template_text || '';
  Object.keys(variables).forEach(key => {
    const regex = new RegExp(`\\{${key}\\}`, 'g');
    body = body.replace(regex, variables[key]);
  });

  document.getElementById('emailBody').value = body;
}

function copyEmailToClipboard() {
  const to = document.getElementById('emailTo').value;
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;

  const emailText = `To: ${to}\nSubject: ${subject}\n\n${body}`;

  navigator.clipboard.writeText(emailText).then(() => {
    showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
  }).catch(err => {
    showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  });
}

function closeEmailModal() {
  document.getElementById('emailModal').style.display = 'none';
}

// ============================================
// æ¡ˆä»¶ç®¡ç†
// ============================================
function renderDesignerTabs() {
  const container = document.getElementById('designerTabs');
  if (!container) {
    console.warn('âš ï¸ designerTabsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }

  console.log('ğŸ¨ æ‹…å½“è€…ã‚¿ãƒ–æç”»:', {
    ç·ã‚¹ã‚¿ãƒƒãƒ•æ•°: designers.length,
    è¨­è¨ˆæ‹…å½“: designers.filter(d => d.category === 'è¨­è¨ˆ').length,
    ICæ‹…å½“: designers.filter(d => d.category === 'IC').length,
    æ¡ˆä»¶æ•°: projects.length
  });

  const activeCount = projects.filter(p => p.status !== 'completed').length;

  let html = `<button class="designer-tab ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="setDesignerTab('ALL')">å…¨æ¡ˆä»¶ (${activeCount})</button>`;

  // è¨­è¨ˆæ‹…å½“
  const sekkeiDesigners = designers.filter(d => d.category === 'è¨­è¨ˆ');
  console.log('ğŸ“ è¨­è¨ˆæ‹…å½“:', sekkeiDesigners.map(d => d.name));
  if (sekkeiDesigners.length > 0) {
    html += '<div class="designer-group-label">è¨­è¨ˆæ‹…å½“</div>';
    sekkeiDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  } else {
    console.warn('âš ï¸ è¨­è¨ˆæ‹…å½“ãŒ0åã§ã™');
  }

  // ICæ‹…å½“
  const icDesigners = designers.filter(d => d.category === 'IC');
  console.log('ğŸ¨ ICæ‹…å½“:', icDesigners.map(d => d.name));
  if (icDesigners.length > 0) {
    html += '<div class="designer-group-label">ICæ‹…å½“</div>';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  }

  container.innerHTML = html;
}

function setDesignerTab(name) {
  currentDesignerTab = name;
  renderDesignerTabs();
  renderProjects();
}

function renderProjects() {
  const container = document.getElementById('projectsGrid');
  const emptyState = document.getElementById('emptyProjects');

  let filtered = projects.filter(p => {
    if (currentDesignerTab !== 'ALL' && p.assigned_to !== currentDesignerTab) return false;
    if (p.status === 'completed') return false;

    const query = document.getElementById('searchQuery').value.toLowerCase();
    if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

    const specFilter = document.getElementById('specFilter').value;
    if (specFilter && p.specifications !== specFilter) return false;

    return true;
  });

  if (filtered.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  container.style.display = 'grid';
  emptyState.style.display = 'none';
  container.innerHTML = filtered.map(project => renderProjectCard(project)).join('');
}

function renderProjectCard(project) {
  const progress = calculateProgress(project);
  const progressData = project.progress || {};

  // æ‹…å½“è€…ã®ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
  const tasks = getTasksForAssignee(project.assigned_to);

  const tasksHtml = tasks.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '' };

    // ãƒ¡ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¹ã‚¯ã«æ¥­è€…ãŒç´ã¥ã„ã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const emailBtn = hasVendor ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="ãƒ¡ãƒ¼ãƒ«ä½œæˆ">ğŸ“§</button>` : '';

    // çŠ¶æ…‹ã‚»ãƒ¬ã‚¯ãƒˆã®ç”Ÿæˆï¼ˆã‚¿ã‚¹ã‚¯ã«çŠ¶æ…‹ç®¡ç†ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
    let stateSelect = '';
    const stateOptions = getTaskStateOptions(key);
    if (stateOptions && Array.isArray(stateOptions)) {
      const stateClass = task.state === 'ä¾é ¼æ¸ˆ' ? 'state-yellow' : task.state === 'ä¿å­˜æ¸ˆ' ? 'state-green' : '';
      stateSelect = `
        <select class="task-state-select ${stateClass}"
          onchange="updateTaskState('${project.id}', '${key}', this.value)">
          ${stateOptions.map(state =>
            `<option value="${state}" ${task.state === state ? 'selected' : ''}>${state || '-'}</option>`
          ).join('')}
        </select>
      `;
    }

    return `
      <div class="task-item">
        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}
          onchange="updateTaskStatus('${project.id}', '${key}', this.checked)">
        <span class="task-label">${taskDef.task_name}</span>
        ${stateSelect}
        ${emailBtn}
      </div>
    `;
  }).join('');

  return `
    <div class="project-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            ${project.customer}
            <span class="badge badge-primary">${project.specifications || 'LIFE'}</span>
          </div>
          <div class="card-subtitle">æ‹…å½“ï¼š${project.assigned_to}</div>
        </div>
        <button class="btn btn-ghost btn-small" onclick="editProject('${project.id}')">ç·¨é›†</button>
      </div>
      <div class="progress-section">
        <div class="progress-header">
          <span class="progress-label">é€²æ—çŠ¶æ³</span>
          <span class="progress-value">${progress}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%"></div>
        </div>
      </div>
      <div class="tasks-grid">${tasksHtml}</div>
      ${project.memo ? `<div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md); margin-top: 16px; font-size: 14px; color: var(--text-secondary);">${project.memo}</div>` : ''}
      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--bg-secondary); display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 13px; color: var(--text-muted);">æ›´æ–°: ${formatDateTime(project.updated_at)}</span>
        <button class="btn btn-danger btn-small" onclick="deleteProject('${project.id}')">å‰Šé™¤</button>
      </div>
    </div>
  `;
}

function calculateProgress(project) {
  const progressData = project.progress || {};
  const tasks = getTasksForAssignee(project.assigned_to);
  if (tasks.length === 0) return 0;
  const completed = tasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / tasks.length) * 100);
}

function formatDateTime(dateStr) {
  if (!dateStr) return 'â€”';
  const d = new Date(dateStr);
  return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

async function updateTaskStatus(projectId, taskKey, completed) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].completed = completed;
  if (completed && !progressData[taskKey].date) {
    progressData[taskKey].date = new Date().toISOString().split('T')[0];
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

async function updateTaskState(projectId, taskKey, state) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = state;

  showStatus('ä¿å­˜ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

function openProjectModal(projectId = null) {
  editingProjectId = projectId;
  const modal = document.getElementById('projectModal');
  const title = document.getElementById('projectModalTitle');

  if (projectId) {
    const project = projects.find(p => p.id === projectId);
    title.textContent = 'æ¡ˆä»¶ç·¨é›†';
    document.getElementById('projectCustomer').value = project.customer;
    document.getElementById('projectAssignedTo').value = project.assigned_to;
    document.getElementById('projectSpecifications').value = project.specifications || 'LIFE';
    document.getElementById('projectMemo').value = project.memo || '';
  } else {
    title.textContent = 'æ¡ˆä»¶è¿½åŠ ';
    document.getElementById('projectCustomer').value = '';
    document.getElementById('projectSpecifications').value = 'LIFE';
    document.getElementById('projectMemo').value = '';
  }

  const assignedToSelect = document.getElementById('projectAssignedTo');
  assignedToSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
    designers.map(d => `<option value="${d.name}">${d.name}</option>`).join('');

  modal.classList.add('show');
}

function closeProjectModal() {
  document.getElementById('projectModal').classList.remove('show');
  editingProjectId = null;
}

async function saveProject() {
  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value;
  const specifications = document.getElementById('projectSpecifications').value;
  const memo = document.getElementById('projectMemo').value.trim();

  if (!customer || !assignedTo) {
    showToast('ãŠå®¢æ§˜åã¨æ‹…å½“è¨­è¨ˆå£«ã¯å¿…é ˆã§ã™', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  // æ‹…å½“è¨­è¨ˆå£«ã®IDã‚’å–å¾—
  const designer = designers.find(d => d.name === assignedTo);
  const designerId = designer ? designer.id : null;

  const blankProgress = {};
  Object.keys(TASK_NAMES).forEach(key => {
    blankProgress[key] = { completed: false, date: '', state: '' };
  });

  if (editingProjectId) {
    const project = projects.find(p => p.id === editingProjectId);
    const { error } = await supabase
      .from('projects')
      .update({
        customer,
        assigned_to: assignedTo,
        designer_id: designerId,
        specifications,
        memo,
        updated_at: new Date().toISOString()
      })
      .eq('id', editingProjectId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    Object.assign(project, { customer, assigned_to: assignedTo, specifications, memo, updated_at: new Date().toISOString() });
  } else {
    const newProject = {
      uid: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      customer,
      assigned_to: assignedTo,
      designer_id: designerId,
      specifications,
      memo,
      status: 'active',
      progress: blankProgress,
      created_by: currentUser.id
    };

    const { data, error } = await supabase
      .from('projects')
      .insert([newProject])
      .select();

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    projects.unshift(data[0]);
  }

  closeProjectModal();
  renderDesignerTabs();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('æ¡ˆä»¶ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

function editProject(projectId) {
  openProjectModal(projectId);
}

async function deleteProject(projectId) {
  if (!confirm('ã“ã®æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .delete()
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  projects = projects.filter(p => p.id !== projectId);
  renderDesignerTabs();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// è¨­è¨ˆå£«ç®¡ç†
// ============================================
function openDesignerModal() {
  renderDesignerList();
  document.getElementById('designerModal').classList.add('show');
}

function closeDesignerModal() {
  document.getElementById('designerModal').classList.remove('show');
}

function renderDesignerList() {
  const container = document.getElementById('designerList');

  // ã‚«ãƒ†ã‚´ãƒªã§ä¸¦ã³æ›¿ãˆï¼ˆè¨­è¨ˆâ†’ICï¼‰
  const sortedDesigners = [...designers].sort((a, b) => {
    if (a.category === 'è¨­è¨ˆ' && b.category === 'IC') return -1;
    if (a.category === 'IC' && b.category === 'è¨­è¨ˆ') return 1;
    return (a.display_order || 999) - (b.display_order || 999);
  });

  container.innerHTML = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆ' + designers.length + 'åï¼‰</h3>' +
    '<div class="table-container"><table class="table"><thead><tr><th>ã‚¹ã‚¿ãƒƒãƒ•å</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>æ‹…å½“æ¡ˆä»¶æ•°</th><th>æ“ä½œ</th></tr></thead><tbody>' +
    sortedDesigners.map(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      const categoryLabel = designer.category === 'è¨­è¨ˆ' ? 'è¨­è¨ˆæ‹…å½“' : 'ICæ‹…å½“';
      return `
        <tr>
          <td><strong>${designer.name}</strong></td>
          <td><span class="badge ${designer.category === 'è¨­è¨ˆ' ? 'badge-primary' : 'badge-success'}">${categoryLabel}</span></td>
          <td>${count}ä»¶</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteDesigner('${designer.id}')">å‰Šé™¤</button></td>
        </tr>
      `;
    }).join('') +
    '</tbody></table></div>';
}

async function addDesigner() {
  const name = document.getElementById('newDesignerName').value.trim();
  const category = document.getElementById('newDesignerCategory').value;

  if (!name) {
    showToast('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚¹ã‚¿ãƒƒãƒ•åã§ã™', 'error');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªã®æœ€å¤§display_orderã‚’å–å¾—ã—ã¦+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerName').value = '';
  renderDesignerList();
  renderDesignerTabs();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteDesigner(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯æ¡ˆä»¶ã«å‰²å½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚æ¡ˆä»¶ã®æ‹…å½“ã‚’å¤‰æ›´ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  if (!confirm(`${designer.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerList();
  renderDesignerListInline();
  renderSidebar();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†é–¢æ•°
function renderDesignerListInline() {
  const container = document.getElementById('designerListInline');
  if (!container) return;

  const sekkeiDesigners = [...designers].filter(d => d.category === 'è¨­è¨ˆ').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = [...designers].filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));

  let html = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆ' + designers.length + 'åï¼‰</h3>';
  html += '<p style="color: var(--text-secondary); margin-bottom: 16px;">ğŸ’¡ è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¡¨ç¤ºé †åºã‚’å¤‰æ›´ã§ãã¾ã™</p>';

  // è¨­è¨ˆæ‹…å½“
  if (sekkeiDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--primary-color);">ğŸ“ è¨­è¨ˆæ‹…å½“</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>ã‚¹ã‚¿ãƒƒãƒ•å</th><th>æ‹…å½“æ¡ˆä»¶æ•°</th><th>æ“ä½œ</th></tr></thead><tbody id="sekkeiTbody">';
    sekkeiDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      html += `
        <tr class="draggable-row" draggable="true" data-designer-id="${designer.id}" data-category="è¨­è¨ˆ">
          <td><span class="drag-handle">â‰¡</span></td>
          <td><strong>${designer.name}</strong></td>
          <td>${count}ä»¶</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteDesignerInline('${designer.id}')">å‰Šé™¤</button></td>
        </tr>
      `;
    });
    html += '</tbody></table></div>';
  }

  // ICæ‹…å½“
  if (icDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--success-color);">ğŸ¨ ICæ‹…å½“</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>ã‚¹ã‚¿ãƒƒãƒ•å</th><th>æ‹…å½“æ¡ˆä»¶æ•°</th><th>æ“ä½œ</th></tr></thead><tbody id="icTbody">';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      html += `
        <tr class="draggable-row" draggable="true" data-designer-id="${designer.id}" data-category="IC">
          <td><span class="drag-handle">â‰¡</span></td>
          <td><strong>${designer.name}</strong></td>
          <td>${count}ä»¶</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteDesignerInline('${designer.id}')">å‰Šé™¤</button></td>
        </tr>
      `;
    });
    html += '</tbody></table></div>';
  }

  container.innerHTML = html;

  // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  setupDragAndDrop();
}

async function addDesignerInline() {
  const name = document.getElementById('newDesignerNameInline').value.trim();
  const category = document.getElementById('newDesignerCategoryInline').value;

  if (!name) {
    showToast('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚¹ã‚¿ãƒƒãƒ•åã§ã™', 'error');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªã®æœ€å¤§display_orderã‚’å–å¾—ã—ã¦+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerNameInline').value = '';
  renderDesignerListInline();
  renderSidebar();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteDesignerInline(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯æ¡ˆä»¶ã«å‰²å½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚æ¡ˆä»¶ã®æ‹…å½“ã‚’å¤‰æ›´ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  if (!confirm(`${designer.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerListInline();
  renderSidebar();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
let draggedElement = null;

function setupDragAndDrop() {
  const draggableRows = document.querySelectorAll('.draggable-row');

  draggableRows.forEach(row => {
    row.addEventListener('dragstart', handleDragStart);
    row.addEventListener('dragover', handleDragOver);
    row.addEventListener('drop', handleDrop);
    row.addEventListener('dragend', handleDragEnd);
    row.addEventListener('dragleave', handleDragLeave);
  });
}

function handleDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªå†…ã§ã®ã¿ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½
  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  if (draggedCategory === targetCategory && this !== draggedElement) {
    this.classList.add('drag-over');
  }

  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªå†…ã§ã®ã¿ãƒ‰ãƒ­ãƒƒãƒ—å®Ÿè¡Œ
  if (draggedCategory === targetCategory && draggedElement !== this) {
    const draggedId = draggedElement.dataset.designerId;
    const targetId = this.dataset.designerId;

    // é †åºã‚’å…¥ã‚Œæ›¿ãˆ
    updateDesignerOrder(draggedId, targetId, draggedCategory);
  }

  this.classList.remove('drag-over');
  return false;
}

function handleDragEnd(e) {
  this.classList.remove('dragging');

  const allRows = document.querySelectorAll('.draggable-row');
  allRows.forEach(row => {
    row.classList.remove('drag-over');
  });
}

function handleDragLeave(e) {
  this.classList.remove('drag-over');
}

async function updateDesignerOrder(draggedId, targetId, category) {
  showStatus('ä¸¦ã³æ›¿ãˆä¸­...', 'saving');

  // è©²å½“ã‚«ãƒ†ã‚´ãƒªã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å–å¾—
  const categoryDesigners = designers.filter(d => d.category === category);

  // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ã‚¿ãƒƒãƒ•ã‚’è¦‹ã¤ã‘ã‚‹
  const draggedIndex = categoryDesigners.findIndex(d => d.id === draggedId);
  const targetIndex = categoryDesigners.findIndex(d => d.id === targetId);

  // é…åˆ—ã‚’ä¸¦ã³æ›¿ãˆ
  const [draggedDesigner] = categoryDesigners.splice(draggedIndex, 1);
  categoryDesigners.splice(targetIndex, 0, draggedDesigner);

  // display_orderã‚’å†è¨ˆç®—
  const updates = [];
  for (let i = 0; i < categoryDesigners.length; i++) {
    const designer = categoryDesigners[i];
    const newOrder = i + 1;

    if (designer.display_order !== newOrder) {
      updates.push({
        id: designer.id,
        display_order: newOrder
      });

      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
      const localDesigner = designers.find(d => d.id === designer.id);
      if (localDesigner) {
        localDesigner.display_order = newOrder;
      }
    }
  }

  // Supabaseã«ä¸€æ‹¬æ›´æ–°
  for (const update of updates) {
    const { error } = await supabase
      .from('designers')
      .update({ display_order: update.display_order })
      .eq('id', update.id);

    if (error) {
      console.error('ä¸¦ã³æ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }
  }

  // UIæ›´æ–°
  renderDesignerListInline();
  renderSidebar();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ä¸¦ã³æ›¿ãˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

// ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆã‚«ãƒ†ã‚´ãƒªè¿½åŠ 
async function addCategoryInline() {
  const name = document.getElementById('newCategoryNameInline').value.trim();

  if (!name) {
    showToast('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (vendorCategories.find(c => c.name === name)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªåã§ã™', 'error');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');
  const { data, error } = await supabase
    .from('vendor_categories')
    .insert([{ name, display_order: vendorCategories.length + 1 }])
    .select();

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  vendorCategories.push(data[0]);
  document.getElementById('newCategoryNameInline').value = '';
  renderCategoriesList();
  renderCategoryFilters();
  populateVendorCategoryDropdown();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
// ============================================
function renderTemplates() {
  const container = document.getElementById('templatesTable');
  if (!container) return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

  const categoryFilterEl = document.getElementById('categoryFilter');
  const categoryFilter = categoryFilterEl ? categoryFilterEl.value : null;

  let filtered = emailTemplates;

  // currentUserCategoryã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆç®¡ç†è€…ä»¥å¤–ï¼‰
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  // ã•ã‚‰ã«ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
  if (categoryFilter) {
    filtered = filtered.filter(t => t.category === categoryFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“§</div><div class="empty-title">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-description">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¦ã€æ¡ˆä»¶ã‹ã‚‰ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã§ãã¾ã™</div><button class="btn btn-primary" onclick="openTemplateModal()">+ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>è¡¨ç¤ºå</th>
          <th>ã‚«ãƒ†ã‚´ãƒª</th>
          <th>ä¼šç¤¾å</th>
          <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(template => `
          <tr>
            <td><strong>${template.display_name}</strong></td>
            <td><span class="badge ${template.category === 'IC' ? 'badge-success' : 'badge-primary'}">${template.category}</span></td>
            <td>${template.company}</td>
            <td>${template.email || 'â€”'}</td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost btn-small" onclick="editTemplate('${template.id}')">ç·¨é›†</button>
                <button class="btn btn-danger btn-small" onclick="deleteTemplate('${template.id}')">å‰Šé™¤</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function openTemplateModal(templateId = null) {
  editingTemplateId = templateId;
  const modal = document.getElementById('templateModal');
  const title = document.getElementById('templateModalTitle');

  if (templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    title.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†';
    document.getElementById('templateId').value = template.template_id;
    document.getElementById('templateId').disabled = true;
    document.getElementById('templateDisplayName').value = template.display_name;
    document.getElementById('templateCategory').value = template.category;
    document.getElementById('templateCompany').value = template.company;
    document.getElementById('templateContact').value = template.contact || '';
    document.getElementById('templateEmail').value = template.email || '';
    document.getElementById('templateSubjectFormat').value = template.subject_format || '';
    document.getElementById('templateText').value = template.template_text || '';
  } else {
    title.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ ';
    document.getElementById('templateId').value = '';
    document.getElementById('templateId').disabled = false;
    document.getElementById('templateDisplayName').value = '';
    document.getElementById('templateCategory').value = 'è¨­è¨ˆ';
    document.getElementById('templateCompany').value = '';
    document.getElementById('templateContact').value = '';
    document.getElementById('templateEmail').value = '';
    document.getElementById('templateSubjectFormat').value = '';
    document.getElementById('templateText').value = '';
  }

  modal.classList.add('show');
}

function closeTemplateModal() {
  document.getElementById('templateModal').classList.remove('show');
  editingTemplateId = null;
}

async function saveTemplate() {
  const templateId = document.getElementById('templateId').value.trim();
  const displayName = document.getElementById('templateDisplayName').value.trim();
  const category = document.getElementById('templateCategory').value;
  const company = document.getElementById('templateCompany').value.trim();
  const contact = document.getElementById('templateContact').value.trim();
  const email = document.getElementById('templateEmail').value.trim();
  const subjectFormat = document.getElementById('templateSubjectFormat').value.trim();
  const templateText = document.getElementById('templateText').value.trim();

  if (!templateId || !displayName || !company || !subjectFormat || !templateText) {
    showToast('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const templateData = {
    template_id: templateId,
    display_name: displayName,
    category,
    company,
    contact,
    email,
    subject_format: subjectFormat,
    template_text: templateText,
    has_special_content: false,
    has_sub_options: false,
    created_by: currentUser.id
  };

  if (editingTemplateId) {
    const { error } = await supabase
      .from('email_templates')
      .update(templateData)
      .eq('id', editingTemplateId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    const template = emailTemplates.find(t => t.id === editingTemplateId);
    Object.assign(template, templateData);
  } else {
    const { data, error } = await supabase
      .from('email_templates')
      .insert([templateData])
      .select();

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    emailTemplates.push(data[0]);
  }

  closeTemplateModal();
  renderTemplates();
  renderMappings();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

function editTemplate(templateId) {
  openTemplateModal(templateId);
}

async function deleteTemplate(templateId) {
  if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('email_templates')
    .delete()
    .eq('id', templateId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  emailTemplates = emailTemplates.filter(t => t.id !== templateId);
  renderTemplates();
  renderMappings();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// æ¥­è€…ç®¡ç†
// ============================================
function renderVendors() {
  const container = document.getElementById('vendorsTable');
  if (!container) return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

  const filterSelect = document.getElementById('vendorTemplateFilter');
  if (!filterSelect) return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

  const templateFilter = filterSelect.value;

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¡¨ç¤ºï¼‰
  filterSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</option>' +
    emailTemplates.map(t =>
      `<option value="${t.template_id}">${t.display_name}</option>`
    ).join('');
  if (templateFilter) filterSelect.value = templateFilter;

  let filtered = vendors;
  if (templateFilter) {
    filtered = vendors.filter(v => v.template_id === templateFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-title">æ¥­è€…æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-description">æ¥­è€…æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ä½¿ç”¨ã§ãã¾ã™</div><button class="btn btn-primary" onclick="openVendorModal()">+ æ¥­è€…è¿½åŠ </button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>ä¼šç¤¾å</th>
          <th>æ‹…å½“è€…</th>
          <th>é›»è©±ç•ªå·</th>
          <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
          <th>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(vendor => {
          const template = emailTemplates.find(t => t.template_id === vendor.template_id);
          return `
            <tr>
              <td><strong>${vendor.company}</strong></td>
              <td>${vendor.contact}</td>
              <td>${vendor.tel || 'â€”'}</td>
              <td>${vendor.email}</td>
              <td>${template ? template.display_name : 'â€”'}</td>
              <td>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-ghost btn-small" onclick="editVendor('${vendor.id}')">ç·¨é›†</button>
                  <button class="btn btn-danger btn-small" onclick="deleteVendor('${vendor.id}')">å‰Šé™¤</button>
                </div>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

function openVendorModal(vendorId = null) {
  editingVendorId = vendorId;
  const modal = document.getElementById('vendorModal');
  const title = document.getElementById('vendorModalTitle');

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°
  const templateSelect = document.getElementById('vendorTemplateId');
  templateSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
    emailTemplates.map(t => `<option value="${t.template_id}">${t.display_name}</option>`).join('');

  if (vendorId) {
    const vendor = vendors.find(v => v.id === vendorId);
    title.textContent = 'æ¥­è€…ç·¨é›†';
    document.getElementById('vendorTemplateId').value = vendor.template_id;
    document.getElementById('vendorId').value = vendor.vendor_id;
    document.getElementById('vendorId').disabled = true;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact;
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email;
  } else {
    title.textContent = 'æ¥­è€…è¿½åŠ ';
    document.getElementById('vendorTemplateId').value = '';
    document.getElementById('vendorId').value = '';
    document.getElementById('vendorId').disabled = false;
    document.getElementById('vendorCompany').value = '';
    document.getElementById('vendorContact').value = '';
    document.getElementById('vendorTel').value = '';
    document.getElementById('vendorEmail').value = '';
  }

  modal.classList.add('show');
}

function closeVendorModal() {
  document.getElementById('vendorModal').classList.remove('show');
  editingVendorId = null;
}

async function saveVendor() {
  const templateId = document.getElementById('vendorTemplateId').value;
  const vendorId = document.getElementById('vendorId').value.trim();
  const company = document.getElementById('vendorCompany').value.trim();
  const contact = document.getElementById('vendorContact').value.trim();
  const tel = document.getElementById('vendorTel').value.trim();
  const email = document.getElementById('vendorEmail').value.trim();

  if (!templateId || !vendorId || !company || !contact || !email) {
    showToast('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const vendorData = {
    template_id: templateId,
    vendor_id: vendorId,
    company,
    contact,
    tel,
    email,
    created_by: currentUser.id
  };

  if (editingVendorId) {
    const { error } = await supabase
      .from('template_vendors')
      .update(vendorData)
      .eq('id', editingVendorId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    const vendor = vendors.find(v => v.id === editingVendorId);
    Object.assign(vendor, vendorData);
  } else {
    const { data, error } = await supabase
      .from('template_vendors')
      .insert([vendorData])
      .select();

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    vendors.push(data[0]);
  }

  closeVendorModal();
  renderVendors();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('æ¥­è€…æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

function editVendor(vendorId) {
  openVendorModal(vendorId);
}

async function deleteVendor(vendorId) {
  if (!confirm('ã“ã®æ¥­è€…æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('template_vendors')
    .delete()
    .eq('id', vendorId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  vendors = vendors.filter(v => v.id !== vendorId);
  renderVendors();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('æ¥­è€…æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ã‚¿ã‚¹ã‚¯-ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç´ã¥ã‘
// ============================================
function renderMappings() {
  const container = document.getElementById('mappingsGrid');
  if (!container) return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

  // æ—§ã‚·ã‚¹ãƒ†ãƒ ã¯ä½¿ç”¨ã—ãªã„ãŸã‚ã€ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  container.innerHTML = '<div class="empty-state"><div class="empty-icon">âš™ï¸</div><div class="empty-title">ã‚¿ã‚¹ã‚¯-ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç´ã¥ã‘ã¯æ—§ã‚·ã‚¹ãƒ†ãƒ ã§ã™</div><div class="empty-description">æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€Œâœ… ã‚¿ã‚¹ã‚¯ç®¡ç†ã€ã‹ã‚‰æ¥­è€…ã‚’ç´ã¥ã‘ã¦ãã ã•ã„</div></div>';
  return;

  container.innerHTML = Object.keys({}).map(taskKey => {
    const templateOptions = emailTemplates.map(t =>
      `<option value="${t.template_id}" ${taskMappings[taskKey] === t.template_id ? 'selected' : ''}>
        ${t.display_name} (${t.category})
      </option>`
    ).join('');

    return `
      <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
        <label style="flex: 0 0 200px; font-weight: 600;">${TASK_NAMES[taskKey]}</label>
        <select class="form-select" id="mapping_${taskKey}" style="flex: 1;">
          <option value="">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—</option>
          ${templateOptions}
        </select>
      </div>
    `;
  }).join('');
}

async function saveMappings() {
  showStatus('ä¿å­˜ä¸­...', 'saving');

  const newMappings = {};
  Object.keys(TASK_NAMES).forEach(taskKey => {
    const select = document.getElementById('mapping_' + taskKey);
    if (select && select.value) {
      newMappings[taskKey] = select.value;
    }
  });

  // æ—¢å­˜ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‰Šé™¤
  const { error: deleteError } = await supabase
    .from('task_template_mappings')
    .delete()
    .neq('id', '00000000-0000-0000-0000-000000000000');

  if (deleteError) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + deleteError.message, 'error');
    return;
  }

  // æ–°ã—ã„ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æŒ¿å…¥
  const mappingsToInsert = Object.keys(newMappings).map(taskKey => ({
    task_key: taskKey,
    template_id: newMappings[taskKey]
  }));

  if (mappingsToInsert.length > 0) {
    const { error: insertError } = await supabase
      .from('task_template_mappings')
      .insert(mappingsToInsert);

    if (insertError) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + insertError.message, 'error');
      return;
    }
  }

  taskMappings = newMappings;
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¿ã‚¹ã‚¯è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

// ============================================
function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const templateId = taskMappings[taskKey];
  if (!templateId) {
    showToast('ã“ã®ã‚¿ã‚¹ã‚¯ã«ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã€Œã‚¿ã‚¹ã‚¯è¨­å®šã€ã‚¿ãƒ–ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) {
    showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  const taskDate = project.progress?.[taskKey]?.date;
  const dueDate = taskDate || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ¥­è€…ãƒªã‚¹ãƒˆã‚’å–å¾—
  const templateVendors = vendors.filter(v => v.template_id === templateId);
  const hasVendorOptions = template.has_sub_options && templateVendors.length > 0;

  // æ¥­è€…é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
  let vendorSelectHtml = '';
  if (hasVendorOptions) {
    vendorSelectHtml = `
      <div class="form-group">
        <label class="form-label">æ¥­è€…é¸æŠ</label>
        <select class="form-select" id="emailVendorSelect" onchange="updateVendorInfo('${templateId}')">
          <option value="">æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          ${templateVendors.map(v => `<option value="${v.id}">${v.company} - ${v.contact}</option>`).join('')}
        </select>
      </div>
    `;
  }

  content.innerHTML = `
    <div class="form-group">
      <label class="form-label">æ‹…å½“è€…åï¼ˆç½²åç”¨ï¼‰</label>
      <input type="text" class="form-input" id="emailStaffName" value="${project.assigned_to}">
    </div>
    <div class="form-group">
      <label class="form-label">æœŸæ—¥</label>
      <input type="date" class="form-input" id="emailDueDate" value="${dueDate}">
    </div>
    ${vendorSelectHtml}
    <div class="form-group">
      <label class="form-label">å†…å®¹è©³ç´°ï¼ˆä»»æ„ï¼‰</label>
      <textarea class="form-textarea" id="emailSpecialContent" placeholder="å¿…è¦ã«å¿œã˜ã¦è©³ç´°ã‚’å…¥åŠ›"></textarea>
    </div>
    <button class="btn btn-primary" onclick="generateEmail('${project.id}', '${taskKey}')">ãƒ¡ãƒ¼ãƒ«ã‚’ç”Ÿæˆ</button>
    <div id="generatedEmailSection" style="display: none; margin-top: 32px;">
      <h3 style="margin-bottom: 12px; font-size: 18px; font-weight: 600;">ğŸ“§ ä»¶å</h3>
      <div id="emailSubject" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailSubject')">ä»¶åã‚’ã‚³ãƒ”ãƒ¼</button>

      <h3 style="margin: 24px 0 12px; font-size: 18px; font-weight: 600;">ğŸ“® å®›å…ˆ</h3>
      <div id="emailAddress" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailAddress')">å®›å…ˆã‚’ã‚³ãƒ”ãƒ¼</button>

      <h3 style="margin: 24px 0 12px; font-size: 18px; font-weight: 600;">ğŸ“¨ æœ¬æ–‡</h3>
      <div id="emailBody" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailBody')">æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
  `;

  modal.classList.add('show');
}

// æ¥­è€…é¸æŠæ™‚ã«æƒ…å ±ã‚’æ›´æ–°
function updateVendorInfo(templateId) {
  const select = document.getElementById('emailVendorSelect');
  if (!select) return;

  // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
  if (!select.value) return;

  // é¸æŠã•ã‚ŒãŸæ¥­è€…ã‚’å–å¾—
  const selectedVendor = vendors.find(v => v.id === select.value);
  if (selectedVendor) {
    // ç‰¹åˆ¥ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ä¸è¦ï¼ˆgenerateEmailæ™‚ã«ä½¿ç”¨ï¼‰
    console.log('æ¥­è€…é¸æŠ:', selectedVendor.company);
  }
}

function generateEmail(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const templateId = taskMappings[taskKey];
  const template = emailTemplates.find(t => t.template_id === templateId);

  const staffName = document.getElementById('emailStaffName').value.trim();
  const dueDate = document.getElementById('emailDueDate').value;
  const specialContent = document.getElementById('emailSpecialContent').value.trim();

  // æ¥­è€…é¸æŠãŒã‚ã‚‹å ´åˆã¯æ¥­è€…æƒ…å ±ã‚’ä½¿ç”¨
  let company = template.company;
  let contact = template.contact || 'ã”æ‹…å½“è€…æ§˜';
  let email = template.email;

  const vendorSelect = document.getElementById('emailVendorSelect');
  if (vendorSelect && vendorSelect.value) {
    const selectedVendor = vendors.find(v => v.id === vendorSelect.value);
    if (selectedVendor) {
      company = selectedVendor.company;
      contact = selectedVendor.contact;
      email = selectedVendor.email;
    }
  }

  const replacements = {
    '{customerName}': project.customer,
    '{dueDate}': dueDate,
    '{staffName}': staffName,
    '{company}': company,
    '{contact}': contact,
    '{specialContent}': specialContent || template.default_special_content || ''
  };

  let subject = template.subject_format;
  let body = template.template_text;

  Object.keys(replacements).forEach(key => {
    const regex = new RegExp(key.replace(/[{}]/g, '\\$&'), 'g');
    subject = subject.replace(regex, replacements[key]);
    body = body.replace(regex, replacements[key]);
  });

  document.getElementById('emailSubject').textContent = subject;
  document.getElementById('emailAddress').textContent = email || 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
  document.getElementById('emailBody').textContent = body;
  document.getElementById('generatedEmailSection').style.display = 'block';
}

function copyText(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent;

  navigator.clipboard.writeText(text).then(() => {
    showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
  }).catch(err => {
    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
    showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  });
}

// ============================================
// ã‚¿ã‚¹ã‚¯ã‹ã‚‰ã®ãƒ¡ãƒ¼ãƒ«ä½œæˆæ©Ÿèƒ½
// ============================================
async function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  // ã‚¿ã‚¹ã‚¯ã«é–¢é€£ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
  const mapping = taskMappings[taskKey];

  // ãƒãƒƒãƒ”ãƒ³ã‚°ãŒãªã„å ´åˆã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
  if (!mapping) {
    showTemplateSelector(projectId, taskKey);
    return;
  }

  const template = emailTemplates.find(t => t.template_id === mapping);
  if (!template) {
    showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  // æ‹…å½“è€…æƒ…å ±ã‚’å–å¾—
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆ
  const composerHTML = createEmailComposer(project, template, staffName, taskKey);
  document.getElementById('emailComposerContent').innerHTML = composerHTML;

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  document.getElementById('emailModal').classList.add('show');
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
function showTemplateSelector(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const currentTaskNames = getTaskNames();
  const taskName = currentTaskNames[taskKey];

  // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿
  const availableTemplates = emailTemplates.filter(t => t.category === currentUserCategory);

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 8px; color: var(--text-primary);">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h3>
      <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 14px;">
        æ¡ˆä»¶ï¼š${project.customer} ï¼ ã‚¿ã‚¹ã‚¯ï¼š${taskName}
      </p>

      <div style="display: grid; gap: 12px;">
        ${availableTemplates.map(template => `
          <button class="template-select-btn" onclick="selectTemplateForTask('${projectId}', '${taskKey}', '${template.template_id}')">
            <div style="font-weight: 600; margin-bottom: 4px;">${template.display_name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${template.company}</div>
          </button>
        `).join('')}
      </div>

      ${availableTemplates.length === 0 ? '<p style="text-align: center; padding: 32px; color: var(--text-muted);">åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>' : ''}
    </div>
  `;

  document.getElementById('emailComposerContent').innerHTML = html;
  document.getElementById('emailModal').classList.add('show');
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠå¾Œã«ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’è¡¨ç¤º
function selectTemplateForTask(projectId, taskKey, templateId) {
  const project = projects.find(p => p.id === projectId);
  const template = emailTemplates.find(t => t.template_id === templateId);
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  const composerHTML = createEmailComposer(project, template, staffName, taskKey);
  document.getElementById('emailComposerContent').innerHTML = composerHTML;
}

function createEmailComposer(project, template, staffName, taskKey) {
  const hasSubOptions = template.has_sub_options;
  const hasSpecialContent = template.has_special_content;

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 16px; color: var(--text-primary);">${template.display_name}</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div class="form-group">
          <label class="form-label">ãŠå®¢æ§˜å:</label>
          <input type="text" class="form-input" id="modalCustomerName" value="${project.customer}" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label class="form-label">æ‹…å½“è€…å:</label>
          <input type="text" class="form-input" id="modalStaffName" value="${staffName}" oninput="updateModalEmail()">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">æœŸæ—¥:</label>
        <input type="date" class="form-input" id="modalDueDate" oninput="updateModalEmail()">
      </div>
  `;

  if (hasSpecialContent) {
    const defaultContent = template.default_special_content || '';
    html += `
      <div class="form-group">
        <label class="form-label">ç‰¹è¨˜äº‹é …:</label>
        <textarea class="form-textarea" id="modalSpecialContent" rows="4" oninput="updateModalEmail()">${defaultContent}</textarea>
      </div>
    `;
  }

  if (hasSubOptions) {
    const templateVendors = vendors.filter(v => v.template_id === template.template_id);
    html += `
      <div class="form-group">
        <label class="form-label">æ¥­è€…é¸æŠ:</label>
        <select class="form-select" id="modalVendorSelect" onchange="updateModalEmail()">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          ${templateVendors.map(v => `<option value="${v.vendor_id}">${v.company}</option>`).join('')}
        </select>
      </div>
    `;
  }

  html += `
    </div>

    <div style="margin-top: 24px;">
      <h3 style="margin-bottom: 12px; color: var(--text-primary);">ğŸ“¬ ç”Ÿæˆã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«</h3>

      <div class="form-group">
        <label class="form-label">ä»¶å:</label>
        <div id="modalEmailSubject" style="padding: 12px; background: #f8f9fa; border-radius: 8px; font-weight: 500;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailSubject')" style="margin-top: 8px;">ğŸ“‹ ä»¶åã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>

      <div class="form-group">
        <label class="form-label">é€ä¿¡å…ˆ:</label>
        <div id="modalEmailAddress" style="padding: 12px; background: #f8f9fa; border-radius: 8px; color: var(--primary-color);"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailAddress')" style="margin-top: 8px;">ğŸ“‹ ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>

      <div class="form-group">
        <label class="form-label">æœ¬æ–‡:</label>
        <div id="modalEmailBody" style="padding: 16px; background: #f8f9fa; border-radius: 8px; white-space: pre-wrap; line-height: 1.8; min-height: 200px;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailBody')" style="margin-top: 8px;">ğŸ“‹ æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeEmailModal()">é–‰ã˜ã‚‹</button>
      <button class="btn btn-primary" onclick="markTaskAsRequested('${project.id}', '${taskKey}')">ä¾é ¼æ¸ˆã¿ã«ã™ã‚‹</button>
    </div>
  `;

  // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆupdateModalEmailã§ä½¿ç”¨ï¼‰
  window.__currentEmailData = {
    project,
    template,
    staffName,
    taskKey
  };

  // åˆå›ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
  setTimeout(() => updateModalEmail(), 100);

  return html;
}

function updateModalEmail() {
  if (!window.__currentEmailData) return;

  const { project, template } = window.__currentEmailData;

  const customerName = document.getElementById('modalCustomerName')?.value || project.customer;
  const staffName = document.getElementById('modalStaffName')?.value || '';
  const dueDate = document.getElementById('modalDueDate')?.value || '';
  const specialContent = document.getElementById('modalSpecialContent')?.value || template.default_special_content || '';
  const vendorSelect = document.getElementById('modalVendorSelect');
  const selectedVendorId = vendorSelect?.value || '';

  let subject = template.subject_format || '';
  let body = template.template_text || '';
  let email = template.email || '';
  let company = template.company || '';
  let contact = template.contact || '';

  // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯æ¥­è€…æƒ…å ±ã‚’ä½¿ç”¨
  if (template.has_sub_options && selectedVendorId) {
    const vendor = vendors.find(v => v.template_id === template.template_id && v.vendor_id === selectedVendorId);
    if (vendor) {
      company = vendor.company;
      contact = vendor.contact || 'ã”æ‹…å½“è€…æ§˜';
      email = vendor.email || '';
    }
  }

  // å¤‰æ•°ã‚’ç½®æ›
  subject = subject
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{dueDate\}/g, dueDate);

  body = body
    .replace(/\{company\}/g, company)
    .replace(/\{contact\}/g, contact)
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{staffName\}/g, staffName)
    .replace(/\{dueDate\}/g, dueDate)
    .replace(/\{specialContent\}/g, specialContent);

  // è¡¨ç¤ºã‚’æ›´æ–°
  const subjectEl = document.getElementById('modalEmailSubject');
  const addressEl = document.getElementById('modalEmailAddress');
  const bodyEl = document.getElementById('modalEmailBody');

  if (subjectEl) subjectEl.textContent = subject;
  if (addressEl) addressEl.textContent = email;
  if (bodyEl) bodyEl.textContent = body;
}

function copyModalText(elementId) {
  const text = document.getElementById(elementId)?.textContent;
  if (!text || text.includes('{') || text.includes('é¸æŠã—ã¦ãã ã•ã„')) {
    showToast('ã‚³ãƒ”ãƒ¼ã§ãã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
  }).catch(err => {
    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
    showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  });
}

async function markTaskAsRequested(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = 'ä¾é ¼æ¸ˆ';

  showStatus('ä¿å­˜ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    return;
  }

  project.progress = progressData;
  renderProjects();
  closeEmailModal();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ä¾é ¼æ¸ˆã¿ã«æ›´æ–°ã—ã¾ã—ãŸ', 'success');
}

function closeEmailModal() {
  document.getElementById('emailModal').classList.remove('show');
  window.__currentEmailData = null;
}

// ============================================
// ç‹¬ç«‹ã—ãŸãƒ¡ãƒ¼ãƒ«ä½œæˆæ©Ÿèƒ½ï¼ˆå‰Šé™¤äºˆå®šï¼‰
// ============================================
function updateStandaloneEmail() {
  const templateSelect = document.getElementById('standaloneTemplateSelect');
  const templateId = templateSelect.value;

  if (!templateId) {
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæœªé¸æŠæ™‚ã¯ã‚¯ãƒªã‚¢
    document.getElementById('standaloneEmailSubject').textContent = '';
    document.getElementById('standaloneEmailAddress').textContent = '';
    document.getElementById('standaloneEmailBody').textContent = '';
    document.getElementById('standaloneVendorGroup').style.display = 'none';
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) return;

  // ç‰¹è¨˜äº‹é …ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
  if (template.has_special_content) {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'block';
  } else {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
  }

  // å…¥åŠ›å€¤ã‚’å–å¾—
  const customerName = document.getElementById('standaloneCustomerName').value.trim();
  const staffName = document.getElementById('standaloneStaffName').value.trim();
  const dueDate = document.getElementById('standaloneDueDate').value;
  const specialContent = document.getElementById('standaloneSpecialContent').value.trim();

  // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ¥­è€…é¸æŠï¼‰ãŒã‚ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å ´åˆ
  if (template.has_sub_options) {
    document.getElementById('standaloneVendorGroup').style.display = 'block';
    const vendorSelect = document.getElementById('standaloneVendorSelect');
    const selectedVendorId = vendorSelect.value;

    // æ¥­è€…é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
    if (vendorSelect.options.length === 0) {
      const templateVendors = vendors.filter(v => v.template_id === templateId);
      vendorSelect.innerHTML = '<option value="">æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
        templateVendors.map(v =>
          `<option value="${v.vendor_id}">${v.company}</option>`
        ).join('');
    }

    if (!selectedVendorId) {
      // æ¥­è€…æœªé¸æŠæ™‚ã¯ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆã—ãªã„
      document.getElementById('standaloneEmailSubject').textContent = 'æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„';
      document.getElementById('standaloneEmailAddress').textContent = '';
      document.getElementById('standaloneEmailBody').textContent = '';
      return;
    }

    const vendor = vendors.find(v => v.template_id === templateId && v.vendor_id === selectedVendorId);
    if (!vendor) return;

    // æ¥­è€…æƒ…å ±ã§å¤‰æ•°ã‚’ç½®æ›
    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{ãŠå®¢æ§˜å}')
      .replace(/\{dueDate\}/g, dueDate || '{æœŸæ—¥}');

    body = body
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || 'ã”æ‹…å½“è€…æ§˜')
      .replace(/\{customerName\}/g, customerName || '{ãŠå®¢æ§˜å}')
      .replace(/\{staffName\}/g, staffName || '{æ‹…å½“è€…å}')
      .replace(/\{dueDate\}/g, dueDate || '{æœŸæ—¥}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = vendor.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  } else {
    // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãªã—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    document.getElementById('standaloneVendorGroup').style.display = 'none';

    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{ãŠå®¢æ§˜å}')
      .replace(/\{dueDate\}/g, dueDate || '{æœŸæ—¥}');

    body = body
      .replace(/\{company\}/g, template.company)
      .replace(/\{contact\}/g, template.contact || 'ã”æ‹…å½“è€…æ§˜')
      .replace(/\{customerName\}/g, customerName || '{ãŠå®¢æ§˜å}')
      .replace(/\{staffName\}/g, staffName || '{æ‹…å½“è€…å}')
      .replace(/\{dueDate\}/g, dueDate || '{æœŸæ—¥}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = template.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  }
}

function copyStandaloneText(elementId) {
  const text = document.getElementById(elementId).textContent;
  if (!text || text.includes('{') || text.includes('é¸æŠã—ã¦ãã ã•ã„')) {
    showToast('ã‚³ãƒ”ãƒ¼ã§ãã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
  }).catch(err => {
    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
    showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  });
}

function populateStandaloneTemplateSelect() {
  const select = document.getElementById('standaloneTemplateSelect');
  if (!select) return;

  // currentUserCategoryã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  let filtered = emailTemplates;
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  select.innerHTML = '<option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
    filtered.map(t =>
      `<option value="${t.template_id}">${t.display_name}</option>`
    ).join('');
}

// ============================================
// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
// ============================================
function exportJSON() {
  if (projects.length === 0) {
    showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  const dataStr = JSON.stringify(projects, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `projects_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);

  showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
}

function exportCSV() {
  if (projects.length === 0) {
    showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  // CSVãƒ˜ãƒƒãƒ€ãƒ¼
  const headers = ['é¡§å®¢å', 'æ‹…å½“è€…', 'å•†å“', 'é€²æ—ç‡', 'ãƒ¡ãƒ¢', 'ä½œæˆæ—¥', 'æ›´æ–°æ—¥'];

  // CSVãƒœãƒ‡ã‚£
  const rows = projects.map(p => {
    const progress = calculateProgress(p);
    return [
      `"${(p.customer || '').replace(/"/g, '""')}"`,
      `"${(p.assigned_to || '').replace(/"/g, '""')}"`,
      `"${(p.specifications || 'LIFE').replace(/"/g, '""')}"`,
      `${progress}%`,
      `"${(p.memo || '').replace(/"/g, '""')}"`,
      `"${p.created_at || ''}"`,
      `"${p.updated_at || ''}"`
    ].join(',');
  });

  const csvContent = [headers.join(','), ...rows].join('\n');

  // BOMä»˜ãUTF-8ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆExcelå¯¾å¿œï¼‰
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const dataBlob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `projects_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url);

  showToast('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã³æ›¿ãˆ
// ============================================
let draggedProject = null;

function enableDragAndDrop() {
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰ã«ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½å±æ€§ã‚’è¿½åŠ 
  const updateDraggable = () => {
    const cards = document.querySelectorAll('.project-card');
    cards.forEach((card, index) => {
      card.setAttribute('draggable', 'true');
      card.dataset.projectIndex = index;

      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragover', handleDragOver);
      card.addEventListener('drop', handleDrop);
      card.addEventListener('dragend', handleDragEnd);
    });
  };

  // åˆå›ã¨renderProjectså¾Œã«å®Ÿè¡Œ
  updateDraggable();

  // MutationObserverã§DOMå¤‰æ›´ã‚’ç›£è¦–
  const observer = new MutationObserver(updateDraggable);
  const container = document.getElementById('projectsContainer');
  if (container) {
    observer.observe(container, { childList: true, subtree: true });
  }
}

function handleDragStart(e) {
  draggedProject = this;
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  if (draggedProject !== this) {
    const draggedIndex = parseInt(draggedProject.dataset.projectIndex);
    const targetIndex = parseInt(this.dataset.projectIndex);

    // é…åˆ—ã®é †åºã‚’å…¥ã‚Œæ›¿ãˆ
    const temp = projects[draggedIndex];
    projects.splice(draggedIndex, 1);
    projects.splice(targetIndex, 0, temp);

    // å†æç”»
    renderProjects();
  }

  return false;
}

function handleDragEnd(e) {
  this.style.opacity = '1';

  // ã™ã¹ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  const cards = document.querySelectorAll('.project-card');
  cards.forEach(card => {
    card.classList.remove('over');
  });
}

// ============================================
// URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹æ©Ÿèƒ½ï¼ˆãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰
// ============================================
function handleHashChange() {
  const hash = window.location.hash.substring(1); // #ã‚’é™¤å»
  if (!hash) return;

  const [mainTab, subTab] = hash.split('/');

  // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
  if (mainTab === 'projects') {
    const btn = document.querySelector('.tab-nav-btn');
    if (btn) switchMainTab('projects', btn);
  } else if (mainTab === 'settings') {
    const btn = document.querySelectorAll('.tab-nav-btn')[1];
    if (btn) switchMainTab('settings', btn);

    // ã‚µãƒ–ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
    if (subTab) {
      setTimeout(() => {
        const subTabMap = {
          'staff': 0,
          'vendors': 1,
          'categories': 2,
          'tasks': 3,
          'products': 4
        };
        const index = subTabMap[subTab];
        if (index !== undefined) {
          const subBtn = document.querySelectorAll('.sub-tab-btn')[index];
          if (subBtn) switchSubTab(subTab, subBtn);
        }
      }, 100);
    }
  }
}

// ãƒãƒƒã‚·ãƒ¥å¤‰æ›´æ™‚ã®ãƒªã‚¹ãƒŠãƒ¼
window.addEventListener('hashchange', handleHashChange);

// ============================================
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
// ============================================
window.addEventListener('DOMContentLoaded', () => {
  checkAuth();

  // URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã®å‡¦ç†
  setTimeout(() => {
    handleHashChange();
  }, 500);
});
</script>
</body>
</html>
