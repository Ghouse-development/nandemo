# システム診断レポート

**作成日時**: 2025-11-09 (最新版)
**デプロイURL**: https://nandemo-b9231a6nr-ghouse-developments-projects.vercel.app/sekkei/index_v2.html

---

## 📊 自己評価: 75/100点

### ✅ 実装完了項目

1. **無限ループ防止機構** (20点 / 20点)
   - `isHandlingHashChange`フラグで再帰防止
   - switchMainTab/switchSubTabでURL更新をスキップ
   - 詳細なタイムスタンプ付きログ

2. **IC担当者選択機能** (15点 / 15点)
   - 案件モーダルで設計・IC両方選択可能
   - IC未定の場合は後から追加可能
   - SQL実行済み (add_ic_assignee_column.sql)

3. **スタッフ認証設定** (15点 / 15点)
   - 画面上からログインID/パスワード設定可能
   - supabase.auth.signUp()で直接アカウント作成

4. **商品マスタ管理** (10点 / 10点)
   - 「仕様」→「商品」に全面変更
   - 商品CRUD完全実装

5. **データ読み込み** (10点 / 10点)
   - Promise.allSettled()で並列読み込み
   - エラーハンドリング実装

---

### ⚠️ 要確認項目 (減点理由: -25点)

1. **業者データ表示** (-10点)
   - ✅ データ読み込み: loadVendorsV2() 実装済み
   - ✅ 描画関数: renderVendorsV2() 実装済み
   - ✅ init()で呼び出し: 実装済み (line 2178)
   - ❓ **確認必要**: 実際にUIに表示されるか
   - **原因候補**:
     - vendorsV2配列が空の可能性
     - カテゴリフィルターで全て除外されている可能性
     - 無限ループでページがリロードされ続けている可能性

2. **メール作成ボタン** (-10点)
   - ✅ ロジック: taskVendorMappings.some()で判定 (line 3678)
   - ✅ SQL実行済み: insert_default_task_vendor_mappings.sql
   - ❓ **確認必要**: 📧ボタンが表示されるか
   - **原因候補**:
     - taskVendorMappings配列が空の可能性
     - task_idが一致していない可能性
     - 無限ループでrenderProjectCard()が正常に完了していない可能性

3. **無限ループ解消** (-5点)
   - ✅ 防止機構: 実装済み
   - ❓ **確認必要**: 実際に解消されているか
   - **原因候補**:
     - setTimeout のタイミングで次のイベントが発火している可能性
     - 別の箇所でhash更新が発生している可能性

---

## 🔍 デバッグ情報の確認方法

ユーザーは以下の手順でデバッグ情報を確認してください:

### ステップ1: ブラウザコンソールを開く
1. https://nandemo-nu.vercel.app/sekkei/index_v2.html にアクセス
2. F12キーを押してDevToolsを開く
3. Consoleタブを選択

### ステップ2: ログイン
1. admin@ghouse.jp でログイン
2. アカウント種別を選択 (管理者 or 設計担当 or IC担当)

### ステップ3: 初期化ログを確認
以下のログが表示されるはずです:

```
🚀 初期化開始...
📦 データ読み込み開始...
🔄 設計士データ読み込み開始...
🔄 業者データ読み込み開始... {timestamp: "..."}
🔄 タスク-業者紐づけデータ読み込み開始... {timestamp: "..."}
📡 loadVendorsV2 Supabaseレスポンス: {success: true, dataLength: 20+, ...}
✅ 業者読み込み完了: {count: 20+, vendors: [...]}
📡 loadTaskVendorMappings Supabaseレスポンス: {success: true, dataLength: 10+, ...}
✅ タスク-業者紐づけ読み込み完了: {count: 10+, mappings: [...]}
🔗 mergeVendorCategories() 開始: {vendorsV2Length: 20+, ...}
🎨 新システム描画開始: {vendorsV2Length: 20+, taskVendorMappingsLength: 10+, ...}
📞 renderVendorsV2() 呼び出し開始
📊 vendorsV2配列の状態: {length: 20+, data: [...], 全データ: [...]}
✅ 初期化完了
```

**重要確認ポイント:**
- `vendorsV2Length: 20+` → 業者データが読み込まれている
- `taskVendorMappingsLength: 10+` → タスク-業者紐づけが読み込まれている

### ステップ4: 設定タブに移動
1. 「⚙️ 設定」タブをクリック
2. 「🏢 業者・メール管理」サブタブをクリック
3. 以下のログを確認:

```
📑 switchMainTab 開始: {tabName: "settings", isHandlingHashChange: false, ...}
🔗 switchMainTab: URLを更新: settings
🔗 handleHashChange 開始: {hash: "settings", vendorsV2Length: 20+, taskVendorMappingsLength: 10+, ...}
📑 switchMainTab 開始: {tabName: "settings", isHandlingHashChange: true, ...}
⏸️ switchMainTab: URL更新をスキップ (isHandlingHashChange=true)
✅ handleHashChange完了
📑 switchSubTab 開始: {panelName: "vendors", ...}
📞 renderVendorsV2() 呼び出し開始
```

**重要確認ポイント:**
- `isHandlingHashChange: true` でURL更新がスキップされている → 無限ループ防止成功
- `renderVendorsV2() 呼び出し開始` が表示される → 描画関数が実行されている

### ステップ5: 案件カードでメールボタンを確認
1. 「📋 案件管理」タブに戻る
2. 案件カードのタスクリストを確認
3. 以下のログを確認:

```
📧 メールボタン判定: {
  taskKey: "ventilation",
  taskName: "換気図面",
  taskId: "...",
  hasVendor: true,
  taskVendorMappingsCount: 10+,
  matchingMappings: [{task_id: "...", vendor_id: "..."}]
}
```

**重要確認ポイント:**
- `hasVendor: true` → メールボタンが表示されるはず
- `matchingMappings: [...]` → 紐づけデータが存在する

### ステップ6: 無限ループの確認
コンソールを見て、同じログが連続して表示されていないか確認:

**正常な場合:**
```
🔗 handleHashChange 開始: {...}
✅ handleHashChange完了
(1回だけ)
```

**無限ループの場合:**
```
🔗 handleHashChange 開始: {...}
🔗 handleHashChange 開始: {...}
🔗 handleHashChange 開始: {...}
(連続して繰り返す)
```

---

## 🛠️ トラブルシューティング

### 問題1: 業者データが空
**症状**: renderVendorsV2()で `vendorsV2.length: 0`

**確認事項:**
1. Supabaseの`vendors_v2`テーブルにデータが存在するか
2. `loadVendorsV2()`でエラーが発生していないか
3. `mergeVendorCategories()`が正常に実行されているか

**対処法:**
- Supabaseダッシュボードで `SELECT * FROM vendors_v2;` を実行
- データが存在しない場合は業者データを再登録

### 問題2: メールボタンが表示されない
**症状**: `hasVendor: false`

**確認事項:**
1. `taskVendorMappings.length` が0以上か
2. `task_id`が一致しているか (console.logで確認)

**対処法:**
- `insert_default_task_vendor_mappings.sql` を再実行
- または「⚙️ 設定」→「📋 タスク管理」から手動で紐づけ

### 問題3: 無限ループ
**症状**: handleHashChangeが連続して呼ばれる

**確認事項:**
1. `isHandlingHashChange`フラグが正しく動作しているか
2. setTimeout内でフラグがリセットされているか

**対処法:**
- ブラウザのキャッシュをクリア (Ctrl + Shift + Delete)
- ハードリロード (Ctrl + F5)

---

## 📝 次のアクション

ユーザーに以下を確認していただく:

1. ✅ **コンソールログ確認**
   - 上記の手順でログを確認
   - スクリーンショットを共有

2. ✅ **動作確認**
   - 業者データが表示されるか
   - メールボタン（📧）が表示されるか
   - 画面がちらつかないか

3. ✅ **問題報告**
   - 問題がある場合はコンソールログをコピーして共有
   - どのステップで問題が発生したかを報告

---

## 🎯 100点を目指すための改善案

### 現在の-25点を回復するには:

1. **業者データ表示** (+10点)
   - 原因特定: コンソールログでvendorsV2の状態を確認
   - 修正: データが空なら読み込みロジックを修正

2. **メールボタン** (+10点)
   - 原因特定: taskVendorMappingsの状態を確認
   - 修正: 紐づけが空ならSQLを再実行 or 手動紐づけ

3. **無限ループ完全解消** (+5点)
   - 原因特定: handleHashChangeの呼び出し回数を確認
   - 修正: フラグのタイミングを調整 or 別のアプローチ

### 実現すれば100点:
✅ 無限ループなし
✅ 業者データが正しく表示される
✅ メールボタンが全ての紐づけタスクに表示される
✅ IC担当者選択が動作する
✅ スタッフ認証設定が動作する
✅ 全ての機能がスムーズに動作する

---

**最終更新**: 2025-11-09
**Git Commit**: 3d47ae9 デバッグ強化: 詳細ログ追加で無限ループ・業者データ・メールボタンを追跡
**デプロイ**: https://nandemo-b9231a6nr-ghouse-developments-projects.vercel.app/sekkei/index_v2.html
