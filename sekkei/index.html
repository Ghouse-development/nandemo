<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¨­è¨ˆãƒ»ICæ¥­å‹™çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container {
  max-width: 1600px;
  margin: 0 auto;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,.1);
  overflow: hidden;
}
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: #fff;
  padding: 22px 24px;
}
.header h1 { font-size: 1.8rem; margin-bottom: 6px; }
.header .subtitle { opacity: .9; font-size: 0.95rem; }
.tabs-nav {
  display: flex;
  background: #f8f9fa;
  border-bottom: 2px solid #ddd;
  padding: 0 20px;
}
.tab-nav-btn {
  padding: 15px 30px;
  cursor: pointer;
  background: #e0e0e0;
  border: none;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s;
  border-radius: 0;
}
.tab-nav-btn:hover { background: #d0d0d0; }
.tab-nav-btn.active {
  background: white;
  color: #3498db;
  border-bottom: 3px solid #3498db;
}
.tab-panel { display: none; }
.tab-panel.active { display: block; }
.controls {
  padding: 14px 20px;
  background: #f8f9fa;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  border-bottom: 1px solid #eee;
}
.designer-tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.tab-btn {
  padding: 8px 14px;
  border: 2px solid #e9ecef;
  border-radius: 999px;
  background: #fff;
  cursor: pointer;
  font-weight: 700;
  font-size: .9rem;
}
.tab-btn.active {
  background: #667eea;
  color: #fff;
  border-color: #667eea;
}
.toolbar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
  flex: 1;
}
.input {
  height: 38px;
  padding: 0 12px;
  border: 2px solid #e9ecef;
  border-radius: 10px;
  font-size: .95rem;
  min-width: 180px;
  background: #fff;
}
.select {
  height: 38px;
  padding: 0 8px;
  border: 2px solid #e9ecef;
  border-radius: 10px;
  background: #fff;
}
.btn {
  padding: 10px 16px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 700;
  color: #fff;
  white-space: nowrap;
}
.btn-primary { background: #667eea; }
.btn-secondary { background: #43e97b; }
.btn-ghost { background: #f0f3f7; color: #333; }
.btn-small {
  padding: 6px 12px;
  font-size: 0.85rem;
}
.cards-container { padding: 20px; }
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
  gap: 18px;
}
.project-card {
  background: #fff;
  border-radius: 16px;
  padding: 18px;
  box-shadow: 0 4px 20px rgba(0,0,0,.08);
  border: 2px solid #f1f3f4;
  position: relative;
}
.card-header {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 14px;
}
.card-title {
  font-size: 18px;
  font-weight: 800;
  color: #333;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
.card-subtitle {
  font-size: 13px;
  color: #666;
  margin-top: 4px;
}
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: .75rem;
  font-weight: 700;
}
.badge-green { background: #e6ffec; color: #1a7f37; }
.badge-blue { background: #eef2ff; color: #3f51b5; }
.milestone-row {
  font-size: 13.5px;
  color: #333;
  margin-top: 6px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.milestone {
  background: #fff3cd;
  color: #7a5b00;
  border: 1px solid #ffeeba;
  border-radius: 999px;
  padding: 4px 10px;
  cursor: pointer;
  font-size: 13px;
}
.milestone-floor {
  background: #ffe8e8;
  border-color: #ffd2d2;
  color: #7a1f1f;
}
.progress-section { margin-bottom: 12px; }
.progress-bar {
  height: 8px;
  background: #e9ecef;
  border-radius: 4px;
  overflow: hidden;
  margin: 8px 0;
}
.progress-fill {
  height: 100%;
  background: #667eea;
  transition: width .25s;
}
.tasks-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}
.task-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: #555;
  padding: 6px 10px;
  border-radius: 6px;
  background: #f8f9fa;
  min-width: 160px;
  position: relative;
}
.task-checkbox {
  width: 14px;
  height: 14px;
  cursor: pointer;
}
.task-email-btn {
  margin-left: auto;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 2px 6px;
  cursor: pointer;
  font-size: 11px;
}
.task-email-btn:hover {
  background: #2980b9;
}
.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 10px;
  border-top: 1px solid #f1f3f4;
  margin-top: 8px;
}
.card-actions {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.card-btn {
  padding: 6px 10px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 700;
}
.card-btn-primary { background: #667eea; color: #fff; }
.card-btn-secondary { background: #f0f3f7; color: #333; }
.card-btn-danger { background: #dc3545; color: #fff; }
.modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.5);
  z-index: 9999;
}
.modal.show { display: flex; }
.modal-content {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  width: min(800px, 92vw);
  max-height: 86vh;
  overflow: auto;
  padding: 24px;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-bottom: 2px solid #3498db;
  padding-bottom: 10px;
}
.modal-header h2 {
  margin: 0;
  color: #2c3e50;
}
.close {
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  background: none;
  border: none;
}
.close:hover { color: #000; }
.form-group {
  margin-bottom: 15px;
}
.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #2c3e50;
}
.form-group input[type="text"],
.form-group input[type="date"],
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 10px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
}
.form-group textarea {
  min-height: 100px;
  font-family: inherit;
}
.email-output {
  background: white;
  border: 2px solid #3498db;
  border-radius: 8px;
  padding: 20px;
  font-family: 'MS Gothic', monospace;
  white-space: pre-wrap;
  line-height: 1.8;
  min-height: 200px;
  font-size: 14px;
  margin: 10px 0;
}
.copy-button {
  background: #3498db;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}
.copy-button:hover {
  background: #2980b9;
}
.template-list {
  display: grid;
  gap: 15px;
}
.template-card {
  background: #f8f9fa;
  border: 2px solid #ddd;
  border-radius: 8px;
  padding: 15px;
}
.template-card h4 {
  margin: 0 0 10px 0;
  color: #2c3e50;
}
.template-card-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.status-indicator {
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
}
.status-saving {
  background: #fff3cd;
  color: #856404;
}
.status-saved {
  background: #d4edda;
  color: #155724;
}
.status-error {
  background: #f8d7da;
  color: #721c24;
}
.mapping-grid {
  display: grid;
  gap: 10px;
}
.mapping-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
}
.mapping-item label {
  flex: 0 0 200px;
  font-weight: bold;
}
.mapping-item select {
  flex: 1;
  padding: 8px;
  border: 2px solid #ddd;
  border-radius: 6px;
}
@media (max-width: 768px) {
  .cards-grid { grid-template-columns: 1fr; }
  .tabs-nav { overflow-x: auto; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>è¨­è¨ˆãƒ»ICæ¥­å‹™çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    <div class="subtitle">æ¡ˆä»¶ç®¡ç†ãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ç™ºæ³¨æ¥­å‹™ã‚’ä¸€å…ƒåŒ–</div>
    <div id="statusIndicator" class="status-indicator status-saved" style="margin-top: 10px;">ä¿å­˜æ¸ˆã¿</div>
  </div>

  <div class="tabs-nav">
    <button class="tab-nav-btn active" onclick="switchMainTab('projects')">ğŸ“‹ æ¡ˆä»¶ç®¡ç†</button>
    <button class="tab-nav-btn" onclick="switchMainTab('templates')">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
    <button class="tab-nav-btn" onclick="switchMainTab('mappings')">ğŸ”— ã‚¿ã‚¹ã‚¯è¨­å®š</button>
  </div>

  <!-- æ¡ˆä»¶ç®¡ç†ã‚¿ãƒ– -->
  <div id="projectsTab" class="tab-panel active">
    <div class="controls">
      <div class="designer-tabs" id="designerTabs"></div>
      <div class="toolbar">
        <input id="searchQuery" class="input" placeholder="æ¤œç´¢ï¼ˆé¡§å®¢å / ãƒ¡ãƒ¢ï¼‰" oninput="renderProjects()" />
        <select id="sortKey" class="select" onchange="renderProjects()">
          <option value="manual">æ‰‹å‹•ä¸¦ã³æ›¿ãˆ</option>
          <option value="progress">é€²æ—ãŒä½ã„é †</option>
          <option value="updatedAt">æ›´æ–°ãŒæ–°ã—ã„é †</option>
          <option value="customer">é¡§å®¢åé †</option>
        </select>
        <select id="specFilter" class="select" onchange="renderProjects()">
          <option value="">ä»•æ§˜ï¼šã™ã¹ã¦</option>
          <option>LIFE</option>
          <option>LIFE+</option>
          <option>HOURS</option>
          <option>LACIE</option>
          <option>LIFEãƒªãƒŸ</option>
          <option>LIFE+ãƒªãƒŸ</option>
        </select>
        <button class="btn btn-secondary" onclick="openDesignerModal()">è¨­è¨ˆå£«ç®¡ç†</button>
        <button class="btn btn-primary" onclick="openProjectModal()">æ¡ˆä»¶è¿½åŠ </button>
      </div>
    </div>
    <div class="cards-container">
      <div class="cards-grid" id="projectsGrid"></div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ã‚¿ãƒ– -->
  <div id="templatesTab" class="tab-panel">
    <div class="controls">
      <div class="toolbar">
        <button class="btn btn-primary" onclick="openTemplateModal()">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </button>
        <select id="categoryFilter" class="select" onchange="renderTemplates()">
          <option value="">ã™ã¹ã¦</option>
          <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
          <option value="IC">IC</option>
        </select>
      </div>
    </div>
    <div class="cards-container">
      <div class="template-list" id="templatesList"></div>
    </div>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯-ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç´ã¥ã‘è¨­å®šã‚¿ãƒ– -->
  <div id="mappingsTab" class="tab-panel">
    <div class="cards-container">
      <h2 style="margin-bottom: 20px;">ã‚¿ã‚¹ã‚¯ã¨ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç´ã¥ã‘è¨­å®š</h2>
      <p style="margin-bottom: 20px; color: #666;">å„ã‚¿ã‚¹ã‚¯ã§ä½¿ç”¨ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚è¨­å®šå¾Œã€æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã®ã‚¿ã‚¹ã‚¯ã‹ã‚‰ç›´æ¥ãƒ¡ãƒ¼ãƒ«ä½œæˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
      <div class="mapping-grid" id="mappingsGrid"></div>
      <button class="btn btn-primary" style="margin-top: 20px;" onclick="saveMappings()">è¨­å®šã‚’ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- æ¡ˆä»¶è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="projectModalTitle">æ¡ˆä»¶è¿½åŠ </h2>
      <button class="close" onclick="closeProjectModal()">&times;</button>
    </div>
    <div class="form-group">
      <label>ãŠå®¢æ§˜å *</label>
      <input type="text" id="projectCustomer" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒæ§˜">
    </div>
    <div class="form-group">
      <label>æ‹…å½“è¨­è¨ˆå£« *</label>
      <select id="projectAssignedTo"></select>
    </div>
    <div class="form-group">
      <label>ä»•æ§˜</label>
      <select id="projectSpecifications">
        <option>LIFE</option>
        <option>LIFE+</option>
        <option>HOURS</option>
        <option>LACIE</option>
        <option>LIFEãƒªãƒŸ</option>
        <option>LIFE+ãƒªãƒŸ</option>
      </select>
    </div>
    <div class="form-group">
      <label>ãƒ¡ãƒ¢</label>
      <textarea id="projectMemo" placeholder="è¦æœ›ãƒ»æ³¨æ„ç‚¹ãªã©"></textarea>
    </div>
    <div style="text-align: right; margin-top: 20px;">
      <button class="btn btn-ghost" onclick="closeProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveProject()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="emailModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2>ğŸ“§ ãƒ¡ãƒ¼ãƒ«ä½œæˆ</h2>
      <button class="close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div id="emailComposerContent"></div>
  </div>
</div>

<!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="templateModalTitle">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </h2>
      <button class="close" onclick="closeTemplateModal()">&times;</button>
    </div>
    <div class="form-group">
      <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDï¼ˆè‹±æ•°å­—ï¼‰*</label>
      <input type="text" id="templateId" placeholder="ä¾‹: new-template">
    </div>
    <div class="form-group">
      <label>è¡¨ç¤ºå *</label>
      <input type="text" id="templateDisplayName" placeholder="ä¾‹: æ–°ä¼šç¤¾åï¼ˆä½œæ¥­å†…å®¹ï¼‰">
    </div>
    <div class="form-group">
      <label>ã‚«ãƒ†ã‚´ãƒª *</label>
      <select id="templateCategory">
        <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
        <option value="IC">IC</option>
      </select>
    </div>
    <div class="form-group">
      <label>ä¼šç¤¾å *</label>
      <input type="text" id="templateCompany" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã€‡ã€‡">
    </div>
    <div class="form-group">
      <label>å®›å…ˆå</label>
      <input type="text" id="templateContact" placeholder="ä¾‹: ç”°ä¸­æ§˜">
    </div>
    <div class="form-group">
      <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
      <input type="text" id="templateEmail" placeholder="ä¾‹: tanaka@example.com">
    </div>
    <div class="form-group">
      <label>ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ *</label>
      <input type="text" id="templateSubjectFormat" placeholder="ä¾‹: {customerName}æ§˜ æ–°è¦ã€‡ã€‡ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}">
      <small>ä½¿ç”¨å¯èƒ½ãªå¤‰æ•°: {customerName}, {dueDate}, {staffName}</small>
    </div>
    <div class="form-group">
      <label>ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ *</label>
      <textarea id="templateText" rows="10" placeholder="ä¾‹:&#10;{company}&#10;{contact}&#10;&#10;ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚"></textarea>
      <small>ä½¿ç”¨å¯èƒ½ãªå¤‰æ•°: {company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</small>
    </div>
    <div style="text-align: right; margin-top: 20px;">
      <button class="btn btn-ghost" onclick="closeTemplateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveTemplate()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- è¨­è¨ˆå£«ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="designerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>è¨­è¨ˆå£«ç®¡ç†</h2>
      <button class="close" onclick="closeDesignerModal()">&times;</button>
    </div>
    <div class="form-group">
      <label>æ–°ã—ã„è¨­è¨ˆå£«ã‚’è¿½åŠ </label>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="newDesignerName" placeholder="è¨­è¨ˆå£«å" style="flex: 1;">
        <button class="btn btn-primary" onclick="addDesigner()">è¿½åŠ </button>
      </div>
    </div>
    <div id="designerList"></div>
    <div style="text-align: right; margin-top: 20px;">
      <button class="btn btn-primary" onclick="closeDesignerModal()">å®Œäº†</button>
    </div>
  </div>
</div>

<script>
// =====================================================
// SupabaseåˆæœŸåŒ–
// =====================================================
const SUPABASE_URL = 'https://twzsirpfudqwboeyakta.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3enNpcnBmdWRxd2JvZXlha3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzM4NjgsImV4cCI6MjA3NzAwOTg2OH0.E_8GxfsO6Scjc0dDoEoyxq3i4lfvNxYZvnSL1OlSDSM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let projects = [];
let designers = [];
let emailTemplates = [];
let taskMappings = {};
let currentDesignerTab = 'ALL';
let editingProjectId = null;
let editingTemplateId = null;

// ã‚¿ã‚¹ã‚¯å®šç¾©
const TASK_NAMES = {
  meeting0: '0å›ç›®æ‰“åˆã›',
  floorPlan: 'é–“å–ã‚Šç¢ºå®š',
  initialPrep: 'åˆå›æº–å‚™',
  finalDrawing: 'ç¢ºå®šå›³é¢',
  checklist: 'ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ',
  workingDrawing: 'å®Ÿæ–½å›³ä¾é ¼',
  plumbing: 'çµ¦æ’æ°´',
  ventilation: 'æ›æ°—',
  solar: 'å¤ªé™½å…‰',
  evoltz: 'ã‚¨ãƒœãƒ«ãƒ„',
  sash: 'ã‚µãƒƒã‚·ä¾é ¼',
  structure: 'æ§‹é€ ä¾é ¼',
  groundSurvey: 'åœ°ç›¤èª¿æŸ»',
  application: 'ç”³è«‹ä¾é ¼',
  exterior: 'å¤–æ§‹ä¾é ¼',
  dandori: 'ãƒ€ãƒ³ãƒ‰ãƒªUP'
};

// ã‚¿ã‚¹ã‚¯çŠ¶æ…‹å®šç¾©
const TASK_STATES = {
  workingDrawing: ['', 'ä¾é ¼æ¸ˆ', 'ä¿å­˜æ¸ˆ'],
  plumbing: ['', 'ä¾é ¼æ¸ˆ', 'ä¿å­˜æ¸ˆ'],
  ventilation: ['', 'ä¾é ¼æ¸ˆ', 'ä¿å­˜æ¸ˆ'],
  solar: ['', 'ä¾é ¼æ¸ˆ', 'ä¿å­˜æ¸ˆ'],
  evoltz: ['', 'ä¾é ¼æ¸ˆ', 'ä¿å­˜æ¸ˆ'],
  sash: ['', 'ä¾é ¼æ¸ˆ', 'ä¿å­˜æ¸ˆ'],
  groundSurvey: ['', 'ä¾é ¼æ¸ˆ', 'ä¿å­˜æ¸ˆ'],
  application: ['', 'ä¾é ¼æ¸ˆ', 'ä¿å­˜æ¸ˆ'],
  structure: ['', 'ä¾é ¼æ¸ˆ', 'ãƒ©ãƒ•ãƒã‚§ãƒƒã‚¯æ¸ˆ', 'ï¼‘å›ç›®CBæ¸ˆ', 'ï¼’å›ç›®CBæ¸ˆ']
};

// =====================================================
// åˆæœŸåŒ–
// =====================================================
async function init() {
  showStatus('èª­ã¿è¾¼ã¿ä¸­...', 'saving');
  try {
    await loadDesigners();
    await loadProjects();
    await loadEmailTemplates();
    await loadTaskMappings();

    renderDesignerTabs();
    renderProjects();
    renderTemplates();
    renderMappings();

    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  } catch (error) {
    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

// =====================================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// =====================================================
async function loadDesigners() {
  const { data, error } = await supabase
    .from('designers')
    .select('*')
    .order('name');

  if (error) throw error;
  designers = data || [];
}

async function loadProjects() {
  const { data, error } = await supabase
    .from('projects')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) throw error;
  projects = data || [];
}

async function loadEmailTemplates() {
  const { data, error } = await supabase
    .from('email_templates')
    .select('*')
    .order('display_name');

  if (error) throw error;
  emailTemplates = data || [];
}

async function loadTaskMappings() {
  const { data, error } = await supabase
    .from('task_template_mappings')
    .select('*');

  if (error) throw error;

  taskMappings = {};
  (data || []).forEach(mapping => {
    taskMappings[mapping.task_key] = mapping.template_id;
  });
}

// =====================================================
// UIåˆ¶å¾¡
// =====================================================
function switchMainTab(tabName) {
  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');
}

function showStatus(message, type) {
  const indicator = document.getElementById('statusIndicator');
  indicator.textContent = message;
  indicator.className = 'status-indicator status-' + type;
}

// =====================================================
// æ¡ˆä»¶ç®¡ç†
// =====================================================
function renderDesignerTabs() {
  const container = document.getElementById('designerTabs');
  const activeCount = projects.filter(p => p.status !== 'completed').length;

  let html = `<button class="tab-btn ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="setDesignerTab('ALL')">å…¨æ¡ˆä»¶ (${activeCount})</button>`;

  designers.forEach(designer => {
    const count = projects.filter(p => p.assigned_to === designer.name && p.status !== 'completed').length;
    const active = currentDesignerTab === designer.name ? 'active' : '';
    html += `<button class="tab-btn ${active}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
  });

  container.innerHTML = html;
}

function setDesignerTab(name) {
  currentDesignerTab = name;
  renderDesignerTabs();
  renderProjects();
}

function renderProjects() {
  const container = document.getElementById('projectsGrid');
  let filtered = projects.filter(p => {
    if (currentDesignerTab !== 'ALL' && p.assigned_to !== currentDesignerTab) return false;
    if (p.status === 'completed') return false;

    const query = document.getElementById('searchQuery').value.toLowerCase();
    if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

    const specFilter = document.getElementById('specFilter').value;
    if (specFilter && p.specifications !== specFilter) return false;

    return true;
  });

  const sortKey = document.getElementById('sortKey').value;
  if (sortKey === 'progress') {
    filtered.sort((a, b) => calculateProgress(a) - calculateProgress(b));
  } else if (sortKey === 'updatedAt') {
    filtered.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
  } else if (sortKey === 'customer') {
    filtered.sort((a, b) => a.customer.localeCompare(b.customer, 'ja'));
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 60px; color: #666;">æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  container.innerHTML = filtered.map(project => renderProjectCard(project)).join('');
}

function renderProjectCard(project) {
  const progress = calculateProgress(project);
  const progressData = project.progress || {};

  const tasksHtml = Object.keys(TASK_NAMES).map(key => {
    const task = progressData[key] || { completed: false, date: '', state: '' };
    const hasMapping = taskMappings[key];
    const emailBtn = hasMapping ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="ãƒ¡ãƒ¼ãƒ«ä½œæˆ">ğŸ“§</button>` : '';

    return `
      <div class="task-item">
        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}
          onchange="updateTaskStatus('${project.id}', '${key}', this.checked)">
        <span>${TASK_NAMES[key]}</span>
        ${emailBtn}
      </div>
    `;
  }).join('');

  return `
    <div class="project-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span>${project.customer}</span>
            <span class="badge badge-blue">${project.specifications || 'LIFE'}</span>
          </div>
          <div class="card-subtitle">æ‹…å½“ï¼š${project.assigned_to}</div>
        </div>
        <div class="milestone-row">
          <span class="milestone">0å›ç›®: ${formatDate(progressData.meeting0?.date)}</span>
          <span class="milestone milestone-floor">é–“å–ã‚Š: ${formatDate(progressData.floorPlan?.date)}</span>
        </div>
      </div>
      <div class="progress-section">
        <div style="margin-bottom: 8px;">é€²æ—: <strong>${progress}%</strong></div>
        <div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>
      </div>
      <div class="tasks-container">${tasksHtml}</div>
      ${project.memo ? `<div style="padding: 10px; background: #f0f8ff; border-radius: 8px; margin-bottom: 8px; font-size: 12px;">${project.memo}</div>` : ''}
      <div class="card-footer">
        <div style="font-size: 11px; color: #666;">æ›´æ–°: ${formatDateTime(project.updated_at)}</div>
        <div class="card-actions">
          <button class="card-btn card-btn-primary" onclick="editProject('${project.id}')">ç·¨é›†</button>
          <button class="card-btn card-btn-danger" onclick="deleteProject('${project.id}')">å‰Šé™¤</button>
        </div>
      </div>
    </div>
  `;
}

function calculateProgress(project) {
  const progressData = project.progress || {};
  const keys = Object.keys(TASK_NAMES);
  const completed = keys.filter(key => progressData[key]?.completed).length;
  return Math.round((completed / keys.length) * 100);
}

function formatDate(dateStr) {
  if (!dateStr) return 'â€”';
  const d = new Date(dateStr);
  return `${d.getMonth() + 1}/${d.getDate()}`;
}

function formatDateTime(dateStr) {
  if (!dateStr) return 'â€”';
  const d = new Date(dateStr);
  return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

async function updateTaskStatus(projectId, taskKey, completed) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].completed = completed;
  if (completed && !progressData[taskKey].date) {
    progressData[taskKey].date = new Date().toISOString().split('T')[0];
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    return;
  }

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

function openProjectModal(projectId = null) {
  editingProjectId = projectId;
  const modal = document.getElementById('projectModal');
  const title = document.getElementById('projectModalTitle');

  if (projectId) {
    const project = projects.find(p => p.id === projectId);
    title.textContent = 'æ¡ˆä»¶ç·¨é›†';
    document.getElementById('projectCustomer').value = project.customer;
    document.getElementById('projectAssignedTo').value = project.assigned_to;
    document.getElementById('projectSpecifications').value = project.specifications || 'LIFE';
    document.getElementById('projectMemo').value = project.memo || '';
  } else {
    title.textContent = 'æ¡ˆä»¶è¿½åŠ ';
    document.getElementById('projectCustomer').value = '';
    document.getElementById('projectSpecifications').value = 'LIFE';
    document.getElementById('projectMemo').value = '';
  }

  const assignedToSelect = document.getElementById('projectAssignedTo');
  assignedToSelect.innerHTML = designers.map(d =>
    `<option value="${d.name}">${d.name}</option>`
  ).join('');

  modal.classList.add('show');
}

function closeProjectModal() {
  document.getElementById('projectModal').classList.remove('show');
  editingProjectId = null;
}

async function saveProject() {
  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value;
  const specifications = document.getElementById('projectSpecifications').value;
  const memo = document.getElementById('projectMemo').value.trim();

  if (!customer || !assignedTo) {
    alert('ãŠå®¢æ§˜åã¨æ‹…å½“è¨­è¨ˆå£«ã¯å¿…é ˆã§ã™');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const blankProgress = {};
  Object.keys(TASK_NAMES).forEach(key => {
    blankProgress[key] = { completed: false, date: '', state: '' };
  });

  if (editingProjectId) {
    const project = projects.find(p => p.id === editingProjectId);
    const { error } = await supabase
      .from('projects')
      .update({
        customer,
        assigned_to: assignedTo,
        specifications,
        memo,
        updated_at: new Date().toISOString()
      })
      .eq('id', editingProjectId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      return;
    }

    Object.assign(project, { customer, assigned_to: assignedTo, specifications, memo, updated_at: new Date().toISOString() });
  } else {
    const newProject = {
      uid: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      customer,
      assigned_to: assignedTo,
      specifications,
      memo,
      status: 'active',
      progress: blankProgress
    };

    const { data, error } = await supabase
      .from('projects')
      .insert([newProject])
      .select();

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      return;
    }

    projects.unshift(data[0]);
  }

  closeProjectModal();
  renderDesignerTabs();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

function editProject(projectId) {
  openProjectModal(projectId);
}

async function deleteProject(projectId) {
  if (!confirm('ã“ã®æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .delete()
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    return;
  }

  projects = projects.filter(p => p.id !== projectId);
  renderDesignerTabs();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

// =====================================================
// è¨­è¨ˆå£«ç®¡ç†
// =====================================================
function openDesignerModal() {
  renderDesignerList();
  document.getElementById('designerModal').classList.add('show');
}

function closeDesignerModal() {
  document.getElementById('designerModal').classList.remove('show');
}

function renderDesignerList() {
  const container = document.getElementById('designerList');
  container.innerHTML = '<h3 style="margin: 20px 0 10px;">ç™»éŒ²æ¸ˆã¿è¨­è¨ˆå£«</h3>' +
    designers.map(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 6px;">
          <span>${designer.name} (${count}ä»¶)</span>
          <button class="btn btn-small btn-ghost" onclick="deleteDesigner('${designer.id}')">å‰Šé™¤</button>
        </div>
      `;
    }).join('');
}

async function addDesigner() {
  const name = document.getElementById('newDesignerName').value.trim();
  if (!name) {
    alert('è¨­è¨ˆå£«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  if (designers.find(d => d.name === name)) {
    alert('æ—¢ã«å­˜åœ¨ã™ã‚‹è¨­è¨ˆå£«åã§ã™');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');
  const { data, error } = await supabase
    .from('designers')
    .insert([{ name }])
    .select();

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerName').value = '';
  renderDesignerList();
  renderDesignerTabs();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

async function deleteDesigner(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    alert('ã“ã®è¨­è¨ˆå£«ã¯æ¡ˆä»¶ã«å‰²å½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚æ¡ˆä»¶ã®æ‹…å½“ã‚’å¤‰æ›´ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  if (!confirm(`${designer.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerList();
  renderDesignerTabs();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

// =====================================================
// ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
// =====================================================
function renderTemplates() {
  const container = document.getElementById('templatesList');
  const categoryFilter = document.getElementById('categoryFilter').value;

  let filtered = emailTemplates;
  if (categoryFilter) {
    filtered = emailTemplates.filter(t => t.category === categoryFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 60px; color: #666;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  container.innerHTML = filtered.map(template => `
    <div class="template-card">
      <h4>${template.display_name}
        <span class="badge ${template.category === 'IC' ? 'badge-green' : 'badge-blue'}">${template.category}</span>
      </h4>
      <p style="margin: 5px 0; color: #666;">ä¼šç¤¾: ${template.company}</p>
      <p style="margin: 5px 0; color: #666;">å®›å…ˆ: ${template.contact || 'ã”æ‹…å½“è€…æ§˜'}</p>
      <p style="margin: 5px 0; color: #666;">Email: ${template.email || 'ãªã—'}</p>
      <div class="template-card-actions">
        <button class="btn btn-small btn-primary" onclick="editTemplate('${template.id}')">ç·¨é›†</button>
        <button class="btn btn-small btn-ghost" onclick="deleteTemplate('${template.id}')">å‰Šé™¤</button>
      </div>
    </div>
  `).join('');
}

function openTemplateModal(templateId = null) {
  editingTemplateId = templateId;
  const modal = document.getElementById('templateModal');
  const title = document.getElementById('templateModalTitle');

  if (templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    title.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†';
    document.getElementById('templateId').value = template.template_id;
    document.getElementById('templateId').disabled = true;
    document.getElementById('templateDisplayName').value = template.display_name;
    document.getElementById('templateCategory').value = template.category;
    document.getElementById('templateCompany').value = template.company;
    document.getElementById('templateContact').value = template.contact || '';
    document.getElementById('templateEmail').value = template.email || '';
    document.getElementById('templateSubjectFormat').value = template.subject_format || '';
    document.getElementById('templateText').value = template.template_text || '';
  } else {
    title.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ ';
    document.getElementById('templateId').value = '';
    document.getElementById('templateId').disabled = false;
    document.getElementById('templateDisplayName').value = '';
    document.getElementById('templateCategory').value = 'è¨­è¨ˆ';
    document.getElementById('templateCompany').value = '';
    document.getElementById('templateContact').value = '';
    document.getElementById('templateEmail').value = '';
    document.getElementById('templateSubjectFormat').value = '';
    document.getElementById('templateText').value = '';
  }

  modal.classList.add('show');
}

function closeTemplateModal() {
  document.getElementById('templateModal').classList.remove('show');
  editingTemplateId = null;
}

async function saveTemplate() {
  const templateId = document.getElementById('templateId').value.trim();
  const displayName = document.getElementById('templateDisplayName').value.trim();
  const category = document.getElementById('templateCategory').value;
  const company = document.getElementById('templateCompany').value.trim();
  const contact = document.getElementById('templateContact').value.trim();
  const email = document.getElementById('templateEmail').value.trim();
  const subjectFormat = document.getElementById('templateSubjectFormat').value.trim();
  const templateText = document.getElementById('templateText').value.trim();

  if (!templateId || !displayName || !company || !subjectFormat || !templateText) {
    alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const templateData = {
    template_id: templateId,
    display_name: displayName,
    category,
    company,
    contact,
    email,
    subject_format: subjectFormat,
    template_text: templateText,
    has_special_content: false,
    has_sub_options: false
  };

  if (editingTemplateId) {
    const { error } = await supabase
      .from('email_templates')
      .update(templateData)
      .eq('id', editingTemplateId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      return;
    }

    const template = emailTemplates.find(t => t.id === editingTemplateId);
    Object.assign(template, templateData);
  } else {
    const { data, error } = await supabase
      .from('email_templates')
      .insert([templateData])
      .select();

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      return;
    }

    emailTemplates.push(data[0]);
  }

  closeTemplateModal();
  renderTemplates();
  renderMappings();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

function editTemplate(templateId) {
  openTemplateModal(templateId);
}

async function deleteTemplate(templateId) {
  if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('email_templates')
    .delete()
    .eq('id', templateId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    return;
  }

  emailTemplates = emailTemplates.filter(t => t.id !== templateId);
  renderTemplates();
  renderMappings();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

// =====================================================
// ã‚¿ã‚¹ã‚¯-ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç´ã¥ã‘è¨­å®š
// =====================================================
function renderMappings() {
  const container = document.getElementById('mappingsGrid');

  container.innerHTML = Object.keys(TASK_NAMES).map(taskKey => {
    const templateOptions = emailTemplates.map(t =>
      `<option value="${t.template_id}" ${taskMappings[taskKey] === t.template_id ? 'selected' : ''}>
        ${t.display_name} (${t.category})
      </option>`
    ).join('');

    return `
      <div class="mapping-item">
        <label>${TASK_NAMES[taskKey]}</label>
        <select id="mapping_${taskKey}">
          <option value="">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—</option>
          ${templateOptions}
        </select>
      </div>
    `;
  }).join('');
}

async function saveMappings() {
  showStatus('ä¿å­˜ä¸­...', 'saving');

  const newMappings = {};
  Object.keys(TASK_NAMES).forEach(taskKey => {
    const select = document.getElementById('mapping_' + taskKey);
    if (select && select.value) {
      newMappings[taskKey] = select.value;
    }
  });

  // æ—¢å­˜ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‰Šé™¤
  const { error: deleteError } = await supabase
    .from('task_template_mappings')
    .delete()
    .neq('id', '00000000-0000-0000-0000-000000000000'); // å…¨å‰Šé™¤

  if (deleteError) {
    showStatus('ã‚¨ãƒ©ãƒ¼: ' + deleteError.message, 'error');
    return;
  }

  // æ–°ã—ã„ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æŒ¿å…¥
  const mappingsToInsert = Object.keys(newMappings).map(taskKey => ({
    task_key: taskKey,
    template_id: newMappings[taskKey]
  }));

  if (mappingsToInsert.length > 0) {
    const { error: insertError } = await supabase
      .from('task_template_mappings')
      .insert(mappingsToInsert);

    if (insertError) {
      showStatus('ã‚¨ãƒ©ãƒ¼: ' + insertError.message, 'error');
      return;
    }
  }

  taskMappings = newMappings;
  renderProjects(); // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®ğŸ“§ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
  showStatus('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'saved');
}

// =====================================================
// ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ¼ãƒ«ä½œæˆ
// =====================================================
function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const templateId = taskMappings[taskKey];
  if (!templateId) {
    alert('ã“ã®ã‚¿ã‚¹ã‚¯ã«ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã€Œã‚¿ã‚¹ã‚¯è¨­å®šã€ã‚¿ãƒ–ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) {
    alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }

  // ã‚¿ã‚¹ã‚¯ã®æœŸæ—¥ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°1é€±é–“å¾Œï¼‰
  const taskDate = project.progress?.[taskKey]?.date;
  const dueDate = taskDate || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // ãƒ¡ãƒ¼ãƒ«ä½œæˆUI
  content.innerHTML = `
    <div class="form-group">
      <label>æ‹…å½“è€…åï¼ˆç½²åç”¨ï¼‰</label>
      <input type="text" id="emailStaffName" value="${project.assigned_to}" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
    </div>
    <div class="form-group">
      <label>æœŸæ—¥</label>
      <input type="date" id="emailDueDate" value="${dueDate}" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
    </div>
    <div class="form-group">
      <label>å†…å®¹è©³ç´°ï¼ˆä»»æ„ï¼‰</label>
      <textarea id="emailSpecialContent" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;" placeholder="å¿…è¦ã«å¿œã˜ã¦è©³ç´°ã‚’å…¥åŠ›"></textarea>
    </div>
    <button class="btn btn-primary" onclick="generateEmail('${project.id}', '${taskKey}')">ãƒ¡ãƒ¼ãƒ«ã‚’ç”Ÿæˆ</button>
    <div id="generatedEmailSection" style="display: none; margin-top: 20px;">
      <h3>ğŸ“§ ä»¶å</h3>
      <div id="emailSubject" class="email-output" style="min-height: 60px; background: #e8f4f8;"></div>
      <button class="copy-button" onclick="copyText('emailSubject')">ä»¶åã‚’ã‚³ãƒ”ãƒ¼</button>

      <h3 style="margin-top: 20px;">ğŸ“® å®›å…ˆ</h3>
      <div id="emailAddress" class="email-output" style="min-height: 60px; background: #f8e8f8;"></div>
      <button class="copy-button" onclick="copyText('emailAddress')">å®›å…ˆã‚’ã‚³ãƒ”ãƒ¼</button>

      <h3 style="margin-top: 20px;">ğŸ“¨ æœ¬æ–‡</h3>
      <div id="emailBody" class="email-output"></div>
      <button class="copy-button" onclick="copyText('emailBody')">æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
  `;

  modal.classList.add('show');
}

function generateEmail(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const templateId = taskMappings[taskKey];
  const template = emailTemplates.find(t => t.template_id === templateId);

  const staffName = document.getElementById('emailStaffName').value.trim();
  const dueDate = document.getElementById('emailDueDate').value;
  const specialContent = document.getElementById('emailSpecialContent').value.trim();

  // å¤‰æ•°ç½®æ›
  const replacements = {
    '{customerName}': project.customer,
    '{dueDate}': dueDate,
    '{staffName}': staffName,
    '{company}': template.company,
    '{contact}': template.contact || 'ã”æ‹…å½“è€…æ§˜',
    '{specialContent}': specialContent || ''
  };

  let subject = template.subject_format;
  let body = template.template_text;

  Object.keys(replacements).forEach(key => {
    subject = subject.replace(new RegExp(key.replace(/[{}]/g, '\\$&'), 'g'), replacements[key]);
    body = body.replace(new RegExp(key.replace(/[{}]/g, '\\$&'), 'g'), replacements[key]);
  });

  document.getElementById('emailSubject').textContent = subject;
  document.getElementById('emailAddress').textContent = template.email || 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
  document.getElementById('emailBody').textContent = body;
  document.getElementById('generatedEmailSection').style.display = 'block';
}

function copyText(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent;

  navigator.clipboard.writeText(text).then(() => {
    alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  }).catch(err => {
    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
    alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
  });
}

function closeEmailModal() {
  document.getElementById('emailModal').classList.remove('show');
}

// =====================================================
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
// =====================================================
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
